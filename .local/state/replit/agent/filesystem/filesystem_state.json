{"file_contents":{"daily_reminder.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nDaily Payment Reminder Script\nRun this script daily to send payment reminders for 90-day payment plans.\n\"\"\"\n\nimport asyncio\nimport sys\nimport os\n\n# Add project root to path\nsys.path.append(os.path.dirname(os.path.abspath(__file__)))\n\nfrom bot.payment_reminder import run_daily_reminder_check\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nasync def main():\n    \"\"\"Main function to run daily reminders\"\"\"\n    logger.info(\"Starting daily payment reminder check...\")\n    \n    try:\n        await run_daily_reminder_check()\n        logger.info(\"Daily payment reminder check completed successfully\")\n        \n    except Exception as e:\n        logger.error(f\"Error in daily reminder check: {e}\")\n        return 1\n    \n    return 0\n\nif __name__ == \"__main__\":\n    exit_code = asyncio.run(main())\n    sys.exit(exit_code)\n","size_bytes":866},"main.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nDecoTeen Telegram Bot - Main Entry Point\nØ±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ú©ÙˆØªÛŒÙ†\n\"\"\"\n\nimport logging\nfrom telegram.ext import ApplicationBuilder\nfrom bot.handlers import BotHandlers\nfrom bot.config import Config\nfrom utils.logger import setup_logger\nfrom reminder_scheduler import reminder_scheduler\n\n# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯Ø±\nlogger = setup_logger(__name__)\n\n\ndef main():\n    \"\"\"ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª\"\"\"\n    try:\n        # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª\n        config = Config()\n\n        if not config.bot_token:\n            logger.error(\"âŒ BOT_TOKEN not found in environment variables\")\n            print(\"âŒ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n            return\n\n        config.print_config_status()\n\n        # Ø§ÛŒØ¬Ø§Ø¯ Application\n        app = ApplicationBuilder().token(config.bot_token).build()\n\n        # Ø§ÛŒØ¬Ø§Ø¯ handlers\n        bot_handlers = BotHandlers()\n\n        # ØªÙ†Ø¸ÛŒÙ… handlers\n        bot_handlers.setup_handlers(app)\n\n        # Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ\n        reminder_scheduler.start_scheduler()\n        \n        # Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª\n        logger.info(\"ğŸš€ Starting DecoTeen Bot...\")\n        print(\"âœ… Ø±Ø¨Ø§Øª Ø´Ø±ÙˆØ¹ Ø´Ø¯...\")\n        print(\"ğŸ”” Ø³ÛŒØ³ØªÙ… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯...\")\n\n        # Add error handling for multiple bot instances\n        try:\n            app.run_polling(\n                allowed_updates=[\"message\", \"callback_query\"],\n                drop_pending_updates=True,\n                timeout=30,\n                read_timeout=10,\n                write_timeout=10,\n                connect_timeout=10,\n                pool_timeout=10\n            )\n        except Exception as polling_error:\n            logger.error(f\"Polling error: {polling_error}\")\n            # Wait a bit before potentially restarting\n            import time\n            time.sleep(5)\n            raise\n\n    except Exception as e:\n        logger.error(f\"âŒ Error starting bot: {e}\")\n        print(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª: {e}\")\n        raise\n    finally:\n        logger.info(\"ğŸ›‘ Bot stopped\")\n\n\nif __name__ == \"__main__\":\n    print(\"ğŸ¤– DecoTeen Telegram Bot\")\n    print(\"=\" * 40)\n\n    try:\n        # Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª\n        main()\n    except KeyboardInterrupt:\n        print(\"\\nğŸ‘‹ Bot stopped by user\")\n    except Exception as e:\n        print(f\"ğŸ’¥ Fatal error: {e}\")\n        exit(1)\n","size_bytes":2417},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"python-telegram-bot>=22.3\",\n    \"requests>=2.32.4\",\n    \"telegram>=0.0.1\",\n]\n","size_bytes":224},"reminder_scheduler.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nAutomated Reminder Scheduler\nØ§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª\n\"\"\"\n\nimport asyncio\nimport schedule\nimport time\nimport threading\nfrom datetime import datetime\nfrom bot.payment_reminder import run_daily_reminder_check\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass ReminderScheduler:\n    \"\"\"Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ Ø®ÙˆØ¯Ú©Ø§Ø± ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§\"\"\"\n    \n    def __init__(self):\n        self.running = False\n        self.thread = None\n    \n    def start_scheduler(self):\n        \"\"\"Ø´Ø±ÙˆØ¹ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯\"\"\"\n        if self.running:\n            logger.warning(\"Scheduler is already running\")\n            return\n        \n        self.running = True\n        \n        # ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ - Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 9 ØµØ¨Ø­\n        schedule.every().day.at(\"09:00\").do(self._run_daily_check)\n        \n        # ØªÙ†Ø¸ÛŒÙ… Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø± 4 Ø³Ø§Ø¹Øª Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨ÛŒØ´ØªØ±\n        schedule.every(4).hours.do(self._run_hourly_check)\n        \n        logger.info(\"âœ… Reminder scheduler started - Daily at 9:00 AM, Every 4 hours\")\n        \n        # Ø§Ø¬Ø±Ø§ Ø¯Ø± thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\n        self.thread = threading.Thread(target=self._scheduler_loop, daemon=True)\n        self.thread.start()\n    \n    def stop_scheduler(self):\n        \"\"\"ØªÙˆÙ‚Ù Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯\"\"\"\n        self.running = False\n        schedule.clear()\n        logger.info(\"ğŸ›‘ Reminder scheduler stopped\")\n    \n    def _scheduler_loop(self):\n        \"\"\"Ø­Ù„Ù‚Ù‡ Ø§ØµÙ„ÛŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯\"\"\"\n        while self.running:\n            try:\n                schedule.run_pending()\n                time.sleep(60)  # Ú†Ú© Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡\n            except Exception as e:\n                logger.error(f\"Scheduler error: {e}\")\n                time.sleep(300)  # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†\n    \n    def _run_daily_check(self):\n        \"\"\"Ø§Ø¬Ø±Ø§ÛŒ Ú†Ú© Ø±ÙˆØ²Ø§Ù†Ù‡\"\"\"\n        try:\n            logger.info(\"ğŸ”” Running daily reminder check...\")\n            asyncio.run(run_daily_reminder_check())\n            logger.info(\"âœ… Daily reminder check completed\")\n        except Exception as e:\n            logger.error(f\"Daily reminder error: {e}\")\n    \n    def _run_hourly_check(self):\n        \"\"\"Ø§Ø¬Ø±Ø§ÛŒ Ú†Ú© 4 Ø³Ø§Ø¹ØªÙ‡\"\"\"\n        try:\n            current_hour = datetime.now().hour\n            if 8 <= current_hour <= 20:  # ÙÙ‚Ø· Ø¯Ø± Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ\n                logger.info(\"ğŸ”” Running hourly reminder check...\")\n                asyncio.run(run_daily_reminder_check())\n                logger.info(\"âœ… Hourly reminder check completed\")\n        except Exception as e:\n            logger.error(f\"Hourly reminder error: {e}\")\n\n# Instance Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± main\nreminder_scheduler = ReminderScheduler()\n\nif __name__ == \"__main__\":\n    reminder_scheduler.start_scheduler()\n    \n    try:\n        while True:\n            time.sleep(1)\n    except KeyboardInterrupt:\n        reminder_scheduler.stop_scheduler()\n        print(\"ğŸ‘‹ Reminder scheduler stopped\")\n","size_bytes":3063},"replit.md":{"content":"# Persian E-commerce Telegram Bot\n\n## Overview\n\nThis is a comprehensive Persian e-commerce Telegram bot designed for selling bedding and home textile products. The bot provides a complete shopping experience with customer authentication, hierarchical product browsing, shopping cart management, and invoice generation. The system is built using the python-telegram-bot library and follows a modular architecture with clear separation of concerns.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\nThe application follows a modular architecture with clear separation of concerns:\n\n- **Bot Layer**: Handles Telegram API interactions using the python-telegram-bot library with handlers for commands, callbacks, and messages\n- **Data Layer**: Manages customer database and product catalog using static data structures stored in Python dictionaries\n- **Business Logic Layer**: Processes cart operations, pricing calculations, discount management, and invoice generation\n- **Utilities Layer**: Provides logging, Persian language support, text formatting, and number conversion utilities\n\nThe architecture is designed for maintainability and scalability, with each module having specific responsibilities. The system uses JSON file-based persistence for cart data and maintains user session state in memory.\n\n## Key Components\n\n### 1. Bot Management (`bot/`)\n- **handlers.py**: Main bot handlers for commands (/start, /help), callback queries, and message processing with session management\n- **keyboards.py**: All inline keyboard layouts including main menu, category selection, alphabetical search navigation, and product selection interfaces\n- **cart.py**: Shopping cart management with JSON file-based persistence in `cart_data/` directory, supporting add/remove/clear operations\n- **pricing.py**: Product pricing engine with fixed category prices, discount calculations (30% cash, 25% installment), 9% tax computation, and invoice generation\n- **config.py**: Configuration management using environment variables (BOT_TOKEN, ADMIN_IDS, LOG_LEVEL, CART_DATA_DIR, MAX_CART_ITEMS)\n\n### 2. Data Management (`data/`)\n- **product_data.py**: Complete product catalog with 6 main categories and fixed pricing:\n  - Baby bedding: 4,780,000 toman (19+ products)\n  - Teen bedding: 4,780,000 toman\n  - Adult bedding: 5,600,000 toman\n  - Curtains: 3,500,000 toman\n  - Cushions: 2,800,000 toman\n  - Tablecloth & runners: 2,200,000 toman\n- **customer_service.py**: Customer database with 30+ registered customers, each with unique 6-digit authentication codes, names, and cities\n\n### 3. Utilities (`utils/`)\n- **logger.py**: Centralized logging system with console output, configurable log levels, and timestamp formatting\n- **persian_utils.py**: Persian language utilities including bidirectional number conversion (Persian â†” English digits), price formatting with thousand separators, and text processing functions\n\n## Recent Changes (August 11, 2025)\n\n### Migration and Bug Fixes Completed\n- **Environment Migration**: Successfully completed migration from Replit Agent to standard Replit environment\n- **Dependencies Verified**: All required packages (python-telegram-bot==20.7, requests, schedule) properly installed\n- **Bot Functionality**: Bot server running successfully with all handlers and schedulers active\n- **Database Integration**: Customer database initialized with 110 customers\n- **Size Selection Error Fixed**: Added error handling and session management improvements for size selection process\n- **Payment Flow Enhancement**: Standardized both 60-day and 90-day payment flows to show invoice with amounts â†’ cash/check selection â†’ process accordingly\n- **Payment System Standardization**: Both 60-day and 90-day payments now follow consistent two-stage flow with proper callback data routing\n\n### Enhanced Two-Stage Payment System Completed\n- **Payment Method Selection**: First stage now shows 60/90 day payment options with discount calculations\n- **Payment Type Selection**: Second stage offers Cash vs Check payment types for each method\n- **Check Payment Workflow**: Complete check payment system with photo upload functionality\n- **Admin Verification System**: Support group receives check photos with admin action buttons\n- **Customer Communication Flow**: Automated messaging system for check processing status updates\n- **Persian Instructions**: Check payment includes specific Persian delivery instructions (10-day requirement)\n\n### Check Payment Features (August 11, 2025)\n- **Photo Upload System**: Customers can upload check photos directly in bot\n- **Admin Processing**: Support group gets check photos with verification buttons\n- **Status Tracking**: Customers can track check processing status via \"Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\" button\n- **Delivery Requirements**: Clear 10-day delivery instruction to factory accounting\n- **Complete Integration**: Check orders fully integrated with existing order management system\n\n### Enhanced Check Payment System (August 11, 2025)\n- **Specific Admin Recipients**: Replaced generic admin buttons with specific recipient buttons:\n  - Ø®Ø§Ù†Ù… ÙØ±Ø§Ù†Ú© ØºØ±ÛŒØ¨ÛŒ (National ID: 0012311138)\n  - Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ (National ID: 0451640594) \n  - Ù…Ø¬ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù† (National ID: 007335310)\n  - ÙˆØ­ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù† (National ID: 0077860357)\n- **Customer Confirmation System**: Added \"Ú†Ú© Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ Ø§Ù… ÙˆØªØ§ 10 Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ù… Ú©Ø±Ø¯\" button in customer chat only\n- **Clean Admin Interface**: Admin support group shows only recipient selection buttons, no customer actions\n- **Automatic Re-submission**: Customer confirmation resends invoice and check photo to support group\n- **Personalized Messages**: Each recipient selection sends specific message with name and national ID\n- **Complete Integration**: All features work seamlessly with existing payment system\n\n### Bug Fixes and Maintenance (August 11, 2025)\n- **Fixed Category Navigation**: Resolved issue where clicking product categories showed default message\n- **Fixed Photo Upload Error**: Resolved KeyError when payment_info is missing during check photo upload\n- **Added Missing Methods**: Added public `generate_order_id()` and `save_order()` methods to OrderManagementServer\n- **Enhanced Error Logging**: Improved callback error reporting for better debugging\n- **Removed Check Confirmation Message**: Removed \"âœ… Ø¹Ú©Ø³ Ú†Ú© Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯ Ùˆ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\" message for cleaner user experience\n- **Clean Interface Updates**: Removed customer confirmation button from admin support group keyboards\n- **Preserved Existing Functionality**: All original bot features remain intact and functional\n\n## Previous Changes (August 10, 2025)\n\n### Migration Completed\n- **Replit Environment Migration**: Successfully migrated from Replit Agent to standard Replit environment\n- **Dependencies Updated**: Installed python-telegram-bot==20.7 and requests packages via package manager\n- **Security Enhancement**: Configured BOT_TOKEN as environment variable for secure token management\n- **Bot Activation**: DecoTeen Telegram Bot is now running successfully with proper configuration\n\n### Hesabfa Integration Status\n- **Integration Attempted**: Attempted comprehensive integration with Hesabfa accounting system\n- **Network Limitation Confirmed**: Replit environment cannot access Hesabfa API endpoints due to network restrictions\n- **Alternative Implementation**: Complete order data logging system implemented for manual invoice creation workflow\n- **Order Management**: Enhanced order tracking and status management with detailed logging for admin workflow\n\n### UI Improvements Completed (August 10, 2025)\n- **Pagination System**: Added pagination buttons (\"Ø¯Ú©Ù…Ù‡ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\") for all product categories\n- **Button Layout**: Improved column alignment with 8 items per page (4 rows Ã— 2 buttons) for better navigation\n- **Categories Enhanced**: Baby, Curtain, Cushion, Tablecloth, and alphabetical search now support pagination\n- **Navigation Flow**: Updated handlers to support pagination navigation with proper state management\n\n### Enhanced Order Cancellation System (August 10, 2025)\n- **Remaining Balance Display**: When admin cancels an order, customer sees detailed invoice breakdown with remaining balance amount\n- **Payment Recovery Flow**: Added \"ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨\" button for cancelled orders to allow balance payment\n- **Receipt Processing**: Customers can upload receipt photos for remaining balance payments\n- **Admin Re-approval**: System sends receipt to support group with admin buttons for order re-confirmation\n- **Streamlined Interface**: Cancelled orders show only \"Contact Support\" and \"Pay Remaining Balance\" buttons\n- **Complete Workflow**: Full cycle from cancellation â†’ balance payment â†’ receipt upload â†’ admin approval â†’ order reactivation\n\n## Previous Changes (July 27, 2025)\n\n- **Direct Catalog Access**: After authentication, customers now see the product catalog immediately instead of welcome page\n- **Updated Product Data**: Baby products now include authentic names like \"ÙØ§Ø±Ø³Øª\" and \"Ø¨Ùˆ\" from original catalog\n- **Size Restrictions**: \n  - Baby category: Only 70Ã—160 size available\n  - Teen/Adult categories: Removed 75Ã—160 size option\n- **Enhanced Payment Options**: Added 90-day payment option (25% discount + 25% advance payment)\n- **Improved Invoice**: Includes discount calculations and detailed payment breakdown\n\n## Data Flow\n\n1. **User Authentication**: Customer enters unique 6-digit code â†’ system validates against customer database â†’ authenticated session created â†’ direct catalog display\n2. **Product Browsing**: Category selection â†’ subcategory (for curtains) â†’ alphabetical search using Persian keyboard â†’ product selection with category-specific size options\n3. **Cart Management**: Add products with size/quantity selection â†’ view cart with itemized breakdown â†’ modify quantities or remove items\n4. **Checkout Process**: Generate invoice with customer details â†’ calculate discounts and taxes â†’ display three payment options (cash 30%, installment 25%, 90-day 25% + 25% advance)\n\n## External Dependencies\n\n- **python-telegram-bot**: Core Telegram Bot API wrapper for handling updates, commands, and callbacks\n- **Python Standard Library**: json for cart persistence, os for file operations, logging for system monitoring, datetime for invoice timestamps\n- **No database dependencies**: Uses file-based JSON storage for cart data and in-memory dictionaries for product/customer data\n\n## Deployment Strategy\n\nThe application is configured for deployment on Replit with:\n\n- **Environment Variables**: BOT_TOKEN (required), ADMIN_IDS, LOG_LEVEL, CART_DATA_DIR, MAX_CART_ITEMS\n- **File Structure**: Modular package structure with clear separation between bot logic, data management, and utilities\n- **Persistence**: JSON files in `cart_data/` directory for shopping cart storage\n- **Error Handling**: Comprehensive logging and graceful error recovery throughout the application\n- **Session Management**: In-memory user session tracking for authentication state and navigation context\n\nThe bot is designed to be stateless regarding user authentication (relies on customer code validation) but maintains cart state through file persistence, making it suitable for cloud deployment environments.","size_bytes":11438},"run_monthly_reminders.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nMonthly Payment Reminder Runner\nØ§Ø¬Ø±Ø§ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø³Ø§Ø·ÛŒ\n\"\"\"\n\nimport asyncio\nimport sys\nimport os\nfrom datetime import datetime\n\n# Add project root to path\nsys.path.append(os.path.dirname(os.path.abspath(__file__)))\n\nfrom bot.payment_reminder import PaymentReminderBot\nfrom bot.config import Config\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nasync def run_monthly_reminders():\n    \"\"\"Ø§Ø¬Ø±Ø§ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡\"\"\"\n    try:\n        logger.info(\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø§Ù‡Ø§Ù†Ù‡...\")\n        \n        config = Config()\n        reminder_bot = PaymentReminderBot(config)\n        \n        # Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ú©Ù‡ Ø´Ø§Ù…Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ù‡Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯)\n        await reminder_bot.send_daily_reminders()\n        \n        logger.info(\"âœ… Ø¨Ø±Ø±Ø³ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\")\n        \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡: {e}\")\n        raise\n\nif __name__ == \"__main__\":\n    asyncio.run(run_monthly_reminders())\n","size_bytes":1287},"bot/__init__.py":{"content":"\"\"\"\nBot Package\nContains all bot-related functionality including handlers, keyboards, and cart management.\n\"\"\"\n","size_bytes":111},"bot/cart.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nShopping Cart Management\nHandles cart operations with JSON file-based persistence.\n\"\"\"\n\nimport json\nimport os\nfrom typing import List, Dict, Any, Optional\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass CartManager:\n    \"\"\"Manages shopping cart operations with file-based persistence\"\"\"\n    \n    def __init__(self, cart_data_dir: str = \"cart_data\"):\n        self.cart_data_dir = cart_data_dir\n        # Ensure cart data directory exists\n        os.makedirs(self.cart_data_dir, exist_ok=True)\n    \n    def _get_cart_file_path(self, user_id: int) -> str:\n        \"\"\"Get the file path for a user's cart\"\"\"\n        return os.path.join(self.cart_data_dir, f\"cart_{user_id}.json\")\n    \n    def get_cart(self, user_id: int) -> List[Dict[str, Any]]:\n        \"\"\"Get cart items for a user\"\"\"\n        cart_file = self._get_cart_file_path(user_id)\n        \n        try:\n            if os.path.exists(cart_file):\n                with open(cart_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            return []\n        except Exception as e:\n            logger.error(f\"Error loading cart for user {user_id}: {e}\")\n            return []\n    \n    def save_cart(self, user_id: int, cart_items: List[Dict[str, Any]]) -> bool:\n        \"\"\"Save cart items for a user\"\"\"\n        cart_file = self._get_cart_file_path(user_id)\n        \n        try:\n            with open(cart_file, 'w', encoding='utf-8') as f:\n                json.dump(cart_items, f, ensure_ascii=False, indent=2)\n            logger.info(f\"Cart saved for user {user_id}: {len(cart_items)} items\")\n            return True\n        except Exception as e:\n            logger.error(f\"Error saving cart for user {user_id}: {e}\")\n            return False\n    \n    def add_to_cart(self, user_id: int, item: Dict[str, Any]) -> bool:\n        \"\"\"Add an item to user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        # Check if item already exists in cart\n        existing_item = None\n        for cart_item in cart_items:\n            if (cart_item['product_id'] == item['product_id'] and \n                cart_item['size'] == item['size']):\n                existing_item = cart_item\n                break\n        \n        if existing_item:\n            # Update quantity\n            existing_item['quantity'] += item['quantity']\n            logger.info(f\"Updated quantity for product {item['product_id']} in cart of user {user_id}\")\n        else:\n            # Add new item\n            cart_items.append(item)\n            logger.info(f\"Added new product {item['product_id']} to cart of user {user_id}\")\n        \n        return self.save_cart(user_id, cart_items)\n    \n    def remove_from_cart(self, user_id: int, product_id: str, size: str) -> bool:\n        \"\"\"Remove an item from user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        # Find and remove the item\n        cart_items = [\n            item for item in cart_items \n            if not (item['product_id'] == product_id and item['size'] == size)\n        ]\n        \n        logger.info(f\"Removed product {product_id} (size {size}) from cart of user {user_id}\")\n        return self.save_cart(user_id, cart_items)\n    \n    def update_quantity(self, user_id: int, product_id: str, size: str, new_quantity: int) -> bool:\n        \"\"\"Update quantity of an item in user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        for item in cart_items:\n            if item['product_id'] == product_id and item['size'] == size:\n                if new_quantity <= 0:\n                    # Remove item if quantity is 0 or negative\n                    return self.remove_from_cart(user_id, product_id, size)\n                else:\n                    item['quantity'] = new_quantity\n                    logger.info(f\"Updated quantity of product {product_id} to {new_quantity} for user {user_id}\")\n                    return self.save_cart(user_id, cart_items)\n        \n        logger.warning(f\"Product {product_id} (size {size}) not found in cart of user {user_id}\")\n        return False\n    \n    def clear_cart(self, user_id: int) -> bool:\n        \"\"\"Clear all items from user's cart\"\"\"\n        return self.save_cart(user_id, [])\n    \n    def get_cart_total(self, user_id: int) -> float:\n        \"\"\"Calculate total price of items in user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        total = sum(item['price'] * item['quantity'] for item in cart_items)\n        return total\n    \n    def get_cart_item_count(self, user_id: int) -> int:\n        \"\"\"Get total number of items in user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        return sum(item['quantity'] for item in cart_items)\n    \n    def is_cart_empty(self, user_id: int) -> bool:\n        \"\"\"Check if user's cart is empty\"\"\"\n        cart_items = self.get_cart(user_id)\n        return len(cart_items) == 0\n    \n    def get_cart_summary(self, user_id: int) -> Dict[str, Any]:\n        \"\"\"Get a summary of user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        return {\n            'items': cart_items,\n            'item_count': sum(item['quantity'] for item in cart_items),\n            'total_price': sum(item['price'] * item['quantity'] for item in cart_items),\n            'unique_products': len(cart_items)\n        }\n","size_bytes":5344},"bot/config.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBot Configuration - Fixed Version\nManages environment variables and configuration settings.\n\"\"\"\n\nimport os\nimport logging\nfrom typing import List, Optional\n\n\nclass Config:\n    \"\"\"Configuration class for the Telegram bot\"\"\"\n\n    def __init__(self):\n        \"\"\"Initialize configuration from environment variables\"\"\"\n        # Get bot token from environment or use provided token\n        self.bot_token: str = os.getenv(\"BOT_TOKEN\", \"482872229:AAEG0hySlWspi-KOF5lbR2fMZGJ1qWUPLn0\")\n\n        if not self.bot_token:\n            raise ValueError(\"BOT_TOKEN not found in environment variables\")\n\n        # ZarinPal configuration - using your provided merchant ID\n        self.zarinpal_merchant_id: str = os.getenv(\n            \"ZARINPAL_MERCHANT_ID\", \"fd4166f9-78e2-4228-ac7d-077a5168f064\")\n        self.zarinpal_sandbox: bool = os.getenv(\"ZARINPAL_SANDBOX\",\n                                                \"True\").lower() == \"true\"\n\n        # Order group settings\n        self.order_group_chat_id = os.getenv('ORDER_GROUP_CHAT_ID')\n\n        # Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Chat ID Ú¯Ø±ÙˆÙ‡ DecoTeen Bot Orders Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†\n        if not self.order_group_chat_id:\n            # Chat ID Ø§Ø² Ø¹Ú©Ø³: -4804296164 (Ú¯Ø±ÙˆÙ‡ DecoTeen Bot Orders)\n            self.order_group_chat_id = -4804296164\n            logging.info(\n                f\"âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: {self.order_group_chat_id}\")\n        else:\n            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ int\n            try:\n                self.order_group_chat_id = int(self.order_group_chat_id)\n                logging.info(\n                    f\"âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡: {self.order_group_chat_id}\")\n            except ValueError:\n                logging.error(\n                    f\"âŒ ORDER_GROUP_CHAT_ID Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {self.order_group_chat_id}\"\n                )\n                # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶\n                self.order_group_chat_id = -4804296164\n                logging.info(\n                    f\"âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ù‡ Ø¬Ø§ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {self.order_group_chat_id}\"\n                )\n\n        # Optional configurations with safe defaults\n        self.admin_ids: List[int] = self._parse_admin_ids()\n        self.log_level: str = os.getenv(\"LOG_LEVEL\", \"INFO\")\n        self.cart_data_dir: str = os.getenv(\"CART_DATA_DIR\", \"cart_data\")\n        self.max_cart_items: int = int(os.getenv(\"MAX_CART_ITEMS\", \"50\"))\n\n        # Bot domain for payment callbacks\n        self.bot_domain: str = os.getenv(\"BOT_DOMAIN\", \"example.com\")\n\n    def _parse_admin_ids(self) -> List[int]:\n        \"\"\"Parse admin IDs from environment variable\"\"\"\n        admin_ids_str = os.getenv(\"ADMIN_IDS\", \"\")\n        if not admin_ids_str:\n            return []\n\n        try:\n            return [\n                int(id_str.strip()) for id_str in admin_ids_str.split(\",\")\n                if id_str.strip()\n            ]\n        except ValueError:\n            logging.warning(\"Invalid ADMIN_IDS format. Using empty list.\")\n            return []\n\n    def get_callback_url(self) -> str:\n        \"\"\"Get payment callback URL\"\"\"\n        return f\"https://{self.bot_domain}/payment/callback\"\n\n    def validate_setup(self) -> List[str]:\n        \"\"\"Validate configuration and return list of issues\"\"\"\n        issues = []\n\n        if not self.bot_token or self.bot_token == \"YOUR_BOT_TOKEN_HERE\":\n            issues.append(\"BOT_TOKEN is not set or using placeholder value\")\n\n        if not self.zarinpal_merchant_id or self.zarinpal_merchant_id == \"YOUR_MERCHANT_ID\":\n            issues.append(\n                \"ZARINPAL_MERCHANT_ID is not set or using placeholder value\")\n\n        if self.bot_domain == \"example.com\":\n            issues.append(\n                \"BOT_DOMAIN should be set to your actual domain (required for payment callbacks)\"\n            )\n\n        if not self.admin_ids:\n            issues.append(\"Consider setting ADMIN_IDS for bot administration\")\n\n        return issues\n\n    def print_config_status(self):\n        \"\"\"Print configuration status for debugging\"\"\"\n        print(\"=== Bot Configuration Status ===\")\n        print(f\"Bot Token: âœ… Set and Ready\")\n        print(\n            f\"ZarinPal Merchant ID: âœ“ Set ({self.zarinpal_merchant_id[:8]}...{self.zarinpal_merchant_id[-8:]})\"\n        )\n        print(f\"Bot Domain: âœ“ Set ({self.bot_domain})\")\n        print(f\"Callback URL: {self.get_callback_url()}\")\n        print(f\"Admin IDs: {len(self.admin_ids)} configured\")\n        print(f\"Order Group ID: âœ“ Set ({self.order_group_chat_id})\")\n        print(\n            f\"ZarinPal Sandbox: {'Enabled' if self.zarinpal_sandbox else 'Disabled'}\"\n        )\n        print(f\"Max Cart Items: {self.max_cart_items}\")\n        print(\"================================\")\n\n        issues = self.validate_setup()\n        if issues:\n            print(\"âš ï¸ Configuration Notes:\")\n            for issue in issues:\n                print(f\"  - {issue}\")\n        else:\n            print(\"âœ… Configuration is complete!\")\n\n    async def test_group_connection(self, bot):\n        \"\"\"Test connection to order group\"\"\"\n        if not self.order_group_chat_id:\n            print(\"âŒ Order group ID not configured\")\n            return False\n\n        try:\n            # Try to get chat info\n            chat = await bot.get_chat(self.order_group_chat_id)\n            print(f\"âœ… Group connection successful!\")\n            print(f\"   Title: {chat.title}\")\n            print(f\"   Type: {chat.type}\")\n            print(\n                f\"   Member count: {await bot.get_chat_member_count(self.order_group_chat_id)}\"\n            )\n            return True\n        except Exception as e:\n            print(f\"âŒ Group connection failed: {e}\")\n            print(f\"   Group ID: {self.order_group_chat_id}\")\n            print(\"   Possible issues:\")\n            print(\"   - Bot is not a member of the group\")\n            print(\"   - Group ID is incorrect\")\n            print(\"   - Bot doesn't have permission to send messages\")\n            return False\n\n\n# Example usage and testing\nif __name__ == \"__main__\":\n    config = Config()\n    config.print_config_status()\n\n    print(\"\\nâœ… Setup Complete! Your bot is ready to run!\")\n","size_bytes":6271},"bot/handlers.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBot Handlers\nMain bot handlers for commands, callbacks, and message processing.\n\"\"\"\n\nfrom telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup\nfrom telegram.ext import ContextTypes, CommandHandler, CallbackQueryHandler, MessageHandler, filters\nfrom bot.keyboards import BotKeyboards\nfrom bot.cart import CartManager\nfrom bot.pricing import PricingManager\nfrom bot.zarinpal import ZarinPalGateway\nfrom bot.payment_scheduler import PaymentScheduler\nfrom bot.order_server import OrderManagementServer, OrderStatus\nfrom bot.config import Config\nfrom data.customer_service import CustomerService\nfrom data.product_data import (get_products_by_category, get_product_by_id,\n                               search_products_by_name,\n                               search_products_by_icon, get_category_info,\n                               get_product_price, PERSIAN_ALPHABET,\n                               PRODUCT_PRICES)\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\nfrom datetime import datetime\nfrom typing import Dict, List\nimport json\n\nlogger = setup_logger(__name__)\n\n\nclass BotHandlers:\n    \"\"\"Main class handling all bot interactions\"\"\"\n\n    def __init__(self):\n        self.keyboards = BotKeyboards()\n        self.cart_manager = CartManager()\n        self.pricing_manager = PricingManager()\n        self.customer_service = CustomerService()\n        self.config = Config()\n        self.zarinpal = ZarinPalGateway(\n            merchant_id=self.config.zarinpal_merchant_id,\n            sandbox=self.config.zarinpal_sandbox)\n        self.payment_scheduler = PaymentScheduler()\n        self.order_server = OrderManagementServer()\n        self.user_sessions = {}  # Store user session data\n        self.bot = None  # Bot instance Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ\n        logger.info(\n            \"ğŸ”„ PricingManager initialized with updated payment display configurations\"\n        )\n\n    def setup_handlers(self, application):\n        \"\"\"Setup all bot handlers\"\"\"\n        # ØªÙ†Ø¸ÛŒÙ… bot instance Ø¯Ø± Ø³Ø±ÙˆØ± Ø³ÙØ§Ø±Ø´Ø§Øª Ùˆ handlers\n        self.order_server.set_bot(application.bot)\n        self.bot = application.bot  # ØªÙ†Ø¸ÛŒÙ… bot instance Ø¯Ø± handlers\n\n        # Command handlers\n        application.add_handler(CommandHandler(\"start\", self.start_command))\n        application.add_handler(CommandHandler(\"help\", self.help_command))\n        application.add_handler(CommandHandler(\"debug\", self.debug_command))\n        application.add_handler(\n            CommandHandler(\"pricing\", self.pricing_test_command))\n\n        # Callback query handlers\n        application.add_handler(CallbackQueryHandler(self.button_callback))\n\n        # Message handlers\n        application.add_handler(\n            MessageHandler(filters.TEXT & ~filters.COMMAND,\n                           self.handle_text_message))\n\n        # Photo handler for receipt uploads\n        application.add_handler(\n            MessageHandler(filters.PHOTO, self.handle_photo_message))\n\n        # Group message handler for support\n        application.add_handler(\n            MessageHandler(filters.TEXT & filters.ChatType.GROUPS,\n                           self.handle_group_message))\n\n        logger.info(\"âœ… All handlers registered successfully\")\n\n    async def start_command(self, update: Update,\n                            context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /start command\"\"\"\n        user_id = update.effective_user.id\n        logger.info(f\"User {user_id} started the bot\")\n\n        # Set user state to awaiting customer code directly\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['awaiting_customer_code'] = True\n\n        welcome_text = (\"ğŸ” Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ú©ÙˆØªÛŒÙ†\\n\\n\"\n                        \"Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø´Ø´ Ø±Ù‚Ù…ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n\n        await update.message.reply_text(welcome_text)\n\n    async def help_command(self, update: Update,\n                           context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /help command\"\"\"\n        help_text = (\"ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª:\\n\\n\"\n                     \"ğŸ”¹ /start - Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø±Ø¨Ø§Øª\\n\"\n                     \"ğŸ”¹ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ\\n\"\n                     \"ğŸ”¹ Ù…Ø±ÙˆØ± Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ\\n\"\n                     \"ğŸ”¹ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\"\n                     \"ğŸ”¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ² Ùˆ ØªØ¹Ø¯Ø§Ø¯\\n\"\n                     \"ğŸ”¹ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯\\n\"\n                     \"ğŸ”¹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ± Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª\\n\\n\"\n                     \"ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯Ú©Ù…Ù‡ Â«Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.\")\n        await update.message.reply_text(help_text)\n\n    async def debug_command(self, update: Update,\n                            context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /debug command - for troubleshooting\"\"\"\n        chat_id = update.effective_chat.id\n        chat_type = update.effective_chat.type\n        user_id = update.effective_user.id\n\n        debug_info = (\n            f\"ğŸ” Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯:\\n\\n\"\n            f\"ğŸ’¬ Chat ID: {chat_id}\\n\"\n            f\"ğŸ“ Chat Type: {chat_type}\\n\"\n            f\"ğŸ‘¤ User ID: {user_id}\\n\"\n            f\"âš™ï¸ Configured Group ID: {self.config.order_group_chat_id}\\n\"\n            f\"âœ… Match: {'YES' if str(chat_id) == str(self.config.order_group_chat_id) else 'NO'}\\n\\n\"\n            f\"ğŸ“‹ Test Commands:\\n\"\n            f\"â€¢ Ø³ÙØ§Ø±Ø´\\n\"\n            f\"â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§\\n\"\n            f\"â€¢ Ø¢Ù…Ø§Ø±\")\n\n        await update.message.reply_text(debug_info)\n\n        # Ø°Ø®ÛŒØ±Ù‡ Chat ID Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢ÛŒÙ†Ø¯Ù‡\n        logger.info(\n            f\"ğŸ”§ DEBUG: Chat ID {chat_id} can be used as ORDER_GROUP_CHAT_ID\")\n\n    async def pricing_test_command(self, update: Update,\n                                   context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /pricing command - test pricing functionality\"\"\"\n        test_items = [{\n            'product_name': 'ØªØ´Ú© Ø¨Ú†Ù‡ ØªØ³Øª',\n            'size': '120x60',\n            'quantity': 1,\n            'price': 4780000\n        }]\n        test_customer = {\n            'name': 'ØªØ³Øª Ú©Ø§Ø±Ø¨Ø±',\n            'city': 'ØªÙ‡Ø±Ø§Ù†',\n            'customer_id': '123456'\n        }\n\n        # Test different pricing methods\n        cash_invoice = self.pricing_manager.generate_final_invoice(\n            test_items, test_customer, \"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\", 0.30)\n\n        pricing_info = (\n            f\"ğŸ’° ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ:\\n\\n\"\n            f\"ğŸ”§ Ù†Ø±Ø® ØªØ®ÙÛŒÙ Ù†Ù‚Ø¯ÛŒ: {self.pricing_manager.discount_rates.get('cash', 0) * 100}%\\n\"\n            f\"ğŸ”§ Ù†Ø±Ø® ØªØ®ÙÛŒÙ Ø§Ù‚Ø³Ø§Ø·ÛŒ: {self.pricing_manager.discount_rates.get('installment', 0) * 100}%\\n\"\n            f\"ğŸ”§ Ù†Ø±Ø® ØªØ®ÙÛŒÙ 90 Ø±ÙˆØ²Ù‡: {self.pricing_manager.discount_rates.get('90day', 0) * 100}%\\n\\n\"\n            f\"ğŸ“„ Ù†Ù…ÙˆÙ†Ù‡ ÙØ§Ú©ØªÙˆØ±:\\n\"\n            f\"{cash_invoice[:200]}...\")\n\n        await update.message.reply_text(pricing_info)\n        logger.info(\n            f\"ğŸ’° Pricing test executed for user {update.effective_user.id}\")\n\n    async def button_callback(self, update: Update,\n                              context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle all button callbacks - Optimized version\"\"\"\n        query = update.callback_query\n        user_id = query.from_user.id\n        data = query.data\n\n        # Fast answer to prevent timeout\n        await query.answer()\n\n        logger.debug(f\"User {user_id} pressed: {data}\")\n\n        # Quick routing dictionary for better performance\n        handlers = {\n            \"authenticate\": self._handle_authentication_request,\n            \"main_menu\": self._handle_main_menu,\n            \"start_shopping\": self._handle_start_shopping,\n            \"view_cart\": self._handle_view_cart,\n            \"view_invoice\": self._handle_view_invoice,\n            \"upload_receipt\": self._handle_upload_receipt_request,\n            \"confirm_payment_receipt\":\n            self._handle_payment_receipt_confirmation,\n            \"confirm_payment_terms\": self._handle_payment_terms_confirmation,\n            \"confirm_order\": self._handle_order_confirmation,\n            \"cart_clear\": self._handle_cart_clear,\n            \"verify_payment\": self._handle_payment_verification,\n            \"payment_completed\": self._handle_payment_completed,\n            \"back_to_categories\": self._handle_back_to_categories,\n            \"back_to_alphabet\": self._handle_back_to_alphabet,\n            \"back_to_curtain_subcategories\":\n            self._handle_back_to_curtain_subcategories,\n            \"back_to_products\": self._handle_back_to_products,\n            \"daily_stats\": self._handle_daily_stats_request,\n            \"refresh_daily_orders\": self._handle_refresh_daily_orders,\n            \"back_to_daily_orders\": self._handle_back_to_daily_orders,\n            \"contact_support\": self._handle_contact_support_request,\n            \"faq\": self._handle_faq_request,\n            \"confirm_60day_order\": self._handle_60day_order_confirmation,\n            \"upload_check_photo\": self._handle_upload_check_photo_request,\n            \"check_follow_up\": self._handle_check_follow_up,\n            \"confirm_check_submission\": self._handle_confirm_check_submission,\n        }\n\n        try:\n            # Direct handler for exact matches\n            if data in handlers:\n                await handlers[data](query)\n                return\n\n            # Prefix-based routing for better performance\n            if data.startswith(\"category_\"):\n                await self._handle_category_selection(query, data)\n            elif data.startswith(\"subcategory_\"):\n                await self._handle_subcategory_selection(query, data)\n            elif data.startswith(\"alpha_\"):\n                await self._handle_alphabet_selection(query, data)\n            elif data.startswith(\"product_\"):\n                await self._handle_product_selection(query, data)\n            elif data.startswith(\"size_selection_\"):\n                await self._handle_size_selection_from_category(query, data)\n            elif data.startswith(\"size_\"):\n                await self._handle_size_selection(query, data)\n            # Pagination handlers\n            elif data.startswith(\"baby_page_\"):\n                await self._handle_baby_page(query, data)\n            elif data.startswith(\"curtain_page_\"):\n                await self._handle_curtain_page(query, data)\n            elif data.startswith(\"cushion_page_\"):\n                await self._handle_cushion_page(query, data)\n            elif data.startswith(\"tablecloth_page_\"):\n                await self._handle_tablecloth_page(query, data)\n            elif data.startswith(\"alpha_page_\"):\n                await self._handle_alpha_page(query, data)\n            elif data.startswith(\"qty_\"):\n                await self._handle_quantity_selection(query, data)\n            elif data.startswith(\"payment_type_\"):\n                await self._handle_payment_type_selection(query, data)\n            elif data.startswith(\"payment_\"):\n                await self._handle_payment_selection(query, data)\n            elif data.startswith(\"order_status_\"):\n                await self._handle_order_status_update(query, data)\n            elif data.startswith(\"order_details_\"):\n                await self._handle_order_details_request(query, data)\n            elif data.startswith(\"order_\"):\n                await self._handle_order_actions(query, data)\n            elif data.startswith(\"alphabet_search_\"):\n                await self._handle_alphabet_search(query, data)\n\n            elif data.startswith(\"sewing_\"):\n                await self._handle_sewing_type_selection(query, data)\n            elif data.startswith(\"fabric_\"):\n                await self._handle_fabric_selection(query, data)\n            elif data == \"back_to_fabric_selection\":\n                await self._handle_back_to_fabric_selection(query)\n            elif data == \"back_to_sewing_type\":\n                await self._handle_back_to_sewing_type(query)\n            elif data.startswith(\"payment_confirmed_\"):\n                await self._handle_payment_confirmation_from_group(query, data)\n            elif data.startswith(\"contact_made_\"):\n                await self._handle_contact_made_from_group(query, data)\n            elif data.startswith(\"remind_tomorrow_\"):\n                await self._handle_remind_tomorrow_from_group(query, data)\n            elif data.startswith(\"pay_remaining_\"):\n                await self._handle_pay_remaining_balance(query, data)\n            elif data.startswith(\"confirm_remaining_payment_\"):\n                await self._handle_confirm_remaining_payment(query, data)\n            elif data == \"confirm_remaining_payment_receipt\":\n                await self._handle_confirm_remaining_payment(query, \"confirm_remaining_payment_receipt\")\n            elif data == \"upload_remaining_receipt\":\n                await self._handle_upload_remaining_receipt(query)\n            elif data.startswith(\"check_info_sent_\"):\n                await self._handle_check_info_sent(query, data)\n            elif data.startswith(\"check_contacted_\"):\n                await self._handle_check_contacted(query, data)\n            elif data.startswith(\"check_recipient_\"):\n                await self._handle_check_recipient_selection(query, data)\n            elif data.startswith(\"check_customer_confirm_\"):\n                await self._handle_check_customer_confirmation(query, data)\n            else:\n                logger.warning(f\"Unhandled callback data: {data}\")\n                await query.edit_message_text(\" Ø³ÙØ§Ø±Ø´ Ø¯Ø±Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø³Øª .\")\n\n        except Exception as e:\n            logger.error(f\"Callback error for {data}: {e}\")\n            logger.error(f\"Exception type: {type(e)}\")\n            logger.error(f\"Exception traceback:\", exc_info=True)\n            try:\n                await query.edit_message_text(\n                    \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n            except:\n                pass  # Prevent secondary errors\n\n    async def handle_text_message(self, update: Update,\n                                  context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle text messages\"\"\"\n        user_id = update.effective_user.id\n        text = update.message.text.strip()\n\n        # Check if user is in authentication process\n        if user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'awaiting_customer_code'):\n            await self._handle_customer_code_input(update, text)\n        # Check if user is inputting curtain height\n        elif user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'awaiting_curtain_height'):\n            await self._handle_curtain_height_input(update, text)\n        else:\n            await update.message.reply_text(\n                \"Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(\n                    self._is_authenticated(user_id)))\n\n    async def handle_photo_message(self, update: Update,\n                                   context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle photo messages (for receipt uploads)\"\"\"\n        user_id = update.effective_user.id\n\n        # Check if user is waiting for receipt upload (for orders)\n        if (user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'payment_info', {}).get('awaiting_receipt')):\n            await self._handle_order_receipt_upload(update, user_id)\n        # Check if user is waiting for remaining balance receipt upload\n        elif (user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'remaining_payment', {}).get('awaiting_receipt')):\n            await self._handle_remaining_receipt_upload(update, user_id)\n        # Check if user is waiting for check photo upload\n        elif (user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'awaiting_check_photo')):\n            await self._handle_check_photo_upload(update, user_id)\n\n            # Store photo info\n            photo = update.message.photo[-1]  # Get highest resolution photo\n            self.user_sessions[user_id]['receipt_photo'] = {\n                'file_id': photo.file_id,\n                'file_unique_id': photo.file_unique_id\n            }\n\n            # Get payment info for final invoice display - handle missing payment_info\n            payment_info = self.user_sessions[user_id].get('payment_info')\n            if not payment_info:\n                # If payment_info is missing, skip to main menu without any confirmation message\n                await update.message.reply_text(\n                    \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.\",\n                    reply_markup=self.keyboards.get_main_menu(self._is_authenticated(user_id)))\n                return\n            customer = self.user_sessions[user_id]['customer']\n            cart_items = self.cart_manager.get_cart(user_id)\n\n            # Generate final invoice text\n            final_invoice = (\n                f\"âœ… ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(payment_info['subtotal'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(payment_info['discount_rate'] * 100)))}Ùª): {format_price(payment_info['discount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“¸ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯\\n\"\n                f\"âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø³ÙØ§Ø±Ø´\")\n\n            # Show confirmation button with final invoice\n            keyboard = [[\n                InlineKeyboardButton(\"âœ… Ø³ÙØ§Ø±Ø´ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù…\",\n                                     callback_data=\"confirm_payment_receipt\")\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯\",\n                                callback_data=\"upload_receipt\")\n                        ]]\n\n            await update.message.reply_text(\n                final_invoice, reply_markup=InlineKeyboardMarkup(keyboard))\n        else:\n            await update.message.reply_text(\n                \"Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(\n                    self._is_authenticated(user_id)))\n\n    async def _handle_order_receipt_upload(self, update, user_id):\n        \"\"\"Handle receipt upload for regular orders\"\"\"\n        # Store photo info\n        photo = update.message.photo[-1]  # Get highest resolution photo\n        self.user_sessions[user_id]['receipt_photo'] = {\n            'file_id': photo.file_id,\n            'file_unique_id': photo.file_unique_id\n        }\n\n        # Get payment info for final invoice display\n        payment_info = self.user_sessions[user_id]['payment_info']\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Generate final invoice text\n        final_invoice = (\n            f\"âœ… ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(payment_info['subtotal'])} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(payment_info['discount_rate'] * 100)))}Ùª): {format_price(payment_info['discount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ“¸ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯\\n\"\n            f\"âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø³ÙØ§Ø±Ø´\")\n\n        # Show confirmation button with final invoice\n        keyboard = [[\n            InlineKeyboardButton(\"âœ… Ø³ÙØ§Ø±Ø´ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù…\",\n                                 callback_data=\"confirm_payment_receipt\")\n        ],\n                    [\n                        InlineKeyboardButton(\n                            \"ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯\",\n                            callback_data=\"upload_receipt\")\n                    ]]\n\n        await update.message.reply_text(\n            final_invoice, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_remaining_receipt_upload(self, update, user_id):\n        \"\"\"Handle receipt upload for remaining balance payment\"\"\"\n        # Store photo info\n        photo = update.message.photo[-1]  # Get highest resolution photo\n        self.user_sessions[user_id]['receipt_photo'] = {\n            'file_id': photo.file_id,\n            'file_unique_id': photo.file_unique_id\n        }\n\n        # Get remaining payment info\n        remaining_payment = self.user_sessions[user_id]['remaining_payment']\n        order_id = remaining_payment['order_id']\n        amount = remaining_payment['amount']\n\n        # Show confirmation message\n        confirmation_text = (\n            f\"âœ… ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ“¸ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\\n\"\n            f\"âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ\"\n        )\n\n        keyboard = [[\n            InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\",\n                                 callback_data=\"confirm_remaining_payment_receipt\")\n        ], [\n            InlineKeyboardButton(\"ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯\",\n                                 callback_data=\"upload_remaining_receipt\")\n        ]]\n\n        await update.message.reply_text(\n            confirmation_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def handle_group_message(self, update: Update,\n                                   context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle messages in group chats (support group)\"\"\"\n        chat_id = update.effective_chat.id\n        message_text = update.message.text.strip(\n        ) if update.message.text else \"\"\n        user_name = update.effective_user.first_name or \"Ú©Ø§Ø±Ø¨Ø±\"\n\n        # Log group info for debugging\n        logger.info(f\"ğŸ“© Group message received:\")\n        logger.info(f\"   Chat ID: {chat_id} (type: {type(chat_id)})\")\n        logger.info(\n            f\"   Chat Title: {getattr(update.effective_chat, 'title', 'N/A')}\")\n        logger.info(f\"   Message: '{message_text}'\")\n        logger.info(f\"   User: {user_name}\")\n        logger.info(\n            f\"   Configured group ID: {self.config.order_group_chat_id} (type: {type(self.config.order_group_chat_id)})\"\n        )\n\n        # ØªØ¨Ø¯ÛŒÙ„ chat_id Ø¨Ù‡ int Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡\n        try:\n            current_group_id = int(chat_id)\n            config_group_id = int(\n                self.config.order_group_chat_id\n            ) if self.config.order_group_chat_id else None\n        except (ValueError, TypeError) as e:\n            logger.error(f\"Error converting chat IDs to int: {e}\")\n            return\n\n        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ØŒ Ú¯Ø±ÙˆÙ‡ Ù…Ù†Ø§Ø³Ø¨ Ù‡Ø³Øª ÛŒØ§ Ù†Ù‡\n        if config_group_id and current_group_id != config_group_id:\n            logger.info(\n                f\"âŒ Ù¾ÛŒØ§Ù… Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù…Ø®ØªÙ„Ù: {current_group_id} != {config_group_id}\"\n            )\n            return\n\n        # Ø§Ú¯Ø± Ù‡ÛŒÚ† group ID ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú¯Ø±ÙˆÙ‡ Ø§ØµÙ„ÛŒ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±\n        if not config_group_id:\n            logger.warning(\n                f\"âš ï¸ GROUP_CHAT_ID ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ ÙØ¹Ù„ÛŒ: {current_group_id}\"\n            )\n            self.config.order_group_chat_id = current_group_id\n\n        logger.info(f\"âœ… Processing group message: '{message_text}'\")\n\n        # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±\n        if not message_text:\n            return\n\n        # ÙÙ‚Ø· Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø´Ø®Øµ - Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø¯ÛŒ\n        message_lower = message_text.lower().strip()\n\n        # Ù„ÛŒØ³Øª Ø¯Ù‚ÛŒÙ‚ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¬Ø§Ø²\n        valid_commands = [\n            'Ø³ÙØ§Ø±Ø´', 'Ø³ÙØ§Ø±Ø´Ø§Øª', 'order', 'orders', 'ÙØ§Ú©ØªÙˆØ±', 'ÙØ§Ú©ØªÙˆØ±Ù‡Ø§',\n            'invoice', 'invoices', 'Ø¢Ù…Ø§Ø±', 'stat', 'statistics', 'Ø±Ø§Ù‡Ù†Ù…Ø§',\n            'help', 'Ú©Ù…Ú©', 'Ø¯Ø³ØªÙˆØ±', 'Ø±Ø¨Ø§Øª', 'bot', '@decoteen_bot'\n        ]\n\n        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ù¾ÛŒØ§Ù… Ø´Ø§Ù…Ù„ Ø¯Ø³ØªÙˆØ± Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±\n        is_valid_command = False\n        for cmd in valid_commands:\n            if cmd in message_lower:\n                is_valid_command = True\n                break\n\n        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÙˆØ± ÙˆØ¶Ø¹ÛŒØª\n        if message_text.startswith('ÙˆØ¶Ø¹ÛŒØª ') or message_text.startswith(\n                'status '):\n            is_valid_command = True\n\n        # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¯Ø³ØªÙˆØ± Ù…Ø¹ØªØ¨Ø±ÛŒ Ù†ÛŒØ³ØªØŒ Ø¢Ù† Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±\n        if not is_valid_command:\n            logger.debug(f\"ğŸ” Ù¾ÛŒØ§Ù… Ø¹Ø§Ø¯ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯: '{message_text}'\")\n            return\n\n        try:\n            # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¹ØªØ¨Ø±\n            if any(word in message_lower\n                   for word in ['Ø³ÙØ§Ø±Ø´', 'Ø³ÙØ§Ø±Ø´Ø§Øª', 'order', 'orders']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± Ø³ÙØ§Ø±Ø´ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_daily_orders(update)\n                return\n            elif any(\n                    word in message_lower\n                    for word in ['ÙØ§Ú©ØªÙˆØ±', 'ÙØ§Ú©ØªÙˆØ±Ù‡Ø§', 'invoice', 'invoices']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± ÙØ§Ú©ØªÙˆØ± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_daily_invoices(update)\n                return\n            elif message_text.startswith('ÙˆØ¶Ø¹ÛŒØª ') or message_text.startswith(\n                    'status '):\n                order_id = message_text.replace('ÙˆØ¶Ø¹ÛŒØª ',\n                                                '').replace('status ',\n                                                            '').strip()\n                logger.info(f\"ğŸ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´: {order_id}\")\n                await self._show_order_status(update, order_id)\n                return\n            elif any(word in message_lower\n                     for word in ['Ø¢Ù…Ø§Ø±', 'stat', 'statistics']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± Ø¢Ù…Ø§Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_orders_statistics(update)\n                return\n            elif any(word in message_lower\n                     for word in ['Ø±Ø§Ù‡Ù†Ù…Ø§', 'help', 'Ú©Ù…Ú©', 'Ø¯Ø³ØªÙˆØ±']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± Ø±Ø§Ù‡Ù†Ù…Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_group_help(update)\n                return\n            elif message_lower in ['Ø±Ø¨Ø§Øª', 'bot', '@decoteen_bot']:\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± ØªØ³Øª Ø±Ø¨Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await update.message.reply_text(\n                    \"ğŸ¤– Ø±Ø¨Ø§Øª DecoTeen Ø¢Ù…Ø§Ø¯Ù‡ Ø®Ø¯Ù…Ø§Øªâ€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª!\\n\\n\"\n                    \"ğŸ“‹ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:\\n\"\n                    \"â€¢ Ø³ÙØ§Ø±Ø´ - Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\\n\"\n                    \"â€¢ ÙØ§Ú©ØªÙˆØ± - Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²\\n\"\n                    \"â€¢ Ø¢Ù…Ø§Ø± - Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\\n\"\n                    \"â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§ - Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„\\n\\n\"\n                    f\"ğŸ”§ Chat ID Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡: {current_group_id}\")\n                return\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡: {e}\")\n            logger.error(\n                f\"Message: '{message_text}', Chat ID: {current_group_id}\")\n\n            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\n            try:\n                await update.message.reply_text(\n                    f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±: {str(e)[:100]}\\n\"\n                    \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\")\n            except Exception as reply_error:\n                logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§: {reply_error}\")\n\n        return\n\n    async def _show_daily_orders(self, update: Update):\n        \"\"\"Show today's orders as clickable summary with icons\"\"\"\n        try:\n            logger.info(\"ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\")\n\n            # Get today's orders\n            today_orders = await self.order_server.get_todays_orders()\n            logger.info(f\"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {len(today_orders)}\")\n\n            if not today_orders:\n                await update.message.reply_text(\n                    f\"ğŸ“Š Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\\n\"\n                    \"Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ğŸ“‹\\n\\n\"\n                    \"ğŸ’¡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.\")\n                return\n\n            # Create summary message with clickable icons\n            summary_text = (\n                f\"ğŸ“Š Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„: {persian_numbers(str(len(today_orders)))}\\n\\n\"\n                f\"ğŸ”½ Ø±ÙˆÛŒ Ù‡Ø± Ø¢ÛŒÚ©ÙˆÙ† Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ÙØ§Ú©ØªÙˆØ± Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯:\\n\\n\")\n\n            # Create inline keyboard with clickable order icons\n            keyboard = []\n            for i, order in enumerate(today_orders, 1):\n                customer = order.get('customer', {})\n                status_icon = \"ğŸ†•\" if order.get('status') == 'pending' else \"âœ…\"\n\n                button_text = f\"{status_icon} {persian_numbers(str(i))} - {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')[:10]}\"\n                callback_data = f\"order_details_{order['order_id']}\"\n\n                keyboard.append([\n                    InlineKeyboardButton(button_text,\n                                         callback_data=callback_data)\n                ])\n\n            # Add summary row at the bottom\n            keyboard.append([\n                InlineKeyboardButton(\"ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\",\n                                     callback_data=\"daily_stats\"),\n                InlineKeyboardButton(\"ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\",\n                                     callback_data=\"refresh_daily_orders\")\n            ])\n\n            await update.message.reply_text(\n                summary_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n            logger.info(\"âœ… Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡: {e}\")\n            await update.message.reply_text(\n                f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡.\\n\"\n                f\"Ø¬Ø²Ø¦ÛŒØ§Øª: {str(e)[:100]}\\n\"\n                \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\")\n\n    async def _show_daily_invoices(self, update: Update):\n        \"\"\"Show today's invoices in the group\"\"\"\n        try:\n            today_orders = await self.order_server.get_todays_orders()\n\n            if not today_orders:\n                await update.message.reply_text(\n                    \"ğŸ“„ Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²\\n\\n\"\n                    \"Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§Ù…Ø±ÙˆØ² ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ğŸ“‹\")\n                return\n\n            invoice_text = (\n                f\"ğŸ“„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n\")\n\n            for i, order in enumerate(today_orders, 1):\n                customer = order.get('customer', {})\n                pricing = order.get('pricing', {})\n\n                invoice_text += (\n                    f\"{persian_numbers(str(i))}. ğŸ“‹ {order['order_id']}\\n\"\n                    f\"   ğŸ‘¤ {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                    f\"   ğŸ™ï¸ {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                    f\"   ğŸ’° {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"   ğŸ“Š {self.order_server._get_status_text(order.get('status', 'pending'))}\\n\\n\"\n                )\n\n            # Create action keyboard\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´\",\n                                     callback_data=\"save_daily_invoices\"),\n                InlineKeyboardButton(\"ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„\",\n                                     callback_data=\"email_daily_invoices\")\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\",\n                                callback_data=\"refresh_daily_invoices\")\n                        ]]\n\n            await update.message.reply_text(\n                invoice_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        except Exception as e:\n            logger.error(f\"Error showing daily invoices: {e}\")\n            await update.message.reply_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n    async def _show_order_status(self, update: Update, order_id: str):\n        \"\"\"Show specific order status\"\"\"\n        try:\n            order_data = await self.order_server.get_order_details(order_id)\n\n            if not order_data:\n                await update.message.reply_text(\n                    f\"âŒ Ø³ÙØ§Ø±Ø´ {order_id} ÛŒØ§ÙØª Ù†Ø´Ø¯.\\n\"\n                    \"Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.\")\n                return\n\n            status_text = self.order_server._get_status_text(\n                order_data['status'])\n            customer = order_data.get('customer', {})\n            pricing = order_data.get('pricing', {})\n\n            order_info = (\n                f\"ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: {status_text}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"â° ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: {persian_numbers(order_data.get('created_at', '')[:10])}\\n\"\n            )\n\n            # Create management keyboard\n            keyboard = self.order_server._create_admin_buttons(\n                order_id, order_data['user_id'])\n\n            await update.message.reply_text(\n                order_info, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        except Exception as e:\n            logger.error(f\"Error showing order status: {e}\")\n            await update.message.reply_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n    async def _show_orders_statistics(self, update: Update):\n        \"\"\"Show orders statistics in the group\"\"\"\n        try:\n            stats = await self.order_server.get_orders_statistics()\n\n            if not stats:\n                await update.message.reply_text(\"ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÙØ§Ø±Ø´Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.\"\n                                                )\n                return\n\n            stats_text = (\n                f\"ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ“¦ Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª: {persian_numbers(str(stats.get('total_orders', 0)))}\\n\"\n                f\"ğŸ†• Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {persian_numbers(str(stats.get('today_orders', 0)))}\\n\"\n                f\"ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„: {format_price(stats.get('total_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’³ Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²: {format_price(stats.get('today_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“ˆ ØªÙˆØ²ÛŒØ¹ ÙˆØ¶Ø¹ÛŒØª:\\n\")\n\n            for status, count in stats.get('status_distribution', {}).items():\n                stats_text += f\"â€¢ {status}: {persian_numbers(str(count))}\\n\"\n\n            await update.message.reply_text(stats_text)\n\n        except Exception as e:\n            logger.error(f\"Error showing statistics: {e}\")\n            await update.message.reply_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n    async def _show_group_help(self, update: Update):\n        \"\"\"Show help commands for group\"\"\"\n        help_text = (\"ğŸ¤– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ú¯Ø±ÙˆÙ‡\\n\"\n                     \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                     \"ğŸ“‹ Ø³ÙØ§Ø±Ø´ / Ø³ÙØ§Ø±Ø´Ø§Øª - Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\\n\"\n                     \"ğŸ“„ ÙØ§Ú©ØªÙˆØ± / ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ - Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²\\n\"\n                     \"ğŸ“Š Ø¢Ù…Ø§Ø± - Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\\n\"\n                     \"ğŸ” ÙˆØ¶Ø¹ÛŒØª [Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´] - Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\\n\"\n                     \"â“ Ø±Ø§Ù‡Ù†Ù…Ø§ / Ú©Ù…Ú© - Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§\\n\\n\"\n                     \"ğŸ’¡ Ù†Ú©ØªÙ‡: ÙÙ‚Ø· Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª\")\n\n        await update.message.reply_text(help_text)\n\n    async def _send_order_invoice_card(self, update: Update, order: Dict):\n        \"\"\"Send order as invoice card with management buttons\"\"\"\n        try:\n            customer = order.get('customer', {})\n            pricing = order.get('pricing', {})\n            cart_items = order.get('cart_items', [])\n\n            # Create invoice card\n            invoice_card = (\n                f\"ğŸ§¾ ÙØ§Ú©ØªÙˆØ± - {order['order_id']}\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ™ï¸ {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer.get('customer_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {order.get('user_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"â° {persian_numbers(order.get('created_at', '')[:16].replace('T', ' - '))}\\n\\n\"\n                f\"ğŸ“¦ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:\\n\")\n\n            # Add cart items\n            for i, item in enumerate(cart_items, 1):\n                item_total = item.get('price', 0) * item.get('quantity', 0)\n                invoice_card += (\n                    f\"{persian_numbers(str(i))}. {item.get('product_name', 'Ù…Ø­ØµÙˆÙ„')}\\n\"\n                    f\"   ğŸ“ {item.get('size', 'Ù†Ø§Ù…Ø´Ø®Øµ')} | \"\n                    f\"ğŸ“¦ {persian_numbers(str(item.get('quantity', 0)))} Ø¹Ø¯Ø¯ | \"\n                    f\"ğŸ’° {format_price(item_total)}\\n\")\n\n            # Add pricing\n            invoice_card += (\n                f\"\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ’³ {order.get('payment_method', 'Ù†Ù‚Ø¯ÛŒ')}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ“Š {self.order_server._get_status_text(order.get('status', 'pending'))}\"\n            )\n\n            # Create management keyboard\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"ğŸ“ ØªÙ…Ø§Ø³\",\n                    callback_data=f\"order_status_{order['order_id']}_contacted\"\n                ),\n                InlineKeyboardButton(\n                    \"âœ… ØªØ§ÛŒÛŒØ¯\",\n                    callback_data=f\"order_status_{order['order_id']}_confirmed\"\n                ),\n                InlineKeyboardButton(\n                    \"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡\",\n                    callback_data=f\"order_status_{order['order_id']}_ready\")\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"ğŸšš Ø§Ø±Ø³Ø§Ù„\",\n                                callback_data=\n                                f\"order_status_{order['order_id']}_shipped\"),\n                            InlineKeyboardButton(\n                                \"ğŸ‰ ØªÚ©Ù…ÛŒÙ„\",\n                                callback_data=\n                                f\"order_status_{order['order_id']}_completed\"),\n                            InlineKeyboardButton(\n                                \"âŒ Ù„ØºÙˆ\",\n                                callback_data=\n                                f\"order_status_{order['order_id']}_cancelled\")\n                        ]]\n\n            await update.message.reply_text(\n                invoice_card, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        except Exception as e:\n            logger.error(f\"Error sending order invoice card: {e}\")\n\n    async def _send_order_summary_with_buttons(self, update: Update,\n                                               order: Dict):\n        \"\"\"Send order summary with management buttons (kept for compatibility)\"\"\"\n        await self._send_order_invoice_card(update, order)\n\n    async def _handle_authentication_request(self, query):\n        \"\"\"Handle authentication request\"\"\"\n        user_id = query.from_user.id\n\n        # Set user state to awaiting customer code\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['awaiting_customer_code'] = True\n\n        text = (\"ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª \\n\\n\"\n                \" Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n        await query.edit_message_text(text)\n\n    async def _handle_customer_code_input(self, update, customer_code):\n        \"\"\"Handle customer code input\"\"\"\n        user_id = update.effective_user.id\n\n        # Validate customer code\n        customer = self.customer_service.authenticate_customer(customer_code)\n\n        if customer:\n            # Authentication successful\n            self.user_sessions[user_id] = {\n                'authenticated': True,\n                'customer': customer,\n                'awaiting_customer_code': False\n            }\n\n            welcome_text = (f\"âœ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ {customer['name']} Ø¹Ø²ÛŒØ²!\\n\"\n                            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                            f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\\n\"\n                            \"\\n\"\n                            \"Ø¬Ù‡Øª Ø³ÙØ§Ø±Ø´ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯:\")\n\n            keyboard = self.keyboards.get_categories_keyboard()\n            await update.message.reply_text(welcome_text,\n                                            reply_markup=keyboard)\n        else:\n            # Authentication failed\n            error_text = (\"âŒ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.\\n\"\n                          \"Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ ØµØ­ÛŒØ­ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n            await update.message.reply_text(error_text)\n\n    async def _handle_main_menu(self, query):\n        \"\"\"Handle main menu\"\"\"\n        user_id = query.from_user.id\n        authenticated = self._is_authenticated(user_id)\n\n        if authenticated:\n            customer = self.user_sessions[user_id]['customer']\n            text = (f\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\\n\\n\"\n                    f\"ğŸ‘¤ {customer['name']}\\n\"\n                    f\"ğŸ™ï¸ {customer['city']}\\n\\n\"\n                    \"ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n        else:\n            text = \"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\\n\\nØ¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø®Ø±ÛŒØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\"\n\n        keyboard = self.keyboards.get_main_menu(authenticated)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_start_shopping(self, query):\n        \"\"\"Handle start shopping\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        text = (\"Ø¹Ø§Ù„ÛŒÙ‡ \\n\\n\"\n                \"Ø¬Ù‡Øª Ø³ÙØ§Ø±Ø´ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯Ù†Ø·Ø± Ø®ÙˆØ¯Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ†:\")\n\n        keyboard = self.keyboards.get_categories_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_view_cart(self, query):\n        \"\"\"Handle view cart\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        if not cart_items:\n            text = \"ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\"\n            keyboard = self.keyboards.get_main_menu(authenticated=True)\n        else:\n            text = \"ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§:\\n\\n\"\n            total = 0\n\n            for i, item in enumerate(cart_items, 1):\n                item_total = item['price'] * item['quantity']\n                total += item_total\n                text += (\n                    f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                    f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                    f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                    f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n            text += f\"ğŸ’° Ù…Ø¬Ù…ÙˆØ¹: {format_price(total)} ØªÙˆÙ…Ø§Ù†\"\n            keyboard = self.keyboards.get_cart_management_keyboard()\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_view_invoice(self, query):\n        \"\"\"Handle view invoice\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        invoice_text = self.pricing_manager.generate_invoice(\n            cart_items, customer)\n        keyboard = self.keyboards.get_payment_keyboard()\n\n        await query.edit_message_text(invoice_text, reply_markup=keyboard)\n\n    async def _handle_category_selection(self, query, data):\n        \"\"\"Handle category selection\"\"\"\n        category = data.replace(\"category_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected category in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_category'] = category\n\n        category_info = get_category_info(category)\n        category_name = category_info.get('name', category)\n\n        if category == \"curtain_only\":\n            # For curtain_only, show products directly with icon-based keyboard\n            text = f\"{category_name}\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n            keyboard = self.keyboards.get_curtain_subcategories()\n        elif category == \"tablecloth\":\n            # For tablecloth, show subcategories first\n            keyboard = self.keyboards.get_tablecloth_subcategories()\n            await query.edit_message_text(\"Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø´ÛŒÙ†Ù‡:\",\n                                          reply_markup=keyboard)\n            return\n        elif category == \"baby\":\n            # Baby category with pagination\n            text = f\"{category_name}\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n            keyboard = self.keyboards.get_baby_subcategories()\n        elif category == \"cushion\":\n            # Cushion category with pagination\n            text = f\"{category_name}\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n            keyboard = self.keyboards.get_cushion_subcategories()\n        else:\n            # For other categories, show products directly with icon-based keyboard\n            text = f\"{category_name}\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n            keyboard = self.keyboards.get_category_products_keyboard(category)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_subcategory_selection(self, query, data):\n        \"\"\"Handle subcategory selection\"\"\"\n        subcategory = data.replace(\"subcategory_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected subcategory in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_subcategory'] = subcategory\n\n        text = f\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_alphabetical_keyboard(subcategory)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_alphabet_selection(self, query, data):\n        \"\"\"Handle alphabet selection\"\"\"\n        parts = data.split(\"_\")\n        if len(parts) < 3:\n            await query.edit_message_text(\"âŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.\")\n            return\n        category = parts[1]\n        letter = parts[2]\n        user_id = query.from_user.id\n\n        # Get products starting with selected letter\n        subcategory = self.user_sessions[user_id].get('selected_subcategory')\n        actual_category = subcategory if subcategory else category\n\n        products = search_products_by_name(category, letter, subcategory)\n\n        if not products:\n            text = f\"âŒ Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø§ Ø­Ø±Ù Â«{letter}Â» ÛŒØ§ÙØª Ù†Ø´Ø¯.\\n\\nØ­Ø±Ù Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n            keyboard = self.keyboards.get_alphabetical_keyboard(\n                actual_category)\n        else:\n            text = f\"ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ Ø­Ø±Ù Â«{letter}Â»:\\n\\nÛŒÚ©ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n            keyboard = self.keyboards.get_products_keyboard(products, category)\n\n            # Store filtered products in session\n            self.user_sessions[user_id]['filtered_products'] = products\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_product_selection(self, query, data):\n        \"\"\"Handle product selection\"\"\"\n        product_id = data.replace(\"product_\", \"\")\n        user_id = query.from_user.id\n\n        # Find product by ID\n        product = get_product_by_id(product_id)\n\n        if not product:\n            await query.edit_message_text(\"âŒ Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯.\")\n            return\n\n        # Store selected product in session\n        self.user_sessions[user_id]['selected_product'] = product\n\n        # Get price based on product (check for special pricing first)\n        category = product.get('category_id', 'baby')\n\n        # For curtains, show sewing type selection first\n        if category == 'curtain_only':\n            # Check if it's the special bedside curtain\n            if product_id == 'curtain_15':  # Ù¾Ø±Ø¯Ù‡ Ø­Ø±ÛŒØ± Ø³Ø±ØªØ®Øª (Ø¬ÙØª)\n                price = get_product_price(product['id'], category)\n                text = (f\"ğŸ“¦ {product['name']}\\n\"\n                        f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                        \"Ø¹Ø§Ù„ÛŒÙ‡! Ø§Ù†ØªØ®Ø§Ø¨Øª\\n\"\n                        \"Ø§Ø±ØªÙØ§Ø¹: 240 Ùˆ Ø¹Ø±Ø¶ 2Ã—290 Ù‡Ø³Øª Ú©Ù‡ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù†ÛŒØ³Øª\")\n                self.user_sessions[user_id]['selected_fabric'] = 'special'\n                self.user_sessions[user_id]['selected_category'] = category\n                self.user_sessions[user_id][\n                    'selected_size'] = 'Ø§Ø±ØªÙØ§Ø¹: 240 - Ø¹Ø±Ø¶: 2Ã—290'\n\n                keyboard = [[\n                    InlineKeyboardButton(\"Ø¨Ù„Ù‡ Ù‡Ù…ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø±Ùˆ Ù…ÛŒØ®ÙˆØ§Ù…\",\n                                         callback_data=\"qty_1\")\n                ]]\n                keyboard.append([\n                    InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                         callback_data=\"back_to_categories\")\n                ])\n                keyboard = InlineKeyboardMarkup(keyboard)\n            else:\n                text = (f\"ğŸ“¦ {product['name']}\\n\\n\"\n                        \"Ø¹Ø§Ù„ÛŒÙ‡ Ú†Ù‡ Ù†ÙˆØ¹ Ø¯ÙˆØ®ØªÛŒ Ù…Ø¯ Ù†Ø¸Ø±ØªÙ‡ØŸ\")\n                keyboard = self.keyboards.get_sewing_type_keyboard()\n        # For tablecloth, show base price initially\n        elif category == 'tablecloth':\n            price = PRODUCT_PRICES[category]  # Show base price\n            text = (f\"ğŸ“¦ {product['name']}\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: Ø§Ø² {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø³Ø§ÛŒØ² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            # Store category for size selection\n            self.user_sessions[user_id]['selected_category'] = category\n            keyboard = self.keyboards.get_size_selection_keyboard(category)\n        # For cushions, skip size selection and go directly to quantity\n        elif category == 'cushion':\n            price = get_product_price(product['id'], category)\n            # Store default size for cushions\n            self.user_sessions[user_id]['selected_size'] = 'Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯'\n            self.user_sessions[user_id]['selected_category'] = category\n\n            text = (f\" {product['name']}\\n\"\n                    f\" Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"ØªØ¹Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            keyboard = self.keyboards.get_quantity_keyboard()\n        else:\n            price = get_product_price(product['id'], category)\n            text = (f\"ğŸ“¦ {product['name']}\\n\"\n                    f\" Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø³Ø§ÛŒØ² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            keyboard = self.keyboards.get_size_selection_keyboard(category)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_size_selection_from_category(self, query, data):\n        \"\"\"Handle size selection directly from category\"\"\"\n        category = data.replace(\"size_selection_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected category in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_category'] = category\n\n        category_info = get_category_info(category)\n        category_name = category_info.get('name', category)\n        price = category_info.get('price', 4780000)\n\n        if category == 'tablecloth':\n            text = (f\"{category_name}\\n\\n\"\n                    f\" Ù‚ÛŒÙ…Øª: Ø§Ø² {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ú†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¨ÛŒ! Ø­Ø§Ù„Ø§ Ø³Ø§ÛŒØ² ØªØ´Ú© Ú†Ù‚Ø¯Ø± Ø¨Ø§Ø´Ù‡ØŸ\")\n        else:\n            text = (f\"{category_name}\\n\\n\"\n                    f\" Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ú†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¨ÛŒ! Ø­Ø§Ù„Ø§ Ø³Ø§ÛŒØ² ØªØ´Ú© Ú†Ù‚Ø¯Ø± Ø¨Ø§Ø´Ù‡ØŸ\")\n\n        # Use the keyboard's size selection method instead of hardcoded sizes\n        keyboard = self.keyboards.get_size_selection_keyboard(category)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_size_selection(self, query, data):\n        \"\"\"Handle size selection\"\"\"\n        try:\n            parts = data.split(\"_\")\n            if len(parts) >= 3:\n                size = \"_\".join(parts[1:-1])  # All parts except first and last\n                category = parts[-1]  # Last part is category\n            else:\n                size = data.replace(\"size_\", \"\")\n                category = self.user_sessions.get(query.from_user.id,\n                                                  {}).get('selected_category',\n                                                          'baby')\n\n            user_id = query.from_user.id\n\n            # Ensure user session exists\n            if user_id not in self.user_sessions:\n                self.user_sessions[user_id] = {}\n\n            # Store selected size and category in session\n            self.user_sessions[user_id]['selected_size'] = size\n            self.user_sessions[user_id]['selected_category'] = category\n\n            # Get category info for price\n            category_info = get_category_info(category)\n\n            # For tablecloth, get size-based price\n            if category == 'tablecloth':\n                price = get_product_price('', category, size)\n            else:\n                price = category_info.get('price', 4780000)\n\n            text = (f\"ğŸ“ Ø³Ø§ÛŒØ² Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {size}\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø·Ø±Ø­ Ù‚Ø´Ù†Ú¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ! Ø­Ø§Ù„Ø§ ØªØ¹Ø¯Ø§Ø¯ Ú†Ù‚Ø¯Ø± Ø¨Ø§Ø´Ù‡ØŸ\")\n            keyboard = self.keyboards.get_quantity_keyboard()\n\n            await query.edit_message_text(text, reply_markup=keyboard)\n            logger.info(f\"Size selected: {size} for category {category} by user {user_id}\")\n            \n        except Exception as e:\n            logger.error(f\"Error in size selection: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ². Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(self._is_authenticated(user_id))\n            )\n\n    async def _handle_quantity_selection(self, query, data):\n        \"\"\"Handle quantity selection\"\"\"\n        quantity = int(data.replace(\"qty_\", \"\"))\n        user_id = query.from_user.id\n\n        # Get session data\n        session = self.user_sessions[user_id]\n        size = session.get('selected_size')\n        category = session.get('selected_category', 'baby')\n        fabric = session.get('selected_fabric')\n\n        # Check if we have a specific product or just category\n        if 'selected_product' in session:\n            # Product-based ordering\n            product = session['selected_product']\n            category = product.get('category_id', category)\n            product_name = product['name']\n            product_id = product['id']\n        else:\n            # Category-based ordering (for teen and adult)\n            category_info = get_category_info(category)\n            product_name = category_info.get('name', category)\n            product_id = f\"{category}_generic\"\n\n        # Get price based on product and fabric\n        if category == 'tablecloth':\n            price = get_product_price(product_id, category, size)\n        elif category == 'curtain_only' and fabric:\n            if fabric == 'special':  # For bedside curtain\n                price = get_product_price(product['id'], category)\n            else:\n                price = get_product_price(product_id, category, fabric=fabric)\n        else:\n            price = get_product_price(product['id'], category)\n\n        # Add fabric and sewing type info to product name if applicable\n        if fabric and fabric != 'special':\n            fabric_name = \"Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\" if fabric == \"silk_cotton\" else \"Ù…Ø®Ù…Ù„\"\n            product_name = f\"{product_name} - {fabric_name}\"\n\n            # Add sewing type if available\n            sewing_type = session.get('selected_sewing_type')\n            if sewing_type:\n                sewing_type_name = \"Ù¾Ø§Ù†Ú†\" if sewing_type == \"panch\" else \"Ù†ÙˆØ§Ø±Ø¯ÙˆØ²ÛŒ\"\n                product_name = f\"{product_name} - {sewing_type_name}\"\n\n        # Add to cart\n        cart_item = {\n            'product_id': product_id,\n            'product_name': product_name,\n            'size': size,\n            'quantity': quantity,\n            'price': price\n        }\n\n        self.cart_manager.add_to_cart(user_id, cart_item)\n\n        total_price = price * quantity\n        text = (f\"âœ… Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!\\n\\n\"\n                f\" {product_name}\\n\"\n                f\" Ø³Ø§ÛŒØ²: {size}\\n\"\n                f\" ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(quantity))}\\n\"\n                f\" Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(total_price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                \"Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú†Ù‡ Ú©Ø§Ø± Ú©Ù†ÛŒØ¯ØŸ\")\n\n        keyboard = self.keyboards.get_cart_management_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_payment_selection(self, query, data):\n        \"\"\"Handle payment selection - now shows payment type selection\"\"\"\n        user_id = query.from_user.id\n\n        # Check authentication\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\n                \"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=False))\n            return\n\n        cart_items = self.cart_manager.get_cart(user_id)\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n\n        # Extract payment method from callback data\n        payment_method = data.replace(\"payment_\", \"\").replace(\"_card\", \"\")\n        \n        # Store payment method in session\n        self.user_sessions[user_id]['selected_payment_method'] = payment_method\n        \n        # Calculate amounts for display\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        if payment_method == \"cash\":\n            discount_rate = 0.30\n            payment_text = \"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (Û³Û°Ùª ØªØ®ÙÛŒÙ)\"\n        elif payment_method == \"60day\":\n            discount_rate = 0.25\n            payment_text = \"Ù¾Ø±Ø¯Ø§Ø®Øª Û¶Û° Ø±ÙˆØ² (Û²ÛµÙª ØªØ®ÙÛŒÙ)\"\n        elif payment_method == \"90day\":\n            discount_rate = 0.25\n            payment_text = \"Ù¾Ø±Ø¯Ø§Ø®Øª Û¹Û° Ø±ÙˆØ² (Û²ÛµÙª ØªØ®ÙÛŒÙ + Û²ÛµÙª Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª)\"\n        else:\n            discount_rate = 0\n            payment_text = \"Ù¾Ø±Ø¯Ø§Ø®Øª\"\n\n        discount = self.pricing_manager.calculate_discount(subtotal, discount_rate)\n        final_amount = subtotal - discount\n        \n        if payment_method == \"90day\":\n            advance_amount = final_amount * 0.25\n            amount_text = f\" Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (Û²ÛµÙª): {format_price(advance_amount)} ØªÙˆÙ…Ø§Ù†\\n Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\"\n        else:\n            amount_text = f\" Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\"\n\n        text = (f\"âœ… {payment_text}\\n\\n\"\n                f\"{amount_text}\\n\\n\"\n                \"Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n\n        keyboard = self.keyboards.get_payment_type_keyboard(payment_method)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_payment_type_selection(self, query, data):\n        \"\"\"Handle payment type selection (Cash vs Check)\"\"\"\n        user_id = query.from_user.id\n        \n        # Parse callback data: payment_type_cash_method or payment_type_check_method\n        parts = data.split(\"_\")\n        if len(parts) < 4:\n            await query.edit_message_text(\"âŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.\")\n            return\n            \n        payment_type = parts[2]  # cash or check\n        payment_method = parts[3]  # cash, 60day, 90day\n        \n        # Store payment details in session\n        self.user_sessions[user_id]['payment_type'] = payment_type\n        self.user_sessions[user_id]['selected_payment_method'] = payment_method\n        \n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n        \n        # Calculate amounts\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        if payment_method == \"cash\":\n            discount_rate = 0.30\n        elif payment_method in [\"60day\", \"90day\"]:\n            discount_rate = 0.25\n        else:\n            discount_rate = 0\n            \n        discount = self.pricing_manager.calculate_discount(subtotal, discount_rate)\n        final_amount = subtotal - discount\n        \n        if payment_type == \"cash\":\n            await self._handle_cash_payment_flow(query, payment_method, final_amount)\n        elif payment_type == \"check\":\n            await self._handle_check_payment_flow(query, payment_method, final_amount)\n\n    async def _handle_cash_payment_flow(self, query, payment_method, final_amount):\n        \"\"\"Handle cash payment flow\"\"\"\n        user_id = query.from_user.id\n        \n        if payment_method == \"90day\":\n            advance_amount = final_amount * 0.25\n            amount_text = f\" Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (Û²ÛµÙª): {format_price(advance_amount)} ØªÙˆÙ…Ø§Ù†\"\n            payment_amount = advance_amount\n        else:\n            amount_text = f\" Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\"\n            payment_amount = final_amount\n            \n        # Store payment info for receipt processing\n        self.user_sessions[user_id]['payment_info'] = {\n            'payment_method': f\"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ - {payment_method}\",\n            'amount': payment_amount,\n            'subtotal': self.pricing_manager.calculate_subtotal(self.cart_manager.get_cart(user_id)),\n            'discount_rate': 0.30 if payment_method == \"cash\" else 0.25,\n            'discount': self.pricing_manager.calculate_subtotal(self.cart_manager.get_cart(user_id)) - final_amount,\n            'awaiting_receipt': True\n        }\n        \n        # Show bank information and request receipt\n        bank_info = self.pricing_manager.bank_info\n        text = (f\" Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\\n\\n\"\n                f\"{amount_text}\\n\\n\"\n                f\"ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:\\n\"\n                f\"ğŸ¦ Ú©Ø§Ø±Øª: {bank_info['card_number']}\\n\"\n                f\"ğŸ¦ Ø´Ø¨Ø§: {bank_info['sheba_number']}\\n\"\n                f\"ğŸ‘¤ {bank_info['account_holder']}\\n\\n\"\n                f\"Ù„Ø·ÙØ§Ù‹ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\")\n        \n        keyboard = self.keyboards.get_cash_payment_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_check_payment_flow(self, query, payment_method, final_amount):\n        \"\"\"Handle check payment flow with admin recipient selection system\"\"\"\n        user_id = query.from_user.id\n        \n        if payment_method == \"90day\":\n            advance_amount = final_amount * 0.25\n            amount_text = f\" Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ú†Ú© (Û²ÛµÙª): {format_price(advance_amount)} ØªÙˆÙ…Ø§Ù†\\n Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\"\n            payment_amount = advance_amount\n        else:\n            amount_text = f\" Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ Ú†Ú©: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\"\n            payment_amount = final_amount\n            \n        # Store check payment info\n        self.user_sessions[user_id]['check_payment_info'] = {\n            'payment_method': f\"Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©ÛŒ - {payment_method}\",\n            'amount': payment_amount,\n            'final_amount': final_amount,\n            'awaiting_check_photo': True\n        }\n        \n        text = (f\"ğŸ“„ Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©ÛŒ\\n\\n\"\n                f\"{amount_text}\\n\\n\"\n                f\"ğŸ“ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©ÛŒ:\\n\"\n                f\"Ù„Ø·ÙØ§ Ø¹Ú©Ø³ Ú†Ú© Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒÙ† ØªØ§ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¬Ù‡Øª Ø«Ø¨Øª Ú†Ú© Ø¨Ù‡ Ø§Ø³Ù… Ùˆ Ú©Ø¯ Ù…Ù„ÛŒ Ù…Ø¯ Ù†Ø¸Ø± Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¨Ù‡ØªÙˆÙ† Ù¾ÛŒØ§Ù… Ø¨Ø¯Ù†\")\n        \n        keyboard = self.keyboards.get_check_payment_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_upload_check_photo_request(self, query):\n        \"\"\"Handle request to upload check photo\"\"\"\n        user_id = query.from_user.id\n        \n        # Set awaiting check photo flag\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['awaiting_check_photo'] = True\n        \n        text = \"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ Ú†Ú© Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\"\n        await query.edit_message_text(text)\n\n    async def _handle_check_follow_up(self, query):\n        \"\"\"Handle check follow up status\"\"\"\n        user_id = query.from_user.id\n        \n        # This button will be used when admin sends status updates\n        text = (\"ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\\n\\n\"\n                \"Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø³Øª. Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø±Ø¯.\")\n        \n        keyboard = self.keyboards.get_check_payment_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_confirm_check_submission(self, query):\n        \"\"\"Handle check submission confirmation\"\"\"\n        user_id = query.from_user.id\n        \n        # Get check payment info and send final invoice to support group\n        check_info = self.user_sessions[user_id].get('check_payment_info', {})\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n        check_photo = self.user_sessions[user_id].get('check_photo')\n        \n        if not check_photo:\n            await query.edit_message_text(\"âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¹Ú©Ø³ Ú†Ú© Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\")\n            return\n            \n        # Generate final order with check information\n        await self._submit_check_order_to_support(user_id, check_info, customer, cart_items, check_photo)\n        \n        # Clear cart and session data\n        self.cart_manager.clear_cart(user_id)\n        if user_id in self.user_sessions:\n            self.user_sessions[user_id].pop('check_payment_info', None)\n            self.user_sessions[user_id].pop('check_photo', None)\n            self.user_sessions[user_id].pop('awaiting_check_photo', None)\n        \n        text = (\"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\\n\"\n                \"ğŸ“„ Ú†Ú© Ø´Ù…Ø§ Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.\\n\"\n                \"ğŸ• Ú†Ú© Ø¨Ø§ÛŒØ¯ Ø·ÛŒ Û±Û° Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯.\\n\\n\"\n                \"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ…!\")\n                \n        keyboard = self.keyboards.get_main_menu(authenticated=True)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_check_photo_upload(self, update, user_id):\n        \"\"\"Handle check photo upload\"\"\"\n        # Store photo info\n        photo = update.message.photo[-1]  # Get highest resolution photo\n        self.user_sessions[user_id]['check_photo'] = {\n            'file_id': photo.file_id,\n            'file_unique_id': photo.file_unique_id\n        }\n        \n        # Clear the awaiting flag\n        self.user_sessions[user_id]['awaiting_check_photo'] = False\n        \n        # Send to support group for admin review\n        await self._send_check_to_support_for_review(user_id, photo)\n        \n        text = (\"âœ… Ø¹Ú©Ø³ Ú†Ú© Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!\\n\\n\"\n                \"ğŸ“¤ Ø¹Ú©Ø³ Ú†Ú© Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.\\n\"\n                \"ğŸ“ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø¯ Ù…Ù„ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø±Ø§ Ù¾ÛŒØ§Ù… Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø¯Ø§Ø¯.\\n\\n\"\n                \"Ø§Ø² Ø¯Ú©Ù…Ù‡ Â«Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒÂ» Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\")\n        \n        keyboard = self.keyboards.get_check_payment_keyboard()\n        await update.message.reply_text(text, reply_markup=keyboard)\n\n    async def _send_check_to_support_for_review(self, user_id, photo):\n        \"\"\"Send check photo to support group for admin review\"\"\"\n        try:\n            customer = self.user_sessions[user_id]['customer']\n            check_info = self.user_sessions[user_id].get('check_payment_info', {})\n            \n            # Create message for support group\n            support_text = (f\"ğŸ“„ Ú†Ú© Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯\\n\"\n                           f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                           f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                           f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                           f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                           f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                           f\"ğŸ’° Ù…Ø¨Ù„Øº: {format_price(check_info.get('amount', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                           f\"ğŸ’³ Ø±ÙˆØ´: {check_info.get('payment_method', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\\n\"\n                           f\"ğŸ“ Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ù„ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\")\n            \n            # Create admin buttons with specific recipients (no customer confirmation button)\n            keyboard = [\n                [InlineKeyboardButton(\" Ø®Ø§Ù†Ù… ÙØ±Ø§Ù†Ú© ØºØ±ÛŒØ¨ÛŒ\", \n                                   callback_data=f\"check_recipient_farank_{user_id}\")],\n                [InlineKeyboardButton(\" Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\", \n                                   callback_data=f\"check_recipient_nima_{user_id}\")],\n                [InlineKeyboardButton(\" Ù…Ø¬ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \n                                   callback_data=f\"check_recipient_majid_{user_id}\")],\n                [InlineKeyboardButton(\" ÙˆØ­ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \n                                   callback_data=f\"check_recipient_vahid_{user_id}\")]\n            ]\n            \n            # Send to support group\n            if self.config.order_group_chat_id:\n                await self.bot.send_photo(\n                    chat_id=self.config.order_group_chat_id,\n                    photo=photo.file_id,\n                    caption=support_text,\n                    reply_markup=InlineKeyboardMarkup(keyboard)\n                )\n                logger.info(f\"Check photo sent to support group for user {user_id}\")\n            \n        except Exception as e:\n            logger.error(f\"Error sending check to support group: {e}\")\n\n    async def _submit_check_order_to_support(self, user_id, check_info, customer, cart_items, check_photo):\n        \"\"\"Submit final check order to support group\"\"\"\n        try:\n            # Generate order ID\n            order_id = await self.order_server.generate_order_id()\n            \n            # Create final invoice text\n            invoice_text = (f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ - Ú†Ú©\\n\"\n                           f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                           f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                           f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                           f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                           f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                           f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                           f\"ğŸ’³ Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª: {check_info.get('payment_method', 'Ú†Ú©ÛŒ')}\\n\"\n                           f\"ğŸ’° Ù…Ø¨Ù„Øº Ú†Ú©: {format_price(check_info.get('amount', 0))} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                           f\"ğŸ“¦ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:\\n\")\n            \n            # Add cart items\n            for i, item in enumerate(cart_items, 1):\n                item_total = item.get('price', 0) * item.get('quantity', 0)\n                invoice_text += (f\"{persian_numbers(str(i))}. {item.get('product_name', 'Ù…Ø­ØµÙˆÙ„')}\\n\"\n                               f\"   ğŸ“ {item.get('size', 'Ù†Ø§Ù…Ø´Ø®Øµ')} | \"\n                               f\"ğŸ“¦ {persian_numbers(str(item.get('quantity', 0)))} Ø¹Ø¯Ø¯ | \"\n                               f\"ğŸ’° {format_price(item_total)}\\n\")\n            \n            invoice_text += (f\"\\nğŸ• Ú†Ú© Ø¨Ø§ÛŒØ¯ Ø·ÛŒ Û±Û° Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯\\n\"\n                           f\"âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªØ§ÛŒÛŒØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´\")\n            \n            # Create admin management buttons\n            keyboard = [[\n                InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´\", \n                                   callback_data=f\"order_status_{order_id}_confirmed\"),\n                InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ\", \n                                   callback_data=f\"order_status_{order_id}_contacted\")\n            ], [\n                InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\", \n                                   callback_data=f\"order_status_{order_id}_ready\"),\n                InlineKeyboardButton(\"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\", \n                                   callback_data=f\"order_status_{order_id}_shipped\")\n            ], [\n                InlineKeyboardButton(\"âœ… ØªÚ©Ù…ÛŒÙ„\", \n                                   callback_data=f\"order_status_{order_id}_completed\"),\n                InlineKeyboardButton(\"âŒ Ù„ØºÙˆ\", \n                                   callback_data=f\"order_status_{order_id}_cancelled\")\n            ]]\n            \n            # Send final invoice with check photo to support group\n            if self.config.order_group_chat_id and check_photo:\n                await self.bot.send_photo(\n                    chat_id=self.config.order_group_chat_id,\n                    photo=check_photo['file_id'],\n                    caption=invoice_text,\n                    reply_markup=InlineKeyboardMarkup(keyboard)\n                )\n                \n                # Also save order data to server\n                await self.order_server.save_order(\n                    order_id=order_id,\n                    user_id=user_id,\n                    customer=customer,\n                    cart_items=cart_items,\n                    payment_info={\n                        'payment_method': check_info.get('payment_method', 'Ú†Ú©ÛŒ'),\n                        'amount': check_info.get('amount', 0),\n                        'type': 'check'\n                    }\n                )\n                \n                logger.info(f\"Check order {order_id} submitted to support group\")\n            \n        except Exception as e:\n            logger.error(f\"Error submitting check order to support: {e}\")\n\n    async def _handle_check_info_sent(self, query, data):\n        \"\"\"Handle admin confirmation that check info was sent to customer\"\"\"\n        try:\n            user_id = int(data.split(\"_\")[-1])\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n            \n            # Update support group message\n            updated_text = f\"âœ… {admin_name}: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø¯ Ù…Ù„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\" + query.message.caption\n            \n            # Keep same admin buttons after selection (no customer confirmation button)\n            keyboard = [\n                [InlineKeyboardButton(\"ğŸ‘© Ø®Ø§Ù†Ù… ÙØ±Ø§Ù†Ú© ØºØ±ÛŒØ¨ÛŒ\", \n                                   callback_data=f\"check_recipient_farank_{user_id}\")],\n                [InlineKeyboardButton(\"ğŸ‘¨ Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\", \n                                   callback_data=f\"check_recipient_nima_{user_id}\")],\n                [InlineKeyboardButton(\"ğŸ‘¨ Ù…Ø¬ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \n                                   callback_data=f\"check_recipient_majid_{user_id}\")],\n                [InlineKeyboardButton(\"ğŸ‘¨ ÙˆØ­ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \n                                   callback_data=f\"check_recipient_vahid_{user_id}\")]\n            ]\n            \n            await query.edit_message_caption(\n                caption=updated_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n            \n            # Send message to customer with new options\n            customer_text = (\"ğŸ“ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø¯ Ù…Ù„ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ú†Ú© Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯.\\n\\n\"\n                           \"Ù„Ø·ÙØ§ Ú†Ú© Ø±Ø§ Ø·ÛŒ Ø¯Ù‡ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø¨Ø®Ø´ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒÙ†\\n\\n\"\n                           \"Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ú†Ú©ØŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯:\")\n            \n            check_keyboard = self.keyboards.get_check_confirmation_keyboard()\n            \n            try:\n                await query.bot.send_message(\n                    chat_id=user_id,\n                    text=customer_text,\n                    reply_markup=check_keyboard\n                )\n            except Exception as customer_error:\n                logger.error(f\"Error sending check info to customer {user_id}: {customer_error}\")\n                \n        except Exception as e:\n            logger.error(f\"Error handling check info sent: {e}\")\n\n    async def _handle_check_contacted(self, query, data):\n        \"\"\"Handle admin confirmation that customer was contacted\"\"\"\n        try:\n            user_id = int(data.split(\"_\")[-1])\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n            \n            # Update support group message\n            updated_text = f\"ğŸ“ {admin_name}: Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\\n\" + query.message.caption\n            \n            await query.edit_message_caption(caption=updated_text)\n            \n            # Notify customer of contact\n            try:\n                await query.bot.send_message(\n                    chat_id=user_id,\n                    text=\"ğŸ“ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„Ø§Ø²Ù… Ø§Ø±Ø§Ø¦Ù‡ Ø´Ø¯.\"\n                )\n            except Exception as customer_error:\n                logger.error(f\"Error notifying customer {user_id}: {customer_error}\")\n                \n        except Exception as e:\n            logger.error(f\"Error handling check contacted: {e}\")\n\n    async def _handle_zarinpal_payment(self, query, payment_type: str,\n                                       payment_method: str):\n        \"\"\"Handle ZarinPal payment\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Calculate payment amount based on type\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        discount_rate = self.pricing_manager.discount_rates.get(\n            payment_type, 0)\n        discount = self.pricing_manager.calculate_discount(\n            subtotal, discount_rate)\n\n        if payment_type == \"90day\":\n            # For 90-day payment, only 25% advance payment required\n            amount = int((subtotal - discount) * 0.25)  # 25% advance\n            description = f\"Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Û²ÛµÙª Ø³ÙØ§Ø±Ø´ - {customer['name']}\"\n        else:\n            # For cash payment, full amount\n            amount = int(subtotal - discount)\n            description = f\"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ Ø³ÙØ§Ø±Ø´ - {customer['name']}\"\n\n        # Create payment request with proper callback URL\n        callback_url = \"https://www.zarinpal.com/pg/services/WebGate/wsdl\"  # Temporary callback\n\n        payment_result = self.zarinpal.create_payment_request(\n            amount=amount,\n            description=description,\n            callback_url=callback_url,\n            customer_mobile=customer.get('phone', ''),\n            customer_email=customer.get('email', ''))\n\n        if payment_result['success']:\n            # Store payment info in session\n            self.user_sessions[user_id]['payment_info'] = {\n                'authority': payment_result['authority'],\n                'amount': amount,\n                'payment_type': payment_type,\n                'payment_method': payment_method\n            }\n\n            text = (f\"ğŸ’³ {payment_method}\\n\\n\"\n                    f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"ğŸ”— Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:\")\n\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†\",\n                                     url=payment_result['payment_url'])\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\",\n                                callback_data=\"payment_completed\")\n                        ],\n                        [\n                            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                                 callback_data=\"view_invoice\")\n                        ],\n                        [\n                            InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\",\n                                                 callback_data=\"main_menu\")\n                        ]]\n\n            await query.edit_message_text(\n                text, reply_markup=InlineKeyboardMarkup(keyboard))\n        else:\n            text = (f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n                    f\"{payment_result['error']}\\n\\n\"\n                    \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\")\n\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯\",\n                    callback_data=f\"payment_{payment_type}_zarinpal\")\n            ], [\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            await query.edit_message_text(\n                text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_card_to_card_payment(self, query, payment_type: str,\n                                           payment_method: str,\n                                           discount_rate: float):\n        \"\"\"Handle card-to-card payment\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Calculate payment amount\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        discount = self.pricing_manager.calculate_discount(\n            subtotal, discount_rate)\n        final_amount = subtotal - discount\n\n        # Store payment info in session\n        self.user_sessions[user_id]['payment_info'] = {\n            'payment_type':\n            payment_type,\n            'payment_method':\n            payment_method,\n            'amount':\n            final_amount if payment_type not in [\"90day\", \"60day\"] else int(\n                final_amount * 0.25),\n            'discount_rate':\n            discount_rate,\n            'awaiting_receipt':\n            payment_type != \"60day\",  # 60-day doesn't need receipt\n            'full_amount':\n            final_amount,\n            'subtotal':\n            subtotal,\n            'discount':\n            discount\n        }\n\n        # Generate payment details based on payment type\n        if payment_type == \"cash\":\n            payment_details = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (30% ØªØ®ÙÛŒÙ)\\n\"\n                f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ ØªØ®ÙÛŒÙ (30%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø³ Ø§Ø² ØªØ®ÙÛŒÙ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:\\n\"\n                f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: 6219861915854102\\n\"\n                f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR110560611828005185959401\\n\"\n                f\"ğŸ‘¤ Ø¨Ù‡ Ù†Ø§Ù…:Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\\n\\n\"\n                f\"ğŸ“¸ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\")\n            # Create keyboard for cash payment\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\",\n                                     callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        elif payment_type == \"60day\":\n            payment_details = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ (25% ØªØ®ÙÛŒÙ)\\n\"\n                f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ ØªØ®ÙÛŒÙ (25%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"Ù‡Ø± 15 Ø±ÙˆØ² ÛŒÚ© Ø¨Ø§Ø± Ø±Ø¨Ø§ØªØŒØ¬Ù‡Øª ÛŒØ§Ø¯Ø§ÙˆØ±ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø¨Ù‡ØªÙˆÙ† Ù¾ÛŒØ§Ù… Ù…ÛŒØ¯Ù‡\\n\"\n                f\"Ø¯Ø±ØµÙˆØ±Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ ØµÙˆØ±Øª Ú†Ú©ÛŒØŒ ØªØ§Ø±ÛŒØ® Ø³Ø± Ø±Ø³ÛŒØ¯ Ú†Ú© Ø¯Ø± Ù‡Ù…ÛŒÙ† Ø¯ÙˆÙ…Ø§Ù‡ Ø¨Ø§Ø´Ø¯\\n\\n\"\n                f\"Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            # Create keyboard for 60-day payment with cash/check options\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\",\n                                     callback_data=\"payment_type_cash_60day\")\n            ], [\n                InlineKeyboardButton(\"ğŸ“‹ Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©ÛŒ\",\n                                     callback_data=\"payment_type_check_60day\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                     callback_data=\"view_invoice\")\n            ]]\n\n        elif payment_type == \"90day\":\n            advance_payment = int(final_amount * 0.25)\n            payment_details = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª 90 Ø±ÙˆØ²Ù‡ (25% ØªØ®ÙÛŒÙ + 25% Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª)\\n\"\n                f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ (25%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’³ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (25%): {format_price(advance_payment)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"Ù†ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n            )\n            # Create keyboard for 90-day payment with cash/check options\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\",\n                                     callback_data=\"payment_type_cash_90day\")\n            ], [\n                InlineKeyboardButton(\"ğŸ“‹ Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©ÛŒ\",\n                                     callback_data=\"payment_type_check_90day\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        await query.edit_message_text(\n            payment_details, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_check_payment(self, query, payment_type: str,\n                                    payment_method: str, discount_rate: float):\n        \"\"\"Handle check payment method\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Calculate payment amount\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        discount = self.pricing_manager.calculate_discount(\n            subtotal, discount_rate)\n        final_amount = subtotal - discount\n\n        # Store payment info in session\n        self.user_sessions[user_id]['payment_info'] = {\n            'payment_type': payment_type,\n            'payment_method': payment_method,\n            'amount': final_amount,\n            'discount_rate': discount_rate,\n            'awaiting_receipt': True,\n            'full_amount': final_amount,\n            'subtotal': subtotal,\n            'discount': discount,\n            'is_check_payment': True\n        }\n\n        payment_details = (\n            f\"ğŸ“‹ {payment_method} (25% ØªØ®ÙÛŒÙ)\\n\"\n            f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ ØªØ®ÙÛŒÙ (25%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ“¸. Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ Ú†Ú© Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\\n\\n\"\n            f\"ğŸ“ Ù†Ú©ØªÙ‡: Ø¯Ø±ØµÙˆØ±Øª Ø®Ø±ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ú†Ú©ÛŒ Ù„Ø·ÙØ§Ù‹ Ú†Ú© Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\"\n        )\n\n        keyboard = [[\n            InlineKeyboardButton(\"ğŸ“¸  Ø§Ø±Ø³Ø§Ù„ Ú†Ú© Ø«Ø¨Øª Ø´Ø¯Ù‡ \",\n                                 callback_data=\"upload_receipt\")\n        ], [InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")]]\n\n        await query.edit_message_text(\n            payment_details, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_payment_terms_confirmation(self, query):\n        \"\"\"Handle payment terms confirmation for 60-day and 90-day payments\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        payment_info = self.user_sessions[user_id].get('payment_info')\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Send invoice to support group\n        invoice_text = self.pricing_manager.generate_final_invoice(\n            cart_items, customer, payment_info['payment_method'],\n            payment_info['discount_rate'])\n\n        # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n        if self.config.order_group_chat_id:\n            try:\n                group_message = (\n                    f\"ğŸ“‹ ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ\\n\"\n                    f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                    f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                    f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                    f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                    f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                    f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                    f\"ğŸ’° Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"ğŸ’° Ù…Ø¨Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {format_price(payment_info['full_amount'] - payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"â° Ø²Ù…Ø§Ù† ØªØ§ÛŒÛŒØ¯: {persian_numbers(datetime.now().strftime('%Y/%m/%d - %H:%M'))}\\n\\n\"\n                    f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                    f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                    f\"{invoice_text}\")\n\n                await query.bot.send_message(\n                    chat_id=self.config.order_group_chat_id,\n                    text=group_message)\n                logger.info(f\"âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\")\n\n            except Exception as e:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: {e}\")\n\n        # Schedule payment reminder for both 60-day and 90-day payments\n        if payment_info['payment_type'] in ['60day', '90day']:\n            total_amount = payment_info['full_amount']\n            advance_paid = payment_info['amount']\n            remaining_amount = total_amount - advance_paid\n\n            # Create order ID for tracking\n            order_id = f\"ORDER_{user_id}_{int(datetime.now().timestamp())}\"\n\n            if payment_info['payment_type'] == '60day':\n                # For 60-day payment: single reminder after 60 days\n                self.payment_scheduler.add_60day_payment_schedule(\n                    user_id=user_id,\n                    customer_info=customer,\n                    total_amount=total_amount,\n                    advance_paid=advance_paid,\n                    remaining_amount=remaining_amount,\n                    order_id=order_id)\n                logger.info(\n                    f\"âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n            else:\n                # For 90-day payment: monthly reminders\n                self.payment_scheduler.add_90day_payment_schedule(\n                    user_id=user_id,\n                    customer_info=customer,\n                    total_amount=total_amount,\n                    advance_paid=advance_paid,\n                    remaining_amount=remaining_amount,\n                    order_id=order_id)\n                logger.info(\n                    f\"âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª 90 Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n\n        # Show upload receipt interface\n        await query.edit_message_text(\n            f\"âœ… Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯!\\n\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ“… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ø¨Ù‚ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\\n\\n\"\n            f\"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ² Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\",\n            reply_markup=InlineKeyboardMarkup([[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\",\n                                     callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]))\n\n        if payment_type in [\"60day\", \"90day\"]:\n            keyboard = [[\n                InlineKeyboardButton(button_text,\n                                     callback_data=\"confirm_payment_terms\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n        else:\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\",\n                                     callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        await query.edit_message_text(\n            bank_info, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_upload_receipt_request(self, query):\n        \"\"\"Handle receipt upload request\"\"\"\n        user_id = query.from_user.id\n        payment_info = self.user_sessions[user_id].get('payment_info', {})\n\n        if payment_info.get('is_check_payment'):\n            message_text = (\n                \"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ/Ú†Ú© Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\\n\\n\"\n                \"âš ï¸ ÙÙ‚Ø· ØªØµØ§ÙˆÛŒØ± Ø¨Ø§ ÙØ±Ù…Øª JPG, PNG Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ù‡Ø³ØªÙ†Ø¯\\n\\n\"\n                \"ğŸ“ Ù†Ú©ØªÙ‡: Ø¯Ø±ØµÙˆØ±Øª Ø®Ø±ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ú†Ú©ÛŒ Ù„Ø·ÙØ§Ù‹ Ú†Ú© Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\\n\\n\"\n                \"Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ØŒ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\")\n        else:\n            message_text = (\n                \"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Ú†Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\\n\\n\"\n                \"âš ï¸ ÙÙ‚Ø· ØªØµØ§ÙˆÛŒØ± Ø¨Ø§ ÙØ±Ù…Øª JPG, PNG Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ù‡Ø³ØªÙ†Ø¯\\n\\n\"\n                \"Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ØŒ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\")\n\n        await query.edit_message_text(message_text,\n                                      reply_markup=InlineKeyboardMarkup([[\n                                          InlineKeyboardButton(\n                                              \"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                              callback_data=\"view_invoice\")\n                                      ]]))\n\n    async def _handle_payment_receipt_confirmation(self, query):\n        \"\"\"Handle payment receipt confirmation\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        # Check if user is authenticated\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\n                \"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=False))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n        payment_info = self.user_sessions[user_id].get('payment_info')\n\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        try:\n            # Get receipt photo if available\n            receipt_photo_id = None\n            if 'receipt_photo' in self.user_sessions[user_id]:\n                receipt_photo_id = self.user_sessions[user_id][\n                    'receipt_photo']['file_id']\n\n            # Send receipt/check photo to support group before creating order\n            if receipt_photo_id and self.config.order_group_chat_id:\n                try:\n                    payment_type_text = \"Ú†Ú©\" if payment_info.get(\n                        'is_check_payment') else \"ÙÛŒØ´ /Ú†Ú© Ø«Ø¨Øª Ø´Ø¯Ù‡ \"\n                    photo_caption = (\n                        f\"ğŸ“¸ {payment_type_text} Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                        f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                        f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                        f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                        f\"â° Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„: {persian_numbers(datetime.now().strftime('%Y/%m/%d - %H:%M'))}\"\n                    )\n\n                    await query.bot.send_photo(\n                        chat_id=self.config.order_group_chat_id,\n                        photo=receipt_photo_id,\n                        caption=photo_caption)\n                    logger.info(f\"âœ… Ø¹Ú©Ø³ {payment_type_text} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\")\n\n                except Exception as e:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: {e}\")\n\n            # Create order using order management server\n            order_id = await self.order_server.create_order(\n                user_id=user_id,\n                customer=customer,\n                cart_items=cart_items,\n                payment_method=payment_info['payment_method'],\n                discount_rate=payment_info['discount_rate'],\n                receipt_photo_id=receipt_photo_id)\n\n            # Clear cart and payment info\n            self.cart_manager.clear_cart(user_id)\n            if 'payment_info' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['payment_info']\n            if 'receipt_photo' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['receipt_photo']\n\n            # Confirm to customer\n            await query.edit_message_text(\n                f\"âœ… Ø¹Ø§Ù„ÛŒÙ‡! Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ”„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø§Ø¯.\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ….\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n            logger.info(\n                f\"âœ… Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id}\")\n\n        except Exception as e:\n            logger.error(f\"Error in payment receipt confirmation: {e}\")\n            logger.error(\n                f\"User ID: {user_id}, Customer: {customer if customer else 'None'}, Cart items: {len(cart_items) if cart_items else 0}\"\n            )\n\n            # More detailed error handling\n            try:\n                await query.edit_message_text(\n                    f\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯.\\n\"\n                    f\"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\\n\\n\"\n                    f\"Ú©Ø¯ Ø®Ø·Ø§: {type(e).__name__}\",\n                    reply_markup=self.keyboards.get_main_menu(\n                        authenticated=True))\n            except Exception as edit_error:\n                logger.error(f\"Error editing message: {edit_error}\")\n                # Send new message if editing fails\n                try:\n                    await query.message.reply_text(\n                        f\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯.\\n\"\n                        f\"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\",\n                        reply_markup=self.keyboards.get_main_menu(\n                            authenticated=True))\n                except Exception as reply_error:\n                    logger.error(f\"Error sending reply: {reply_error}\")\n\n    async def _handle_group_payment(self, query, payment_type: str,\n                                    payment_method: str):\n        \"\"\"Handle group payment (installment)\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        # Check if cart is not empty\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Check if group chat ID is configured\n        if not self.config.order_group_chat_id:\n            await query.edit_message_text(\n                \"âŒ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        try:\n            # Generate final invoice\n            discount_rate = self.pricing_manager.discount_rates.get(\n                payment_type, 0.25)\n            invoice_text = self.pricing_manager.generate_final_invoice(\n                cart_items, customer, payment_method, discount_rate)\n\n            # Send to customer with confirmation\n            confirmation_text = (\n                f\"{invoice_text}\\n\\n\"\n                \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.\\n\"\n                \"Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù…Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø±Ø¬Ø±ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø¯Ø§Ø¯    .\")\n\n            keyboard = [[\n                InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´\",\n                                     callback_data=\"confirm_order\")\n            ], [\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            # Store order info for confirmation```python\n            self.user_sessions[user_id]['pending_order'] = {\n                'payment_method': payment_method,\n                'discount_rate': discount_rate,\n                'invoice_text': invoice_text\n            }\n\n            await query.edit_message_text(\n                confirmation_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n            logger.info(\n                \"Group payment processed successfully for user {user_id}\")\n\n        except Exception as e:\n            logger.error(f\"Error in group payment handling: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    async def _handle_order_confirmation(self, query):\n        \"\"\"Handle order confirmation using order management server\"\"\"\n        user_id = query.from_user.id\n\n        # Check if user is authenticated\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\n                \"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=False))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n        pending_order = self.user_sessions[user_id].get('pending_order')\n\n        if not pending_order:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        try:\n            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª\n            order_id = await self.order_server.create_order(\n                user_id=user_id,\n                customer=customer,\n                cart_items=cart_items,\n                payment_method=pending_order['payment_method'],\n                discount_rate=pending_order['discount_rate'])\n\n            # Clear cart and session\n            self.cart_manager.clear_cart(user_id)\n            if 'pending_order' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['pending_order']\n\n            # Store order ID in session\n            self.user_sessions[user_id]['last_order_id'] = order_id\n\n            # Confirm to customer\n            await query.edit_message_text(\n                f\"âœ… Ø¹Ø§Ù„ÛŒÙ‡! Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ”„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø§Ø¯.\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ….\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n        except Exception as e:\n            logger.error(f\"Error in order confirmation: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    async def _handle_payment_completed(self, query):\n        \"\"\"Handle payment completed confirmation\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        payment_info = self.user_sessions[user_id].get('payment_info')\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\\n\"\n                \"Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Generate final invoice\n        discount_rate = self.pricing_manager.discount_rates.get(\n            payment_info['payment_type'], 0)\n        invoice_text = self.pricing_manager.generate_final_invoice(\n            cart_items, customer, payment_info['payment_method'],\n            discount_rate)\n\n        # Send to group if configured\n        if self.config.order_group_chat_id:\n            group_message = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                f\"ğŸ“± ÛŒÙˆØ²Ø±Ù†ÛŒÙ… ØªÙ„Ú¯Ø±Ø§Ù…: @{query.from_user.username or 'Ù†Ø¯Ø§Ø±Ø¯'}\\n\"\n                f\"ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"â° Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª: {persian_numbers(datetime.now().strftime('%Y/%m/%d - %H:%M'))}\\n\\n\"\n                f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"{invoice_text}\\n\\n\"\n                f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø±Ø³Ø§Ù„\")\n\n            # Create admin action buttons for paid orders\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"âœ… ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\",\n                    callback_data=f\"order_contacted_{user_id}\"),\n                InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n                                     callback_data=f\"order_ready_{user_id}\")\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                                callback_data=f\"order_shipped_{user_id}\"),\n                            InlineKeyboardButton(\n                                \"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                                callback_data=f\"order_completed_{user_id}\")\n                        ]]\n\n            try:\n                sent_message = await query.bot.send_message(\n                    chat_id=self.config.order_group_chat_id,\n                    text=group_message,\n                    reply_markup=InlineKeyboardMarkup(keyboard))\n                logger.info(\n                    f\"âœ… Payment info sent to group {self.config.order_group_chat_id}\"\n                )\n                logger.info(f\"Message ID: {sent_message.message_id}\")\n\n                # Store order info for tracking\n                order_info = {\n                    'user_id': user_id,\n                    'customer': customer,\n                    'message_id': sent_message.message_id,\n                    'status': 'paid',\n                    'created_at': datetime.now().isoformat()\n                }\n                self.user_sessions[user_id]['order_info'] = order_info\n\n            except Exception as e:\n                logger.error(\n                    f\"âŒ Error sending payment info to group {self.config.order_group_chat_id}: {e}\"\n                )\n                logger.error(f\"Error type: {type(e).__name__}\")\n                # Send error info to customer for debugging\n                await query.bot.send_message(\n                    chat_id=user_id,\n                    text=\n                    f\"âš ï¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø«Ø¨Øª Ø´Ø¯ Ø§Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯:\\n{str(e)[:200]}\"\n                )\n        else:\n            logger.warning(\n                \"âŒ Order group chat ID is not configured for payment notification\"\n            )\n\n        # Clear cart and payment info\n        self.cart_manager.clear_cart(user_id)\n        if 'payment_info' in self.user_sessions[user_id]:\n            del self.user_sessions[user_id]['payment_info']\n\n        text = (\n            f\"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!\\n\\n\"\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\" Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ù‡ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¯Ø± Ù‡Ù…ÛŒÙ† ØµÙØ­Ù‡ Ø´Ù…Ø§Ø±Ø§ Ø¯Ø±Ø¬Ø±ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø§Ø¯ .\\n\"\n            f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ….\")\n\n        await query.edit_message_text(\n            text,\n            reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    async def _handle_payment_verification(self, query):\n        \"\"\"Handle payment verification\"\"\"\n        user_id = query.from_user.id\n        payment_info = self.user_sessions[user_id].get('payment_info')\n\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Verify payment with ZarinPal\n        verify_result = self.zarinpal.verify_payment(\n            authority=payment_info['authority'], amount=payment_info['amount'])\n\n        if verify_result['success']:\n            # Payment successful\n            customer = self.user_sessions[user_id]['customer']\n            cart_items = self.cart_manager.get_cart(user_id)\n\n            # Generate final invoice\n            discount_rate = self.pricing_manager.discount_rates[\n                payment_info['payment_type']]\n            invoice_text = self.pricing_manager.generate_final_invoice(\n                cart_items, customer, payment_info['payment_method'],\n                discount_rate)\n\n            # Send to group if configured\n            if self.config.order_group_chat_id:\n                group_message = (\n                    f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ - {payment_info['payment_method']}\\n\"\n                    f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                    f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                    f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                    f\"ğŸ†”Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ : {customer['customer_id']}\\n\"\n                    f\"ğŸ“± Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…: @{query.from_user.username or 'Ù†Ø¯Ø§Ø±Ø¯'}\\n\"\n                    f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: {verify_result['ref_id']}\\n\\n\"\n                    f\"{invoice_text}\")\n\n                try:\n                    await query.bot.send_message(\n                        chat_id=self.config.order_group_chat_id,\n                        text=group_message)\n                except Exception as e:\n                    logger.error(\n                        f\"Error sending payment confirmation to group: {e}\")\n\n            # Clear cart and payment info\n            self.cart_manager.clear_cart(user_id)\n            if 'payment_info' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['payment_info']\n\n            text = (f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!\\n\\n\"\n                    f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: {verify_result['ref_id']}\\n\\n\"\n                    f\"ğŸ“ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\\n\"\n                    f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ….\")\n\n            await query.edit_message_text(\n                text,\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n        else:\n            # Payment failed\n            text = (f\"âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯:\\n\"\n                    f\"{verify_result['error']}\\n\\n\"\n                    \"Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯\",\n                    callback_data=\n                    f\"payment_{payment_info['payment_type']}_zarinpal\")\n            ], [\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            await query.edit_message_text(\n                text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_cart_clear(self, query):\n        \"\"\"Handle cart clear\"\"\"\n        user_id = query.from_user.id\n        self.cart_manager.clear_cart(user_id)\n\n        text = \"ğŸ—‘ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ù¾Ø§Ú© Ø´Ø¯.\"\n        keyboard = self.keyboards.get_main_menu(authenticated=True)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_categories(self, query):\n        \"\"\"Handle back to categories\"\"\"\n        await self._handle_start_shopping(query)\n\n    async def _handle_back_to_alphabet(self, query):\n        \"\"\"Handle back to alphabet\"\"\"\n        user_id = query.from_user.id\n        category = self.user_sessions[user_id].get('selected_category', 'baby')\n\n        text = f\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_alphabetical_keyboard(category)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_curtain_subcategories(self, query):\n        \"\"\"Handle back to curtain subcategories\"\"\"\n        text = \"ğŸ  Ù¾Ø±Ø¯Ù‡ Ùˆ Ú©ÙˆØ³Ù†\\n\\nÙ…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_curtain_subcategories()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_products(self, query):\n        \"\"\"Handle back to products\"\"\"\n        user_id = query.from_user.id\n        session = self.user_sessions[user_id]\n\n        if 'selected_product' in session:\n            product = session['selected_product']\n\n            # Get price based on category\n            category = product.get('category_id', 'baby')\n            category_info = get_category_info(category)\n            price = category_info.get('price', 4780000)\n\n            text = (f\"ğŸ“¦ {product['name']}\\n\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"ğŸ“ Ø³Ø§ÛŒØ² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n\n            keyboard = self.keyboards.get_size_selection_keyboard(category)\n            await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_alphabet_search(self, query, data):\n        \"\"\"Handle alphabet search button\"\"\"\n        category = data.replace(\"alphabet_search_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected category in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_category'] = category\n\n        category_info = get_category_info(category)\n        category_name = category_info.get('name', category)\n\n        text = f\"{category_name}\\n\\nğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n\n        keyboard = self.keyboards.get_alphabetical_keyboard(category)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_icon_selection(self, query, data):\n        \"\"\"Handle icon-based product selection\"\"\"\n        parts = data.split(\"_\", 2)\n        if len(parts) < 3:\n            await query.edit_message_text(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ†.\")\n            return\n\n        category = parts[1]\n        icon = parts[2]\n\n        # Search products by icon\n        products = search_products_by_icon(category, icon)\n\n        if not products:\n            await query.edit_message_text(\"âŒ Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø¢ÛŒÚ©ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯.\")\n            return\n\n        if len(products) == 1:\n            # Only one product found, select it directly\n            product = products[0]\n            await self._handle_direct_product_selection(\n                query, product, category)\n        else:\n            # Multiple products found, show selection keyboard\n            keyboard = self.keyboards.get_products_keyboard(products, category)\n            await query.edit_message_text(f\"Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø±ØªØ¨Ø·:\",\n                                          reply_markup=keyboard)\n\n    async def _handle_payment_confirmed(self, query, data):\n        \"\"\"Handle payment confirmation from the group\"\"\"\n        # Extract user_id from callback data\n        user_id = int(data.split(\"_\")[2])\n\n        # Get customer info\n        customer = self.user_sessions[user_id]['customer']\n\n        # Send confirmation to customer\n        text = (f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯!\\n\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ….\")\n\n        await query.bot.send_message(\n            chat_id=user_id,\n            text=text,\n            reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n        # Edit message in group to confirm\n        await query.edit_message_text(\n            f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø´ØªØ±ÛŒ {customer['name']} ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.\")\n\n    async def _handle_contact_made(self, query, data):\n        \"\"\"Handle contact confirmation from the group\"\"\"\n        # Extract user_id from callback data\n        user_id = int(data.split(\"_\")[2])\n\n        # Get customer info\n        customer = self.user_sessions[user_id]['customer']\n\n        # Edit message in group to confirm\n        await query.edit_message_text(\n            f\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ {customer['name']} Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.\")\n\n    async def _handle_remind_tomorrow(self, query, data):\n        \"\"\"Handle remind tomorrow request from the group\"\"\"\n        # Extract user_id from callback data\n        user_id = int(data.split(\"_\")[2])\n\n        # Get customer info\n        customer = self.user_sessions[user_id]['customer']\n\n        # Schedule reminder\n        # self.payment_scheduler.schedule_reminder(user_id)\n\n        # Edit message in group to confirm\n        await query.edit_message_text(\n            f\"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ {customer['name']} Ø¨Ø±Ø§ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.\")\n\n    async def _handle_order_contacted(self, query, data):\n        \"\"\"Handle order contacted confirmation\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        # Update message\n        updated_text = f\"ğŸ“ {admin_name} Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª\\n\" + query.message.text\n\n        # Create updated keyboard with remaining options\n        keyboard = [[\n            InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n                                 callback_data=f\"order_ready_{user_id}\"),\n            InlineKeyboardButton(\"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                                 callback_data=f\"order_shipped_{user_id}\")\n        ],\n                    [\n                        InlineKeyboardButton(\n                            \"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                            callback_data=f\"order_completed_{user_id}\"),\n                        InlineKeyboardButton(\n                            \"âŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´\",\n                            callback_data=f\"order_cancelled_{user_id}\")\n                    ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\n                \"ğŸ“ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ù…Ø§ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª. Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª.\")\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_ready(self, query, data):\n        \"\"\"Handle order ready for shipping\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"ğŸ“¦ {admin_name}: Ø³ÙØ§Ø±Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\" + query.message.text\n\n        keyboard = [[\n            InlineKeyboardButton(\"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                                 callback_data=f\"order_shipped_{user_id}\"),\n            InlineKeyboardButton(\"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                                 callback_data=f\"order_completed_{user_id}\")\n        ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!\")\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_shipped(self, query, data):\n        \"\"\"Handle order shipped\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"ğŸšš {admin_name}: Ø³ÙØ§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\" + query.message.text\n\n        keyboard = [[\n            InlineKeyboardButton(\"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                                 callback_data=f\"order_completed_{user_id}\")\n        ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\"ğŸšš Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø±Ø¯.\")\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_completed(self, query, data):\n        \"\"\"Handle order completion\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"âœ… {admin_name}: Ø³ÙØ§Ø±Ø´ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\\n\" + query.message.text\n\n        await query.edit_message_text(updated_text)\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\n                \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!\\nğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ…. Ø§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… Ø§Ø² Ø®Ø±ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§Ø¶ÛŒ Ø¨Ø§Ø´ÛŒØ¯.\"\n            )\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_cancelled(self, query, data):\n        \"\"\"Handle order cancellation\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"âŒ {admin_name}: Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯\\n\" + query.message.text\n\n        await query.edit_message_text(updated_text)\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\n                \"âŒ Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ù„ØºÙˆ Ø´Ø¯.\\nğŸ“ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\"\n            )\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_reminder(self, query, data):\n        \"\"\"Handle order reminder for tomorrow\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"â° {admin_name}: ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\\n\" + query.message.text\n\n        # Keep all original buttons\n        keyboard = [[\n            InlineKeyboardButton(\"âœ… ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\",\n                                 callback_data=f\"order_contacted_{user_id}\"),\n            InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n                                 callback_data=f\"order_ready_{user_id}\")\n        ],\n                    [\n                        InlineKeyboardButton(\n                            \"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                            callback_data=f\"order_shipped_{user_id}\"),\n                        InlineKeyboardButton(\n                            \"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                            callback_data=f\"order_completed_{user_id}\")\n                    ],\n                    [\n                        InlineKeyboardButton(\n                            \"âŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´\",\n                            callback_data=f\"order_cancelled_{user_id}\")\n                    ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_order_status_update(self, query, data):\n        \"\"\"Handle order status update from admin\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª: {data}\")\n\n            # Parse callback data: order_status_ORDER_ID_STATUS\n            parts = data.split(\"_\")\n            if len(parts) < 4:\n                logger.error(f\"âŒ ÙØ±Ù…Øª Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {data}\")\n                await query.answer(\"âŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±\", show_alert=True)\n                return\n\n            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ order_id Ùˆ status Ø§Ø² callback data\n            order_id = parts[2]\n            new_status = parts[3]\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n            logger.info(\n                f\"ğŸ“‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª {new_status} ØªÙˆØ³Ø· {admin_name}\"\n            )\n\n            # Ù¾Ø§Ø³Ø® ÙÙˆØ±ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±\n            await query.answer(\"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...\")\n\n            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø³ÙØ§Ø±Ø´\n            order_data = await self.order_server.get_order_details(order_id)\n            if not order_data:\n                logger.error(f\"âŒ Ø³ÙØ§Ø±Ø´ {order_id} ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n                await query.answer(\"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\", show_alert=True)\n                return\n\n            # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\n            success = await self.order_server.update_order_status(\n                order_id=order_id,\n                new_status=new_status,\n                admin_name=admin_name)\n\n            if success:\n                logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\")\n                status_text = self.order_server._get_status_text(new_status)\n\n                try:\n                    # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡\n                    current_text = query.message.text\n\n                    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ù¾ÛŒØ§Ù…\n                    updated_text = f\"ğŸ“ {admin_name}: ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ '{status_text}' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n{current_text}\"\n\n                    # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯\n                    keyboard = self.order_server._create_admin_buttons(\n                        order_id, order_data['user_id'])\n\n                    await query.edit_message_text(\n                        updated_text,\n                        reply_markup=InlineKeyboardMarkup(keyboard))\n                    logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯\")\n\n                except Exception as edit_error:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡: {edit_error}\")\n                    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\n                    try:\n                        confirmation_message = f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ '{status_text}' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ ØªÙˆØ³Ø· {admin_name}\"\n                        await query.message.reply_text(confirmation_message)\n                        logger.info(f\"âœ… Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                    except Exception as reply_error:\n                        logger.error(\n                            f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªØ§ÛŒÛŒØ¯: {reply_error}\")\n\n            else:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id}\")\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª\", show_alert=True)\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± _handle_order_status_update: {e}\")\n            logger.error(f\"   Data: {data}\")\n            logger.error(\n                f\"   User: {query.from_user.first_name if query.from_user else 'Unknown'}\"\n            )\n\n            try:\n                await query.answer(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´: {str(e)[:30]}\",\n                                   show_alert=True)\n            except Exception as msg_error:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§: {msg_error}\")\n\n    async def _handle_order_details_request(self, query, data):\n        \"\"\"Handle request for order details\"\"\"\n        try:\n            order_id = data.replace(\"order_details_\", \"\")\n            order_data = await self.order_server.get_order_details(order_id)\n\n            if not order_data:\n                await query.answer(\"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n                return\n\n            # Create detailed invoice message\n            customer = order_data.get('customer', {})\n            pricing = order_data.get('pricing', {})\n            cart_items = order_data.get('cart_items', [])\n\n            invoice_text = (\n                f\"ğŸ“‹ ÙØ§Ú©ØªÙˆØ± - {order_id}\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ™ï¸ {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer.get('customer_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {order_data.get('user_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"â° {persian_numbers(order_data.get('created_at', '')[:16].replace('T', ' - '))}\\n\\n\"\n                f\"ğŸ“¦ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:\\n\")\n\n            # Add cart items\n            for i, item in enumerate(cart_items, 1):\n                item_total = item.get('price', 0) * item.get('quantity', 0)\n                invoice_text += (\n                    f\"{persian_numbers(str(i))}. {item.get('product_name', 'Ù…Ø­ØµÙˆÙ„')}\\n\"\n                    f\"   ğŸ“ {item.get('size', 'Ù†Ø§Ù…Ø´Ø®Øµ')} | \"\n                    f\"ğŸ“¦ {persian_numbers(str(item.get('quantity', 0)))} Ø¹Ø¯Ø¯ | \"\n                    f\"ğŸ’° {format_price(item_total)}\\n\")\n\n            # Add pricing\n            invoice_text += (\n                f\"\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ’³ {order_data.get('payment_method', 'Ù†Ù‚Ø¯ÛŒ')}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ“Š {self.order_server._get_status_text(order_data.get('status', 'pending'))}\"\n            )\n\n            # Create management keyboard\n            keyboard = self.order_server._create_admin_buttons(\n                order_id, order_data['user_id'])\n            keyboard.append([\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª\",\n                                     callback_data=\"back_to_daily_orders\")\n            ])\n\n            await query.edit_message_text(\n                invoice_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        except Exception as e:\n            logger.error(f\"Error showing order details: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª\")\n\n    async def _handle_daily_stats_request(self, query):\n        \"\"\"Handle daily statistics request\"\"\"\n        try:\n            stats = await self.order_server.get_orders_statistics()\n            today_orders = await self.order_server.get_todays_orders()\n\n            stats_text = (\n                f\"ğŸ“Š Ø¢Ù…Ø§Ø± Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ“¦ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {persian_numbers(str(len(today_orders)))}\\n\"\n                f\"ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²: {format_price(stats.get('today_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:\\n\"\n                f\"ğŸ“¦ Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª: {persian_numbers(str(stats.get('total_orders', 0)))}\\n\"\n                f\"ğŸ’³ Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯: {format_price(stats.get('total_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n            )\n\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                     callback_data=\"back_to_daily_orders\")\n            ]]\n\n            await query.edit_message_text(\n                stats_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        except Exception as e:\n            logger.error(f\"Error showing daily stats: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±\")\n\n    async def _handle_refresh_daily_orders(self, query):\n        \"\"\"Handle refresh daily orders request\"\"\"\n        await query.answer(\"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...\")\n\n        # Create a fake update object to reuse the _show_daily_orders method\n        class FakeUpdate:\n\n            def __init__(self, message):\n                self.message = message\n\n        fake_update = FakeUpdate(query.message)\n        await self._show_daily_orders(fake_update)\n\n    async def _handle_back_to_daily_orders(self, query):\n        \"\"\"Handle back to daily orders list\"\"\"\n\n        # Create a fake update object to reuse the _show_daily_orders method\n        class FakeUpdate:\n\n            def __init__(self, message):\n                self.message = message\n\n        fake_update = FakeUpdate(query.message)\n        await self._show_daily_orders(fake_update)\n\n    async def _handle_contact_customer_request(self, query, data):\n        \"\"\"Handle request to contact customer\"\"\"\n        try:\n            user_id = int(data.replace(\"contact_customer_\", \"\"))\n\n            contact_message = (\n                f\"ğŸ“ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ\\n\"\n                f\"ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\\n\"\n                f\"Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªÙ„ÙÙ† ÛŒØ§ Ù¾ÛŒØ§Ù… Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\")\n\n            await query.answer(\"âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯\")\n            await query.message.reply_text(contact_message)\n\n        except Exception as e:\n            logger.error(f\"Error handling contact request: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_check_order_status(self, query, data):\n        \"\"\"Handle customer's request to check order status\"\"\"\n        try:\n            order_id = data.replace(\"check_order_status_\", \"\")\n            order_data = await self.order_server.get_order_details(order_id)\n\n            if not order_data:\n                await query.edit_message_text(\n                    \"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                    reply_markup=InlineKeyboardMarkup([[\n                        InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\",\n                                             callback_data=\"main_menu\")\n                    ]]))\n                return\n\n            status_text = self.order_server._get_status_text(\n                order_data[\"status\"])\n            last_update = datetime.fromisoformat(\n                order_data[\"updated_at\"]).strftime(\"%Y/%m/%d - %H:%M\")\n\n            status_message = (\n                f\"ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡: {order_id}\\n\\n\"\n                f\"ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: {status_text}\\n\"\n                f\"â° Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {persian_numbers(last_update)}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {order_data['payment_method']}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(order_data['pricing']['total'])} ØªÙˆÙ…Ø§Ù†\"\n            )\n\n            keyboard = self.order_server._create_customer_support_buttons(\n                order_id)\n\n            await query.edit_message_text(\n                status_message, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        except Exception as e:\n            logger.error(f\"Error checking order status: {e}\")\n            await query.edit_message_text(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\")\n\n    async def _handle_payment_confirmation_from_group(self, query, data):\n        \"\"\"Handle payment confirmation from the payment reminder group\"\"\"\n        try:\n            # Extract schedule_id and payment_number from callback data\n            parts = data.split(\"_\")\n            schedule_id = parts[2]\n            payment_number = int(parts[3])\n\n            # Mark payment as made\n            success = self.payment_scheduler.mark_payment_made(\n                schedule_id, payment_number)\n\n            if success:\n                await query.edit_message_text(query.message.text +\n                                              \"\\n\\nâœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯\")\n                await query.answer(\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\")\n            else:\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª\")\n\n        except Exception as e:\n            logger.error(f\"Error handling payment confirmation: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_contact_made_from_group(self, query, data):\n        \"\"\"Handle contact made confirmation from the payment reminder group\"\"\"\n        try:\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n            await query.edit_message_text(\n                query.message.text + f\"\\n\\nğŸ“ {admin_name} Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª\")\n            await query.answer(\"âœ… ØªÙ…Ø§Ø³ Ø«Ø¨Øª Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"Error handling contact confirmation: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_remind_tomorrow_from_group(self, query, data):\n        \"\"\"Handle remind tomorrow request from the payment reminder group\"\"\"\n        try:\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n            await query.edit_message_text(\n                query.message.text +\n                f\"\\n\\nâ° {admin_name} ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯\")\n            await query.answer(\"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"Error handling remind tomorrow: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_contact_support_request(self, query):\n        \"\"\"Handle customer's request to contact support\"\"\"\n        user_id = query.from_user.id\n        await self.order_server.send_support_contact_info(user_id)\n        await query.answer(\"ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n    async def _handle_faq_request(self, query):\n        \"\"\"Handle customer's request for FAQ\"\"\"\n        user_id = query.from_user.id\n        await self.order_server.send_faq(user_id)\n        await query.answer(\"â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n    async def _handle_sewing_type_selection(self, query, data):\n        \"\"\"Handle sewing type selection for curtains\"\"\"\n        sewing_type = data.replace(\"sewing_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected sewing type in session\n        self.user_sessions[user_id]['selected_sewing_type'] = sewing_type\n\n        sewing_type_name = \"Ù¾Ø§Ù†Ú†\" if sewing_type == \"panch\" else \"Ù†ÙˆØ§Ø±Ø¯ÙˆØ²ÛŒ\"\n\n        text = (f\"âœ… Ù†ÙˆØ¹ Ø¯ÙˆØ®Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {sewing_type_name}\\n\\n\"\n                \"Ø¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¬Ù†Ø³ Ù¾Ø§Ø±Ú†Ø´ Ú†ÛŒ Ø¨Ø§Ø´Ù‡ØŸ\")\n\n        keyboard = self.keyboards.get_fabric_selection_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_fabric_selection(self, query, data):\n        \"\"\"Handle fabric selection for curtains\"\"\"\n        fabric = data.replace(\"fabric_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected fabric in session\n        self.user_sessions[user_id]['selected_fabric'] = fabric\n        category = 'curtain_only'\n        self.user_sessions[user_id]['selected_category'] = category\n\n        # Get price based on fabric\n        price = get_product_price('', category, fabric=fabric)\n\n        fabric_name = \"Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\" if fabric == \"silk_cotton\" else \"Ù…Ø®Ù…Ù„\"\n\n        text = (\n            f\"âœ… Ø¬Ù†Ø³ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {fabric_name}\\n\"\n            f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            \"Ø¹Ø§Ù„ÛŒÙ‡\\n\\n\"\n            \"Ø¹Ø±Ø¶ Ù¾Ø±Ø¯Ù‡ Ù‡Ø§ 135 Ø³Ø§Ù†ØªÛŒ Ù…ØªØ± Ø«Ø§Ø¨Øª Ø§Ø³Øª Ù„Ø·ÙØ§ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ØªÙˆ Ø¨Ù†ÙˆÛŒØ³\"\n        )\n\n        # Set flag for height input\n        self.user_sessions[user_id]['awaiting_curtain_height'] = True\n\n        keyboard = self.keyboards.get_height_input_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_curtain_height_input(self, update, height_text):\n        \"\"\"Handle curtain height input\"\"\"\n        user_id = update.effective_user.id\n\n        try:\n            # Parse height (should be a number)\n            height = float(height_text)\n            if height < 2:\n                await update.message.reply_text(\n                    \"âŒ Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 2 Ù…ØªØ± Ø¨Ø§Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n                return\n\n            # Store height and clear input flag\n            self.user_sessions[user_id]['selected_height'] = height\n            self.user_sessions[user_id]['awaiting_curtain_height'] = False\n\n            # Create custom size string for curtains\n            size = f\"Ø¹Ø±Ø¶: 135 - Ø§Ø±ØªÙØ§Ø¹: {height}Ù…\"\n            self.user_sessions[user_id]['selected_size'] = size\n\n            # Get price based on fabric\n            fabric = self.user_sessions[user_id]['selected_fabric']\n            category = self.user_sessions[user_id]['selected_category']\n\n            if fabric == 'special':  # For bedside curtain\n                product = self.user_sessions[user_id]['selected_product']\n                price = get_product_price(product['id'], category)\n            else:\n                price = get_product_price('', category, fabric=fabric)\n\n            text = (f\"âœ… Ø§Ø±ØªÙØ§Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {height} Ù…ØªØ±\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø­Ø§Ù„Ø§ Ù¾Ø±Ø¯Øª Ú†Ù†Ø¯ Ù‚ÙˆØ§Ø±Ù‡ Ø¨Ø§Ø´Ù‡ØŸ\")\n\n            keyboard = self.keyboards.get_quantity_keyboard()\n            await update.message.reply_text(text, reply_markup=keyboard)\n\n        except ValueError:\n            await update.message.reply_text(\n                \"âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø±ØªÙØ§Ø¹ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 2.5):\")\n\n    async def _handle_back_to_sewing_type(self, query):\n        \"\"\"Handle back to sewing type selection\"\"\"\n        user_id = query.from_user.id\n\n        product = self.user_sessions[user_id].get('selected_product')\n        if product:\n            text = (f\"ğŸ“¦ {product['name']}\\n\\n\"\n                    \"Ø¹Ø§Ù„ÛŒÙ‡ Ú†Ù‡ Ù†ÙˆØ¹ Ø¯ÙˆØ®ØªÛŒ Ù…Ø¯ Ù†Ø¸Ø±ØªÙ‡ØŸ\")\n            keyboard = self.keyboards.get_sewing_type_keyboard()\n            await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_fabric_selection(self, query):\n        \"\"\"Handle back to fabric selection\"\"\"\n        user_id = query.from_user.id\n\n        # Clear height input flag\n        if 'awaiting_curtain_height' in self.user_sessions[user_id]:\n            del self.user_sessions[user_id]['awaiting_curtain_height']\n\n        sewing_type = self.user_sessions[user_id].get('selected_sewing_type',\n                                                      'panch')\n        sewing_type_name = \"Ù¾Ø§Ù†Ú†\" if sewing_type == \"panch\" else \"Ù†ÙˆØ§Ø±Ø¯ÙˆØ²ÛŒ\"\n\n        text = (f\"âœ… Ù†ÙˆØ¹ Ø¯ÙˆØ®Øª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {sewing_type_name}\\n\\n\"\n                \"Ø¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¬Ù†Ø³ Ù¾Ø§Ø±Ú†Ø´ Ú†ÛŒ Ø¨Ø§Ø´Ù‡ØŸ\")\n        keyboard = self.keyboards.get_fabric_selection_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_order_actions(self, query, data):\n        \"\"\"Optimized handler for all order-related actions\"\"\"\n        try:\n            if data.startswith(\"order_contacted_\"):\n                await self._handle_order_contacted(query, data)\n            elif data.startswith(\"order_ready_\"):\n                await self._handle_order_ready(query, data)\n            elif data.startswith(\"order_shipped_\"):\n                await self._handle_order_shipped(query, data)\n            elif data.startswith(\"order_completed_\"):\n                await self._handle_order_completed(query, data)\n            elif data.startswith(\"order_cancelled_\"):\n                await self._handle_order_cancelled(query, data)\n            elif data.startswith(\"order_remind_\"):\n                await self._handle_order_reminder(query, data)\n            else:\n                logger.warning(f\"Unhandled order action: {data}\")\n                await query.answer(\"Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...\")\n        except Exception as e:\n            logger.error(f\"Order action error: {e}\")\n            try:\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´.\")\n            except:\n                pass\n\n    def _is_authenticated(self, user_id: int) -> bool:\n        \"\"\"Check if user is authenticated\"\"\"\n        return (user_id in self.user_sessions\n                and self.user_sessions[user_id].get('authenticated', False))\n\n    async def test_group_connection(self, bot):\n        \"\"\"Test if bot can send messages to the configured group\"\"\"\n        logger.info(\"ğŸ” Testing group connection...\")\n\n        if not self.config.order_group_chat_id:\n            logger.warning(\"âŒ Order group chat ID is not configured\")\n            return False\n\n        try:\n            # Try to get chat info\n            chat = await bot.get_chat(self.config.order_group_chat_id)\n            logger.info(f\"âœ… Group connection successful!\")\n            logger.info(f\"   Title: {chat.title}\")\n            logger.info(f\"   Type: {chat.type}\")\n            logger.info(f\"   ID: {chat.id}\")\n\n            return True\n        except Exception as e:\n            logger.warning(f\"âš ï¸ Group connection test failed: {e}\")\n            logger.info(\n                \"   Note: This is normal during startup - bot will work fine\")\n            return False\n\n    async def get_current_chat_info(self, bot, chat_id):\n        \"\"\"Get detailed info about current chat for debugging\"\"\"\n        try:\n            chat = await bot.get_chat(chat_id)\n            logger.info(f\"ğŸ’¬ Chat Info:\")\n            logger.info(f\"   ID: {chat.id}\")\n            logger.info(f\"   Title: {chat.title}\")\n            logger.info(f\"   Type: {chat.type}\")\n            logger.info(\n                f\"   Description: {getattr(chat, 'description', 'N/A')}\")\n            return chat\n        except Exception as e:\n            logger.error(f\"Error getting chat info: {e}\")\n            return None\n\n    async def _send_invoice_to_group(self, invoice_text, user_id):\n        \"\"\"Send invoice to group after order completion\"\"\"\n        group_chat_id = self.config.order_group_chat_id\n        if not group_chat_id:\n            logger.error(\"Group chat ID not configured.\")\n            return\n\n        try:\n            # Note: self.bot is not available in handlers, we need to get it from context\n            logger.info(\n                f\"Invoice sent to group {group_chat_id} for user {user_id}.\")\n        except Exception as e:\n            logger.error(f\"Failed to send invoice to group: {e}\")\n\n    async def _handle_60day_order_confirmation(self, query):\n        \"\"\"Handle confirmation for 60-day payment orders.\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        payment_info = self.user_sessions[user_id].get('payment_info')\n        if not payment_info or payment_info['payment_type'] != '60day':\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ 60 Ø±ÙˆØ²Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Schedule the 60-day payment reminder\n        total_amount = payment_info['full_amount']\n        advance_paid = payment_info['amount']\n        remaining_amount = total_amount - advance_paid\n        order_id = f\"ORDER_{user_id}_{int(datetime.now().timestamp())}\"\n\n        self.payment_scheduler.add_60day_payment_schedule(\n            user_id=user_id,\n            customer_info=customer,\n            total_amount=total_amount,\n            advance_paid=advance_paid,\n            remaining_amount=remaining_amount,\n            order_id=order_id)\n        logger.info(f\"âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n\n        try:\n            # Create order using order management server\n            order_id = await self.order_server.create_order(\n                user_id=user_id,\n                customer=customer,\n                cart_items=cart_items,\n                payment_method=payment_info['payment_method'],\n                discount_rate=payment_info['discount_rate'])\n\n            # Clear cart and payment info\n            self.cart_manager.clear_cart(user_id)\n            if 'payment_info' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['payment_info']\n\n            # Confirm to customer\n            await query.edit_message_text(\n                f\"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                f\"ğŸ“… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù…Ø§Ø¨Ù‚ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª ÙØ¹Ø§Ù„ Ø´Ø¯.\\n\"\n                f\"ğŸ“ Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù…Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú¯Ø±ÙØª.\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ….\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n            logger.info(\n                f\"âœ… Ø³ÙØ§Ø±Ø´ 60 Ø±ÙˆØ²Ù‡ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id}\"\n            )\n\n        except Exception as e:\n            logger.error(f\"Error in 60-day order confirmation: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    # Pagination handlers\n    async def _handle_baby_page(self, query, data):\n        \"\"\"Handle baby category pagination\"\"\"\n        page = int(data.split(\"_\")[-1])\n        text = \"ğŸ‘¶ Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ²Ø§Ø¯\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n        keyboard = self.keyboards.get_baby_subcategories(page)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_curtain_page(self, query, data):\n        \"\"\"Handle curtain category pagination\"\"\"\n        page = int(data.split(\"_\")[-1])\n        text = \" Ù¾Ø±Ø¯Ù‡\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n        keyboard = self.keyboards.get_curtain_subcategories(page)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_cushion_page(self, query, data):\n        \"\"\"Handle cushion category pagination\"\"\"\n        page = int(data.split(\"_\")[-1])\n        text = \" Ú©ÙˆØ³Ù†\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n        keyboard = self.keyboards.get_cushion_subcategories(page)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_tablecloth_page(self, query, data):\n        \"\"\"Handle tablecloth category pagination\"\"\"\n        page = int(data.split(\"_\")[-1])\n        text = \" ÙØ±Ø´ÛŒÙ†Ù‡\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n        keyboard = self.keyboards.get_tablecloth_subcategories(page)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_alpha_page(self, query, data):\n        \"\"\"Handle alphabet pagination\"\"\"\n        parts = data.split(\"_\")\n        category = parts[2]\n        page = int(parts[3])\n        text = f\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_alphabetical_keyboard(category, page)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_pay_remaining_balance(self, query, data):\n        \"\"\"Handle remaining balance payment request\"\"\"\n        try:\n            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ order_id Ø§Ø² callback data\n            order_id = data.replace(\"pay_remaining_\", \"\")\n            user_id = query.from_user.id\n            \n            logger.info(f\"ğŸ’³ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id} Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}\")\n            \n            # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´\n            order_data = await self.order_server.get_order_details(order_id)\n            if not order_data:\n                await query.edit_message_text(\"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯.\")\n                return\n                \n            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨\n            pricing = order_data.get('pricing', {})\n            total_amount = pricing.get('total', 0)\n            paid_amount = pricing.get('paid_amount', 0)\n            remaining_amount = total_amount - paid_amount\n            \n            customer = order_data.get('customer', {})\n            customer_name = customer.get('name', 'Ù…Ø´ØªØ±ÛŒ Ú¯Ø±Ø§Ù…ÛŒ')\n            \n            # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ù†Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡\n            bank_info = (\n                f\"ğŸ’³ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ {customer_name} Ø¹Ø²ÛŒØ²\\n\"\n                f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´: {order_id}\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„ ÙØ§Ú©ØªÙˆØ±: {format_price(total_amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’³ Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡: {format_price(paid_amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ“Š Ù…Ø§Ù†Ø¯Ù‡ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(remaining_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:\\n\"\n                f\"ğŸª Ø¨Ø§Ù†Ú© Ù…Ù„Øª\\n\"\n                f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨: Û¶Û²Û±Û°Û¸Û¶Û±Û¹Û±ÛµÛ¶Û¸Û±Û²Û°Û²\\n\"\n                f\"ğŸ‘¤ Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: Ø´Ø±Ú©Øª Ø¯Ú©ÙˆØªÛŒÙ†\\n\\n\"\n                f\"ğŸ“¸ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\"\n            )\n            \n            # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø¯Ø± session\n            if user_id not in self.user_sessions:\n                self.user_sessions[user_id] = {}\n            \n            self.user_sessions[user_id]['remaining_payment'] = {\n                'order_id': order_id,\n                'amount': remaining_amount,\n                'awaiting_receipt': True\n            }\n            \n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\", \n                                   callback_data=\"upload_remaining_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", \n                                   callback_data=\"main_menu\")\n            ]]\n            \n            await query.edit_message_text(bank_info, \n                                        reply_markup=InlineKeyboardMarkup(keyboard))\n                                        \n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨: {e}\")\n            await query.edit_message_text(\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n    async def _handle_confirm_remaining_payment(self, query, data):\n        \"\"\"Handle confirmation of remaining balance payment\"\"\"\n        try:\n            user_id = query.from_user.id\n            \n            # Ø¨Ø±Ø±Ø³ÛŒ session\n            if (user_id not in self.user_sessions or \n                'remaining_payment' not in self.user_sessions[user_id] or\n                'receipt_photo' not in self.user_sessions[user_id]):\n                await query.edit_message_text(\"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\")\n                return\n                \n            remaining_payment = self.user_sessions[user_id]['remaining_payment']\n            order_id = remaining_payment['order_id']\n            amount = remaining_payment['amount']\n            receipt_photo = self.user_sessions[user_id]['receipt_photo']\n            \n            # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ Ùˆ Ù…Ø´ØªØ±ÛŒ\n            order_data = await self.order_server.get_order_details(order_id)\n            customer = order_data.get('customer', {})\n            \n            # Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n            if self.config.order_group_chat_id:\n                try:\n                    photo_caption = (\n                        f\"ğŸ’³ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                        f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer.get('customer_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                        f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                        f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                        f\"ğŸ’° Ù…Ø¨Ù„Øº Ù…Ø§Ù†Ø¯Ù‡: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                        f\"â° Ø²Ù…Ø§Ù† Ø§Ø±Ø³Ø§Ù„: {persian_numbers(datetime.now().strftime('%Y/%m/%d - %H:%M'))}\\n\\n\"\n                        f\"âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªØ§ÛŒÛŒØ¯ Ù…Ø¬Ø¯Ø¯ Ø³ÙØ§Ø±Ø´\"\n                    )\n                    \n                    # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯\n                    admin_keyboard = [[\n                        InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ù…Ø¬Ø¯Ø¯ Ø³ÙØ§Ø±Ø´\", \n                                           callback_data=f\"order_status_{order_id}_confirmed\"),\n                        InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\", \n                                           callback_data=f\"order_status_{order_id}_contacted\")\n                    ]]\n                    \n                    await query.bot.send_photo(\n                        chat_id=self.config.order_group_chat_id,\n                        photo=receipt_photo['file_id'],\n                        caption=photo_caption,\n                        reply_markup=InlineKeyboardMarkup(admin_keyboard)\n                    )\n                    logger.info(f\"âœ… ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                    \n                except Exception as e:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: {e}\")\n            \n            # ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ\n            await query.edit_message_text(\n                f\"âœ… ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!\\n\\n\"\n                f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ”„ ÙÛŒØ´ Ø´Ù…Ø§ Ø¨Ù‡ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\"\n                f\"âœ… Ù¾Ø³ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ§ÛŒÛŒØ¯ØŒ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\\n\\n\"\n                f\"ğŸ“ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯\\n\"\n                f\"ğŸ™ Ø§Ø² ØµØ¨Ø± Ùˆ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ…\",\n                reply_markup=InlineKeyboardMarkup([[\n                    InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n                ]])\n            )\n            \n            # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² session\n            if 'remaining_payment' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['remaining_payment']\n            if 'receipt_photo' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['receipt_photo']\n                \n            logger.info(f\"âœ… ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n            \n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨: {e}\")\n            await query.edit_message_text(\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n    async def _handle_upload_remaining_receipt(self, query):\n        \"\"\"Handle upload remaining balance receipt request\"\"\"\n        await query.edit_message_text(\n            \"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Ú†Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\\n\\n\"\n            \"âš ï¸ ÙÙ‚Ø· ØªØµØ§ÙˆÛŒØ± Ø¨Ø§ ÙØ±Ù…Øª JPG, PNG Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ù‡Ø³ØªÙ†Ø¯\\n\\n\"\n            \"Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ØŒ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\",\n            reply_markup=InlineKeyboardMarkup([[\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"main_menu\")\n            ]])\n        )\n\n    async def _handle_check_recipient_selection(self, query, data):\n        \"\"\"Handle admin selection of check recipient\"\"\"\n        try:\n            # Extract recipient and user_id from callback data\n            # Format: check_recipient_{recipient}_{user_id}\n            parts = data.split(\"_\")\n            recipient = parts[2]  # farank, nima, majid, vahid\n            user_id = int(parts[3])\n            \n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n            \n            # Define recipient information\n            recipients = {\n                'farank': {\n                    'name': 'Ø®Ø§Ù†Ù… ÙØ±Ø§Ù†Ú© ØºØ±ÛŒØ¨ÛŒ',\n                    'national_id': '0012311138'\n                },\n                'nima': {\n                    'name': 'Ø¢Ù‚Ø§ÛŒ Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ', \n                    'national_id': '0451640594'\n                },\n                'majid': {\n                    'name': 'Ù…Ø¬ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†',\n                    'national_id': '007335310'\n                },\n                'vahid': {\n                    'name': 'Ø¢Ù‚Ø§ÛŒ ÙˆØ­ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†',\n                    'national_id': '0077860357'\n                }\n            }\n            \n            recipient_info = recipients.get(recipient)\n            if not recipient_info:\n                await query.answer(\"âŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±\", show_alert=True)\n                return\n                \n            # Send message to customer\n            customer_message = (\n                f\"âœ… Ú†Ú© Ø´Ù…Ø§ ØªÙˆØ³Ø· ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ù…ÙˆØ±Ø¯ Ù‚Ø¨ÙˆÙ„ Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª\\n\\n\"\n                f\"ğŸ“ Ù„Ø·ÙØ§Ù‹ Ú†Ú© Ø±Ø§ Ø¨Ù‡ Ø§Ø³Ù… {recipient_info['name']} \"\n                f\"Ø¨Ù‡ Ú©Ø¯ Ù…Ù„ÛŒ: {recipient_info['national_id']} Ø«Ø¨Øª Ú©Ù†ÛŒØ¯\\n\\n\"\n                f\"ğŸ“… ØªØ§ 10 Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ú†Ú© Ø±Ø§ Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ Ø¨Ø®Ø´ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\"\n            )\n            \n            # Customer confirmation keyboard\n            customer_keyboard = [[\n                InlineKeyboardButton(\"âœ… Ú†Ú© Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ Ø§Ù… ÙˆØªØ§ 10 Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ù… Ú©Ø±Ø¯\", \n                                   callback_data=f\"check_customer_confirm_{user_id}\")\n            ]]\n            \n            # Send message to customer\n            try:\n                await self.bot.send_message(\n                    chat_id=user_id,\n                    text=customer_message,\n                    reply_markup=InlineKeyboardMarkup(customer_keyboard)\n                )\n                \n                # Update support group message\n                updated_text = f\"âœ… {admin_name}: Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ù‡ {recipient_info['name']}\\n\" + query.message.caption\n                \n                await query.edit_message_caption(\n                    caption=updated_text,\n                    reply_markup=query.message.reply_markup\n                )\n                \n                await query.answer(f\"âœ… Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ {recipient_info['name']} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                logger.info(f\"Check recipient message sent to customer {user_id} for {recipient_info['name']}\")\n                \n            except Exception as e:\n                logger.error(f\"Error sending check recipient message to customer {user_id}: {e}\")\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…\", show_alert=True)\n                \n        except Exception as e:\n            logger.error(f\"Error handling check recipient selection: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯\", show_alert=True)\n\n    async def _handle_check_customer_confirmation(self, query, data):\n        \"\"\"Handle customer confirmation of check submission\"\"\"\n        try:\n            user_id = int(data.split(\"_\")[-1])\n            \n            if user_id not in self.user_sessions:\n                await query.answer(\"âŒ Ø¬Ù„Ø³Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡\", show_alert=True)\n                return\n                \n            # Get customer and cart info\n            customer = self.user_sessions[user_id]['customer']\n            cart_items = self.cart_manager.get_cart(user_id)\n            check_info = self.user_sessions[user_id].get('check_payment_info', {})\n            \n            # Send invoice and check photo again to support group\n            support_text = (f\"ğŸ”„ ØªØ§ÛŒÛŒØ¯ Ù…Ø¬Ø¯Ø¯ Ú†Ú© Ø§Ø² Ù…Ø´ØªØ±ÛŒ\\n\"\n                           f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                           f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                           f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                           f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                           f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                           f\"ğŸ’° Ù…Ø¨Ù„Øº: {format_price(check_info.get('amount', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                           f\"ğŸ’³ Ø±ÙˆØ´: {check_info.get('payment_method', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\\n\"\n                           f\"âœ… Ù…Ø´ØªØ±ÛŒ ØªØ§ÛŒÛŒØ¯ Ú©Ø±Ø¯ Ú©Ù‡ Ú†Ú© Ø±Ø§ Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯\")\n            \n            # Get stored check photo\n            receipt_photo = self.user_sessions[user_id].get('receipt_photo')\n            \n            if receipt_photo and self.config.order_group_chat_id:\n                # Same admin buttons (no customer confirmation button)\n                keyboard = [\n                    [InlineKeyboardButton(\"ğŸ‘© Ø®Ø§Ù†Ù… ÙØ±Ø§Ù†Ú© ØºØ±ÛŒØ¨ÛŒ\", \n                                       callback_data=f\"check_recipient_farank_{user_id}\")],\n                    [InlineKeyboardButton(\"ğŸ‘¨ Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\", \n                                       callback_data=f\"check_recipient_nima_{user_id}\")],\n                    [InlineKeyboardButton(\"ğŸ‘¨ Ù…Ø¬ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \n                                       callback_data=f\"check_recipient_majid_{user_id}\")],\n                    [InlineKeyboardButton(\"ğŸ‘¨ ÙˆØ­ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \n                                       callback_data=f\"check_recipient_vahid_{user_id}\")]\n                ]\n                \n                await self.bot.send_photo(\n                    chat_id=self.config.order_group_chat_id,\n                    photo=receipt_photo['file_id'],\n                    caption=support_text,\n                    reply_markup=InlineKeyboardMarkup(keyboard)\n                )\n                \n                logger.info(f\"Check photo and invoice resent to support group for user {user_id}\")\n                \n            # Notify customer\n            await query.edit_message_text(\n                \"âœ… Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ± Ùˆ Ø¹Ú©Ø³ Ú†Ú© Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\"\n                \"â° Ù¾Ø³ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒØŒ Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\"\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error handling check customer confirmation: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯\", show_alert=True)\n","size_bytes":179804},"bot/hesabfa_integration.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nHesabfa API Integration\nØ§Ø¯ØºØ§Ù… Ø¨Ø§ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±Ù‡Ø§\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, List, Optional, Any\nfrom datetime import datetime\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\n\nlogger = setup_logger(__name__)\n\nclass HesabfaAPI:\n    \"\"\"Ú©Ù„Ø§Ø³ Ø§Ø¯ØºØ§Ù… Ø¨Ø§ API Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n    \n    def __init__(self, api_key: str = \"\", login_token: str = \"\"):\n        import os\n        self.api_key = api_key or os.getenv(\"HESABFA_API_KEY\", \"WjJ88NUd9rjK6dIUKYilbtCoPFCUFHs8\")\n        self.login_token = login_token or os.getenv(\"HESABFA_LOGIN_TOKEN\", \"\")\n        self.base_url = \"https://app.hesabfa.com/api/v1\"\n        self.headers = {\n            \"Content-Type\": \"application/json\",\n            \"apikey\": self.api_key,\n            \"logintoken\": self.login_token\n        }\n    \n    async def create_invoice(self, order_data: Dict) -> Dict[str, Any]:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_data.get('order_id')}\")\n            \n            # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±\n            invoice_data = self._prepare_invoice_data(order_data)\n            logger.info(f\"ğŸ“‹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯: {json.dumps(invoice_data, ensure_ascii=False, indent=2)}\")\n            \n            # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Ø­Ø³Ø§Ø¨ÙØ§\n            url = f\"{self.base_url}/invoice\"\n            logger.info(f\"ğŸŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡: {url}\")\n            \n            response = requests.post(\n                url, \n                headers=self.headers, \n                json=invoice_data,\n                timeout=60,  # Ø§ÙØ²Ø§ÛŒØ´ timeout Ø¨Ù‡ 60 Ø«Ø§Ù†ÛŒÙ‡\n                verify=True  # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² SSL\n            )\n            \n            logger.info(f\"ğŸ“¡ Ù¾Ø§Ø³Ø® Ø­Ø³Ø§Ø¨ÙØ§: Status={response.status_code}\")\n            \n            if response.status_code == 200:\n                result = response.json()\n                logger.info(f\"ğŸ“„ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø§Ø³Ø®: {json.dumps(result, ensure_ascii=False, indent=2)}\")\n                \n                if result.get(\"Success\"):\n                    invoice_result = result.get(\"Result\", {})\n                    logger.info(f\"âœ… Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯ - ID: {invoice_result.get('Id')}\")\n                    return {\n                        \"success\": True,\n                        \"invoice_id\": invoice_result.get(\"Id\"),\n                        \"invoice_number\": invoice_result.get(\"Number\"),\n                        \"message\": \"Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯\"\n                    }\n                else:\n                    error_msg = result.get(\"ErrorMessage\", \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ\")\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±: {error_msg}\")\n                    return {\n                        \"success\": False,\n                        \"error\": error_msg\n                    }\n            else:\n                response_text = response.text[:500] if response.text else \"Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆØ§\"\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§: HTTP {response.status_code}\")\n                logger.error(f\"   Response: {response_text}\")\n                return {\n                    \"success\": False,\n                    \"error\": f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§: {response.status_code} - {response_text[:100]}\"\n                }\n                \n        except requests.exceptions.Timeout:\n            logger.error(\"âŒ Timeout Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§\")\n            logger.error(f\"   URL: {url}\")\n            logger.warning(\"âš ï¸ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø´Ø¨Ú©Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ - Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ø¨Ú©Ù‡ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯\"\n            }\n        except requests.exceptions.ConnectionError:\n            logger.error(\"âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ÙØ§ - Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯\")\n            logger.error(f\"   URL: {url}\")\n            logger.warning(\"âš ï¸ Ø§Ø² Ù…Ø­ÛŒØ·â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (Ø®Ø§Ø±Ø¬ Ø§Ø² Replit) ØªØ³Øª Ú©Ù†ÛŒØ¯\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ - Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø´Ø¨Ú©Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯\"\n            }\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§: {e}\")\n            logger.error(f\"   Ù†ÙˆØ¹ Ø®Ø·Ø§: {type(e).__name__}\")\n            return {\n                \"success\": False,\n                \"error\": f\"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ: {str(e)}\"\n            }\n    \n    def _prepare_invoice_data(self, order_data: Dict) -> Dict:\n        \"\"\"Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        customer = order_data.get(\"customer\", {})\n        cart_items = order_data.get(\"cart_items\", [])\n        pricing = order_data.get(\"pricing\", {})\n        \n        # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ\n        contact_data = {\n            \"Name\": customer.get(\"name\", \"Ù…Ø´ØªØ±ÛŒ\"),\n            \"Code\": customer.get(\"customer_id\", \"\"),\n            \"City\": customer.get(\"city\", \"\"),\n            \"ContactType\": 1  # 1 = Ù…Ø´ØªØ±ÛŒ\n        }\n        \n        # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±\n        invoice_items = []\n        for item in cart_items:\n            invoice_items.append({\n                \"ItemCode\": item.get(\"product_id\", \"\"),\n                \"ItemName\": item.get(\"product_name\", \"\"),\n                \"Description\": f\"Ø³Ø§ÛŒØ²: {item.get('size', '')}\",\n                \"Quantity\": item.get(\"quantity\", 1),\n                \"UnitPrice\": item.get(\"price\", 0),\n                \"Tax\": 0,  # Ù…Ø§Ù„ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\n                \"Discount\": 0\n            })\n        \n        # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ÙØ§Ú©ØªÙˆØ±\n        invoice_data = {\n            \"Contact\": contact_data,\n            \"InvoiceItems\": invoice_items,\n            \"Number\": order_data.get(\"order_id\", \"\"),\n            \"Date\": datetime.now().strftime(\"%Y/%m/%d\"),\n            \"DueDate\": datetime.now().strftime(\"%Y/%m/%d\"),\n            \"Status\": 0,  # 0 = Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\n            \"Reference\": f\"Ø³ÙØ§Ø±Ø´ ØªÙ„Ú¯Ø±Ø§Ù… - {order_data.get('order_id')}\",\n            \"Notes\": f\"Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {order_data.get('payment_method', '')}\\nÚ©Ø§Ø±Ø¨Ø± ØªÙ„Ú¯Ø±Ø§Ù…: {order_data.get('user_id', '')}\",\n            \"Tag\": \"ØªÙ„Ú¯Ø±Ø§Ù…-Ø¨Ø§Øª\",\n            \"Project\": \"DecoTeen Bot Orders\",\n            \"SalesPerson\": \"Ø±Ø¨Ø§Øª ÙØ±ÙˆØ´\",\n            \"Currency\": \"IRR\"\n        }\n        \n        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ®ÙÛŒÙ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯\n        if pricing.get(\"discount\", 0) > 0:\n            invoice_data[\"Discount\"] = pricing.get(\"discount\", 0)\n            invoice_data[\"DiscountType\"] = 1  # 1 = Ù…Ù‚Ø¯Ø§Ø± Ø«Ø§Ø¨Øª\n        \n        return invoice_data\n    \n    async def create_contact_if_not_exists(self, customer: Dict) -> Dict[str, Any]:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨ Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯\"\"\"\n        try:\n            contact_data = {\n                \"Name\": customer.get(\"name\", \"Ù…Ø´ØªØ±ÛŒ\"),\n                \"Code\": customer.get(\"customer_id\", \"\"),\n                \"City\": customer.get(\"city\", \"\"),\n                \"ContactType\": 1,  # 1 = Ù…Ø´ØªØ±ÛŒ\n                \"Tag\": \"ØªÙ„Ú¯Ø±Ø§Ù…-Ø¨Ø§Øª\",\n                \"Notes\": f\"Ù…Ø´ØªØ±ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…\"\n            }\n            \n            url = f\"{self.base_url}/contact\"\n            response = requests.post(url, headers=self.headers, json=contact_data)\n            \n            if response.status_code == 200:\n                result = response.json()\n                if result.get(\"Success\"):\n                    logger.info(f\"âœ… Ù…Ø®Ø§Ø·Ø¨ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯: {customer.get('name')}\")\n                    return {\n                        \"success\": True,\n                        \"contact_id\": result.get(\"Result\", {}).get(\"Id\")\n                    }\n                else:\n                    # Ø§Ú¯Ø± Ù…Ø®Ø§Ø·Ø¨ Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªØŒ Ø®Ø·Ø§ Ù†ÛŒØ³Øª\n                    logger.info(f\"â„¹ï¸ Ù…Ø®Ø§Ø·Ø¨ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª: {customer.get('name')}\")\n                    return {\"success\": True}\n            else:\n                logger.warning(f\"âš ï¸ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨: HTTP {response.status_code}\")\n                return {\"success\": False}\n                \n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨: {e}\")\n            return {\"success\": False}\n    \n    async def get_invoice_status(self, invoice_id: str) -> Dict[str, Any]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        try:\n            url = f\"{self.base_url}/invoice/{invoice_id}\"\n            response = requests.get(url, headers=self.headers)\n            \n            if response.status_code == 200:\n                result = response.json()\n                if result.get(\"Success\"):\n                    return {\n                        \"success\": True,\n                        \"invoice\": result.get(\"Result\")\n                    }\n            \n            return {\"success\": False}\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ±: {e}\")\n            return {\"success\": False}\n    \n    async def update_invoice_status(self, invoice_id: str, status: int) -> Dict[str, Any]:\n        \"\"\"Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        try:\n            # 0 = Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±ØŒ 1 = ÙØ§Ú©ØªÙˆØ±ØŒ 2 = Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡\n            url = f\"{self.base_url}/invoice/{invoice_id}\"\n            data = {\"Status\": status}\n            \n            response = requests.put(url, headers=self.headers, json=data)\n            \n            if response.status_code == 200:\n                result = response.json()\n                if result.get(\"Success\"):\n                    logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± {invoice_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯\")\n                    return {\"success\": True}\n            \n            return {\"success\": False}\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ±: {e}\")\n            return {\"success\": False}\n","size_bytes":10917},"bot/keyboards.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBot Keyboards\nManages all inline keyboards for the Telegram bot.\n\"\"\"\n\nfrom telegram import InlineKeyboardButton, InlineKeyboardMarkup\nfrom typing import List, Dict, Any\nfrom data.product_data import PERSIAN_ALPHABET, get_category_product_icons, search_products_by_icon\n\n\nclass BotKeyboards:\n    \"\"\"Class to manage all bot keyboards\"\"\"\n\n    def get_main_menu(self,\n                      authenticated: bool = False) -> InlineKeyboardMarkup:\n        \"\"\"Get main menu keyboard\"\"\"\n        buttons = []\n\n        if authenticated:\n            buttons.extend([[\n                InlineKeyboardButton(\"ğŸ›’ Ø´Ø±ÙˆØ¹ Ø®Ø±ÛŒØ¯\",\n                                     callback_data=\"start_shopping\")\n            ], [\n                InlineKeyboardButton(\"ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯\", callback_data=\"view_cart\")\n            ],\n                            [\n                                InlineKeyboardButton(\n                                    \"ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ±\",\n                                    callback_data=\"view_invoice\")\n                            ]])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_categories_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get main product categories keyboard\"\"\"\n        buttons = [\n            [\n                InlineKeyboardButton(\" Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ²Ø§Ø¯\",\n                                     callback_data=\"category_baby\")\n            ],\n            [\n                InlineKeyboardButton(\" Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ¬ÙˆØ§Ù†\",\n                                     callback_data=\"category_teen\")\n            ],\n            [\n                InlineKeyboardButton(\"Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ø¨Ø²Ø±Ú¯Ø³Ø§Ù„\",\n                                     callback_data=\"category_adult\")\n            ],\n            [\n                InlineKeyboardButton(\" Ù¾Ø±Ø¯Ù‡\",\n                                     callback_data=\"category_curtain_only\")\n            ],\n            [InlineKeyboardButton(\" Ú©ÙˆØ³Ù† \", callback_data=\"category_cushion\")],\n            [\n                InlineKeyboardButton(\" ÙØ±Ø´ÛŒÙ†Ù‡\",\n                                     callback_data=\"category_tablecloth\")\n            ],\n            [InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")]\n        ]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_curtain_subcategories(self, page: int = 0) -> InlineKeyboardMarkup:\n        \"\"\"Get curtain subcategories keyboard with icon navigation and pagination\"\"\"\n        buttons = []\n\n        # Get product icons for curtain_only category\n        product_icons = get_category_product_icons('curtain_only')\n\n        # Pagination settings\n        items_per_page = 8  # 4 rows * 2 buttons\n        start_idx = page * items_per_page\n        end_idx = start_idx + items_per_page\n        page_icons = product_icons[start_idx:end_idx]\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(page_icons):\n            button_text = description\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add pagination buttons\n        nav_row = []\n        total_pages = (len(product_icons) + items_per_page -\n                       1) // items_per_page\n\n        if page > 0:\n            nav_row.append(\n                InlineKeyboardButton(\"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„\",\n                                     callback_data=f\"curtain_page_{page-1}\"))\n\n        if page < total_pages - 1:\n            nav_row.append(\n                InlineKeyboardButton(\"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\",\n                                     callback_data=f\"curtain_page_{page+1}\"))\n\n        if nav_row:\n            buttons.append(nav_row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_curtain_only\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_curtain_only_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get curtain only subcategories keyboard with icon navigation\"\"\"\n        buttons = []\n\n        # Get product icons for curtain_only category\n        product_icons = get_category_product_icons('curtain_only')\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_curtain_only\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_curtain_subcategories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_cushion_subcategories(self, page: int = 0) -> InlineKeyboardMarkup:\n        \"\"\"Get cushion subcategories keyboard with icon navigation and pagination\"\"\"\n        buttons = []\n\n        # Get product icons for cushion category\n        product_icons = get_category_product_icons('cushion')\n\n        # Pagination settings (Ú©ÙˆØ³Ù† Ú©Ù… Ù…Ø­ØµÙˆÙ„ Ø¯Ø§Ø±Ø¯ - 6 ØªØ§)\n        items_per_page = 6  # Ù‡Ù…Ù‡ Ø¯Ø± ÛŒÚ© ØµÙØ­Ù‡\n        start_idx = page * items_per_page\n        end_idx = start_idx + items_per_page\n        page_icons = product_icons[start_idx:end_idx]\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(page_icons):\n            button_text = description\n            callback_data = f\"icon_cushion_{icon}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add pagination buttons (if needed)\n        nav_row = []\n        total_pages = (len(product_icons) + items_per_page -\n                       1) // items_per_page\n\n        if page > 0:\n            nav_row.append(\n                InlineKeyboardButton(\"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„\",\n                                     callback_data=f\"cushion_page_{page-1}\"))\n\n        if page < total_pages - 1:\n            nav_row.append(\n                InlineKeyboardButton(\"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\",\n                                     callback_data=f\"cushion_page_{page+1}\"))\n\n        if nav_row:\n            buttons.append(nav_row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_cushion\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_baby_subcategories(self, page: int = 0) -> InlineKeyboardMarkup:\n        \"\"\"Get baby subcategories keyboard with icon navigation and pagination\"\"\"\n        buttons = []\n\n        # Get product icons for baby category\n        product_icons = get_category_product_icons('baby')\n\n        # Pagination settings\n        items_per_page = 8  # 4 rows * 2 buttons\n        start_idx = page * items_per_page\n        end_idx = start_idx + items_per_page\n        page_icons = product_icons[start_idx:end_idx]\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(page_icons):\n            button_text = description\n            callback_data = f\"icon_baby_{icon}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add pagination buttons\n        nav_row = []\n        total_pages = (len(product_icons) + items_per_page -\n                       1) // items_per_page\n\n        if page > 0:\n            nav_row.append(\n                InlineKeyboardButton(\"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„\",\n                                     callback_data=f\"baby_page_{page-1}\"))\n\n        if page < total_pages - 1:\n            nav_row.append(\n                InlineKeyboardButton(\"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\",\n                                     callback_data=f\"baby_page_{page+1}\"))\n\n        if nav_row:\n            buttons.append(nav_row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_baby\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_teen_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get teen subcategories keyboard with size selection\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ²\",\n                                 callback_data=\"size_selection_teen\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                            callback_data=\"back_to_categories\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_adult_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get adult subcategories keyboard with size selection\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ²\",\n                                 callback_data=\"size_selection_adult\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                            callback_data=\"back_to_categories\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_tablecloth_subcategories(self,\n                                     page: int = 0) -> InlineKeyboardMarkup:\n        \"\"\"Get tablecloth subcategories keyboard with icon navigation and pagination\"\"\"\n        buttons = []\n\n        # Get product icons for tablecloth category\n        product_icons = get_category_product_icons('tablecloth')\n\n        # Pagination settings\n        items_per_page = 8  # 4 rows * 2 buttons\n        start_idx = page * items_per_page\n        end_idx = start_idx + items_per_page\n        page_icons = product_icons[start_idx:end_idx]\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(page_icons):\n            button_text = description  # Remove icon from button text\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add pagination buttons\n        nav_row = []\n        total_pages = (len(product_icons) + items_per_page -\n                       1) // items_per_page\n\n        if page > 0:\n            nav_row.append(\n                InlineKeyboardButton(\n                    \"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„\", callback_data=f\"tablecloth_page_{page-1}\"))\n\n        if page < total_pages - 1:\n            nav_row.append(\n                InlineKeyboardButton(\n                    \"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\", callback_data=f\"tablecloth_page_{page+1}\"))\n\n        if nav_row:\n            buttons.append(nav_row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_tablecloth\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_alphabetical_keyboard(self,\n                                  category: str,\n                                  page: int = 0) -> InlineKeyboardMarkup:\n        \"\"\"Get alphabetical search keyboard with pagination\"\"\"\n        buttons = []\n        row = []\n\n        # Pagination settings\n        letters_per_page = 16  # 4 rows * 4 letters\n        start_idx = page * letters_per_page\n        end_idx = start_idx + letters_per_page\n        page_letters = PERSIAN_ALPHABET[start_idx:end_idx]\n\n        for i, letter in enumerate(page_letters):\n            # Create consistent callback data format\n            callback_data = f\"alpha_{category}_{letter}\"\n            row.append(\n                InlineKeyboardButton(letter, callback_data=callback_data))\n\n            # Create rows of 4 buttons each\n            if (i + 1) % 4 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining buttons if any\n        if row:\n            buttons.append(row)\n\n        # Add pagination buttons\n        nav_row = []\n        total_pages = (len(PERSIAN_ALPHABET) + letters_per_page -\n                       1) // letters_per_page\n\n        if page > 0:\n            nav_row.append(\n                InlineKeyboardButton(\n                    \"â¬…ï¸ ØµÙØ­Ù‡ Ù‚Ø¨Ù„\",\n                    callback_data=f\"alpha_page_{category}_{page-1}\"))\n\n        if page < total_pages - 1:\n            nav_row.append(\n                InlineKeyboardButton(\n                    \"â¡ï¸ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\",\n                    callback_data=f\"alpha_page_{category}_{page+1}\"))\n\n        if nav_row:\n            buttons.append(nav_row)\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_products_keyboard(self, products: List[Dict],\n                              category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get products list keyboard\"\"\"\n        buttons = []\n\n        for product in products:\n            button_text = product['name']\n            callback_data = f\"product_{product['id']}\"\n            buttons.append([\n                InlineKeyboardButton(button_text, callback_data=callback_data)\n            ])\n\n        # Add navigation buttons\n        buttons.append(\n            [InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_category_products_keyboard(self,\n                                       category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get category products keyboard with icons\"\"\"\n        buttons = []\n\n        # Get product icons for this category\n        product_icons = get_category_product_icons(category)\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=f\"alphabet_search_{category}\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_size_selection_keyboard(self,\n                                    category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get size selection keyboard based on category\"\"\"\n        if category == 'baby':\n            # Baby category: only 75Ã—160\n            sizes = [\"75Ã—160\"]\n        elif category in ['teen', 'adult']:\n            # Teen and adult: specific sizes as requested\n            if category == 'teen':\n                sizes = [\n                    \"90Ã—200\",\n                    \"100Ã—200\",\n                    \"120Ã—200\",\n                ]\n            else:  # category == 'adult'\n                sizes = [\n                    \"140Ã—200\",\n                    \"160Ã—200\",\n                    \"180Ã—200\",\n                ]\n        elif category == 'tablecloth':\n            # Tablecloth category: custom sizes with different prices\n            sizes = [\"120Ã—80\", \"100Ã—100\", \"100Ã—150\", \"120Ã—180\"]\n        else:\n            # Default sizes for other categories\n            sizes = [\n                \"140Ã—200\",\n                \"160Ã—200\",\n                \"180Ã—200\",\n            ]\n\n        buttons = []\n        row = []\n\n        for i, size in enumerate(sizes):\n            row.append(\n                InlineKeyboardButton(size,\n                                     callback_data=f\"size_{size}_{category}\"))\n\n            # Create rows of 3 buttons each for better layout with more sizes\n            if (i + 1) % 3 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining buttons if any\n        if row:\n            buttons.append(row)\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_sewing_type_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get sewing type selection keyboard for curtains\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"Ù¾Ø§Ù†Ú†\", callback_data=\"sewing_panch\"),\n            InlineKeyboardButton(\"Ù†ÙˆØ§Ø±Ø¯ÙˆØ²ÛŒ\", callback_data=\"sewing_navardozi\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                            callback_data=\"back_to_categories\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_fabric_selection_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get fabric selection keyboard for curtains\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\",\n                                 callback_data=\"fabric_silk_cotton\"),\n            InlineKeyboardButton(\"Ù…Ø®Ù…Ù„\", callback_data=\"fabric_velvet\")\n        ],\n                   [\n                       InlineKeyboardButton(\n                           \"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_sewing_type\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_height_input_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get height input keyboard for curtains\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_fabric_selection\")\n        ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_quantity_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get quantity selection keyboard\"\"\"\n        buttons = []\n        row = []\n\n        # Quantities 1-10\n        for i in range(1, 11):\n            row.append(InlineKeyboardButton(str(i), callback_data=f\"qty_{i}\"))\n\n            # Create rows of 5 buttons each\n            if i % 5 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add navigation buttons\n        buttons.append([\n            InlineKeyboardButton(\" Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_products\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_payment_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get payment options keyboard\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\" Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (Û³Û°Ùª ØªØ®ÙÛŒÙ)\",\n                                 callback_data=\"payment_cash_card\")\n        ],\n                   [\n                       InlineKeyboardButton(\" Ù¾Ø±Ø¯Ø§Ø®Øª Û¶Û° Ø±ÙˆØ² (Û²ÛµÙª ØªØ®ÙÛŒÙ)\",\n                                            callback_data=\"payment_60day_card\")\n                   ],\n                   [\n                       InlineKeyboardButton(\n                           \" Ù¾Ø±Ø¯Ø§Ø®Øª Û¹Û° Ø±ÙˆØ² (Û²ÛµÙª ØªØ®ÙÛŒÙ + Û²ÛµÙª Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª)\",\n                           callback_data=\"payment_90day_card\")\n                   ],\n                   [\n                       InlineKeyboardButton(\" Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯\",\n                                            callback_data=\"view_cart\")\n                   ],\n                   [\n                       InlineKeyboardButton(\" Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\",\n                                            callback_data=\"main_menu\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_cart_management_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get cart management keyboard\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\" Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ±\",\n                                 callback_data=\"view_invoice\")\n        ], [\n            InlineKeyboardButton(\" Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯\", callback_data=\"start_shopping\")\n        ], [InlineKeyboardButton(\" Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯\", callback_data=\"cart_clear\")\n            ], [InlineKeyboardButton(\" Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_payment_type_keyboard(self,\n                                  payment_method: str) -> InlineKeyboardMarkup:\n        \"\"\"Get payment type selection keyboard (Cash vs Check)\"\"\"\n        buttons = [\n            [\n                InlineKeyboardButton(\n                    \" Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\",\n                    callback_data=f\"payment_type_cash_{payment_method}\")\n            ],\n            [\n                InlineKeyboardButton(\n                    \" Ù¾Ø±Ø¯Ø§Ø®Øª Ú†Ú©ÛŒ\",\n                    callback_data=f\"payment_type_check_{payment_method}\")\n            ], [InlineKeyboardButton(\" Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")]\n        ]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_cash_payment_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get cash payment confirmation keyboard\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\" Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\",\n                                 callback_data=\"upload_receipt\")\n        ], [InlineKeyboardButton(\" Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_check_payment_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get check payment keyboard\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\" Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ú†Ú©\",\n                                 callback_data=\"upload_check_photo\")\n        ],\n                   [\n                       InlineKeyboardButton(\" Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\",\n                                            callback_data=\"check_follow_up\")\n                   ],\n                   [\n                       InlineKeyboardButton(\" Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                            callback_data=\"view_invoice\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_check_confirmation_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get check confirmation keyboard after admin message\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"âœ… Ú†Ú© Ø±Ø§ Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡\",\n                                 callback_data=\"confirm_check_submission\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ú†Ú© Ø¬Ø¯ÛŒØ¯\",\n                                            callback_data=\"upload_check_photo\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n","size_bytes":25416},"bot/order_server.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nOrder Management Server\nØ³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\n\"\"\"\n\nimport json\nimport os\nfrom datetime import datetime\nfrom typing import Dict, List, Optional, Any\nfrom telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup\nfrom bot.config import Config\nfrom bot.pricing import PricingManager\nfrom bot.hesabfa_integration import HesabfaAPI\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\n\nlogger = setup_logger(__name__)\n\nclass OrderStatus:\n    \"\"\"ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø³ÙØ§Ø±Ø´\"\"\"\n    PENDING = \"pending\"           # Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±\n    CONTACTED = \"contacted\"       # ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\n    CONFIRMED = \"confirmed\"       # ØªØ§ÛŒÛŒØ¯ Ø´Ø¯\n    PREPARING = \"preparing\"       # Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ\n    READY = \"ready\"              # Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\n    SHIPPED = \"shipped\"          # Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\n    DELIVERED = \"delivered\"      # ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯\n    COMPLETED = \"completed\"      # ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\n    CANCELLED = \"cancelled\"      # Ù„ØºÙˆ Ø´Ø¯\n\nclass OrderManagementServer:\n    \"\"\"Ø³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª\"\"\"\n\n    def __init__(self):\n        self.config = Config()\n        self.pricing_manager = PricingManager()\n        self.hesabfa_api = HesabfaAPI()\n        self.orders_dir = \"order_data\"\n        self.bot = None\n\n        # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\n        os.makedirs(self.orders_dir, exist_ok=True)\n\n        # Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ\n        self.status_messages = {\n            OrderStatus.PENDING: \"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Øª.\",\n            OrderStatus.CONTACTED: \"ğŸ”„ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªÙˆØ³Ø· ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø¯Ø±Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø§Ø³Øª.\",\n            OrderStatus.CONFIRMED: \"âœ… Ø¹Ø§Ù„ÛŒÙ‡! Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªÙˆØ³Ø· ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.\\nğŸ“ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\\nğŸ¦ Ø³Ø¹ÛŒ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.\",\n            OrderStatus.PREPARING: \"ğŸ”§ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³Øª.\",\n            OrderStatus.READY: \"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!\",\n            OrderStatus.SHIPPED: \"ğŸšš Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ø² Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¯Ú©ÙˆØªÛŒÙ† Ù…Ù…Ù†ÙˆÙ†ÛŒÙ… Ùˆ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.\",\n            OrderStatus.DELIVERED: \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.\",\n            OrderStatus.COMPLETED: \"ğŸ‰ Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± ØµÙ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒØ¨Ø§Ø´Ø¯.\",\n            OrderStatus.CANCELLED: \"\"  # Ù¾ÛŒØ§Ù… Ø®Ø§Øµ Ø¯Ø± Ù…ØªØ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\n        }\n\n    def set_bot(self, bot: Bot):\n        \"\"\"ØªÙ†Ø¸ÛŒÙ… bot instance\"\"\"\n        self.bot = bot\n\n    async def generate_order_id(self) -> str:\n        \"\"\"Public method to generate order ID\"\"\"\n        return self._generate_order_id(0)  # Use 0 as default user_id for check orders\n\n    async def save_order(self, order_id: str, user_id: int, customer: dict, cart_items: list, payment_info: dict):\n        \"\"\"Public method to save order\"\"\"\n        order_data = {\n            'order_id': order_id,\n            'user_id': user_id,\n            'customer': customer,\n            'cart_items': cart_items,\n            'payment_info': payment_info,\n            'status': OrderStatus.PENDING,\n            'created_at': datetime.now().isoformat()\n        }\n        await self._save_order(order_data)\n\n    def _get_order_file_path(self, order_id: str) -> str:\n        \"\"\"Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø³ÙØ§Ø±Ø´\"\"\"\n        return os.path.join(self.orders_dir, f\"order_{order_id}.json\")\n\n    def _generate_order_id(self, user_id: int) -> str:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ø³ÙØ§Ø±Ø´\"\"\"\n        # Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø³Ø§Ø¯Ù‡\n        counter_file = os.path.join(self.orders_dir, \"order_counter.txt\")\n\n        try:\n            # Ø®ÙˆØ§Ù†Ø¯Ù† Ø´Ù…Ø§Ø±Ù‡ ÙØ¹Ù„ÛŒ\n            if os.path.exists(counter_file):\n                with open(counter_file, 'r') as f:\n                    counter = int(f.read().strip())\n            else:\n                counter = 0\n\n            # Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡\n            counter += 1\n\n            # Ø°Ø®ÛŒØ±Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø¯ÛŒØ¯\n            with open(counter_file, 'w') as f:\n                f.write(str(counter))\n\n            return f\"{counter:05d}\"  # Ø´Ù…Ø§Ø±Ù‡ 5 Ø±Ù‚Ù…ÛŒ: 00001, 00002, ...\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {e}\")\n            # fallback to timestamp\n            timestamp = datetime.now().strftime(\"%H%M%S\")\n            return f\"ORD{timestamp}\"\n\n    async def create_order(self, user_id: int, customer: Dict, cart_items: List[Dict],\n                          payment_method: str, discount_rate: float = 0, receipt_photo_id: str = None) -> str:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯\"\"\"\n        try:\n            order_id = self._generate_order_id(user_id)\n\n            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§\n            subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n            discount = self.pricing_manager.calculate_discount(subtotal, discount_rate)\n            tax = self.pricing_manager.calculate_tax(subtotal - discount)\n            total = subtotal - discount + tax\n\n            # Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´\n            order_data = {\n                \"order_id\": order_id,\n                \"user_id\": user_id,\n                \"customer\": customer,\n                \"cart_items\": cart_items,\n                \"payment_method\": payment_method,\n                \"pricing\": {\n                    \"subtotal\": subtotal,\n                    \"discount_rate\": discount_rate,\n                    \"discount\": discount,\n                    \"tax\": tax,\n                    \"total\": total\n                },\n                \"status\": OrderStatus.PENDING,\n                \"created_at\": datetime.now().isoformat(),\n                \"updated_at\": datetime.now().isoformat(),\n                \"status_history\": [\n                    {\n                        \"status\": OrderStatus.PENDING,\n                        \"timestamp\": datetime.now().isoformat(),\n                        \"note\": \"Ø³ÙØ§Ø±Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯\"\n                    }\n                ]\n            }\n\n            # Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´\n            await self._save_order(order_data)\n\n            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n            await self._send_invoice_to_support_group(order_data, receipt_photo_id)\n\n            # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\n            await self._notify_customer(user_id, OrderStatus.PENDING, order_id)\n\n            logger.info(f\"Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: {order_id}\")\n            return order_id\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´: {e}\")\n            raise\n\n    async def _save_order(self, order_data_or_id, order_data=None):\n        \"\"\"Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´ Ø¯Ø± ÙØ§ÛŒÙ„\"\"\"\n        if order_data is None:\n            # Ø§Ú¯Ø± ÙÙ‚Ø· order_data Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡\n            order_file = self._get_order_file_path(order_data_or_id[\"order_id\"])\n            data_to_save = order_data_or_id\n        else:\n            # Ø§Ú¯Ø± order_id Ùˆ order_data Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡\n            order_file = self._get_order_file_path(order_data_or_id)\n            data_to_save = order_data\n\n        try:\n            with open(order_file, 'w', encoding='utf-8') as f:\n                json.dump(data_to_save, f, ensure_ascii=False, indent=2)\n            return True\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´: {e}\")\n            return False\n\n    async def _send_invoice_to_support_group(self, order_data: Dict, receipt_photo_id: str = None):\n        \"\"\"Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\"\"\"\n        if not self.bot:\n            logger.warning(\"âŒ Bot instance ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\")\n            return\n\n        if not self.config.order_group_chat_id:\n            logger.warning(\"âŒ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\")\n            return\n\n        try:\n            # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\n            try:\n                chat_info = await self.bot.get_chat(self.config.order_group_chat_id)\n                logger.info(f\"âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯: {chat_info.title}\")\n            except Exception as chat_error:\n                logger.error(f\"âŒ Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ {self.config.order_group_chat_id}: {chat_error}\")\n                return\n\n            # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\n            invoice_text = self._generate_invoice_text(order_data)\n\n            # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´\n            keyboard = self._create_admin_buttons(order_data[\"order_id\"], order_data[\"user_id\"])\n\n            # Ø§Ú¯Ø± Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¢Ù† Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†\n            if receipt_photo_id:\n                try:\n                    photo_message = await self.bot.send_photo(\n                        chat_id=self.config.order_group_chat_id,\n                        photo=receipt_photo_id,\n                        caption=\"ğŸ“¸ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ù…Ø´ØªØ±ÛŒ\"\n                    )\n                    logger.info(f\"âœ… Ø¹Ú©Ø³ ÙÛŒØ´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ - Message ID: {photo_message.message_id}\")\n                except Exception as photo_error:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ÙÛŒØ´: {photo_error}\")\n                    # Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø¯Ù† Ø­ØªÛŒ Ø§Ú¯Ø± Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´ÙˆØ¯\n\n            # Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\n            sent_message = await self.bot.send_message(\n                chat_id=self.config.order_group_chat_id,\n                text=invoice_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n            logger.info(f\"âœ… Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´ {order_data['order_id']} Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n            logger.info(f\"   Group ID: {self.config.order_group_chat_id}\")\n            logger.info(f\"   Message ID: {sent_message.message_id}\")\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: {e}\")\n            logger.error(f\"   Order ID: {order_data.get('order_id', 'Unknown')}\")\n            logger.error(f\"   Group ID: {self.config.order_group_chat_id}\")\n            logger.error(f\"   Error type: {type(e).__name__}\")\n\n            # Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯\n            if hasattr(e, 'message'):\n                logger.error(f\"   Error message: {e.message}\")\n\n            # Ø­ØªÛŒ Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´\n\n    def _generate_invoice_text(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"cart_items\"]\n        pricing = order_data[\"pricing\"]\n\n        invoice_text = (\n            f\"ğŸ†• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ø´Ù…Ø§Ø±Ù‡: {order_data['order_id']}\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n            f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n            f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {order_data['user_id']}\\n\"\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {order_data['payment_method']}\\n\"\n            f\"â° Ø²Ù…Ø§Ù† Ø«Ø¨Øª: {persian_numbers('1404/05/14')} - {persian_numbers(datetime.fromisoformat(order_data['created_at']).strftime('%H:%M'))}\\n\\n\"\n            f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n        )\n\n        # Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            )\n\n        # Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ù‚ÛŒÙ…Øª\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ø¬Ù…Ø¹ Ú©Ù„: {format_price(pricing['subtotal'])} ØªÙˆÙ…Ø§Ù†\\n\"\n        )\n\n        if pricing['discount'] > 0:\n            invoice_text += f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(pricing['discount_rate'] * 100)))}Ùª): {format_price(pricing['discount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n\n        invoice_text += (\n            f\"ğŸ“Š Ù…Ø§Ù„ÛŒØ§Øª (Û¹Ùª): {format_price(pricing['tax'])} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’³ Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(pricing['total'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª: {self._get_status_text(order_data['status'])}\"\n        )\n\n        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ÙØ§ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯\n        if order_data.get(\"hesabfa_invoice_id\"):\n            invoice_text += (\n                f\"\\n\\nğŸ¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ÙØ§:\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: {order_data.get('hesabfa_invoice_number', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ†” Ø´Ù†Ø§Ø³Ù‡ ÙØ§Ú©ØªÙˆØ±: {order_data.get('hesabfa_invoice_id')}\"\n            )\n\n        return invoice_text\n\n    def _create_admin_buttons(self, order_id: str, user_id: int) -> List[List[InlineKeyboardButton]]:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡)\"\"\"\n        return [\n            [\n                InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´\", callback_data=f\"order_status_{order_id}_confirmed\"),\n                InlineKeyboardButton(\"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\", callback_data=f\"order_status_{order_id}_contacted\")\n            ],\n            [\n                InlineKeyboardButton(\"ğŸšš Ø³ÙØ§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\", callback_data=f\"order_status_{order_id}_shipped\"),\n                InlineKeyboardButton(\"ğŸ‰ Ø³ÙØ§Ø±Ø´ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\", callback_data=f\"order_status_{order_id}_completed\")\n            ],\n            [\n                InlineKeyboardButton(\"âŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´\", callback_data=f\"order_status_{order_id}_cancelled\")\n            ]\n        ]\n\n    async def update_order_status(self, order_id: str, new_status: str, admin_name: str = \"\") -> bool:\n        \"\"\"Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ {new_status} ØªÙˆØ³Ø· {admin_name}\")\n\n            # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´\n            order_data = await self._load_order(order_id)\n            if not order_data:\n                logger.error(f\"âŒ Ø³ÙØ§Ø±Ø´ {order_id} ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n                return False\n\n            # Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ\n            previous_status = order_data.get('status', OrderStatus.PENDING)\n\n            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª\n            order_data['status'] = new_status\n            order_data['updated_at'] = datetime.now().isoformat()\n            order_data['status_history'] = order_data.get('status_history', [])\n\n            # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡\n            order_data['status_history'].append({\n                'status': new_status,\n                'timestamp': datetime.now().isoformat(),\n                'admin': admin_name,\n                'previous_status': previous_status\n            })\n\n            # Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª\n            success = await self._save_order(order_id, order_data)\n            if not success:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø³ÙØ§Ø±Ø´ {order_id}\")\n                return False\n\n            logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ {new_status} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\")\n\n            # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\n            user_id = order_data.get('user_id')\n            if user_id:\n                logger.info(f\"ğŸ“¤ Ø´Ø±ÙˆØ¹ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id}\")\n                await self._notify_customer(user_id, new_status, order_id, admin_name)\n\n            # Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ†\n            if new_status == OrderStatus.CONFIRMED and not order_data.get(\"hesabfa_invoice_id\"):\n                logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n                import asyncio\n                asyncio.create_task(self._process_hesabfa_invoice(order_id, order_data))\n\n            return True\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id}: {e}\")\n            return False\n\n    async def _load_order(self, order_id: str) -> Optional[Dict]:\n        \"\"\"Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´ Ø§Ø² ÙØ§ÛŒÙ„\"\"\"\n        order_file = self._get_order_file_path(order_id)\n\n        try:\n            if os.path.exists(order_file):\n                with open(order_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            return None\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}: {e}\")\n            return None\n\n    async def _process_hesabfa_invoice(self, order_id: str, order_data: Dict):\n        \"\"\"Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ù‡ ØµÙˆØ±Øª ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù†\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n\n            # Ø§Ø¨ØªØ¯Ø§ Ù…Ø®Ø§Ø·Ø¨ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù† (Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯)\n            contact_result = await self.hesabfa_api.create_contact_if_not_exists(order_data[\"customer\"])\n            logger.info(f\"ğŸ“ Ù†ØªÛŒØ¬Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨: {contact_result.get('success', False)}\")\n\n            # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø§ timeout Ú©ÙˆØªØ§Ù‡â€ŒØªØ±\n            hesabfa_result = await self.hesabfa_api.create_invoice(order_data)\n            logger.info(f\"ğŸ¦ Ù†ØªÛŒØ¬Ù‡ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±: {hesabfa_result}\")\n\n            # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³ÙØ§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\n            current_order = await self._load_order(order_id)\n            if not current_order:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³ÙØ§Ø±Ø´ {order_id}\")\n                return\n\n            if hesabfa_result.get(\"success\"):\n                # Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¯Ø± Ø³ÙØ§Ø±Ø´\n                current_order[\"hesabfa_invoice_id\"] = hesabfa_result.get(\"invoice_id\")\n                current_order[\"hesabfa_invoice_number\"] = hesabfa_result.get(\"invoice_number\")\n\n                # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡\n                hesabfa_entry = {\n                    \"status\": \"hesabfa_created\",\n                    \"timestamp\": datetime.now().isoformat(),\n                    \"admin\": \"Ø³ÛŒØ³ØªÙ…\",\n                    \"note\": f\"Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯ - Ø´Ù…Ø§Ø±Ù‡: {hesabfa_result.get('invoice_number')}\"\n                }\n                current_order[\"status_history\"].append(hesabfa_entry)\n\n                # Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª\n                await self._save_order(current_order)\n\n                logger.info(f\"âœ… Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´ {order_id} Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯\")\n                logger.info(f\"   ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: {hesabfa_result.get('invoice_number')}\")\n                logger.info(f\"   ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø­Ø³Ø§Ø¨ÙØ§: {hesabfa_result.get('invoice_id')}\")\n                logger.info(f\"   ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {order_data['customer']['name']}\")\n            else:\n                error_message = hesabfa_result.get('error', 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ')\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§: {error_message}\")\n\n                # Ø«Ø¨Øª Ø®Ø·Ø§ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡\n                error_entry = {\n                    \"status\": \"hesabfa_error\",\n                    \"timestamp\": datetime.now().isoformat(),\n                    \"admin\": \"Ø³ÛŒØ³ØªÙ…\",\n                    \"note\": f\"Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§: {error_message}\"\n                }\n                current_order[\"status_history\"].append(error_entry)\n                await self._save_order(current_order)\n\n        except Exception as hesabfa_exception:\n            logger.error(f\"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø«Ø¨Øª Ø­Ø³Ø§Ø¨ÙØ§: {hesabfa_exception}\")\n\n            # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø¬Ø¯Ø¯ Ùˆ Ø«Ø¨Øª Ø®Ø·Ø§\n            try:\n                current_order = await self._load_order(order_id)\n                if current_order:\n                    error_entry = {\n                        \"status\": \"hesabfa_error\",\n                        \"timestamp\": datetime.now().isoformat(),\n                        \"admin\": \"Ø³ÛŒØ³ØªÙ…\",\n                        \"note\": f\"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±: {str(hesabfa_exception)[:100]}\"\n                    }\n                    current_order[\"status_history\"].append(error_entry)\n                    await self._save_order(current_order)\n            except Exception as save_error:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø®Ø·Ø§ÛŒ Ø­Ø³Ø§Ø¨ÙØ§: {save_error}\")\n\n    async def _notify_customer_async(self, user_id: int, status: str, order_id: str, admin_name: str = \"\"):\n        \"\"\"Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù† Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\"\"\"\n        try:\n            await self._notify_customer(user_id, status, order_id, admin_name)\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù†: {e}\")\n\n    async def _notify_customer(self, user_id: int, status: str, order_id: str, admin_name: str = \"\"):\n        \"\"\"Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\"\"\"\n        if not self.bot:\n            logger.warning(\"Bot instance ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\")\n            return\n\n        try:\n            logger.info(f\"ğŸ”” Ø´Ø±ÙˆØ¹ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n\n            # Ø¨Ø±Ø±Ø³ÛŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø®Ø§Øµ\n            if status == OrderStatus.CANCELLED:\n                # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ Ùˆ ÙØ§Ú©ØªÙˆØ±\n                order_data = await self._load_order(order_id)\n                customer_name = \"Ù…Ø´ØªØ±ÛŒ Ú¯Ø±Ø§Ù…ÛŒ\"\n                total_amount = 0\n                paid_amount = 0\n                remaining_amount = 0\n\n                if order_data and order_data.get('customer'):\n                    customer_name = order_data['customer'].get('name', 'Ù…Ø´ØªØ±ÛŒ Ú¯Ø±Ø§Ù…ÛŒ')\n                \n                # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø§Ø² Ø±ÙˆÛŒ pricing\n                if order_data and order_data.get('pricing'):\n                    from utils.persian_utils import format_price\n                    pricing = order_data['pricing']\n                    total_amount = pricing.get('total', 0)\n                    # ÙØ±Ø¶ Ú©Ù†ÛŒÙ… Ù…Ø´ØªØ±ÛŒ Ù‚Ø³Ù…ØªÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù‡ (Ù…Ø«Ù„ Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª)\n                    paid_amount = pricing.get('paid_amount', 0)  # Ø§ÛŒÙ† ÙÛŒÙ„Ø¯ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯\n                    remaining_amount = total_amount - paid_amount\n\n                full_message = (\n                    f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡: {order_id}\\n\\n\"\n                    f\"Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ø² Ø´Ø±Ú©Øª Ø¯Ú©ÙˆØªÛŒÙ† Ù…Ù…Ù†ÙˆÙ†ÛŒÙ… {customer_name} Ø¹Ø²ÛŒØ²\\n\\n\"\n                    f\"Ø³Ù‚Ù Ø§Ø¹ØªØ¨Ø§Ø± Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù„Øª Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª\\n\\n\"\n                    f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„ ÙØ§Ú©ØªÙˆØ±: {format_price(total_amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"ğŸ’³ Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡: {format_price(paid_amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"ğŸ“Š Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨: {format_price(remaining_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    f\"Ù„Ø·ÙØ§ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ù†Ù…Ø§ÛŒÛŒØ¯ Ùˆ Ø¨Ø§ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯\\n\\n\"\n                    f\"Ø¨Ø§ ØªØ´Ú©Ø±\\n\"\n                    f\"Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¯Ú©ÙˆØªÛŒÙ† ğŸŒŸ\"\n                )\n            else:\n                message = self.status_messages.get(status, f\"ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ù‡ {status} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.\")\n\n                # Ø§ÙØ²ÙˆØ¯Ù† Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´\n                full_message = (\n                    f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡: {order_id}\\n\"\n                    f\"{message}\\n\"\n                )\n\n                if admin_name and status != OrderStatus.PENDING:\n                    full_message += f\"\\nğŸ‘¤ ØªÙˆØ³Ø·: {admin_name}\"\n\n            # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n            is_cancelled = (status == OrderStatus.CANCELLED)\n            keyboard = self._create_customer_support_buttons(order_id, is_cancelled)\n\n            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ retry\n            max_retries = 3\n            for attempt in range(max_retries):\n                try:\n                    await self.bot.send_message(\n                        chat_id=user_id,\n                        text=full_message,\n                        reply_markup=InlineKeyboardMarkup(keyboard)\n                    )\n                    logger.info(f\"âœ… Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª {status} Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                    return\n                except Exception as send_error:\n                    logger.warning(f\"âš ï¸ ØªÙ„Ø§Ø´ {attempt + 1} Ù†Ø§Ù…ÙˆÙÙ‚: {send_error}\")\n                    if attempt == max_retries - 1:\n                        # Ø¢Ø®Ø±ÛŒÙ† ØªÙ„Ø§Ø´ Ø¨Ø§ Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡\n                        simple_message = f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.\"\n                        await self.bot.send_message(\n                            chat_id=user_id,\n                            text=simple_message\n                        )\n                        logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id}: {e}\")\n            logger.error(f\"   Ø³ÙØ§Ø±Ø´: {order_id}, ÙˆØ¶Ø¹ÛŒØª: {status}\")\n            logger.error(f\"   Ø®Ø·Ø§ÛŒ Ú©Ø§Ù…Ù„: {str(e)}\")\n\n            # ØªÙ„Ø§Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø³ÛŒØ§Ø± Ø³Ø§Ø¯Ù‡\n            try:\n                await self.bot.send_message(\n                    chat_id=user_id,\n                    text=f\"Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.\"\n                )\n                logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n            except:\n                logger.error(f\"âŒ Ø­ØªÛŒ Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ù†ÛŒØ² Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯\")\n\n    def _create_customer_support_buttons(self, order_id: str, is_cancelled: bool = False) -> List[List[InlineKeyboardButton]]:\n        \"\"\"Create customer support buttons for order status\"\"\"\n        if is_cancelled:\n            # Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª Ù„ØºÙˆ Ø´Ø¯Ù‡ ÙÙ‚Ø· Ø¯Ùˆ Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯\n            return [\n                [\n                    InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\", callback_data=\"contact_support\"),\n                    InlineKeyboardButton(\"ğŸ’³ ÙˆØ§Ø±ÛŒØ² Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨\", callback_data=f\"pay_remaining_{order_id}\")\n                ]\n            ]\n        else:\n            # Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ø³ÙØ§Ø±Ø´Ø§Øª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø¯ÛŒ\n            return [\n                [\n                    InlineKeyboardButton(\"ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\", callback_data=f\"check_order_status_{order_id}\"),\n                    InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\", callback_data=\"contact_support\")\n                ],\n                [\n                    InlineKeyboardButton(\"â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\", callback_data=\"faq\")\n                ]\n            ]\n\n    def _get_status_text(self, status: str) -> str:\n        \"\"\"Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª\"\"\"\n        status_texts = {\n            OrderStatus.PENDING: \"Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±\",\n            OrderStatus.CONTACTED: \"Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\",\n            OrderStatus.CONFIRMED: \"ØªØ§ÛŒÛŒØ¯ Ø´Ø¯\",\n            OrderStatus.PREPARING: \"Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ\",\n            OrderStatus.READY: \"Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n            OrderStatus.SHIPPED: \"Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n            OrderStatus.DELIVERED: \"ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯\",\n            OrderStatus.COMPLETED: \"ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n            OrderStatus.CANCELLED: \"Ù„ØºÙˆ Ø´Ø¯\"\n        }\n        return status_texts.get(status, status)\n\n    async def get_order_details(self, order_id: str) -> Optional[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´\"\"\"\n        return await self._load_order(order_id)\n\n    async def get_customer_orders(self, user_id: int) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª ÛŒÚ© Ù…Ø´ØªØ±ÛŒ\"\"\"\n        orders = []\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(f\"order_{user_id}_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n                    if order_data:\n                        orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)\n            orders.sort(key=lambda x: x[\"created_at\"], reverse=True)\n            return orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ù…Ø´ØªØ±ÛŒ {user_id}: {e}\")\n            return []\n\n    async def get_all_orders(self, status_filter: str = None) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª (Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†)\"\"\"\n        orders = []\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(\"order_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n                    if order_data:\n                        if status_filter is None or order_data[\"status\"] == status_filter:\n                            orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)\n            orders.sort(key=lambda x: x[\"created_at\"], reverse=True)\n            return orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª: {e}\")\n            return []\n\n    async def send_support_contact_info(self, user_id: int):\n        \"\"\"Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\"\"\"\n        if not self.bot:\n            return\n\n        try:\n            contact_message = (\n                \"ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\\n\\n\"\n                \"ğŸ• Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ: Ø´Ù†Ø¨Ù‡ ØªØ§ Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡ - Û¹ ØµØ¨Ø­ ØªØ§ Û¶ Ø¹ØµØ±\\n\"\n                \"ğŸ“ ØªÙ„ÙÙ†: Û°Û²Û±-Û±Û²Û³Û´ÛµÛ¶Û·Û¸\\n\"\n                \"ğŸ“± ÙˆØ§ØªØ³Ø§Ù¾: Û°Û¹Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹\\n\"\n                \"âœ‰ï¸ Ø§ÛŒÙ…ÛŒÙ„: support@example.com\\n\\n\"\n                \"âš¡ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø± Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ\"\n            )\n\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            await self.bot.send_message(\n                chat_id=user_id,\n                text=contact_message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³: {e}\")\n\n    async def send_faq(self, user_id: int):\n        \"\"\"Ø§Ø±Ø³Ø§Ù„ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\"\"\"\n        if not self.bot:\n            return\n\n        try:\n            faq_message = (\n                \"â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\\n\\n\"\n                \"ğŸ”¸ Ú†Ù‚Ø¯Ø± Ø·ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ø´Ø¯ ØªØ§ Ø³ÙØ§Ø±Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø´ÙˆØ¯ØŸ\\n\"\n                \"Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Û³ ØªØ§ Ûµ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ\\n\\n\"\n                \"ğŸ”¸ Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ\\n\"\n                \"Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø§Ù„Ø§ÛŒ Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù† Ø±Ø§ÛŒÚ¯Ø§Ù†\\n\\n\"\n                \"ğŸ”¸ Ø¢ÛŒØ§ Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ± ÛŒØ§ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŸ\\n\"\n                \"ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª\\n\\n\"\n                \"ğŸ”¸ Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú©Ù†Ù…ØŸ\\n\"\n                \"Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù‡Ù…ÛŒÙ† Ø±Ø¨Ø§Øª ÛŒØ§ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\"\n            )\n\n            keyboard = [\n                [InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\", callback_data=\"contact_support\")],\n                [InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")]\n            ]\n\n            await self.bot.send_message(\n                chat_id=user_id,\n                text=faq_message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„: {e}\")\n\n    async def get_todays_orders(self) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\"\"\"\n        today_orders = []\n        today_date = datetime.now().strftime(\"%Y-%m-%d\")\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(\"order_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n\n                    if order_data:\n                        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´\n                        order_date = order_data.get('created_at', '')[:10]\n                        if order_date == today_date:\n                            today_orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)\n            today_orders.sort(key=lambda x: x.get('created_at', ''), reverse=True)\n            return today_orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {e}\")\n            return []\n\n    async def get_orders_by_date(self, target_date: str) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® (ÙØ±Ù…Øª: YYYY-MM-DD)\"\"\"\n        date_orders = []\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(\"order_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n\n                    if order_data:\n                        order_date = order_data.get('created_at', '')[:10]\n                        if order_date == target_date:\n                            date_orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯\n            date_orders.sort(key=lambda x: x.get('created_at', ''))\n            return date_orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª ØªØ§Ø±ÛŒØ® {target_date}: {e}\")\n            return []\n\n    async def get_orders_statistics(self) -> Dict:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\"\"\"\n        try:\n            all_orders = await self.get_all_orders()\n            today_orders = await self.get_todays_orders()\n\n            # Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\n            total_orders = len(all_orders)\n            today_count = len(today_orders)\n\n            # Ø¢Ù…Ø§Ø± ÙˆØ¶Ø¹ÛŒØª\n            status_stats = {}\n            total_revenue = 0\n            today_revenue = 0\n\n            for order in all_orders:\n                status = order.get('status', 'pending')\n                status_text = self._get_status_text(status)\n                status_stats[status_text] = status_stats.get(status_text, 0) + 1\n                total_revenue += order.get('pricing', {}).get('total', 0)\n\n            for order in today_orders:\n                today_revenue += order.get('pricing', {}).get('total', 0)\n\n            return {\n                'total_orders': total_orders,\n                'today_orders': today_count,\n                'total_revenue': total_revenue,\n                'today_revenue': today_revenue,\n                'status_distribution': status_stats\n            }\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±: {e}\")\n            return {}","size_bytes":37322},"bot/payment_reminder.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nPayment Reminder System\nAutomated system to send monthly payment reminders for 90-day payment plans.\n\"\"\"\n\nimport asyncio\nfrom datetime import datetime\nfrom telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup\nfrom bot.payment_scheduler import PaymentScheduler\nfrom bot.config import Config\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass PaymentReminderBot:\n    \"\"\"Automated payment reminder system\"\"\"\n    \n    def __init__(self, config: Config):\n        self.config = config\n        self.bot = Bot(token=config.bot_token)\n        self.payment_scheduler = PaymentScheduler()\n    \n    async def send_daily_reminders(self):\n        \"\"\"Check and send daily payment reminders\"\"\"\n        try:\n            pending_reminders = self.payment_scheduler.get_pending_reminders()\n            \n            if not pending_reminders:\n                logger.info(\"No payment reminders due today\")\n                return\n            \n            logger.info(f\"Found {len(pending_reminders)} payment reminders to send\")\n            \n            for reminder in pending_reminders:\n                await self._send_reminder_to_group(reminder)\n                \n        except Exception as e:\n            logger.error(f\"Error sending daily reminders: {e}\")\n    \n    async def _send_reminder_to_group(self, reminder_info):\n        \"\"\"Send payment reminder to order group\"\"\"\n        try:\n            message = self.payment_scheduler.generate_reminder_message(reminder_info)\n            \n            # Create keyboard for payment confirmation\n            keyboard = [\n                [\n                    InlineKeyboardButton(\n                        \"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\",\n                        callback_data=f\"payment_confirmed_{reminder_info['schedule_id']}_{reminder_info['payment_number']}\"\n                    )\n                ],\n                [\n                    InlineKeyboardButton(\n                        \"ğŸ“ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\",\n                        callback_data=f\"contact_made_{reminder_info['schedule_id']}_{reminder_info['payment_number']}\"\n                    )\n                ],\n                [\n                    InlineKeyboardButton(\n                        \"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ±Ø¯Ø§\",\n                        callback_data=f\"remind_tomorrow_{reminder_info['schedule_id']}_{reminder_info['payment_number']}\"\n                    )\n                ]\n            ]\n            \n            await self.bot.send_message(\n                chat_id=self.config.order_group_chat_id,\n                text=message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n            \n            logger.info(f\"Sent payment reminder for user {reminder_info['user_id']}\")\n            \n        except Exception as e:\n            logger.error(f\"Error sending reminder to group: {e}\")\n    \n    async def handle_payment_confirmation(self, schedule_id: str, payment_number: int):\n        \"\"\"Handle payment confirmation from group admin\"\"\"\n        try:\n            success = self.payment_scheduler.mark_payment_made(schedule_id, payment_number)\n            \n            if success:\n                logger.info(f\"Payment {payment_number} confirmed for schedule {schedule_id}\")\n                return \"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\"\n            else:\n                logger.error(f\"Failed to confirm payment {payment_number} for schedule {schedule_id}\")\n                return \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n                \n        except Exception as e:\n            logger.error(f\"Error handling payment confirmation: {e}\")\n            return \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n\nasync def run_daily_reminder_check():\n    \"\"\"Function to run daily reminder check\"\"\"\n    config = Config()\n    reminder_bot = PaymentReminderBot(config)\n    await reminder_bot.send_daily_reminders()\n\nif __name__ == \"__main__\":\n    # Run daily reminder check\n    asyncio.run(run_daily_reminder_check())\n","size_bytes":4009},"bot/payment_scheduler.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nPayment Scheduler for 90-day Payment Plans\nManages monthly reminders for remaining payments.\n\"\"\"\n\nimport json\nimport os\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Any, Optional\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\n\nlogger = setup_logger(__name__)\n\nclass PaymentScheduler:\n    \"\"\"Manages payment schedules and monthly reminders\"\"\"\n\n    def __init__(self, data_dir: str = \"payment_data\"):\n        self.data_dir = data_dir\n        os.makedirs(self.data_dir, exist_ok=True)\n        self.payment_file = os.path.join(self.data_dir, \"payment_schedules.json\")\n\n    def _load_payment_schedules(self) -> Dict[str, Any]:\n        \"\"\"Load payment schedules from file\"\"\"\n        try:\n            if os.path.exists(self.payment_file):\n                with open(self.payment_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            return {}\n        except Exception as e:\n            logger.error(f\"Error loading payment schedules: {e}\")\n            return {}\n\n    def _save_payment_schedules(self, schedules: Dict[str, Any]) -> bool:\n        \"\"\"Save payment schedules to file\"\"\"\n        try:\n            with open(self.payment_file, 'w', encoding='utf-8') as f:\n                json.dump(schedules, f, ensure_ascii=False, indent=2, default=str)\n            return True\n        except Exception as e:\n            logger.error(f\"Error saving payment schedules: {e}\")\n            return False\n\n    def add_60day_payment_schedule(self, user_id: int, customer_info: Dict[str, Any], \n                                 total_amount: float, advance_paid: float, \n                                 remaining_amount: float, order_id: str) -> bool:\n        \"\"\"Add a new 60-day payment schedule\"\"\"\n        schedules = self._load_payment_schedules()\n\n        # Calculate payment date (60 days from now)\n        today = datetime.now()\n        payment_date = (today + timedelta(days=60)).strftime(\"%Y-%m-%d\")\n\n        schedule_id = f\"{user_id}_{order_id}_{int(today.timestamp())}\"\n\n        payment_schedule = {\n            'user_id': user_id,\n            'customer_info': customer_info,\n            'order_id': order_id,\n            'total_amount': total_amount,\n            'advance_paid': advance_paid,\n            'remaining_amount': remaining_amount,\n            'payment_date': payment_date,\n            'payment_type': '60day',\n            'payments_made': [],\n            'created_date': today.strftime(\"%Y-%m-%d\"),\n            'status': 'active'\n        }\n\n        schedules[schedule_id] = payment_schedule\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Added 60-day payment schedule for user {user_id}, order {order_id}\")\n            return True\n        return False\n\n    def add_90day_payment_schedule(self, user_id: int, customer_info: Dict[str, Any], \n                                 total_amount: float, advance_paid: float, \n                                 remaining_amount: float, order_id: str) -> bool:\n        \"\"\"Add a new 90-day payment schedule\"\"\"\n        schedules = self._load_payment_schedules()\n\n        # Calculate monthly payments (remaining amount / 3 months)\n        monthly_amount = remaining_amount / 3\n\n        # Calculate payment dates\n        today = datetime.now()\n        payment_dates = [\n            (today + timedelta(days=30)).strftime(\"%Y-%m-%d\"),\n            (today + timedelta(days=60)).strftime(\"%Y-%m-%d\"),\n            (today + timedelta(days=90)).strftime(\"%Y-%m-%d\")\n        ]\n\n        schedule_id = f\"{user_id}_{order_id}_{int(today.timestamp())}\"\n\n        payment_schedule = {\n            'user_id': user_id,\n            'customer_info': customer_info,\n            'order_id': order_id,\n            'total_amount': total_amount,\n            'advance_paid': advance_paid,\n            'remaining_amount': remaining_amount,\n            'monthly_amount': monthly_amount,\n            'payment_dates': payment_dates,\n            'payments_made': [],\n            'created_date': today.strftime(\"%Y-%m-%d\"),\n            'status': 'active'\n        }\n\n        schedules[schedule_id] = payment_schedule\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Added 90-day payment schedule for user {user_id}, order {order_id}\")\n            return True\n        return False\n\n    def get_pending_reminders(self) -> List[Dict[str, Any]]:\n        \"\"\"Get list of users who need payment reminders today\"\"\"\n        schedules = self._load_payment_schedules()\n        today = datetime.now().strftime(\"%Y-%m-%d\")\n        pending_reminders = []\n\n        for schedule_id, schedule in schedules.items():\n            if schedule['status'] != 'active':\n                continue\n\n            payment_type = schedule.get('payment_type', '90day')\n            \n            if payment_type == '60day':\n                # For 60-day payments: single payment date\n                payment_date = schedule['payment_date']\n                if payment_date == today and not schedule['payments_made']:\n                    reminder_info = {\n                        'schedule_id': schedule_id,\n                        'user_id': schedule['user_id'],\n                        'customer_info': schedule['customer_info'],\n                        'payment_number': 1,\n                        'payment_amount': schedule['remaining_amount'],\n                        'payment_type': '60day',\n                        'payment_date': payment_date\n                    }\n                    pending_reminders.append(reminder_info)\n            else:\n                # For 90-day payments: multiple payment dates\n                for i, payment_date in enumerate(schedule['payment_dates']):\n                    if payment_date == today:\n                        # Check if this payment hasn't been made yet\n                        if i not in schedule['payments_made']:\n                            reminder_info = {\n                                'schedule_id': schedule_id,\n                                'user_id': schedule['user_id'],\n                                'customer_info': schedule['customer_info'],\n                                'payment_number': i + 1,\n                                'monthly_amount': schedule['monthly_amount'],\n                                'remaining_payments': 3 - len(schedule['payments_made']),\n                                'payment_type': '90day',\n                                'payment_date': payment_date\n                            }\n                            pending_reminders.append(reminder_info)\n\n        return pending_reminders\n\n    def mark_payment_made(self, schedule_id: str, payment_number: int) -> bool:\n        \"\"\"Mark a payment as completed\"\"\"\n        schedules = self._load_payment_schedules()\n\n        if schedule_id not in schedules:\n            logger.error(f\"Schedule {schedule_id} not found\")\n            return False\n\n        schedule = schedules[schedule_id]\n        payment_type = schedule.get('payment_type', '90day')\n\n        if payment_type == '60day':\n            # For 60-day payments: mark as completed immediately\n            schedule['payments_made'] = [0]  # Single payment made\n            schedule['status'] = 'completed'\n        else:\n            # For 90-day payments: add payment to made payments list\n            if payment_number - 1 not in schedule['payments_made']:\n                schedule['payments_made'].append(payment_number - 1)\n                schedule['payments_made'].sort()\n\n            # Check if all payments are completed\n            if len(schedule['payments_made']) >= 3:\n                schedule['status'] = 'completed'\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Marked payment {payment_number} as completed for schedule {schedule_id}\")\n            return True\n        return False\n\n    def get_user_payment_schedules(self, user_id: int) -> List[Dict[str, Any]]:\n        \"\"\"Get all payment schedules for a specific user\"\"\"\n        schedules = self._load_payment_schedules()\n        user_schedules = []\n\n        for schedule_id, schedule in schedules.items():\n            if schedule['user_id'] == user_id:\n                user_schedules.append({\n                    'schedule_id': schedule_id,\n                    **schedule\n                })\n\n        return user_schedules\n\n    def generate_reminder_message(self, reminder_info: Dict[str, Any]) -> str:\n        \"\"\"Generate reminder message for payment\"\"\"\n        customer = reminder_info['customer_info']\n        payment_type = reminder_info.get('payment_type', '90day')\n        \n        if payment_type == '60day':\n            amount = reminder_info['payment_amount']\n            message = [\n                \"ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡\",\n                \"=\" * 30,\n                \"\",\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n                f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n                \"\",\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\",\n                f\"ğŸ“… Ø³Ø±Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª: Ø§Ù…Ø±ÙˆØ²\",\n                \"\",\n                \"ğŸ“ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯ ØªØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø§Ù…Ù„ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ø¯.\",\n                \"\",\n                \"Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\"\n            ]\n        else:\n            payment_num = reminder_info['payment_number']\n            amount = reminder_info['monthly_amount']\n            remaining = reminder_info['remaining_payments']\n            \n            message = [\n                \"ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡\",\n                \"=\" * 30,\n                \"\",\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n                f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n                \"\",\n                f\"ğŸ“… Ù‚Ø³Ø· Ø´Ù…Ø§Ø±Ù‡: {persian_numbers(str(payment_num))} Ø§Ø² Û³\",\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø³Ø·: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\",\n                f\"ğŸ“Š Ø§Ù‚Ø³Ø§Ø· Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {persian_numbers(str(remaining - 1))}\",\n                \"\",\n                \"ğŸ“ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯ ØªØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ø¯.\",\n                \"\",\n                \"Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\"\n            ]\n\n        return \"\\n\".join(message)\n\n    def cancel_payment_schedule(self, schedule_id: str) -> bool:\n        \"\"\"Cancel a payment schedule\"\"\"\n        schedules = self._load_payment_schedules()\n\n        if schedule_id not in schedules:\n            logger.error(f\"Schedule {schedule_id} not found\")\n            return False\n\n        schedules[schedule_id]['status'] = 'cancelled'\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Cancelled payment schedule {schedule_id}\")\n            return True\n        return False\n\n    def schedule_payment_reminder(self, user_id: int, customer_name: str, amount: int, due_days: int, order_data: Dict):\n        \"\"\"Schedule a payment reminder\"\"\"\n        try:\n            # Load existing schedules\n            schedules = self._load_payment_schedules()\n\n            # Calculate due date\n            due_date = (datetime.now() + timedelta(days=due_days)).isoformat()\n\n            # Create schedule entry\n            schedule_id = f\"{user_id}_{int(datetime.now().timestamp())}\"\n            schedules[schedule_id] = {\n                'user_id': user_id,\n                'customer_name': customer_name,\n                'amount': amount,\n                'due_date': due_date,\n                'due_days': due_days,\n                'status': 'pending',\n                'created_at': datetime.now().isoformat(),\n                'order_data': order_data\n            }\n\n            # Save schedules\n            if self._save_payment_schedules(schedules):\n                logger.info(f\"Payment reminder scheduled for user {user_id}, due in {due_days} days\")\n                return schedule_id\n            else:\n                return None\n\n\n        except Exception as e:\n            logger.error(f\"Error scheduling payment reminder: {e}\")\n            return None","size_bytes":12386},"bot/pricing.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nPricing and Invoice Management\nHandles price calculations and invoice generation.\n\"\"\"\n\nfrom typing import List, Dict, Any\nfrom utils.persian_utils import format_price, persian_numbers\nfrom datetime import datetime\n\n\nclass PricingManager:\n    \"\"\"Manages pricing and invoice generation\"\"\"\n\n    def __init__(self):\n        # Ù†Ø±Ø®â€ŒÙ‡Ø§ÛŒ ØªØ®ÙÛŒÙ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡\n        self.discount_rates = {\n            'cash': 0.30,  # ØªØ®ÙÛŒÙ Û³Û°Ùª Ù†Ù‚Ø¯ÛŒ\n            'installment': 0.25,  # ØªØ®ÙÛŒÙ Û²ÛµÙª Ø§Ù‚Ø³Ø§Ø·ÛŒ\n            '60day': 0.25,  # ØªØ®ÙÛŒÙ Û²ÛµÙª Ø¨Ø±Ø§ÛŒ Û¶Û° Ø±ÙˆØ²Ù‡\n            '90day': 0.25  # ØªØ®ÙÛŒÙ Û²ÛµÙª Ø¨Ø±Ø§ÛŒ Û¹Û° Ø±ÙˆØ²Ù‡\n        }\n\n        # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ\n        self.bank_info = {\n            'card_number': '6219861915854102',\n            'sheba_number': '110560611828005185959401',\n            'account_holder': 'Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ'\n        }\n\n    def calculate_subtotal(self, cart_items: List[Dict[str, Any]]) -> float:\n        \"\"\"Calculate subtotal from cart items\"\"\"\n        return sum(item['price'] * item['quantity'] for item in cart_items)\n\n    def calculate_discount(self, subtotal: float, discount_rate: float) -> int:\n        \"\"\"Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ®ÙÛŒÙ\"\"\"\n        return int(subtotal * discount_rate)\n\n    def calculate_tax(self, amount: int) -> int:\n        \"\"\"Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù„ÛŒØ§Øª ()\"\"\"\n        return int(amount * 0.09)\n\n    def calculate_total(self, subtotal: float, discount: float = 0) -> float:\n        \"\"\"Calculate final total\"\"\"\n        return subtotal - discount\n\n    def generate_invoice(self, cart_items: List[Dict[str, Any]],\n                         customer: Dict[str, Any]) -> str:\n        \"\"\"Generate invoice with all payment options displayed\"\"\"\n        if not cart_items:\n            return \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\"\n\n        # Calculate amounts\n        subtotal = self.calculate_subtotal(cart_items)\n\n        # Calculate discounts for each option\n        cash_discount = self.calculate_discount(subtotal, 0.30)\n        installment_discount = self.calculate_discount(subtotal, 0.25)\n\n        cash_total = subtotal - cash_discount\n        installment_total = subtotal - installment_discount\n        advance_payment_90 = installment_total * 0.25\n\n        # Generate invoice text\n        invoice_lines = [\n            \"ğŸ“‹ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´\", \"=\" * 30, \"\", f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n            f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n            f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\", \"\", \"ğŸ“¦ Ø§Ù‚Ù„Ø§Ù… Ø³ÙØ§Ø±Ø´:\",\n            \"-\" * 20\n        ]\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_lines.extend([\n                f\"{persian_numbers(str(i))}. {item['product_name']}\",\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\",\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: {format_price(item['price'])} ØªÙˆÙ…Ø§Ù†\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\", \"\"\n            ])\n\n        # Add total amount\n        invoice_lines.extend([\n            \"-\" * 20, f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\",\n            \"\",\n            \"ğŸ’³ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®ØªØŒ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        ])\n\n        return \"\\n\".join(invoice_lines)\n\n    def generate_final_invoice(self, cart_items: List[Dict[str, Any]],\n                               customer: Dict[str, Any], payment_method: str,\n                               discount_rate: float) -> str:\n        \"\"\"Generate final invoice with payment method and discounts\"\"\"\n        if not cart_items:\n            return \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\"\n\n        # Calculate amounts\n        subtotal = self.calculate_subtotal(cart_items)\n        discount = self.calculate_discount(subtotal, discount_rate)\n        total = subtotal - discount\n\n        # Generate invoice text\n        invoice_lines = [\n            \"ğŸ“‹ ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ\", \"=\" * 30, \"\", f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n            f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n            f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\",\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_method}\", \"\", \"ğŸ“¦ Ø§Ù‚Ù„Ø§Ù… Ø³ÙØ§Ø±Ø´:\", \"-\" * 20\n        ]\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_lines.extend([\n                f\"{persian_numbers(str(i))}. {item['product_name']}\",\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\",\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: {format_price(item['price'])} ØªÙˆÙ…Ø§Ù†\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\", \"\"\n            ])\n\n        # Add calculations\n        invoice_lines.extend([\n            \"-\" * 20, f\"ğŸ’° Ù…Ø¬Ù…ÙˆØ¹: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\",\n            f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(discount_rate * 100)))}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\",\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(total)} ØªÙˆÙ…Ø§Ù†\"\n        ])\n\n        # Add special details for installment payment\n        if payment_method == \"Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ\":\n            invoice_lines.extend([\n                \"\", \"ğŸ’³ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ:\",\n                f\"ğŸ ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡: {persian_numbers(str(int(discount_rate * 100)))}Ùª\",\n                \"ğŸ“ Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ù‚Ø³Ø§Ø· Ø¨Ø§ ØªÙ…Ø§Ø³ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø§Ø¹Ù„Ø§Ù… Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\"\n            ])\n\n        invoice_lines.extend(\n            [\"\", \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\"])\n\n        return \"\\n\".join(invoice_lines)\n\n    def generate_invoice_text(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.25\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n        advance_payment = total * 0.25\n\n        invoice_text = (\n            f\"ğŸ†• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ø´Ù…Ø§Ø±Ù‡: {order_data['order_id']}\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n            f\"ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ ØªØ®ÙÛŒÙ (25Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(total)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’³ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (25Ùª): {format_price(advance_payment)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ“… ØªØ§Ø±ÛŒØ®: Û±Û´Û°Û´/Û°Ûµ/Û±Û´\\n\"\n            f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n        return invoice_text\n\n    def generate_cash_payment_invoice(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ Ø¨Ø§ ØªØ®ÙÛŒÙ 30%\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.30  # 30% discount for cash payment\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n\n        invoice_text = (f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (30% ØªØ®ÙÛŒÙ)\\n\"\n                        f\"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_data['order_id']}\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\\n\\n\"\n                        f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n        # Add totals\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ ({persian_numbers('30')}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n            f\"ğŸª Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: {self.bank_info['account_holder']}\\n\"\n            f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: {self.bank_info['card_number']}\\n\"\n            f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR{self.bank_info['sheba_number']}\\n\\n\"\n            f\"âœ… Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ù„Ø·ÙØ§Ù‹ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\")\n\n        return invoice_text\n\n    def generate_installment_payment_invoice(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ Ø¨Ø§ ØªØ®ÙÛŒÙ 25%\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.25  # 25% discount for installment payment\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n\n        invoice_text = (f\"ğŸ“… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ (25% ØªØ®ÙÛŒÙ)\\n\"\n                        f\"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_data['order_id']}\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\\n\\n\"\n                        f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n        # Add totals\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ ({persian_numbers('25')}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(total)} ØªÙˆÙ…Ø§Ù†\")\n\n        return invoice_text\n\n    def generate_60day_payment_invoice(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ Ø¨Ø§ ØªØ®ÙÛŒÙ 25% + Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª 25%\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.25  # 25% discount\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n        advance_payment = total * 0.25  # 25% advance payment from final amount\n\n        invoice_text = (f\"ğŸ• Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ (25% ØªØ®ÙÛŒÙ)\\n\"\n                        f\"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_data['order_id']}\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\\n\\n\"\n                        f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n        # Add totals and payment terms\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ ({persian_numbers('25')}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(total)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’³ Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª ({persian_numbers('25')}Ùª): {format_price(advance_payment)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n            f\"ğŸª Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: {self.bank_info['account_holder']}\\n\"\n            f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: {self.bank_info['card_number']}\\n\"\n            f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR{self.bank_info['sheba_number']}\\n\\n\"\n            f\"ğŸ“… Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n            f\"â€¢ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª 25Ùª Ø§Ø² Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ\\n\"\n            f\"â€¢ Ù…Ø§Ø¨Ù‚ÛŒ 60 Ø±ÙˆØ² Ù¾Ø³ Ø§Ø² ØªØ­ÙˆÛŒÙ„\\n\"\n            f\"â€¢ ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡ 25Ùª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡\\n\\n\"\n            f\"âœ… Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ² Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®ØªØŒ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\")\n\n        return invoice_text\n\n    def _get_persian_date(self) -> str:\n        \"\"\"Get current date in Persian format\"\"\"\n        # Return current Persian date: 1404/5/14\n        return persian_numbers(\"14 Ù…Ø±Ø¯Ø§Ø¯ 1404\")\n","size_bytes":15352},"bot/zarinpal.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nZarinPal Payment Integration\nHandles payment processing through ZarinPal gateway.\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, Any, Optional\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass ZarinPalGateway:\n    \"\"\"ZarinPal payment gateway integration\"\"\"\n\n    def __init__(self, merchant_id: str, sandbox: bool = True):\n        self.merchant_id = merchant_id\n        self.sandbox = sandbox\n\n        if sandbox:\n            self.request_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentRequest.json\"\n            self.verify_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentVerification.json\"\n            self.gateway_url = \"https://sandbox.zarinpal.com/pg/StartPay/\"\n        else:\n            self.request_url = \"https://www.zarinpal.com/pg/rest/WebGate/PaymentRequest.json\"\n            self.verify_url = \"https://www.zarinpal.com/pg/rest/WebGate/PaymentVerification.json\"\n            self.gateway_url = \"https://www.zarinpal.com/pg/StartPay/\"\n\n    def create_payment_request(self, amount: int, description: str, \n                             callback_url: str, customer_email: str = \"\",\n                             customer_mobile: str = \"\") -> Dict[str, Any]:\n        \"\"\"Create payment request\"\"\"\n        try:\n            data = {\n                \"MerchantID\": self.merchant_id,\n                \"Amount\": amount,\n                \"Description\": description,\n                \"CallbackURL\": callback_url,\n                \"Email\": customer_email,\n                \"Mobile\": customer_mobile\n            }\n\n            response = requests.post(self.request_url, json=data, timeout=10)\n            result = response.json()\n\n            if result[\"Status\"] == 100:\n                authority = result[\"Authority\"]\n                payment_url = f\"{self.gateway_url}{authority}\"\n\n                logger.info(f\"Payment request created successfully. Authority: {authority}\")\n                return {\n                    \"success\": True,\n                    \"authority\": authority,\n                    \"payment_url\": payment_url\n                }\n            else:\n                error_msg = self._get_error_message(result[\"Status\"])\n                logger.error(f\"ZarinPal payment request failed: {error_msg}\")\n                return {\n                    \"success\": False,\n                    \"error\": error_msg\n                }\n\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Request error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n        except Exception as e:\n            logger.error(f\"Unexpected error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def verify_payment(self, authority: str, amount: int) -> Dict[str, Any]:\n        \"\"\"Verify payment\"\"\"\n        try:\n            data = {\n                \"MerchantID\": self.merchant_id,\n                \"Authority\": authority,\n                \"Amount\": amount\n            }\n\n            response = requests.post(self.verify_url, json=data, timeout=10)\n            result = response.json()\n\n            if result[\"Status\"] == 100:\n                ref_id = result[\"RefID\"]\n                logger.info(f\"Payment verified successfully. RefID: {ref_id}\")\n                return {\n                    \"success\": True,\n                    \"ref_id\": ref_id,\n                    \"status\": \"verified\"\n                }\n            else:\n                error_msg = self._get_error_message(result[\"Status\"])\n                logger.error(f\"Payment verification failed: {error_msg}\")\n                return {\n                    \"success\": False,\n                    \"error\": error_msg\n                }\n\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Request error during verification: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n        except Exception as e:\n            logger.error(f\"Unexpected error during verification: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def _get_error_message(self, status_code: int) -> str:\n        \"\"\"Get Persian error message for status code\"\"\"\n        error_messages = {\n            -1: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù†Ø§Ù‚Øµ Ø§Ø³Øª\",\n            -2: \"IP ÛŒØ§ Ù…Ø±Ú†Ù†Øª Ú©Ø¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª\",\n            -3: \"Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø´Ø§Ù¾Ø±Ú© Ø§Ù…Ú©Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -4: \"Ø³Ø·Ø­ ØªØ£ÛŒÛŒØ¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø³Ø·Ø­ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª\",\n            -11: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -12: \"Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒØ³Ø± Ù†Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -21: \"Ù‡ÛŒÚ† Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -22: \"ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -33: \"Ø±Ù‚Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ø±Ù‚Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯\",\n            -34: \"Ø³Ù‚Ù ØªÙ‚Ø³ÛŒÙ… ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² Ù„Ø­Ø§Ø¸ ØªØ¹Ø¯Ø§Ø¯ ÛŒØ§ Ø±Ù‚Ù… Ø¹Ø¨ÙˆØ± Ù†Ù…ÙˆØ¯Ù‡ Ø§Ø³Øª\",\n            -40: \"Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ØªØ¯ Ù…Ø±Ø¨ÙˆØ·Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -41: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ AdditionalData ØºÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -42: \"Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø¹ØªØ¨Ø± Ø·ÙˆÙ„ Ø¹Ù…Ø± Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Û´Ûµ Ø±ÙˆØ² Ø¨Ø§Ø´Ø¯\",\n            -54: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡ Ø§Ø³Øª\",\n            101: \"Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù‡ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ PaymentVerification ØªØ±Ø§Ú©Ù†Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª\"\n        }\n        \n        return error_messages.get(status_code, f\"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¨Ø§ Ú©Ø¯ {status_code}\")\n","size_bytes":6136},"bot/zarinpal_test.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nZarinPal Payment Integration - Fixed Version\nHandles payment processing through ZarinPal gateway.\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, Any, Optional\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\n\nclass ZarinPalGateway:\n    \"\"\"ZarinPal payment gateway integration\"\"\"\n\n    def __init__(self, merchant_id: str, sandbox: bool = True):\n        self.merchant_id = merchant_id\n        self.sandbox = sandbox\n\n        if sandbox:\n            # Sandbox URLs\n            self.request_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentRequest.json\"\n            self.verify_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentVerification.json\"\n            self.gateway_url = \"https://sandbox.zarinpal.com/pg/StartPay/\"\n        else:\n            # Production URLs - API v4\n            self.request_url = \"https://api.zarinpal.com/pg/v4/payment/request/\"\n            self.verify_url = \"https://api.zarinpal.com/pg/v4/payment/verify/\"\n            self.gateway_url = \"https://www.zarinpal.com/pg/StartPay/\"\n\n    def create_payment_request(self,\n                               amount: int,\n                               description: str,\n                               callback_url: str,\n                               customer_email: str = \"\",\n                               customer_mobile: str = \"\") -> Dict[str, Any]:\n        \"\"\"Create payment request\"\"\"\n        try:\n            if self.sandbox:\n                # Sandbox API (v3 format)\n                data = {\n                    \"MerchantID\": self.merchant_id,\n                    \"Amount\": amount,\n                    \"Description\": description,\n                    \"CallbackURL\": callback_url,\n                    \"Email\": customer_email,\n                    \"Mobile\": customer_mobile\n                }\n                headers = {'Content-Type': 'application/json'}\n            else:\n                # Production API (v4 format)\n                data = {\n                    \"merchant_id\": self.merchant_id,\n                    \"amount\": amount,\n                    \"description\": description,\n                    \"callback_url\": callback_url,\n                    \"metadata\": {\n                        \"email\": customer_email,\n                        \"mobile\": customer_mobile\n                    }\n                }\n                headers = {\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                }\n\n            logger.info(f\"Sending payment request to: {self.request_url}\")\n            logger.info(\n                f\"Request data: {json.dumps(data, ensure_ascii=False)}\")\n\n            response = requests.post(self.request_url,\n                                     json=data,\n                                     headers=headers,\n                                     timeout=15)\n\n            logger.info(f\"Response status: {response.status_code}\")\n            logger.info(f\"Response headers: {dict(response.headers)}\")\n            logger.info(f\"Response text: {response.text}\")\n\n            if response.status_code != 200:\n                return {\n                    \"success\": False,\n                    \"error\":\n                    f\"HTTP Error {response.status_code}: {response.text}\"\n                }\n\n            result = response.json()\n\n            if self.sandbox:\n                # Sandbox response format\n                if result.get(\"Status\") == 100:\n                    authority = result.get(\"Authority\")\n                    payment_url = f\"{self.gateway_url}{authority}\"\n\n                    logger.info(\n                        f\"Payment request created successfully. Authority: {authority}\"\n                    )\n                    return {\n                        \"success\": True,\n                        \"authority\": authority,\n                        \"payment_url\": payment_url\n                    }\n                else:\n                    error_msg = self._get_error_message(\n                        result.get(\"Status\", -999))\n                    logger.error(\n                        f\"ZarinPal payment request failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n            else:\n                # Production response format\n                if result.get(\"data\") and result[\"data\"].get(\"code\") == 100:\n                    authority = result[\"data\"].get(\"authority\")\n                    payment_url = f\"{self.gateway_url}{authority}\"\n\n                    logger.info(\n                        f\"Payment request created successfully. Authority: {authority}\"\n                    )\n                    return {\n                        \"success\": True,\n                        \"authority\": authority,\n                        \"payment_url\": payment_url\n                    }\n                else:\n                    error_msg = result.get(\"errors\",\n                                           {}).get(\"message\", \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ\")\n                    logger.error(\n                        f\"ZarinPal payment request failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n\n        except requests.exceptions.Timeout:\n            logger.error(\"Request timeout\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø²Ù…Ø§Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\"\n            }\n        except requests.exceptions.ConnectionError:\n            logger.error(\"Connection error\")\n            return {\n                \"success\":\n                False,\n                \"error\":\n                \"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª. Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.\"\n            }\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Request error: {e}\")\n            return {\"success\": False, \"error\": \"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except json.JSONDecodeError as e:\n            logger.error(f\"JSON decode error: {e}\")\n            return {\"success\": False, \"error\": \"Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except Exception as e:\n            logger.error(f\"Unexpected error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def verify_payment(self, authority: str, amount: int) -> Dict[str, Any]:\n        \"\"\"Verify payment\"\"\"\n        try:\n            if self.sandbox:\n                # Sandbox API (v3 format)\n                data = {\n                    \"MerchantID\": self.merchant_id,\n                    \"Authority\": authority,\n                    \"Amount\": amount\n                }\n                headers = {'Content-Type': 'application/json'}\n            else:\n                # Production API (v4 format)\n                data = {\n                    \"merchant_id\": self.merchant_id,\n                    \"authority\": authority,\n                    \"amount\": amount\n                }\n                headers = {\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                }\n\n            logger.info(f\"Verifying payment with authority: {authority}\")\n\n            response = requests.post(self.verify_url,\n                                     json=data,\n                                     headers=headers,\n                                     timeout=15)\n\n            logger.info(\n                f\"Verification response status: {response.status_code}\")\n            logger.info(f\"Verification response: {response.text}\")\n\n            if response.status_code != 200:\n                return {\n                    \"success\": False,\n                    \"error\":\n                    f\"HTTP Error {response.status_code}: {response.text}\"\n                }\n\n            result = response.json()\n\n            if self.sandbox:\n                # Sandbox response format\n                if result.get(\"Status\") == 100:\n                    ref_id = result.get(\"RefID\")\n                    logger.info(\n                        f\"Payment verified successfully. RefID: {ref_id}\")\n                    return {\n                        \"success\": True,\n                        \"ref_id\": ref_id,\n                        \"status\": \"verified\"\n                    }\n                else:\n                    error_msg = self._get_error_message(\n                        result.get(\"Status\", -999))\n                    logger.error(f\"Payment verification failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n            else:\n                # Production response format\n                if result.get(\"data\") and result[\"data\"].get(\"code\") == 100:\n                    ref_id = result[\"data\"].get(\"ref_id\")\n                    logger.info(\n                        f\"Payment verified successfully. RefID: {ref_id}\")\n                    return {\n                        \"success\": True,\n                        \"ref_id\": ref_id,\n                        \"status\": \"verified\"\n                    }\n                else:\n                    error_msg = result.get(\"errors\",\n                                           {}).get(\"message\", \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ\")\n                    logger.error(f\"Payment verification failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n\n        except requests.exceptions.Timeout:\n            logger.error(\"Verification request timeout\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø²Ù…Ø§Ù† ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯\"\n            }\n        except requests.exceptions.ConnectionError:\n            logger.error(\"Verification connection error\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Verification request error: {e}\")\n            return {\"success\": False, \"error\": \"Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except json.JSONDecodeError as e:\n            logger.error(f\"Verification JSON decode error: {e}\")\n            return {\"success\": False, \"error\": \"Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except Exception as e:\n            logger.error(f\"Unexpected verification error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def _get_error_message(self, status_code: int) -> str:\n        \"\"\"Get Persian error message for status code\"\"\"\n        error_messages = {\n            -1: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù†Ø§Ù‚Øµ Ø§Ø³Øª\",\n            -2: \"IP ÛŒØ§ Ù…Ø±Ú†Ù†Øª Ú©Ø¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª\",\n            -3: \"Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø´Ø§Ù¾Ø±Ú© Ø§Ù…Ú©Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -4: \"Ø³Ø·Ø­ ØªØ£ÛŒÛŒØ¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø³Ø·Ø­ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª\",\n            -11: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -12: \"Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒØ³Ø± Ù†Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -21: \"Ù‡ÛŒÚ† Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -22: \"ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -33: \"Ø±Ù‚Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ø±Ù‚Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯\",\n            -34: \"Ø³Ù‚Ù ØªÙ‚Ø³ÛŒÙ… ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² Ù„Ø­Ø§Ø¸ ØªØ¹Ø¯Ø§Ø¯ ÛŒØ§ Ø±Ù‚Ù… Ø¹Ø¨ÙˆØ± Ù†Ù…ÙˆØ¯Ù‡ Ø§Ø³Øª\",\n            -40: \"Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ØªØ¯ Ù…Ø±Ø¨ÙˆØ·Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -41: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ AdditionalData ØºÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -42:\n            \"Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø¹ØªØ¨Ø± Ø·ÙˆÙ„ Ø¹Ù…Ø± Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Û´Ûµ Ø±ÙˆØ² Ø¨Ø§Ø´Ø¯\",\n            -54: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡ Ø§Ø³Øª\",\n            101:\n            \"Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù‡ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ PaymentVerification ØªØ±Ø§Ú©Ù†Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª\",\n            -999: \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ - Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯\"\n        }\n\n        return error_messages.get(status_code,\n                                  f\"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¨Ø§ Ú©Ø¯ {status_code}\")\n","size_bytes":12534},"data/__init__.py":{"content":"\"\"\"\nData Package\nContains customer database and product catalog management.\n\"\"\"\n","size_bytes":80},"data/customer_service.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nCustomer Service and Authentication\nManages customer database and authentication.\n\"\"\"\n\nfrom typing import Optional, Dict, Any, List\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass CustomerService:\n    \"\"\"Customer service management class\"\"\"\n    \n    def __init__(self):\n        # Customer database with authentic customer codes from original data\n        self.customers = {\n            # Ú©Ø¯Ù‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ Ø´Ø´ Ø±Ù‚Ù…ÛŒ Ø·Ø¨Ù‚ ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ\n            \"000001\": {\"customer_id\": \"000001\", \"name\": \"Ø®Ø§Ù†Ù… Ù†ÛŒÙ„ÙˆÙØ± ØµÙØ±Ù¾ÙˆØ±\", \"city\": \"Ø§Ø±Ø¯Ø¨ÛŒÙ„\"},\n            \"000002\": {\"customer_id\": \"000002\", \"name\": \"Ø®Ø§Ù†Ù… Ø§Ø¹Ø¸Ù… Ø§ÙØ±Ø§ÛŒÛŒ\", \"city\": \"Ø§ØµÙÙ‡Ø§Ù†\"},\n            \"000003\": {\"customer_id\": \"000003\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø¬ÛŒØ¯ Ø²ÛŒÙ† Ø§Ù„Ø¹Ø§Ø¨Ø¯ÛŒÙ†\", \"city\": \"Ø§ØµÙÙ‡Ø§Ù†\"},\n            \"000004\": {\"customer_id\": \"000004\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø±ÙˆØ­ Ø§Ù„Ù„Ù‡ Ø´Ø§Ú©Ø±ÛŒØ§Ù†\", \"city\": \"Ú©Ø§Ø´Ø§Ù†\"},\n            \"000005\": {\"customer_id\": \"000005\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÛŒØ§Ø´Ø§Ø± Ø­ÛŒØ¯Ø±ÛŒ\", \"city\": \"Ù…Ø·Ù‡Ø±ÛŒ Ú©Ø±Ø¬\"},\n            \"000006\": {\"customer_id\": \"000006\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø´Ø§Ù‡ÙˆÛŒ Ø§Ù…ÛŒØ±ÛŒ\", \"city\": \"Ú©Ø±Ø¬\"},\n            \"000007\": {\"customer_id\": \"000007\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø±ØªØ¶ÛŒ Ø§Ù†Ø¬ÛŒÙ„Ù‡ Ø§ÛŒ\", \"city\": \"Ø¯Ø´Øª Ø¨Ù‡Ø´Øª Ú©Ø±Ø¬\"},\n            \"000008\": {\"customer_id\": \"000008\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¬ÙˆØ§Ø¯ Ø±Ø´ÛŒØ¯ÛŒ\", \"city\": \"Ø§Ú©ÙˆÙ…Ø§Ù„ Ú©Ø±Ø¬\"},\n            \"000009\": {\"customer_id\": \"000009\", \"name\": \"Ø®Ø§Ù†Ù… Ù…Ú˜Ú¯Ø§Ù† Ø¬Ø¹ÙØ±ÛŒ\", \"city\": \"Ú©Ø§Ø¬ Ú©Ø±Ø¬\"},\n            \"000010\": {\"customer_id\": \"000010\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³ÛŒÙ†Ø§ Ø§Ø³Ø¯ Ø§Ù„Ù„Ù‡ÛŒ\", \"city\": \"Ø±Ø³ØªØ§Ø®ÛŒØ²\"},\n            \"000011\": {\"customer_id\": \"000011\", \"name\": \"Ø®Ø§Ù†Ù… Ù†Ø¯Ø§ Ø§Ú©Ø¨Ø±ÛŒ\", \"city\": \"ØªØ¨Ø±ÛŒØ²\"},\n            \"000012\": {\"customer_id\": \"000012\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§ÛŒÙ…Ø§Ù† Ú©ÙˆÙ‡Ú¯Ø±Ø¯\", \"city\": \"ØªØ¨Ø±ÛŒØ²\"},\n            \"000013\": {\"customer_id\": \"000013\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¨Ù‡Ø±ÙˆØ² ØªÙˆÙÛŒÙ‚ÛŒ\", \"city\": \"Ù…ÛŒØ§Ù†Ù‡\"},\n            \"000014\": {\"customer_id\": \"000014\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÛŒØ¹Ù‚ÙˆØ¨ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ÛŒ\", \"city\": \"Ø§Ø±ÙˆÙ…ÛŒÙ‡\"},\n            \"000015\": {\"customer_id\": \"000015\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ù…ÛŒØ± Ø´Ù…Ø§Ù…ÛŒ\", \"city\": \"Ø¨ÙˆÚ©Ø§Ù†\"},\n            \"000016\": {\"customer_id\": \"000016\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ† Ø´ÙÙ‚ÛŒ\", \"city\": \"Ø®ÙˆÛŒ\"},\n            \"000017\": {\"customer_id\": \"000017\", \"name\": \"Ø®Ø§Ù†Ù… Ø´Ù‡Ø±Ø¨Ø§Ù†Ùˆ ÙÙˆÙ„Ø§Ø¯ÛŒ\", \"city\": \"Ø¨ÙˆØ´Ù‡Ø±\"},\n            \"000018\": {\"customer_id\": \"000018\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ù…ÛŒÙ† Ú¯ÙˆØ¯Ø±Ø²ÛŒ\", \"city\": \"Ø¨Ù†Ø¯Ø±Ú¯Ù†Ø§ÙˆÙ‡\"},\n            \"000019\": {\"customer_id\": \"000019\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³ÛŒØ¯Ø¹Ù„ÛŒ Ø­Ø³ÛŒÙ† Ø²Ø§Ø¯Ù‡\", \"city\": \"Ø´Ù‡Ø±Ø¬Ù…\"},\n            \"000020\": {\"customer_id\": \"000020\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³Ø¹ÛŒØ¯ ØµØ§Ù„Ø­ÛŒ\", \"city\": \"Ø¬Ø§Ù…ÛŒ ØªÙ‡Ø±Ø§Ù†\"},\n            \"000021\": {\"customer_id\": \"000021\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø¬ÛŒØ¯ Ø±Ø­ÛŒÙ…ÛŒ\", \"city\": \"Ø®Ù„ÛŒØ¬ ÙØ§Ø±Ø³ ØªÙ‡Ø±Ø§Ù†\"},\n            \"000022\": {\"customer_id\": \"000022\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ù…ÛŒÙ† Ú©ÙˆÙ‡Ø²Ø§Ø¯\", \"city\": \"Ú©Ø§Ø³Ù¾ÛŒÙ† ØªÙ‡Ø±Ø§Ù†\"},\n            \"000023\": {\"customer_id\": \"000023\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÙˆØ­ÛŒØ¯ ØµØ§Ø¯Ù‚ÛŒ\", \"city\": \"Ø¯Ù„Ø§ÙˆØ±Ø§Ù† ØªÙ‡Ø±Ø§Ù†\"},\n            \"000024\": {\"customer_id\": \"000024\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ú©ÙˆØ§Ù†\", \"city\": \"Ú†Ù‡Ø§Ø±Ø¯Ø§Ù†Ú¯Ù‡ ØªÙ‡Ø±Ø§Ù†\"},\n            \"000025\": {\"customer_id\": \"000025\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ø§Ø³Ø¯Ø§Ù„Ù„Ù‡ÛŒ\", \"city\": \"ÙˆØ±Ø§Ù…ÛŒÙ†\"},\n            \"000026\": {\"customer_id\": \"000026\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³Ø¹ÛŒØ¯ÛŒ\", \"city\": \"Ø§ÛŒØ±Ø§Ù†Ù…Ø§Ù„ ØªÙ‡Ø±Ø§Ù†\"},\n            \"000027\": {\"customer_id\": \"000027\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø±ØªØ¶ÛŒ Ø±Ù…Ø¶Ø§Ù†ÛŒ\", \"city\": \"Ø¬Ø§Ø¬Ø±ÙˆØ¯ ØªÙ‡Ø±Ø§Ù†\"},\n            \"000028\": {\"customer_id\": \"000028\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÙØ±Ø²Ø§Ø¯ Ø±Ø¬Ø¨ Ø²Ø§Ø¯Ù‡\", \"city\": \"Ø¨Ø¬Ù†ÙˆØ±Ø¯\"},\n            \"000029\": {\"customer_id\": \"000029\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ø¨Ø§Ù‚Ø± Ù†Ú˜Ø§Ø¯\", \"city\": \"ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡\"},\n            \"000030\": {\"customer_id\": \"000030\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ú©Ø§ÙˆÙ‡ Ù…Ø¯Ø¯ÛŒØ§Ù†\", \"city\": \"Ù…Ø´Ù‡Ø¯\"},\n            \"000031\": {\"customer_id\": \"000031\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ø³Ù† Ø§ØµØºØ±ÛŒ\", \"city\": \"Ø¨ÛŒØ±Ø¬Ù†Ø¯\"},\n            \"000032\": {\"customer_id\": \"000032\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø³Ø¹ÙˆØ¯ Ù…Ù‡Ø± Ø§Ø¨Ø§Ø¯ÛŒ\", \"city\": \"Ø³Ø¨Ø²ÙˆØ§Ø±\"},\n            \"000033\": {\"customer_id\": \"000033\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø­Ù…ÛŒØ¯ Ø±Ø¶Ø§ Ø¹Ù„ÛŒØ²Ø§Ø¯Ù‡\", \"city\": \"Ø´Ù‡Ø±ÙØ±Ø¯ÙˆØ³\"},\n            \"000034\": {\"customer_id\": \"000034\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ú©Ø´Ø§ÙˆØ±Ø²\", \"city\": \"Ø§Ù¾Ø§Ø¯Ø§Ù†Ø§ Ø§Ù‡ÙˆØ§Ø²\"},\n            \"000035\": {\"customer_id\": \"000035\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÙØ±Ø´Ø§Ø¯ Ú©Ø§Ù…Ø±Ø§Ù† ÙØ±\", \"city\": \"Ø§Ù‡ÙˆØ§Ø²\"},\n            \"000036\": {\"customer_id\": \"000036\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ø³Ø¯ Ø§Ù„Ù„Ù‡ ÙÙ„Ø§Ø­ÛŒ\", \"city\": \"Ø¨Ù†Ø¯Ø± Ù…Ø§Ù‡Ø´Ù‡Ø±\"},\n            \"000037\": {\"customer_id\": \"000037\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ø³Ù† Ù…Ø±ÙˆØ¬\", \"city\": \"Ø¨Ù‡Ø¨Ù‡Ø§Ù†\"},\n            \"000038\": {\"customer_id\": \"000038\", \"name\": \"Ø®Ø§Ù†Ù… ØºØ²Ø§Ù„Ù‡ Ú¯Ù„Ú†ÛŒÙ†\", \"city\": \"Ø¯Ø²ÙÙˆÙ„\"},\n            \"000039\": {\"customer_id\": \"000039\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ… Ø­Ø³ÛŒÙ† Ø²Ø§Ø¯Ù‡\", \"city\": \"Ø§Ù†Ø¯ÛŒÙ…Ø´Ú©\"},\n            \"000040\": {\"customer_id\": \"000040\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ú©Ø±Ø¯\", \"city\": \"Ø´ÙˆØ´ Ø¯Ø§Ù†ÛŒØ§Ù„\"},\n            \"000041\": {\"customer_id\": \"000041\", \"name\": \"Ø®Ø§Ù†Ù… Ù…Ø±ÛŒÙ… Ø§Ø­Ù…Ø¯Ø®Ø§Ù†ÛŒ\", \"city\": \"Ø§Ø¨Ù‡Ø±\"},\n            \"000042\": {\"customer_id\": \"000042\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø±Ø¶Ø§ Ø¢Ø±Ø¨ÙˆÙ†ÛŒ\", \"city\": \"Ø²Ù†Ø¬Ø§Ù†\"},\n            \"000043\": {\"customer_id\": \"000043\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø±Ø¶Ø§ Ú©ÛŒÙØ±ÛŒ\", \"city\": \"Ú¯Ø±Ù…Ø³Ø§Ø±\"},\n            \"000044\": {\"customer_id\": \"000044\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ù…ÛŒÙ† Ø³Ø±Ø§Ø¨Ù†Ø¯ÛŒ\", \"city\": \"Ø²Ø§Ù‡Ø¯Ø§Ù†\"},\n            \"000045\": {\"customer_id\": \"000045\", \"name\": \"Ø®Ø§Ù†Ù… Ù…Ø±ÛŒÙ… ØªØ±Ø´ÛŒØ²ÛŒ\", \"city\": \"Ø²Ø§Ù‡Ø¯Ø§Ù†\"},\n            \"000046\": {\"customer_id\": \"000046\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¹Ù„ÛŒ Ø±Ø¦ÛŒØ³ÛŒ\", \"city\": \"Ø´Ù‡Ø±Ú©Ø±Ø¯\"},\n            \"000047\": {\"customer_id\": \"000047\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§ÛŒÙ…Ø§Ù† Ø¢Ù‡ÛŒ ØªØ¨Ø§Ø±\", \"city\": \"Ø¢Ù…Ù„ ÙˆØ¨Ø§Ø¨Ù„\"},\n            \"000048\": {\"customer_id\": \"000048\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ú©Ù…Ø§Ù„ Ø¨Ø§Ù‚Ø±ÛŒ\", \"city\": \"Ø¨Ù‡Ø´Ù‡Ø±\"},\n            \"000049\": {\"customer_id\": \"000049\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¨Ø§Ø¨Ú© Ù…Ø¯Ù†ÛŒ\", \"city\": \"Ø§Ø±Ø§Ú©\"},\n            \"000050\": {\"customer_id\": \"000050\", \"name\": \"Ø®Ø§Ù†Ù… Ù†Ø³Ø§ ØµØ§Ù„Ø­ÛŒ\", \"city\": \"Ø³Ø§ÙˆÙ‡\"},\n            \"000051\": {\"customer_id\": \"000051\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÛŒÙˆØ³Ù Ø³ÙØ§Ø±ÛŒ\", \"city\": \"Ù‚Ø´Ù…\"},\n            \"000052\": {\"customer_id\": \"000052\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø³Ø¹ÙˆØ¯ Ø³Ù„ÛŒÙ…ÛŒ\", \"city\": \"Ù‡ÙˆÙ… Ø¨Ù†Ø¯Ø± Ø¹Ø¨Ø§Ø³\"},\n            \"000053\": {\"customer_id\": \"000053\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ù‚Ù†Ø¨Ø±ÛŒ\", \"city\": \"Ù…Ù„Ø§ÛŒØ±\"},\n            \"000054\": {\"customer_id\": \"000054\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù†Ø§Ø¯Ø¹Ù„ÛŒ Ù†Ø¹ÛŒÙ… Ø§Ø¨Ø§Ø¯ÛŒ\", \"city\": \"ÛŒØ²Ø¯\"},\n            \"000055\": {\"customer_id\": \"000055\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³Ø§Ø³Ø§Ù† Ú©Ø´Ø§ÙˆØ±Ø²\", \"city\": \"Ø¨ÛŒØ¶Ø§\"},\n            \"000056\": {\"customer_id\": \"000056\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø³Ø¹ÙˆØ¯ Ù‡Ù…Ø§ÛŒÙˆÙ†\", \"city\": \"Ù…Ø±Ùˆ Ø¯Ø´Øª\"},\n            \"000057\": {\"customer_id\": \"000057\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø­Ù…ÛŒØ¯ Ø±Ù…Ø¶Ø§Ù†ÛŒ\", \"city\": \"Ù‚Ø²ÙˆÛŒÙ†\"},\n            \"000058\": {\"customer_id\": \"000058\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¹Ù„ÛŒ Ø§ÙØ³Ø±ÛŒ\", \"city\": \"Ù‚Ù…\"},\n            \"000059\": {\"customer_id\": \"000059\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø³Ø¹ÙˆØ¯ Ù†ÙˆØ­ÛŒ\", \"city\": \"Ú©Ø±Ù…Ø§Ù†\"},\n            \"000060\": {\"customer_id\": \"000060\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ù†Ú˜Ø§Ø¯ ØµØ§Ù„Ø­ÛŒ\", \"city\": \"Ø³ÛŒØ±Ø¬Ø§Ù†\"},\n            \"000061\": {\"customer_id\": \"000061\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ú©ÛŒØ§Ù†\", \"city\": \"Ø´Ù‡Ø± Ø¨Ø§Ø¨Ú©\"},\n            \"000062\": {\"customer_id\": \"000062\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÙØ±ÛŒØ¯ Ø³ÛŒØ§Ù‡ Ø¨ÛŒØ¯ÛŒ\", \"city\": \"Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡\"},\n            \"000063\": {\"customer_id\": \"000063\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ø¨ÙˆØ·Ø§Ù„Ø¨ Ø­Ø³ÛŒÙ†ÛŒ\", \"city\": \"ÛŒØ§Ø³ÙˆØ¬\"},\n            \"000064\": {\"customer_id\": \"000064\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…ÛŒÙ„Ø§Ø¯ Ù¾Ø§Ú©Ø²Ø§Ø¯\", \"city\": \"Ú¯Ú†Ø³Ø§Ø±Ø§Ù†\"},\n            \"000065\": {\"customer_id\": \"000065\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¨Ù‡Ø±ÙˆØ² Ø¨Ø­Ø±ÛŒ\", \"city\": \"Ø³Ù‚Ø²\"},\n            \"000066\": {\"customer_id\": \"000066\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÛŒÙˆØ³Ù Ø¨Ù‡Ø±Ø§Ù…ÛŒØ§Ù†\", \"city\": \"Ø³Ù†Ù†Ø¯Ø¬\"},\n            \"000067\": {\"customer_id\": \"000067\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ø³Ù† Ø¹Ø§Ù…Ø±ÛŒØ§Ù†\", \"city\": \"Ú¯Ù†Ø¨Ø¯\"},\n            \"000068\": {\"customer_id\": \"000068\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ… Ø­Ø³ÛŒÙ† Ø²Ø§Ø¯Ù‡\", \"city\": \"Ú¯Ø±Ú¯Ø§Ù†\"},\n            \"000069\": {\"customer_id\": \"000069\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ú©Ø§Ù…Ø±Ø§Ù† ÙÙ„Ø§Ø­ Ø¨Ø§Ù‚Ø±ÛŒ\", \"city\": \"Ø§Ù†Ø²Ù„ÛŒ\"},\n            \"000070\": {\"customer_id\": \"000070\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ø±ÙˆÛŒÙ† Ù…Ø­Ù…Ø¯ÛŒ\", \"city\": \"Ù„Ø§Ú©Ø§Ù†ÛŒ Ø±Ø´Øª\"},\n            \"000071\": {\"customer_id\": \"000071\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…ØµØ·ÙÛŒ Ú©Ø§Ù…Ø±Ø§Ù†\", \"city\": \"Ø±Ø´Øª\"},\n            \"000072\": {\"customer_id\": \"000072\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ø¯Ø§Ø¯Ø±Ø³\", \"city\": \"Ù„Ø§Ù‡ÛŒØ¬Ø§Ù†\"},\n            \"000073\": {\"customer_id\": \"000073\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ† Ø¨Ø®Ø´ÛŒ\", \"city\": \"Ù„Ù†Ú¯Ø±ÙˆØ¯\"},\n            \"000074\": {\"customer_id\": \"000074\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø¹Ù„ÛŒØ±Ø¶Ø§ Ø§Ø­Ù…Ø¯ Ø®Ø§Ù†ÛŒ\", \"city\": \"ØªÙ†Ú©Ø§Ø¨Ù†\"},\n            \"000075\": {\"customer_id\": \"000075\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ù‚Ù„ÛŒ Ø²Ø§Ø¯Ù‡\", \"city\": \"Ù‡ÙˆÙ… Ú†Ø§Ù„ÙˆØ³\"},\n            \"000076\": {\"customer_id\": \"000076\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ† Ù…Ø®ØªØ§Ø±ÛŒ\", \"city\": \"Ø³Ø§Ø±ÛŒ\"},\n            \"000077\": {\"customer_id\": \"000077\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ø®Ù„Ø¯Ø¨Ø±ÛŒÙ†\", \"city\": \"Ù†ÙˆØ±\"},\n            \"000078\": {\"customer_id\": \"000078\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\", \"city\": \"\"},\n            \"000079\": {\"customer_id\": \"000079\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø§Ø¨ÙˆÙ„ÙØ¶Ù„ Ù…ÙˆØ³ÙˆÛŒ\", \"city\": \"\"},\n            \"000080\": {\"customer_id\": \"000080\", \"name\": \"Ø®Ø§Ù†Ù… Ù…Ú˜Ø¯Ù‡ Ø³Ù„Ø·Ø§Ù† Ù…Ø­Ù…Ø¯ÛŒ\", \"city\": \"\"},\n            \"000081\": {\"customer_id\": \"000081\", \"name\": \"Ø®Ø§Ù†Ù… Ø§Ø­Ù…Ø¯ÛŒ\", \"city\": \"\"},\n            \"000082\": {\"customer_id\": \"000082\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ø·Ù‡Ù…Ø§Ø³Ø¨ÛŒ\", \"city\": \"\"},\n            \"000083\": {\"customer_id\": \"000083\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ú©Ù…Ø§Ù„ Ù…Ø­Ù…Ø¯ÛŒ\", \"city\": \"\"},\n            \"000084\": {\"customer_id\": \"000084\", \"name\": \"Ø®Ø§Ù†Ù… Ø­Ù…ÛŒØ±Ø§ Ø¹Ø¸ÛŒÙ…ÛŒ\", \"city\": \"\"},\n            \"000085\": {\"customer_id\": \"000085\", \"name\": \"Ø®Ø§Ù†Ù… Ø³Ù‡ÛŒÙ„Ø§ Ù‚Ù…Ø±Ù¾ÙˆØ±\", \"city\": \"\"},\n            \"000086\": {\"customer_id\": \"000086\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ Ø±ÙÛŒØ¹ÛŒ\", \"city\": \"\"},\n            \"000087\": {\"customer_id\": \"000087\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³Ø¹ÛŒØ¯Ù¾ÙˆØ±Ø±Ø¶Ø§ÛŒÛŒ\", \"city\": \"Ú†Ø§Ù„ÙˆØ³\"},\n            \"000088\": {\"customer_id\": \"000088\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø³Ø¹ÙˆØ¯ Ø³Ù„ÛŒÙ…ÛŒ\", \"city\": \"Ø§Ù¾Ø§Ø¯Ø§Ù†Ø§ Ø¨Ù†Ø¯Ø± Ø¹Ø¨Ø§Ø³\"},\n            \"000089\": {\"customer_id\": \"000089\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ú©Ø´Ø§ÙˆØ±Ø²\", \"city\": \"Ù‡ÙˆÙ… Ø§Ù‡ÙˆØ§Ø²\"},\n            \"000090\": {\"customer_id\": \"000090\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø´Ø§Ù‡Ø±Ø® Ø¹Ø§Ø´ÙˆØ±ÛŒ\", \"city\": \"Ø´ÛŒØ±Ø§Ø²\"},\n            \"000091\": {\"customer_id\": \"000091\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³Ø¹ÛŒØ¯ Ø­Ø³Ù†ÛŒ\", \"city\": \"Ù†ØµØ¨\"},\n            \"000092\": {\"customer_id\": \"000092\", \"name\": \"Ø´Ø±Ú©Øª Ù…Ø­ØªØ±Ù… Ø§Ù¾Ø§Ø¯Ø§Ù†Ø§\", \"city\": \"\"},\n            \"000093\": {\"customer_id\": \"000093\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…ÛŒØ±Ø¹Ù„ÛŒ Ø³ÛŒØ¯ Ø¨Ø§Ù‚Ø±ÛŒ\", \"city\": \"\"},\n            \"000094\": {\"customer_id\": \"000094\", \"name\": \"Ø®Ø§Ù†Ù… Ø²Ù‡Ø±Ø§Ù…Ø­Ù…Ø¯ÛŒ\", \"city\": \"Ø§Ù¾Ø§Ø¯Ø§Ù†Ø§ Ù…Ø§Ø±Ú©Øª\"},\n            \"000095\": {\"customer_id\": \"000095\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ú©Ø´Ø§ÙˆØ±Ø²\", \"city\": \"Ù„Ø§Ù‡ÛŒØ¬Ø§Ù†\"},\n            \"000096\": {\"customer_id\": \"000096\", \"name\": \"Ø¢Ù‚Ø§ÛŒ ÛŒØ¹Ù‚ÙˆØ¨ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ÛŒ\", \"city\": \"Ù‡ÙˆÙ…\"},\n            \"000097\": {\"customer_id\": \"000097\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø±Ø¶Ø§ ØªØ±Ú©Ù…Ù†\", \"city\": \"Ù‡ÙˆÙ… Ú©Ø§Ø³Ù¾ÛŒÙ†\"},\n            \"000098\": {\"customer_id\": \"000098\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø±ØªØ¶ÛŒ Ø§Ù†Ø¬ÛŒÙ„Ù‡ Ø§ÛŒ\", \"city\": \"ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§ÛŒÙ†ØªØ±Ù†ØªÛŒ\"},\n            \"000099\": {\"customer_id\": \"000099\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ø¬ÛŒØ¯ ØªØ±Ø§Ø¨ÛŒØ§Ù†\", \"city\": \"\"},\n            \"000100\": {\"customer_id\": \"000100\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ø³Ø¬Ø§Ø¯ Ø¨ÛŒØ¶Ø§ÛŒÛŒ\", \"city\": \"\"},\n            \"000101\": {\"customer_id\": \"000101\", \"name\": \"Ø®Ø§Ù†Ù… Ø¬Ø¨Ø§Ø±ÛŒ\", \"city\": \"\"},\n            \"000102\": {\"customer_id\": \"000102\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ù…Ø®ØªØ§Ø±ÛŒ\", \"city\": \"Ù‡ÙˆÙ… Ø§ÛŒØ±Ø§Ù†Ù…Ø§Ù„\"},\n            \"000103\": {\"customer_id\": \"000103\", \"name\": \"Ø®Ø§Ù†Ù… Ù¾Ø±ÙˆÛŒØ²ÛŒ\", \"city\": \"Ø´Ù‡Ø±ÛŒØ§Ø±\"},\n            \"000104\": {\"customer_id\": \"000104\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù¾ÛŒØ§Ù… ØµØ§Ù„Ø­ÛŒ\", \"city\": \"Ø¢Ø±ØªÛŒÙ† Ù…ÙˆØ¯\"},\n            \"000105\": {\"customer_id\": \"000105\", \"name\": \"Ø®Ø§Ù†Ù… Ù…ÛŒÙ†Ùˆ Ú¯Ù„Ø´Ù†\", \"city\": \"\"},\n            \"000106\": {\"customer_id\": \"000106\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù…Ù‡Ø¯ÛŒ Ù…Ø®ØªØ§Ø±ÛŒ\", \"city\": \"Ù‡ÙˆÙ… Ø§ÛŒØ±Ø§Ù†Ù…Ø§Ù„\"},\n            \"000107\": {\"customer_id\": \"000107\", \"name\": \"Ø®Ø§Ù†Ù… Ù¾Ø±ÙˆÛŒØ²ÛŒ\", \"city\": \"Ø´Ù‡Ø±ÛŒØ§Ø±\"},\n            \"000108\": {\"customer_id\": \"000108\", \"name\": \"Ø¢Ù‚Ø§ÛŒ Ù¾ÛŒØ§Ù… ØµØ§Ù„Ø­ÛŒ\", \"city\": \"Ø¢Ø±ØªÛŒÙ† Ù…ÙˆØ¯\"},\n            \"000114\": {\"customer_id\": \"000114\", \"name\": \"Ø³Ù„Ù Ø¨Ø³ØªÙ†ÛŒ Ø¨Ø§Ø±Ø§Ù†\", \"city\": \"\"},\n            \"000116\": {\"customer_id\": \"000116\", \"name\": \"Ù‡Ø§ÛŒÙ¾Ø± Ø­Ø³ Ù†Ùˆ\", \"city\": \"\"}\n        }\n        \n        logger.info(f\"Customer database initialized with {len(self.customers)} customers\")\n    \n    def authenticate_customer(self, customer_code: str) -> Optional[Dict[str, Any]]:\n        \"\"\"Authenticate customer by customer code\"\"\"\n        # Clean the input code\n        customer_code = customer_code.strip().replace(' ', '').replace('-', '')\n        \n        # Check if code is exactly 6 digits\n        if not customer_code.isdigit() or len(customer_code) != 6:\n            logger.warning(f\"Invalid customer code format: {customer_code}\")\n            return None\n        \n        # Check if customer exists\n        customer = self.customers.get(customer_code)\n        \n        if customer:\n            logger.info(f\"Customer authenticated successfully: {customer['name']} from {customer['city']}\")\n            return customer.copy()\n        else:\n            logger.warning(f\"Customer code not found: {customer_code}\")\n            return None\n    \n    def get_customer_by_id(self, customer_id: str) -> Optional[Dict[str, Any]]:\n        \"\"\"Get customer information by ID\"\"\"\n        return self.customers.get(customer_id)\n    \n    def get_all_customers(self) -> List[Dict[str, Any]]:\n        \"\"\"Get all customers (for admin use)\"\"\"\n        return list(self.customers.values())\n    \n    def get_customers_by_city(self, city: str) -> List[Dict[str, Any]]:\n        \"\"\"Get all customers from a specific city\"\"\"\n        return [customer for customer in self.customers.values() if customer['city'] == city]\n    \n    def get_customer_count(self) -> int:\n        \"\"\"Get total number of registered customers\"\"\"\n        return len(self.customers)\n    \n    def get_cities(self) -> List[str]:\n        \"\"\"Get list of all cities\"\"\"\n        cities = set(customer['city'] for customer in self.customers.values())\n        return sorted(list(cities))\n    \n    def is_valid_customer_code(self, customer_code: str) -> bool:\n        \"\"\"Check if customer code format is valid\"\"\"\n        if not customer_code:\n            return False\n        \n        # Clean the input code\n        customer_code = customer_code.strip().replace(' ', '').replace('-', '')\n        \n        # Check if code is exactly 6 digits\n        return customer_code.isdigit() and len(customer_code) == 6\n    \n    def add_customer(self, customer_code: str, name: str, city: str) -> bool:\n        \"\"\"Add a new customer (admin function)\"\"\"\n        if not self.is_valid_customer_code(customer_code):\n            logger.error(f\"Invalid customer code format: {customer_code}\")\n            return False\n        \n        if customer_code in self.customers:\n            logger.warning(f\"Customer code already exists: {customer_code}\")\n            return False\n        \n        self.customers[customer_code] = {\n            'customer_id': customer_code,\n            'name': name,\n            'city': city\n        }\n        \n        logger.info(f\"New customer added: {name} from {city} with code {customer_code}\")\n        return True\n    \n    def update_customer(self, customer_code: str, name: str = None, city: str = None) -> bool:\n        \"\"\"Update customer information\"\"\"\n        if customer_code not in self.customers:\n            logger.error(f\"Customer not found: {customer_code}\")\n            return False\n        \n        customer = self.customers[customer_code]\n        \n        if name:\n            customer['name'] = name\n        if city:\n            customer['city'] = city\n        \n        logger.info(f\"Customer updated: {customer_code}\")\n        return True\n    \n    def remove_customer(self, customer_code: str) -> bool:\n        \"\"\"Remove a customer (admin function)\"\"\"\n        if customer_code not in self.customers:\n            logger.error(f\"Customer not found: {customer_code}\")\n            return False\n        \n        customer_name = self.customers[customer_code]['name']\n        del self.customers[customer_code]\n        \n        logger.info(f\"Customer removed: {customer_name} ({customer_code})\")\n        return True\n","size_bytes":17190},"data/product_data.py":{"content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\nfrom typing import List, Dict, Any, Optional\n\n# Persian alphabet for search\nPERSIAN_ALPHABET = [\n    'Ø¢', 'Ø§', 'Ø¨', 'Ù¾', 'Øª', 'Ø«', 'Ø¬', 'Ú†', 'Ø­', 'Ø®', 'Ø¯', 'Ø°', 'Ø±', 'Ø²', 'Ú˜',\n    'Ø³', 'Ø´', 'Øµ', 'Ø¶', 'Ø·', 'Ø¸', 'Ø¹', 'Øº', 'Ù', 'Ù‚', 'Ú©', 'Ú¯', 'Ù„', 'Ù…', 'Ù†',\n    'Ùˆ', 'Ù‡', 'ÛŒ'\n]\n\n# Product prices by category\nPRODUCT_PRICES = {\n    'baby': 4780000,\n    'teen': 4780000,\n    'adult': 5600000,\n    'curtain_only': 1550000,  # Base price for silk-cotton fabric\n    'cushion': 2800000,\n    'tablecloth': 2400000  # Base price (will be overridden by size-based pricing)\n}\n\n# Fabric-based pricing for curtains\nCURTAIN_FABRIC_PRICES = {\n    'silk_cotton': 1550000,  # Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\n    'velvet': 1950000        # Ù…Ø®Ù…Ù„\n}\n\n# Size-based pricing for tablecloth category\nTABLECLOTH_SIZE_PRICES = {\n    '120Ã—80': 2400000,\n    '100Ã—100': 2400000,\n    '100Ã—150': 3600000,\n    '120Ã—180': 5200000\n}\n\n# Special pricing for specific products\nSPECIAL_PRODUCT_PRICES = {\n    'cushion_5': 585000,  # Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… Ø¯Ø³ØªÙ‡ Ø¨Ø§Ø²ÛŒ Ø³ÙÛŒØ¯\n    'cushion_6': 585000,  # Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… zone\n    'cushion_7': 855000,  # Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ awsd\n    'cushion_8': 855000,  # Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ ENTER\n    'cushion_9': 3350000,  # Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… PS-KING\n    'cushion_10': 585000,  # Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… Ø¯Ø³ØªÙ‡ Ø¨Ø§Ø²ÛŒ Ø³ÛŒØ§Ù‡\n    'curtain_15': 1950000,  # Ù¾Ø±Ø¯Ù‡ Ø­Ø±ÛŒØ± Ø³Ø±ØªØ®Øª (Ø¬ÙØª) - Ù‚ÛŒÙ…Øª Ø«Ø§Ø¨Øª\n}\n\n# Product categories with updated icons and search characters\nPRODUCT_CATEGORIES = {\n    'baby': {\n        'name':\n        'ğŸ‘¶ Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ²Ø§Ø¯',\n        'price':\n        4780000,\n        'products': [{\n            'id': 'baby_1',\n            'name': 'Ø¢Ù†Ø¬Ù„',\n            'icon': 'ğŸ‘¼',\n            'search_char': 'Ø¢'\n        }, {\n            'id': 'baby_2',\n            'name': 'Ø¢Ù„ÛŒØ³ÙˆÙ†',\n            'icon': 'ğŸŒ¸',\n            'search_char': 'Ø¢'\n        }, {\n            'id': 'baby_3',\n            'name': 'Ø¨Ø§Ø±Ø¨ÛŒ',\n            'icon': 'ğŸ’„',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'baby_4',\n            'name': 'Ø¨Ø§Ø³ØªØ±',\n            'icon': 'ğŸš€',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'baby_5',\n            'name': 'Ø¨Ù„Ø§',\n            'icon': 'ğŸŒŸ',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'baby_6',\n            'name': 'Ø¨Ùˆ',\n            'icon': 'ğŸ‘»',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'baby_7',\n            'name': 'Ù¾Ø¯ÛŒÙ†Ú¯ØªÙˆÙ†',\n            'icon': 'ğŸ§¸',\n            'search_char': 'Ù¾'\n        }, {\n            'id': 'baby_8',\n            'name': 'Ø¯Ø±ÛŒÙ… Ø¨ÛŒÚ¯',\n            'icon': 'ğŸ’¤',\n            'search_char': 'Ø¯'\n        }, {\n            'id': 'baby_9',\n            'name': 'Ø±ÛŒÙ†Ø¨Ùˆ',\n            'icon': 'ğŸŒˆ',\n            'search_char': 'Ø±'\n        }, {\n            'id': 'baby_10',\n            'name': 'Ø³ÙˆÙÛŒ',\n            'icon': 'ğŸ‘¶',\n            'search_char': 'Ø³'\n        }, {\n            'id': 'baby_11',\n            'name': 'Ø´ÙˆÚ©Ø§',\n            'icon': 'ğŸ­',\n            'search_char': 'Ø´'\n        }, {\n            'id': 'baby_12',\n            'name': 'ÙØ§Ø±Ø³Øª',\n            'icon': 'ğŸŒ²',\n            'search_char': 'Ù'\n        }, {\n            'id': 'baby_13',\n            'name': 'Ú©ÛŒÙˆØª Ø¨ÛŒØ±',\n            'icon': 'ğŸ§¸',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'baby_14',\n            'name': 'Ù„Ø¦Ùˆ',\n            'icon': 'ğŸ¦',\n            'search_char': 'Ù„'\n        }, {\n            'id': 'baby_15',\n            'name': 'Ù…Ø¯Ù„ ÙˆÛŒÚ©ÛŒ',\n            'icon': 'ğŸ¦„',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'baby_16',\n            'name': 'ÙˆÙ„Ú©Ø§Ù…',\n            'icon': 'ğŸ‰',\n            'search_char': 'Ùˆ'\n        }, {\n            'id': 'baby_17',\n            'name': 'Ù‡Ù¾ÛŒ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸ˜Š',\n            'search_char': 'Ù‡'\n        }, {\n            'id': 'baby_18',\n            'name': 'Ù‡Ù¾ÛŒ ØµÙˆØ±ØªÛŒ',\n            'icon': 'ğŸ’–',\n            'search_char': 'Ù‡'\n        }, {\n            'id': 'baby_19',\n            'name': 'ÛŒÙˆÙ†ÛŒÚ©ÙˆØ±Ù†',\n            'icon': 'ğŸ¦„',\n            'search_char': 'ÛŒ'\n        }]\n    },\n    'teen': {\n        'name':\n        'ğŸ§’ Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ¬ÙˆØ§Ù†',\n        'price':\n        4780000,\n        'products': [{\n            'id': 'teen_1',\n            'name': 'Ø¢Ø±ØªØ§ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸ¨',\n            'search_char': 'Ø¢'\n        }, {\n            'id': 'teen_2',\n            'name': 'A4 Ø³ÙˆØ±Ù…Ù‡ Ø§ÛŒÛŒ',\n            'icon': 'ğŸ“„',\n            'search_char': 'Ø§'\n        }, {\n            'id': 'teen_3',\n            'name': 'Ø¨Ø§Ù„Ø±ÛŒÙ† Ø³Ø¨Ø² Ú†ÛŒÙ† Ø¯Ø§Ø±',\n            'icon': 'ğŸ©°',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'teen_4',\n            'name': 'Ø¨Ø§Ù„Ø±ÛŒÙ† Ø³Ø¨Ø² Ø¨Ø¯ÙˆÙ† Ú†ÛŒÙ†',\n            'icon': 'ğŸ’š',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'teen_5',\n            'name': 'Ø¨Ø§Ù„Ø±ÛŒÙ† Ø·ÙˆØ³ÛŒ Ú†ÛŒÙ† Ø¯Ø§Ø±',\n            'icon': 'ğŸ©°',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'teen_6',\n            'name': 'Ø¨Ø§Ù„Ø±ÛŒÙ† Ø·ÙˆØ³ÛŒ Ø¨Ø¯ÙˆÙ† Ú†ÛŒÙ†',\n            'icon': 'ğŸ¤',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'teen_7',\n            'name': 'Ù¾Ø§Ø±Ø§Ø¯Ø§ÛŒØ³',\n            'icon': 'ğŸï¸',\n            'search_char': 'Ù¾'\n        }, {\n            'id': 'teen_8',\n            'name': 'Ú¯ÛŒÙ…',\n            'icon': 'ğŸ¯',\n            'search_char': 'Ú¯'\n        }, {\n            'id': 'teen_9',\n            'name': 'Ú¯ÙˆØªÛŒÚ©',\n            'icon': 'ğŸ–¤',\n            'search_char': 'Ú¯'\n        }, {\n            'id': 'teen_10',\n            'name': 'Ú¯Ø±Ø§ÙÛŒØª Ø·ÙˆØ³ÛŒ',\n            'icon': 'âœï¸',\n            'search_char': 'Ú¯'\n        }, {\n            'id': 'teen_11',\n            'name': 'Ú©Ø§Ø¬',\n            'icon': 'ğŸŒ²',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'teen_12',\n            'name': 'Ú©Ø§Ø±Ù† A4 Ø³ÙˆØ±Ù…Ù‡ Ø§ÛŒÛŒ',\n            'icon': 'ğŸ“‹',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'teen_13',\n            'name': 'Ù…Ø¯Ù„ Ú¯ÛŒÙ… Ù‚Ø±Ù…Ø²',\n            'icon': 'ğŸ®',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'teen_14',\n            'name': 'ÙØ¶Ø§',\n            'icon': 'ğŸš€',\n            'search_char': 'Ù'\n        }]\n    },\n    'adult': {\n        'name':\n        'ğŸ‘¨ Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ø¨Ø²Ø±Ú¯Ø³Ø§Ù„',\n        'price':\n        5600000,\n        'products': [{\n            'id': 'adult_1',\n            'name': 'Ø¢ÙˆØ§Ù†Ú¯Ø§Ø±Ø¯',\n            'icon': 'ğŸ­',\n            'search_char': 'Ø¢'\n        }, {\n            'id': 'adult_2',\n            'name': 'Ø¢Ø±ØªØ§ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸ¨',\n            'search_char': 'Ø¢'\n        }, {\n            'id': 'adult_3',\n            'name': 'Ø¨Ø±Ú¯ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸƒ',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'adult_4',\n            'name': 'Ø¨ÙˆÙ‡Ùˆ',\n            'icon': 'ğŸŒ»',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'adult_5',\n            'name': 'Ù¾Ø§Ø±Ø§Ø¯Ø§ÛŒØ³ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸ–ï¸',\n            'search_char': 'Ù¾'\n        }, {\n            'id': 'adult_6',\n            'name': 'ÙØ±Ø´ØªÙ‡',\n            'icon': 'ğŸ˜‡',\n            'search_char': 'Ù'\n        }, {\n            'id': 'adult_7',\n            'name': 'Ú¯ÙˆØªÛŒÚ©',\n            'icon': 'ğŸ–¤',\n            'search_char': 'Ú¯'\n        }, {\n            'id': 'adult_8',\n            'name': 'Ù‡Ù„Ù†',\n            'icon': 'ğŸ‘‘',\n            'search_char': 'Ù‡'\n        }]\n    },\n    'curtain_only': {\n        'name':\n        'ğŸªŸ Ù¾Ø±Ø¯Ù‡',\n        'price':\n        1550000,\n        'products': [{\n            'id': 'curtain_1',\n            'name': 'ÙØ§Ø±Ø³Øª',\n            'icon': 'ğŸŒ²',\n            'search_char': 'Ù'\n        }, {\n            'id': 'curtain_2',\n            'name': 'Ú¯ÛŒÙ…',\n            'icon': 'ğŸ®',\n            'search_char': 'Ú¯'\n        }, {\n            'id': 'curtain_3',\n            'name': 'Ú©ÛŒÙˆØª Ø¨ÛŒØ±',\n            'icon': 'ğŸ§¸',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'curtain_4',\n            'name': 'Ø¨Ùˆ',\n            'icon': 'ğŸ‘»',\n            'search_char': 'Ø¨'\n        }, {\n            'id': 'curtain_5',\n            'name': 'Ù¾Ø¯ÛŒÙ†Ú¯ØªÙˆÙ†',\n            'icon': 'ğŸ§¸',\n            'search_char': 'Ù¾'\n        }, {\n            'id': 'curtain_6',\n            'name': 'Ø¢Ù†Ø¬Ù„',\n            'icon': 'ğŸ‘¼',\n            'search_char': 'Ø¢'\n        }, {\n            'id': 'curtain_7',\n            'name': 'Ø§Ù„ÛŒØ³ÙˆÙ†',\n            'icon': 'ğŸŒ¸',\n            'search_char': 'Ø§'\n        }, {\n            'id': 'curtain_8',\n            'name': 'ÙˆÙ„Ú©Ø§Ù…',\n            'icon': 'ğŸ‰',\n            'search_char': 'Ùˆ'\n        }, {\n            'id': 'curtain_9',\n            'name': 'Ø¯Ø±ÛŒÙ… Ø¨ÛŒÚ¯',\n            'icon': 'ğŸ’¤',\n            'search_char': 'Ø¯'\n        }, {\n            'id': 'curtain_10',\n            'name': 'Ú†ÛŒÚ©Ùˆ',\n            'icon': 'ğŸ¥',\n            'search_char': 'Ú†'\n        }, {\n            'id': 'curtain_11',\n            'name': 'ÙˆÛŒÚ©ÛŒ',\n            'icon': 'ğŸ¦„',\n            'search_char': 'Ùˆ'\n        }, {\n            'id': 'curtain_12',\n            'name': 'Ù‡Ù¾ÛŒ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸ˜Š',\n            'search_char': 'Ù‡'\n        }, {\n            'id': 'curtain_13',\n            'name': 'Ù‡Ù¾ÛŒ ØµÙˆØ±ØªÛŒ',\n            'icon': 'ğŸ’–',\n            'search_char': 'Ù‡'\n        }, {\n            'id': 'curtain_14',\n            'name': 'ÛŒÙˆÙ†ÛŒÚ©ÙˆØ±Ù†',\n            'icon': 'ğŸ¦„',\n            'search_char': 'ÛŒ'\n        }, {\n            'id': 'curtain_15',\n            'name': 'Ù¾Ø±Ø¯Ù‡ Ø­Ø±ÛŒØ± Ø³Ø±ØªØ®Øª (Ø¬ÙØª)',\n            'icon': 'ğŸªŸ',\n            'search_char': 'Ù¾'\n        }, {\n            'id': 'curtain_16',\n            'name': 'Ø±ÛŒÙ†Ø¨Ùˆ',\n            'icon': 'ğŸŒˆ',\n            'search_char': 'Ø±'\n        }, {\n            'id': 'curtain_17',\n            'name': 'GT Ù‚Ø±Ù…Ø²',\n            'icon': 'ğŸï¸',\n            'search_char': 'Ú¯'\n        }]\n    },\n    'cushion': {\n        'name':\n        'ğŸ§¸ Ú©ÙˆØ³Ù† Ùˆ Ø¹Ø±ÙˆØ³Ú©',\n        'price':\n        2800000,\n        'products': [{\n            'id': 'cushion_5',\n            'name': 'Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… Ø¯Ø³ØªÙ‡ Ø¨Ø§Ø²ÛŒ Ø³ÙÛŒØ¯',\n            'icon': 'ğŸ®',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'cushion_6',\n            'name': 'Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… zone',\n            'icon': 'ğŸ¯',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'cushion_7',\n            'name': 'Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ awsd',\n            'icon': 'âŒ¨ï¸',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'cushion_8',\n            'name': 'Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ ENTER',\n            'icon': 'â',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'cushion_9',\n            'name': 'Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… PS-KING',\n            'icon': 'ğŸ®',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'cushion_10',\n            'name': 'Ú©ÙˆØ³Ù† Ù…Ø®Ù…Ù„ Ú¯ÛŒÙ… Ø¯Ø³ØªÙ‡ Ø¨Ø§Ø²ÛŒ Ø³ÛŒØ§Ù‡',\n            'icon': 'ğŸ–¤',\n            'search_char': 'Ú©'\n        }]\n    },\n    'tablecloth': {\n        'name':\n        'ÙØ±Ø´ÛŒÙ†Ù‡',\n        'price':\n        2400000,  # Base price for smallest size\n        'products': [{\n            'id': 'tablecloth_1',\n            'name': 'Ú©ÛŒÙˆØª Ø¨ÛŒØ±',\n            'icon': 'ğŸ§¸',\n            'search_char': 'Ú©'\n        }, {\n            'id': 'tablecloth_2',\n            'name': 'Ù…Ø¯Ù„ ÙØ§Ø±Ø³Øª',\n            'icon': 'ğŸŒ²',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_3',\n            'name': 'Ù…Ø¯Ù„ Ú¯ÛŒÙ…',\n            'icon': 'ğŸ®',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_4',\n            'name': 'Ù…Ø¯Ù„ Ø±ÛŒÙ†Ø¨Ùˆ',\n            'icon': 'ğŸŒˆ',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_5',\n            'name': 'Ù…Ø¯Ù„ Ø¨Ùˆ',\n            'icon': 'ğŸ‘»',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_6',\n            'name': 'Ù…Ø¯Ù„ Ù¾Ø¯ÛŒÙ†Ú¯ØªÙˆÙ†',\n            'icon': 'ğŸ§¸',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_7',\n            'name': 'Ù…Ø¯Ù„ Ù‡Ù¾ÛŒ Ø³ÛŒØªÛŒ',\n            'icon': 'ğŸ™ï¸',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_8',\n            'name': 'Ù…Ø¯Ù„ Ù‡Ù¾ÛŒ Ø·ÙˆØ³ÛŒ',\n            'icon': 'ğŸ˜Š',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_9',\n            'name': 'Ù…Ø¯Ù„ GTA',\n            'icon': 'ğŸš—',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_10',\n            'name': 'Ù…Ø¯Ù„ ÛŒÙˆÙ†ÛŒÚ©ÙˆØ±Ù†',\n            'icon': 'ğŸ¦„',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_11',\n            'name': 'Ù…Ø¯Ù„ Ø¨Ø§Ø³ØªØ±',\n            'icon': 'ğŸš€',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_12',\n            'name': 'Ù…Ø¯Ù„ Ø§Ù„ÛŒØ³ÙˆÙ†',\n            'icon': 'ğŸŒ¸',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_13',\n            'name': 'Ù…Ø¯Ù„ race',\n            'icon': 'ğŸ',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_14',\n            'name': 'Ù…Ø¯Ù„ Ù‡Ù¾ÛŒ ØµÙˆØ±ØªÛŒ',\n            'icon': 'ğŸ’–',\n            'search_char': 'Ù…'\n        }, {\n            'id': 'tablecloth_15',\n            'name': 'Ù…Ø¯Ù„ ÙˆÙ„Ú©Ø§Ù…',\n            'icon': 'ğŸ‰',\n            'search_char': 'Ù…'\n        }]\n    }\n}\n\n\ndef get_products_by_category(category_id: str) -> List[Dict[str, Any]]:\n    \"\"\"Get all products for a specific category\"\"\"\n    category = PRODUCT_CATEGORIES.get(category_id, {})\n    products = category.get('products', [])\n\n    # Add category_id to each product\n    for product in products:\n        product['category_id'] = category_id\n\n    return products\n\n\ndef get_product_by_id(product_id: str) -> Optional[Dict[str, Any]]:\n    \"\"\"Find a product by its ID across all categories\"\"\"\n    for category_id, category_info in PRODUCT_CATEGORIES.items():\n        for product in category_info.get('products', []):\n            if product['id'] == product_id:\n                product['category_id'] = category_id\n                # Add special price if exists\n                if product_id in SPECIAL_PRODUCT_PRICES:\n                    product['special_price'] = SPECIAL_PRODUCT_PRICES[\n                        product_id]\n                return product\n    return None\n\n\ndef get_product_price(product_id: str, category_id: str, size: str = None, fabric: str = None) -> int:\n    \"\"\"Get price for a specific product, checking for special pricing first\"\"\"\n    if product_id in SPECIAL_PRODUCT_PRICES:\n        return SPECIAL_PRODUCT_PRICES[product_id]\n    \n    # Size-based pricing for tablecloth category\n    if category_id == 'tablecloth' and size and size in TABLECLOTH_SIZE_PRICES:\n        return TABLECLOTH_SIZE_PRICES[size]\n    \n    # Fabric-based pricing for curtains\n    if category_id == 'curtain_only' and fabric and fabric in CURTAIN_FABRIC_PRICES:\n        return CURTAIN_FABRIC_PRICES[fabric]\n    \n    return PRODUCT_PRICES.get(category_id, 2800000)\n\n\ndef search_products_by_name(\n        category_id: str,\n        search_letter: str,\n        subcategory_id: Optional[str] = None) -> List[Dict[str, Any]]:\n    \"\"\"Search products by first letter in a category\"\"\"\n    # Handle subcategory mapping\n    actual_category = subcategory_id if subcategory_id else category_id\n\n    products = get_products_by_category(actual_category)\n\n    # Filter by first letter\n    filtered_products = []\n    for product in products:\n        if product.get('search_char', '').startswith(search_letter):\n            filtered_products.append(product)\n\n    return filtered_products\n\n\ndef get_category_info(category_id: str) -> Dict[str, Any]:\n    \"\"\"Get category information\"\"\"\n    return PRODUCT_CATEGORIES.get(category_id, {})\n\n\ndef get_all_categories() -> Dict[str, Any]:\n    \"\"\"Get all product categories\"\"\"\n    return PRODUCT_CATEGORIES\n\n\ndef get_category_product_icons(category_id: str) -> List[tuple]:\n    \"\"\"Get individual products with their icons and descriptions for a category\"\"\"\n    products = get_products_by_category(category_id)\n\n    # Return individual products instead of grouping\n    result = []\n    for product in products:\n        icon = product.get('icon', 'ğŸ›ï¸')\n        description = product['name']  # Just the product name without emoji\n        result.append((icon, description,\n                       product['id']))  # Include product ID for callback\n\n    return result\n\n\ndef search_products_by_icon(category_id: str,\n                            target_icon: str) -> List[Dict[str, Any]]:\n    \"\"\"Search products by icon in a category\"\"\"\n    products = get_products_by_category(category_id)\n\n    # Filter by icon\n    filtered_products = []\n    for product in products:\n        if product.get('icon', 'ğŸ›ï¸') == target_icon:\n            filtered_products.append(product)\n\n    return filtered_products\n","size_bytes":17332},"utils/__init__.py":{"content":"\"\"\"\nUtils Package\nContains utility functions for logging, Persian language support, and helper functions.\n\"\"\"\n","size_bytes":110},"utils/logger.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nLogging Configuration\nProvides centralized logging setup for the bot.\n\"\"\"\n\nimport logging\nimport os\nfrom datetime import datetime\n\ndef setup_logger(name: str, log_file: str = None, level: str = \"INFO\") -> logging.Logger:\n    \"\"\"\n    Set up a logger with both file and console handlers\n    \n    Args:\n        name: Logger name (usually __name__)\n        log_file: Path to log file (optional)\n        level: Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)\n    \n    Returns:\n        Configured logger instance\n    \"\"\"\n    \n    # Create logger\n    logger = logging.getLogger(name)\n    \n    # Check if logger already has handlers to avoid duplicate logs\n    if logger.handlers:\n        return logger\n    \n    # Set logging level\n    log_levels = {\n        \"DEBUG\": logging.DEBUG,\n        \"INFO\": logging.INFO,\n        \"WARNING\": logging.WARNING,\n        \"ERROR\": logging.ERROR,\n        \"CRITICAL\": logging.CRITICAL\n    }\n    logger.setLevel(log_levels.get(level.upper(), logging.INFO))\n    \n    # Create formatter\n    formatter = logging.Formatter(\n        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n        datefmt='%Y-%m-%d %H:%M:%S'\n    )\n    \n    # Console handler\n    console_handler = logging.StreamHandler()\n    console_handler.setFormatter(formatter)\n    logger.addHandler(console_handler)\n    \n    # File handler (if log_file is provided)\n    if log_file:\n        # Create log directory if it doesn't exist\n        log_dir = os.path.dirname(log_file)\n        if log_dir and not os.path.exists(log_dir):\n            os.makedirs(log_dir, exist_ok=True)\n        \n        file_handler = logging.FileHandler(log_file, encoding='utf-8')\n        file_handler.setFormatter(formatter)\n        logger.addHandler(file_handler)\n    \n    # Prevent propagation to root logger\n    logger.propagate = False\n    \n    return logger\n\ndef get_daily_log_file(base_name: str = \"bot\") -> str:\n    \"\"\"\n    Generate a daily log file name\n    \n    Args:\n        base_name: Base name for the log file\n    \n    Returns:\n        Path to daily log file\n    \"\"\"\n    today = datetime.now().strftime(\"%Y-%m-%d\")\n    log_dir = \"bot_logs\"\n    os.makedirs(log_dir, exist_ok=True)\n    return os.path.join(log_dir, f\"{base_name}_{today}.log\")\n","size_bytes":2255},"utils/persian_utils.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nPersian Language Utilities\nHelper functions for Persian text processing and formatting.\n\"\"\"\n\nimport re\nfrom typing import Union\n\n# Persian to English digit mapping\nPERSIAN_DIGITS = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'\nENGLISH_DIGITS = '0123456789'\n\n# Persian to English digit translation table\nPERSIAN_TO_ENGLISH = str.maketrans(PERSIAN_DIGITS, ENGLISH_DIGITS)\nENGLISH_TO_PERSIAN = str.maketrans(ENGLISH_DIGITS, PERSIAN_DIGITS)\n\ndef persian_numbers(text: str) -> str:\n    \"\"\"\n    Convert English numbers to Persian numbers\n    \n    Args:\n        text: Text containing English digits\n    \n    Returns:\n        Text with Persian digits\n    \"\"\"\n    return text.translate(ENGLISH_TO_PERSIAN)\n\ndef english_numbers(text: str) -> str:\n    \"\"\"\n    Convert Persian numbers to English numbers\n    \n    Args:\n        text: Text containing Persian digits\n    \n    Returns:\n        Text with English digits\n    \"\"\"\n    return text.translate(PERSIAN_TO_ENGLISH)\n\ndef format_price(price: Union[int, float]) -> str:\n    \"\"\"\n    Format price with Persian number separators\n    \n    Args:\n        price: Price value\n    \n    Returns:\n        Formatted price string with Persian digits and separators\n    \"\"\"\n    if isinstance(price, float):\n        price = int(price)\n    \n    # Add thousand separators\n    price_str = f\"{price:,}\"\n    \n    # Convert to Persian digits\n    price_str = persian_numbers(price_str)\n    \n    return price_str\n\ndef clean_persian_text(text: str) -> str:\n    \"\"\"\n    Clean and normalize Persian text\n    \n    Args:\n        text: Persian text to clean\n    \n    Returns:\n        Cleaned Persian text\n    \"\"\"\n    if not text:\n        return \"\"\n    \n    # Remove extra whitespaces\n    text = re.sub(r'\\s+', ' ', text.strip())\n    \n    # Normalize Persian characters\n    text = text.replace('Ùƒ', 'Ú©')  # Arabic Kaf to Persian Kaf\n    text = text.replace('ÙŠ', 'ÛŒ')  # Arabic Yeh to Persian Yeh\n    text = text.replace('Ø©', 'Ù‡')  # Arabic Teh Marbuta to Heh\n    \n    return text\n\ndef is_persian_text(text: str) -> bool:\n    \"\"\"\n    Check if text contains Persian characters\n    \n    Args:\n        text: Text to check\n    \n    Returns:\n        True if text contains Persian characters\n    \"\"\"\n    persian_pattern = r'[\\u0600-\\u06FF\\u200C\\u200D]'\n    return bool(re.search(persian_pattern, text))\n\ndef extract_numbers(text: str) -> list:\n    \"\"\"\n    Extract all numbers (Persian and English) from text\n    \n    Args:\n        text: Text to extract numbers from\n    \n    Returns:\n        List of extracted numbers as integers\n    \"\"\"\n    # Convert Persian digits to English first\n    text = english_numbers(text)\n    \n    # Find all numbers\n    numbers = re.findall(r'\\d+', text)\n    \n    # Convert to integers\n    return [int(num) for num in numbers]\n\ndef format_phone_number(phone: str) -> str:\n    \"\"\"\n    Format Iranian phone number\n    \n    Args:\n        phone: Phone number string\n    \n    Returns:\n        Formatted phone number\n    \"\"\"\n    # Remove all non-digit characters\n    phone = re.sub(r'\\D', '', english_numbers(phone))\n    \n    # Iranian mobile number formatting\n    if len(phone) == 11 and phone.startswith('09'):\n        return persian_numbers(f\"{phone[:4]}-{phone[4:7]}-{phone[7:]}\")\n    elif len(phone) == 10 and phone.startswith('9'):\n        return persian_numbers(f\"Û°{phone[:3]}-{phone[3:6]}-{phone[6:]}\")\n    \n    # Return as-is if doesn't match expected patterns\n    return persian_numbers(phone)\n\ndef truncate_persian_text(text: str, max_length: int, suffix: str = \"...\") -> str:\n    \"\"\"\n    Truncate Persian text to specified length\n    \n    Args:\n        text: Text to truncate\n        max_length: Maximum allowed length\n        suffix: Suffix to add when truncating\n    \n    Returns:\n        Truncated text\n    \"\"\"\n    if len(text) <= max_length:\n        return text\n    \n    truncated = text[:max_length - len(suffix)]\n    \n    # Try to break at word boundary\n    last_space = truncated.rfind(' ')\n    if last_space > max_length // 2:\n        truncated = truncated[:last_space]\n    \n    return truncated + suffix\n","size_bytes":4061},"payment_data/bot/__init__.py":{"content":"\"\"\"\nBot Package\nContains all bot-related functionality including handlers, keyboards, and cart management.\n\"\"\"\n","size_bytes":111},"payment_data/bot/cart.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nShopping Cart Management\nHandles cart operations with JSON file-based persistence.\n\"\"\"\n\nimport json\nimport os\nfrom typing import List, Dict, Any, Optional\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass CartManager:\n    \"\"\"Manages shopping cart operations with file-based persistence\"\"\"\n    \n    def __init__(self, cart_data_dir: str = \"cart_data\"):\n        self.cart_data_dir = cart_data_dir\n        # Ensure cart data directory exists\n        os.makedirs(self.cart_data_dir, exist_ok=True)\n    \n    def _get_cart_file_path(self, user_id: int) -> str:\n        \"\"\"Get the file path for a user's cart\"\"\"\n        return os.path.join(self.cart_data_dir, f\"cart_{user_id}.json\")\n    \n    def get_cart(self, user_id: int) -> List[Dict[str, Any]]:\n        \"\"\"Get cart items for a user\"\"\"\n        cart_file = self._get_cart_file_path(user_id)\n        \n        try:\n            if os.path.exists(cart_file):\n                with open(cart_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            return []\n        except Exception as e:\n            logger.error(f\"Error loading cart for user {user_id}: {e}\")\n            return []\n    \n    def save_cart(self, user_id: int, cart_items: List[Dict[str, Any]]) -> bool:\n        \"\"\"Save cart items for a user\"\"\"\n        cart_file = self._get_cart_file_path(user_id)\n        \n        try:\n            with open(cart_file, 'w', encoding='utf-8') as f:\n                json.dump(cart_items, f, ensure_ascii=False, indent=2)\n            logger.info(f\"Cart saved for user {user_id}: {len(cart_items)} items\")\n            return True\n        except Exception as e:\n            logger.error(f\"Error saving cart for user {user_id}: {e}\")\n            return False\n    \n    def add_to_cart(self, user_id: int, item: Dict[str, Any]) -> bool:\n        \"\"\"Add an item to user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        # Check if item already exists in cart\n        existing_item = None\n        for cart_item in cart_items:\n            if (cart_item['product_id'] == item['product_id'] and \n                cart_item['size'] == item['size']):\n                existing_item = cart_item\n                break\n        \n        if existing_item:\n            # Update quantity\n            existing_item['quantity'] += item['quantity']\n            logger.info(f\"Updated quantity for product {item['product_id']} in cart of user {user_id}\")\n        else:\n            # Add new item\n            cart_items.append(item)\n            logger.info(f\"Added new product {item['product_id']} to cart of user {user_id}\")\n        \n        return self.save_cart(user_id, cart_items)\n    \n    def remove_from_cart(self, user_id: int, product_id: str, size: str) -> bool:\n        \"\"\"Remove an item from user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        # Find and remove the item\n        cart_items = [\n            item for item in cart_items \n            if not (item['product_id'] == product_id and item['size'] == size)\n        ]\n        \n        logger.info(f\"Removed product {product_id} (size {size}) from cart of user {user_id}\")\n        return self.save_cart(user_id, cart_items)\n    \n    def update_quantity(self, user_id: int, product_id: str, size: str, new_quantity: int) -> bool:\n        \"\"\"Update quantity of an item in user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        for item in cart_items:\n            if item['product_id'] == product_id and item['size'] == size:\n                if new_quantity <= 0:\n                    # Remove item if quantity is 0 or negative\n                    return self.remove_from_cart(user_id, product_id, size)\n                else:\n                    item['quantity'] = new_quantity\n                    logger.info(f\"Updated quantity of product {product_id} to {new_quantity} for user {user_id}\")\n                    return self.save_cart(user_id, cart_items)\n        \n        logger.warning(f\"Product {product_id} (size {size}) not found in cart of user {user_id}\")\n        return False\n    \n    def clear_cart(self, user_id: int) -> bool:\n        \"\"\"Clear all items from user's cart\"\"\"\n        return self.save_cart(user_id, [])\n    \n    def get_cart_total(self, user_id: int) -> float:\n        \"\"\"Calculate total price of items in user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        total = sum(item['price'] * item['quantity'] for item in cart_items)\n        return total\n    \n    def get_cart_item_count(self, user_id: int) -> int:\n        \"\"\"Get total number of items in user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        return sum(item['quantity'] for item in cart_items)\n    \n    def is_cart_empty(self, user_id: int) -> bool:\n        \"\"\"Check if user's cart is empty\"\"\"\n        cart_items = self.get_cart(user_id)\n        return len(cart_items) == 0\n    \n    def get_cart_summary(self, user_id: int) -> Dict[str, Any]:\n        \"\"\"Get a summary of user's cart\"\"\"\n        cart_items = self.get_cart(user_id)\n        \n        return {\n            'items': cart_items,\n            'item_count': sum(item['quantity'] for item in cart_items),\n            'total_price': sum(item['price'] * item['quantity'] for item in cart_items),\n            'unique_products': len(cart_items)\n        }\n","size_bytes":5344},"payment_data/bot/config.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBot Configuration - Fixed Version\nManages environment variables and configuration settings.\n\"\"\"\n\nimport os\nimport logging\nfrom typing import List, Optional\n\n\nclass Config:\n    \"\"\"Configuration class for the Telegram bot\"\"\"\n\n    def __init__(self):\n        \"\"\"Initialize configuration from environment variables\"\"\"\n        # Get bot token from environment or use provided token\n        self.bot_token: str = os.getenv(\"BOT_TOKEN\", \"482872229:AAEG0hySlWspi-KOF5lbR2fMZGJ1qWUPLn0\")\n\n        if not self.bot_token:\n            raise ValueError(\"BOT_TOKEN not found in environment variables\")\n\n        # ZarinPal configuration - using your provided merchant ID\n        self.zarinpal_merchant_id: str = os.getenv(\n            \"ZARINPAL_MERCHANT_ID\", \"fd4166f9-78e2-4228-ac7d-077a5168f064\")\n        self.zarinpal_sandbox: bool = os.getenv(\"ZARINPAL_SANDBOX\",\n                                                \"True\").lower() == \"true\"\n\n        # Order group settings\n        self.order_group_chat_id = os.getenv('ORDER_GROUP_CHAT_ID')\n\n        # Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Chat ID Ú¯Ø±ÙˆÙ‡ DecoTeen Bot Orders Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†\n        if not self.order_group_chat_id:\n            # Chat ID Ø§Ø² Ø¹Ú©Ø³: -4804296164 (Ú¯Ø±ÙˆÙ‡ DecoTeen Bot Orders)\n            self.order_group_chat_id = -4804296164\n            logging.info(\n                f\"âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: {self.order_group_chat_id}\")\n        else:\n            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ int\n            try:\n                self.order_group_chat_id = int(self.order_group_chat_id)\n                logging.info(\n                    f\"âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡: {self.order_group_chat_id}\")\n            except ValueError:\n                logging.error(\n                    f\"âŒ ORDER_GROUP_CHAT_ID Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {self.order_group_chat_id}\"\n                )\n                # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶\n                self.order_group_chat_id = -4804296164\n                logging.info(\n                    f\"âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ù‡ Ø¬Ø§ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {self.order_group_chat_id}\"\n                )\n\n        # Optional configurations with safe defaults\n        self.admin_ids: List[int] = self._parse_admin_ids()\n        self.log_level: str = os.getenv(\"LOG_LEVEL\", \"INFO\")\n        self.cart_data_dir: str = os.getenv(\"CART_DATA_DIR\", \"cart_data\")\n        self.max_cart_items: int = int(os.getenv(\"MAX_CART_ITEMS\", \"50\"))\n\n        # Bot domain for payment callbacks\n        self.bot_domain: str = os.getenv(\"BOT_DOMAIN\", \"example.com\")\n\n    def _parse_admin_ids(self) -> List[int]:\n        \"\"\"Parse admin IDs from environment variable\"\"\"\n        admin_ids_str = os.getenv(\"ADMIN_IDS\", \"\")\n        if not admin_ids_str:\n            return []\n\n        try:\n            return [\n                int(id_str.strip()) for id_str in admin_ids_str.split(\",\")\n                if id_str.strip()\n            ]\n        except ValueError:\n            logging.warning(\"Invalid ADMIN_IDS format. Using empty list.\")\n            return []\n\n    def get_callback_url(self) -> str:\n        \"\"\"Get payment callback URL\"\"\"\n        return f\"https://{self.bot_domain}/payment/callback\"\n\n    def validate_setup(self) -> List[str]:\n        \"\"\"Validate configuration and return list of issues\"\"\"\n        issues = []\n\n        if not self.bot_token or self.bot_token == \"YOUR_BOT_TOKEN_HERE\":\n            issues.append(\"BOT_TOKEN is not set or using placeholder value\")\n\n        if not self.zarinpal_merchant_id or self.zarinpal_merchant_id == \"YOUR_MERCHANT_ID\":\n            issues.append(\n                \"ZARINPAL_MERCHANT_ID is not set or using placeholder value\")\n\n        if self.bot_domain == \"example.com\":\n            issues.append(\n                \"BOT_DOMAIN should be set to your actual domain (required for payment callbacks)\"\n            )\n\n        if not self.admin_ids:\n            issues.append(\"Consider setting ADMIN_IDS for bot administration\")\n\n        return issues\n\n    def print_config_status(self):\n        \"\"\"Print configuration status for debugging\"\"\"\n        print(\"=== Bot Configuration Status ===\")\n        print(f\"Bot Token: âœ… Set and Ready\")\n        print(\n            f\"ZarinPal Merchant ID: âœ“ Set ({self.zarinpal_merchant_id[:8]}...{self.zarinpal_merchant_id[-8:]})\"\n        )\n        print(f\"Bot Domain: âœ“ Set ({self.bot_domain})\")\n        print(f\"Callback URL: {self.get_callback_url()}\")\n        print(f\"Admin IDs: {len(self.admin_ids)} configured\")\n        print(f\"Order Group ID: âœ“ Set ({self.order_group_chat_id})\")\n        print(\n            f\"ZarinPal Sandbox: {'Enabled' if self.zarinpal_sandbox else 'Disabled'}\"\n        )\n        print(f\"Max Cart Items: {self.max_cart_items}\")\n        print(\"================================\")\n\n        issues = self.validate_setup()\n        if issues:\n            print(\"âš ï¸ Configuration Notes:\")\n            for issue in issues:\n                print(f\"  - {issue}\")\n        else:\n            print(\"âœ… Configuration is complete!\")\n\n    async def test_group_connection(self, bot):\n        \"\"\"Test connection to order group\"\"\"\n        if not self.order_group_chat_id:\n            print(\"âŒ Order group ID not configured\")\n            return False\n\n        try:\n            # Try to get chat info\n            chat = await bot.get_chat(self.order_group_chat_id)\n            print(f\"âœ… Group connection successful!\")\n            print(f\"   Title: {chat.title}\")\n            print(f\"   Type: {chat.type}\")\n            print(\n                f\"   Member count: {await bot.get_chat_member_count(self.order_group_chat_id)}\"\n            )\n            return True\n        except Exception as e:\n            print(f\"âŒ Group connection failed: {e}\")\n            print(f\"   Group ID: {self.order_group_chat_id}\")\n            print(\"   Possible issues:\")\n            print(\"   - Bot is not a member of the group\")\n            print(\"   - Group ID is incorrect\")\n            print(\"   - Bot doesn't have permission to send messages\")\n            return False\n\n\n# Example usage and testing\nif __name__ == \"__main__\":\n    config = Config()\n    config.print_config_status()\n\n    print(\"\\nâœ… Setup Complete! Your bot is ready to run!\")\n","size_bytes":6271},"payment_data/bot/handlers.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBot Handlers\nMain bot handlers for commands, callbacks, and message processing.\n\"\"\"\n\nfrom telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup\nfrom telegram.ext import ContextTypes, CommandHandler, CallbackQueryHandler, MessageHandler, filters\nfrom bot.keyboards import BotKeyboards\nfrom bot.cart import CartManager\nfrom bot.pricing import PricingManager\nfrom bot.zarinpal import ZarinPalGateway\nfrom bot.payment_scheduler import PaymentScheduler\nfrom bot.order_server import OrderManagementServer, OrderStatus\nfrom bot.config import Config\nfrom data.customer_service import CustomerService\nfrom data.product_data import (get_products_by_category, get_product_by_id,\n                               search_products_by_name,\n                               search_products_by_icon, get_category_info,\n                               get_product_price, PERSIAN_ALPHABET, PRODUCT_PRICES)\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\nfrom datetime import datetime\nfrom typing import Dict, List\nimport json\n\nlogger = setup_logger(__name__)\n\n\nclass BotHandlers:\n    \"\"\"Main class handling all bot interactions\"\"\"\n\n    def __init__(self):\n        self.keyboards = BotKeyboards()\n        self.cart_manager = CartManager()\n        self.pricing_manager = PricingManager()\n        self.customer_service = CustomerService()\n        self.config = Config()\n        self.zarinpal = ZarinPalGateway(\n            merchant_id=self.config.zarinpal_merchant_id,\n            sandbox=self.config.zarinpal_sandbox)\n        self.payment_scheduler = PaymentScheduler()\n        self.order_server = OrderManagementServer()\n        self.user_sessions = {}  # Store user session data\n        self.bot = None  # Bot instance Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ\n        logger.info(\"ğŸ”„ PricingManager initialized with updated payment display configurations\")\n\n    def setup_handlers(self, application):\n        \"\"\"Setup all bot handlers\"\"\"\n        # ØªÙ†Ø¸ÛŒÙ… bot instance Ø¯Ø± Ø³Ø±ÙˆØ± Ø³ÙØ§Ø±Ø´Ø§Øª Ùˆ handlers\n        self.order_server.set_bot(application.bot)\n        self.bot = application.bot  # ØªÙ†Ø¸ÛŒÙ… bot instance Ø¯Ø± handlers\n\n        # Command handlers\n        application.add_handler(CommandHandler(\"start\", self.start_command))\n        application.add_handler(CommandHandler(\"help\", self.help_command))\n        application.add_handler(CommandHandler(\"debug\", self.debug_command))\n        application.add_handler(CommandHandler(\"pricing\", self.pricing_test_command))\n\n        # Callback query handlers\n        application.add_handler(CallbackQueryHandler(self.button_callback))\n\n        # Message handlers\n        application.add_handler(\n            MessageHandler(filters.TEXT & ~filters.COMMAND,\n                           self.handle_text_message))\n\n        # Photo handler for receipt uploads\n        application.add_handler(\n            MessageHandler(filters.PHOTO, self.handle_photo_message))\n\n        # Group message handler for support\n        application.add_handler(\n            MessageHandler(filters.TEXT & filters.ChatType.GROUPS,\n                           self.handle_group_message))\n\n        logger.info(\"âœ… All handlers registered successfully\")\n\n    async def start_command(self, update: Update,\n                            context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /start command\"\"\"\n        user_id = update.effective_user.id\n        logger.info(f\"User {user_id} started the bot\")\n\n        # Set user state to awaiting customer code directly\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['awaiting_customer_code'] = True\n\n        welcome_text = (\"ğŸ” Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¯Ú©ÙˆØªÛŒÙ†\\n\\n\"\n                        \"Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø´Ø´ Ø±Ù‚Ù…ÛŒ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n\n        await update.message.reply_text(welcome_text)\n\n    async def help_command(self, update: Update,\n                            context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /help command\"\"\"\n        help_text = (\"ğŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª:\\n\\n\"\n                     \"ğŸ”¹ /start - Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø±Ø¨Ø§Øª\\n\"\n                     \"ğŸ”¹ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ\\n\"\n                     \"ğŸ”¹ Ù…Ø±ÙˆØ± Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ\\n\"\n                     \"ğŸ”¹ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\"\n                     \"ğŸ”¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ² Ùˆ ØªØ¹Ø¯Ø§Ø¯\\n\"\n                     \"ğŸ”¹ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯\\n\"\n                     \"ğŸ”¹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ± Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª\\n\\n\"\n                     \"ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯Ú©Ù…Ù‡ Â«Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ù…Ø§ÛŒÙ†Ø¯Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.\")\n        await update.message.reply_text(help_text)\n\n    async def debug_command(self, update: Update,\n                            context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /debug command - for troubleshooting\"\"\"\n        chat_id = update.effective_chat.id\n        chat_type = update.effective_chat.type\n        user_id = update.effective_user.id\n\n        debug_info = (\n            f\"ğŸ” Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯:\\n\\n\"\n            f\"ğŸ’¬ Chat ID: {chat_id}\\n\"\n            f\"ğŸ“ Chat Type: {chat_type}\\n\"\n            f\"ğŸ‘¤ User ID: {user_id}\\n\"\n            f\"âš™ï¸ Configured Group ID: {self.config.order_group_chat_id}\\n\"\n            f\"âœ… Match: {'YES' if str(chat_id) == str(self.config.order_group_chat_id) else 'NO'}\\n\\n\"\n            f\"ğŸ“‹ Test Commands:\\n\"\n            f\"â€¢ Ø³ÙØ§Ø±Ø´\\n\"\n            f\"â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§\\n\"\n            f\"â€¢ Ø¢Ù…Ø§Ø±\"\n        )\n\n        await update.message.reply_text(debug_info)\n\n        # Ø°Ø®ÛŒØ±Ù‡ Chat ID Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢ÛŒÙ†Ø¯Ù‡\n        logger.info(f\"ğŸ”§ DEBUG: Chat ID {chat_id} can be used as ORDER_GROUP_CHAT_ID\")\n\n    async def pricing_test_command(self, update: Update,\n                                  context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle /pricing command - test pricing functionality\"\"\"\n        test_items = [{\n            'product_name': 'ØªØ´Ú© Ø¨Ú†Ù‡ ØªØ³Øª',\n            'size': '120x60',\n            'quantity': 1,\n            'price': 4780000\n        }]\n        test_customer = {\n            'name': 'ØªØ³Øª Ú©Ø§Ø±Ø¨Ø±',\n            'city': 'ØªÙ‡Ø±Ø§Ù†',\n            'customer_id': '123456'\n        }\n\n        # Test different pricing methods\n        cash_invoice = self.pricing_manager.generate_final_invoice(\n            test_items, test_customer, \"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\", 0.30)\n\n        pricing_info = (\n            f\"ğŸ’° ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ:\\n\\n\"\n            f\"ğŸ”§ Ù†Ø±Ø® ØªØ®ÙÛŒÙ Ù†Ù‚Ø¯ÛŒ: {self.pricing_manager.discount_rates.get('cash', 0) * 100}%\\n\"\n            f\"ğŸ”§ Ù†Ø±Ø® ØªØ®ÙÛŒÙ Ø§Ù‚Ø³Ø§Ø·ÛŒ: {self.pricing_manager.discount_rates.get('installment', 0) * 100}%\\n\"\n            f\"ğŸ”§ Ù†Ø±Ø® ØªØ®ÙÛŒÙ 90 Ø±ÙˆØ²Ù‡: {self.pricing_manager.discount_rates.get('90day', 0) * 100}%\\n\\n\"\n            f\"ğŸ“„ Ù†Ù…ÙˆÙ†Ù‡ ÙØ§Ú©ØªÙˆØ±:\\n\"\n            f\"{cash_invoice[:200]}...\"\n        )\n\n        await update.message.reply_text(pricing_info)\n        logger.info(f\"ğŸ’° Pricing test executed for user {update.effective_user.id}\")\n\n    async def button_callback(self, update: Update,\n                              context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle all button callbacks - Optimized version\"\"\"\n        query = update.callback_query\n        user_id = query.from_user.id\n        data = query.data\n\n        # Fast answer to prevent timeout\n        await query.answer()\n\n        logger.debug(f\"User {user_id} pressed: {data}\")\n\n        # Quick routing dictionary for better performance\n        handlers = {\n            \"authenticate\": self._handle_authentication_request,\n            \"main_menu\": self._handle_main_menu,\n            \"start_shopping\": self._handle_start_shopping,\n            \"view_cart\": self._handle_view_cart,\n            \"view_invoice\": self._handle_view_invoice,\n            \"upload_receipt\": self._handle_upload_receipt_request,\n            \"confirm_payment_receipt\": self._handle_payment_receipt_confirmation,\n            \"confirm_payment_terms\": self._handle_payment_terms_confirmation,\n            \"confirm_order\": self._handle_order_confirmation,\n            \"cart_clear\": self._handle_cart_clear,\n            \"verify_payment\": self._handle_payment_verification,\n            \"payment_completed\": self._handle_payment_completed,\n            \"back_to_categories\": self._handle_back_to_categories,\n            \"back_to_alphabet\": self._handle_back_to_alphabet,\n            \"back_to_curtain_subcategories\": self._handle_back_to_curtain_subcategories,\n            \"back_to_products\": self._handle_back_to_products,\n            \"daily_stats\": self._handle_daily_stats_request,\n            \"refresh_daily_orders\": self._handle_refresh_daily_orders,\n            \"back_to_daily_orders\": self._handle_back_to_daily_orders,\n            \"contact_support\": self._handle_contact_support_request,\n            \"faq\": self._handle_faq_request,\n            \"confirm_60day_order\": self._handle_60day_order_confirmation,\n        }\n\n        try:\n            # Direct handler for exact matches\n            if data in handlers:\n                await handlers[data](query)\n                return\n\n            # Prefix-based routing for better performance\n            if data.startswith(\"category_\"):\n                await self._handle_category_selection(query, data)\n            elif data.startswith(\"subcategory_\"):\n                await self._handle_subcategory_selection(query, data)\n            elif data.startswith(\"alpha_\"):\n                await self._handle_alphabet_selection(query, data)\n            elif data.startswith(\"product_\"):\n                await self._handle_product_selection(query, data)\n            elif data.startswith(\"size_selection_\"):\n                await self._handle_size_selection_from_category(query, data)\n            elif data.startswith(\"size_\"):\n                await self._handle_size_selection(query, data)\n            elif data.startswith(\"qty_\"):\n                await self._handle_quantity_selection(query, data)\n            elif data.startswith(\"payment_\"):\n                await self._handle_payment_selection(query, data)\n            elif data.startswith(\"order_status_\"):\n                await self._handle_order_status_update(query, data)\n            elif data.startswith(\"order_details_\"):\n                await self._handle_order_details_request(query, data)\n            elif data.startswith(\"order_\"):\n                await self._handle_order_actions(query, data)\n            elif data.startswith(\"alphabet_search_\"):\n                await self._handle_alphabet_search(query, data)\n\n            elif data.startswith(\"fabric_\"):\n                await self._handle_fabric_selection(query, data)\n            elif data == \"back_to_fabric_selection\":\n                await self._handle_back_to_fabric_selection(query)\n            elif data.startswith(\"payment_confirmed_\"):\n                await self._handle_payment_confirmation_from_group(query, data)\n            elif data.startswith(\"contact_made_\"):\n                await self._handle_contact_made_from_group(query, data)\n            elif data.startswith(\"remind_tomorrow_\"):\n                await self._handle_remind_tomorrow_from_group(query, data)\n            else:\n                await query.edit_message_text(\" Ø³ÙØ§Ø±Ø´ Ø¯Ø±Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø³Øª .\")\n\n        except Exception as e:\n            logger.error(f\"Callback error {data}: {e}\")\n            try:\n                await query.edit_message_text(\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n            except:\n                pass  # Prevent secondary errors\n\n    async def handle_text_message(self, update: Update,\n                                  context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle text messages\"\"\"\n        user_id = update.effective_user.id\n        text = update.message.text.strip()\n\n        # Check if user is in authentication process\n        if user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'awaiting_customer_code'):\n            await self._handle_customer_code_input(update, text)\n        # Check if user is inputting curtain height\n        elif user_id in self.user_sessions and self.user_sessions[user_id].get(\n                'awaiting_curtain_height'):\n            await self._handle_curtain_height_input(update, text)\n        else:\n            await update.message.reply_text(\n                \"Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(\n                    self._is_authenticated(user_id)))\n\n    async def handle_photo_message(self, update: Update,\n                                   context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle photo messages (for receipt uploads)\"\"\"\n        user_id = update.effective_user.id\n\n        # Check if user is waiting for receipt upload\n        if (user_id in self.user_sessions and\n            self.user_sessions[user_id].get('payment_info', {}).get('awaiting_receipt')):\n\n            # Store photo info\n            photo = update.message.photo[-1]  # Get highest resolution photo\n            self.user_sessions[user_id]['receipt_photo'] = {\n                'file_id': photo.file_id,\n                'file_unique_id': photo.file_unique_id\n            }\n\n            # Get payment info for final invoice display\n            payment_info = self.user_sessions[user_id]['payment_info']\n            customer = self.user_sessions[user_id]['customer']\n            cart_items = self.cart_manager.get_cart(user_id)\n\n            # Generate final invoice text\n            final_invoice = (\n                f\"âœ… ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(payment_info['subtotal'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(payment_info['discount_rate'] * 100)))}Ùª): {format_price(payment_info['discount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“¸ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯\\n\"\n                f\"âœ… Ø¢Ù…Ø§Ø¯Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ø³ÙØ§Ø±Ø´\"\n            )\n\n            # Show confirmation button with final invoice\n            keyboard = [[\n                InlineKeyboardButton(\"âœ… Ø³ÙØ§Ø±Ø´ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù…\", callback_data=\"confirm_payment_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯\", callback_data=\"upload_receipt\")\n            ]]\n\n            await update.message.reply_text(\n                final_invoice,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n        else:\n            await update.message.reply_text(\n                \"Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(\n                    self._is_authenticated(user_id)))\n\n    async def handle_group_message(self, update: Update,\n                                   context: ContextTypes.DEFAULT_TYPE):\n        \"\"\"Handle messages in group chats (support group)\"\"\"\n        chat_id = update.effective_chat.id\n        message_text = update.message.text.strip() if update.message.text else \"\"\n        user_name = update.effective_user.first_name or \"Ú©Ø§Ø±Ø¨Ø±\"\n\n        # Log group info for debugging\n        logger.info(f\"ğŸ“© Group message received:\")\n        logger.info(f\"   Chat ID: {chat_id} (type: {type(chat_id)})\")\n        logger.info(f\"   Chat Title: {getattr(update.effective_chat, 'title', 'N/A')}\")\n        logger.info(f\"   Message: '{message_text}'\")\n        logger.info(f\"   User: {user_name}\")\n        logger.info(f\"   Configured group ID: {self.config.order_group_chat_id} (type: {type(self.config.order_group_chat_id)})\")\n\n        # ØªØ¨Ø¯ÛŒÙ„ chat_id Ø¨Ù‡ int Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡\n        try:\n            current_group_id = int(chat_id)\n            config_group_id = int(self.config.order_group_chat_id) if self.config.order_group_chat_id else None\n        except (ValueError, TypeError) as e:\n            logger.error(f\"Error converting chat IDs to int: {e}\")\n            return\n\n        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ØŒ Ú¯Ø±ÙˆÙ‡ Ù…Ù†Ø§Ø³Ø¨ Ù‡Ø³Øª ÛŒØ§ Ù†Ù‡\n        if config_group_id and current_group_id != config_group_id:\n            logger.info(f\"âŒ Ù¾ÛŒØ§Ù… Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ù…Ø®ØªÙ„Ù: {current_group_id} != {config_group_id}\")\n            return\n\n        # Ø§Ú¯Ø± Ù‡ÛŒÚ† group ID ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú¯Ø±ÙˆÙ‡ Ø§ØµÙ„ÛŒ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±\n        if not config_group_id:\n            logger.warning(f\"âš ï¸ GROUP_CHAT_ID ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø±ÙˆÙ‡ ÙØ¹Ù„ÛŒ: {current_group_id}\")\n            self.config.order_group_chat_id = current_group_id\n\n        logger.info(f\"âœ… Processing group message: '{message_text}'\")\n\n        # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±\n        if not message_text:\n            return\n\n        # ÙÙ‚Ø· Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø´Ø®Øµ - Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ø¯ÛŒ\n        message_lower = message_text.lower().strip()\n\n        # Ù„ÛŒØ³Øª Ø¯Ù‚ÛŒÙ‚ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¬Ø§Ø²\n        valid_commands = [\n            'Ø³ÙØ§Ø±Ø´', 'Ø³ÙØ§Ø±Ø´Ø§Øª', 'order', 'orders',\n            'ÙØ§Ú©ØªÙˆØ±', 'ÙØ§Ú©ØªÙˆØ±Ù‡Ø§', 'invoice', 'invoices',\n            'Ø¢Ù…Ø§Ø±', 'stat', 'statistics',\n            'Ø±Ø§Ù‡Ù†Ù…Ø§', 'help', 'Ú©Ù…Ú©', 'Ø¯Ø³ØªÙˆØ±',\n            'Ø±Ø¨Ø§Øª', 'bot', '@decoteen_bot'\n        ]\n\n        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ Ù¾ÛŒØ§Ù… Ø´Ø§Ù…Ù„ Ø¯Ø³ØªÙˆØ± Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±\n        is_valid_command = False\n        for cmd in valid_commands:\n            if cmd in message_lower:\n                is_valid_command = True\n                break\n\n        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÙˆØ± ÙˆØ¶Ø¹ÛŒØª\n        if message_text.startswith('ÙˆØ¶Ø¹ÛŒØª ') or message_text.startswith('status '):\n            is_valid_command = True\n\n        # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø¯Ø³ØªÙˆØ± Ù…Ø¹ØªØ¨Ø±ÛŒ Ù†ÛŒØ³ØªØŒ Ø¢Ù† Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±\n        if not is_valid_command:\n            logger.debug(f\"ğŸ” Ù¾ÛŒØ§Ù… Ø¹Ø§Ø¯ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯: '{message_text}'\")\n            return\n\n        try:\n            # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¹ØªØ¨Ø±\n            if any(word in message_lower for word in ['Ø³ÙØ§Ø±Ø´', 'Ø³ÙØ§Ø±Ø´Ø§Øª', 'order', 'orders']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± Ø³ÙØ§Ø±Ø´ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_daily_orders(update)\n                return\n            elif any(word in message_lower for word in ['ÙØ§Ú©ØªÙˆØ±', 'ÙØ§Ú©ØªÙˆØ±Ù‡Ø§', 'invoice', 'invoices']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± ÙØ§Ú©ØªÙˆØ± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_daily_invoices(update)\n                return\n            elif message_text.startswith('ÙˆØ¶Ø¹ÛŒØª ') or message_text.startswith('status '):\n                order_id = message_text.replace('ÙˆØ¶Ø¹ÛŒØª ', '').replace('status ', '').strip()\n                logger.info(f\"ğŸ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´: {order_id}\")\n                await self._show_order_status(update, order_id)\n                return\n            elif any(word in message_lower for word in ['Ø¢Ù…Ø§Ø±', 'stat', 'statistics']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± Ø¢Ù…Ø§Ø± Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_orders_statistics(update)\n                return\n            elif any(word in message_lower for word in ['Ø±Ø§Ù‡Ù†Ù…Ø§', 'help', 'Ú©Ù…Ú©', 'Ø¯Ø³ØªÙˆØ±']):\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± Ø±Ø§Ù‡Ù†Ù…Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await self._show_group_help(update)\n                return\n            elif message_lower in ['Ø±Ø¨Ø§Øª', 'bot', '@decoteen_bot']:\n                logger.info(\"ğŸ¯ Ø¯Ø³ØªÙˆØ± ØªØ³Øª Ø±Ø¨Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯\")\n                await update.message.reply_text(\n                    \"ğŸ¤– Ø±Ø¨Ø§Øª DecoTeen Ø¢Ù…Ø§Ø¯Ù‡ Ø®Ø¯Ù…Ø§Øªâ€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ø³Øª!\\n\\n\"\n                    \"ğŸ“‹ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:\\n\"\n                    \"â€¢ Ø³ÙØ§Ø±Ø´ - Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\\n\"\n                    \"â€¢ ÙØ§Ú©ØªÙˆØ± - Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²\\n\"\n                    \"â€¢ Ø¢Ù…Ø§Ø± - Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\\n\"\n                    \"â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§ - Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„\\n\\n\"\n                    f\"ğŸ”§ Chat ID Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡: {current_group_id}\"\n                )\n                return\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡: {e}\")\n            logger.error(f\"Message: '{message_text}', Chat ID: {current_group_id}\")\n\n            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\n            try:\n                await update.message.reply_text(\n                    f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±: {str(e)[:100]}\\n\"\n                    \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\"\n                )\n            except Exception as reply_error:\n                logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§: {reply_error}\")\n\n        return\n\n    async def _show_daily_orders(self, update: Update):\n        \"\"\"Show today's orders as clickable summary with icons\"\"\"\n        try:\n            logger.info(\"ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\")\n\n            # Get today's orders\n            today_orders = await self.order_server.get_todays_orders()\n            logger.info(f\"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {len(today_orders)}\")\n\n            if not today_orders:\n                await update.message.reply_text(\n                    f\"ğŸ“Š Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\\n\"\n                    \"Ù‡ÛŒÚ† Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ğŸ“‹\\n\\n\"\n                    \"ğŸ’¡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ© Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.\"\n                )\n                return\n\n            # Create summary message with clickable icons\n            summary_text = (\n                f\"ğŸ“Š Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„: {persian_numbers(str(len(today_orders)))}\\n\\n\"\n                f\"ğŸ”½ Ø±ÙˆÛŒ Ù‡Ø± Ø¢ÛŒÚ©ÙˆÙ† Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ÙØ§Ú©ØªÙˆØ± Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯:\\n\\n\"\n            )\n\n            # Create inline keyboard with clickable order icons\n            keyboard = []\n            for i, order in enumerate(today_orders, 1):\n                customer = order.get('customer', {})\n                status_icon = \"ğŸ†•\" if order.get('status') == 'pending' else \"âœ…\"\n\n                button_text = f\"{status_icon} {persian_numbers(str(i))} - {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')[:10]}\"\n                callback_data = f\"order_details_{order['order_id']}\"\n\n                keyboard.append([InlineKeyboardButton(button_text, callback_data=callback_data)])\n\n            # Add summary row at the bottom\n            keyboard.append([\n                InlineKeyboardButton(\"ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\", callback_data=\"daily_stats\"),\n                InlineKeyboardButton(\"ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\", callback_data=\"refresh_daily_orders\")\n            ])\n\n            await update.message.reply_text(\n                summary_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n            logger.info(\"âœ… Ù„ÛŒØ³Øª Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡: {e}\")\n            await update.message.reply_text(\n                f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡.\\n\"\n                f\"Ø¬Ø²Ø¦ÛŒØ§Øª: {str(e)[:100]}\\n\"\n                \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\"\n            )\n\n    async def _show_daily_invoices(self, update: Update):\n        \"\"\"Show today's invoices in the group\"\"\"\n        try:\n            today_orders = await self.order_server.get_todays_orders()\n\n            if not today_orders:\n                await update.message.reply_text(\n                    \"ğŸ“„ Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²\\n\\n\"\n                    \"Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§Ù…Ø±ÙˆØ² ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ğŸ“‹\"\n                )\n                return\n\n            invoice_text = (\n                f\"ğŸ“„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n\"\n            )\n\n            for i, order in enumerate(today_orders, 1):\n                customer = order.get('customer', {})\n                pricing = order.get('pricing', {})\n\n                invoice_text += (\n                    f\"{persian_numbers(str(i))}. ğŸ“‹ {order['order_id']}\\n\"\n                    f\"   ğŸ‘¤ {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                    f\"   ğŸ™ï¸ {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                    f\"   ğŸ’° {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"   ğŸ“Š {self.order_server._get_status_text(order.get('status', 'pending'))}\\n\\n\"\n                )\n\n            # Create action keyboard\n            keyboard = [\n                [\n                    InlineKeyboardButton(\"ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´\", callback_data=\"save_daily_invoices\"),\n                    InlineKeyboardButton(\"ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„\", callback_data=\"email_daily_invoices\")\n                ],\n                [\n                    InlineKeyboardButton(\"ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\", callback_data=\"refresh_daily_invoices\")\n                ]\n            ]\n\n            await update.message.reply_text(\n                invoice_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Error showing daily invoices: {e}\")\n            await update.message.reply_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\"\n            )\n\n    async def _show_order_status(self, update: Update, order_id: str):\n        \"\"\"Show specific order status\"\"\"\n        try:\n            order_data = await self.order_server.get_order_details(order_id)\n\n            if not order_data:\n                await update.message.reply_text(\n                    f\"âŒ Ø³ÙØ§Ø±Ø´ {order_id} ÛŒØ§ÙØª Ù†Ø´Ø¯.\\n\"\n                    \"Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.\"\n                )\n                return\n\n            status_text = self.order_server._get_status_text(order_data['status'])\n            customer = order_data.get('customer', {})\n            pricing = order_data.get('pricing', {})\n\n            order_info = (\n                f\"ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: {status_text}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"â° ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: {persian_numbers(order_data.get('created_at', '')[:10])}\\n\"\n            )\n\n            # Create management keyboard\n            keyboard = self.order_server._create_admin_buttons(order_id, order_data['user_id'])\n\n            await update.message.reply_text(\n                order_info,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Error showing order status: {e}\")\n            await update.message.reply_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\"\n            )\n\n    async def _show_orders_statistics(self, update: Update):\n        \"\"\"Show orders statistics in the group\"\"\"\n        try:\n            stats = await self.order_server.get_orders_statistics()\n\n            if not stats:\n                await update.message.reply_text(\n                    \"ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÙØ§Ø±Ø´Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.\"\n                )\n                return\n\n            stats_text = (\n                f\"ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ“¦ Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª: {persian_numbers(str(stats.get('total_orders', 0)))}\\n\"\n                f\"ğŸ†• Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {persian_numbers(str(stats.get('today_orders', 0)))}\\n\"\n                f\"ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„: {format_price(stats.get('total_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’³ Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²: {format_price(stats.get('today_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“ˆ ØªÙˆØ²ÛŒØ¹ ÙˆØ¶Ø¹ÛŒØª:\\n\"\n            )\n\n            for status, count in stats.get('status_distribution', {}).items():\n                stats_text += f\"â€¢ {status}: {persian_numbers(str(count))}\\n\"\n\n            await update.message.reply_text(stats_text)\n\n        except Exception as e:\n            logger.error(f\"Error showing statistics: {e}\")\n            await update.message.reply_text(\n                \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\"\n            )\n\n    async def _show_group_help(self, update: Update):\n        \"\"\"Show help commands for group\"\"\"\n        help_text = (\n            \"ğŸ¤– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ú¯Ø±ÙˆÙ‡\\n\"\n            \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            \"ğŸ“‹ Ø³ÙØ§Ø±Ø´ / Ø³ÙØ§Ø±Ø´Ø§Øª - Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\\n\"\n            \"ğŸ“„ ÙØ§Ú©ØªÙˆØ± / ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ - Ù†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²\\n\"\n            \"ğŸ“Š Ø¢Ù…Ø§Ø± - Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\\n\"\n            \"ğŸ” ÙˆØ¶Ø¹ÛŒØª [Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´] - Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\\n\"\n            \"â“ Ø±Ø§Ù‡Ù†Ù…Ø§ / Ú©Ù…Ú© - Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§\\n\\n\"\n            \"ğŸ’¡ Ù†Ú©ØªÙ‡: ÙÙ‚Ø· Ø¯Ø± Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª\"\n        )\n\n        await update.message.reply_text(help_text)\n\n    async def _send_order_invoice_card(self, update: Update, order: Dict):\n        \"\"\"Send order as invoice card with management buttons\"\"\"\n        try:\n            customer = order.get('customer', {})\n            pricing = order.get('pricing', {})\n            cart_items = order.get('cart_items', [])\n\n            # Create invoice card\n            invoice_card = (\n                f\"ğŸ§¾ ÙØ§Ú©ØªÙˆØ± - {order['order_id']}\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ™ï¸ {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer.get('customer_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {order.get('user_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"â° {persian_numbers(order.get('created_at', '')[:16].replace('T', ' - '))}\\n\\n\"\n                f\"ğŸ“¦ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:\\n\"\n            )\n\n            # Add cart items\n            for i, item in enumerate(cart_items, 1):\n                item_total = item.get('price', 0) * item.get('quantity', 0)\n                invoice_card += (\n                    f\"{persian_numbers(str(i))}. {item.get('product_name', 'Ù…Ø­ØµÙˆÙ„')}\\n\"\n                    f\"   ğŸ“ {item.get('size', 'Ù†Ø§Ù…Ø´Ø®Øµ')} | \"\n                    f\"ğŸ“¦ {persian_numbers(str(item.get('quantity', 0)))} Ø¹Ø¯Ø¯ | \"\n                    f\"ğŸ’° {format_price(item_total)}\\n\"\n                )\n\n            # Add pricing\n            invoice_card += (\n                f\"\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ’³ {order.get('payment_method', 'Ù†Ù‚Ø¯ÛŒ')}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ“Š {self.order_server._get_status_text(order.get('status', 'pending'))}\"\n            )\n\n            # Create management keyboard\n            keyboard = [\n                [\n                    InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³\", callback_data=f\"order_status_{order['order_id']}_contacted\"),\n                    InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯\", callback_data=f\"order_status_{order['order_id']}_confirmed\"),\n                    InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡\", callback_data=f\"order_status_{order['order_id']}_ready\")\n                ],\n                [\n                    InlineKeyboardButton(\"ğŸšš Ø§Ø±Ø³Ø§Ù„\", callback_data=f\"order_status_{order['order_id']}_shipped\"),\n                    InlineKeyboardButton(\"ğŸ‰ ØªÚ©Ù…ÛŒÙ„\", callback_data=f\"order_status_{order['order_id']}_completed\"),\n                    InlineKeyboardButton(\"âŒ Ù„ØºÙˆ\", callback_data=f\"order_status_{order['order_id']}_cancelled\")\n                ]\n            ]\n\n            await update.message.reply_text(\n                invoice_card,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Error sending order invoice card: {e}\")\n\n    async def _send_order_summary_with_buttons(self, update: Update, order: Dict):\n        \"\"\"Send order summary with management buttons (kept for compatibility)\"\"\"\n        await self._send_order_invoice_card(update, order)\n\n    async def _handle_authentication_request(self, query):\n        \"\"\"Handle authentication request\"\"\"\n        user_id = query.from_user.id\n\n        # Set user state to awaiting customer code\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['awaiting_customer_code'] = True\n\n        text = (\"ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª \\n\\n\"\n                \" Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n        await query.edit_message_text(text)\n\n    async def _handle_customer_code_input(self, update, customer_code):\n        \"\"\"Handle customer code input\"\"\"\n        user_id = update.effective_user.id\n\n        # Validate customer code\n        customer = self.customer_service.authenticate_customer(customer_code)\n\n        if customer:\n            # Authentication successful\n            self.user_sessions[user_id] = {\n                'authenticated': True,\n                'customer': customer,\n                'awaiting_customer_code': False\n            }\n\n            welcome_text = (f\"âœ… Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ {customer['name']} Ø¹Ø²ÛŒØ²!\\n\"\n                            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                            f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\\n\"\n                            \"\\n\"\n                            \"Ø¬Ù‡Øª Ø³ÙØ§Ø±Ø´ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯:\")\n\n            keyboard = self.keyboards.get_categories_keyboard()\n            await update.message.reply_text(welcome_text,\n                                            reply_markup=keyboard)\n        else:\n            # Authentication failed\n            error_text = (\"âŒ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.\\n\"\n                          \"Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ ØµØ­ÛŒØ­ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n            await update.message.reply_text(error_text)\n\n    async def _handle_main_menu(self, query):\n        \"\"\"Handle main menu\"\"\"\n        user_id = query.from_user.id\n        authenticated = self._is_authenticated(user_id)\n\n        if authenticated:\n            customer = self.user_sessions[user_id]['customer']\n            text = (f\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\\n\\n\"\n                    f\"ğŸ‘¤ {customer['name']}\\n\"\n                    f\"ğŸ™ï¸ {customer['city']}\\n\\n\"\n                    \"ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n        else:\n            text = \"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\\n\\nØ¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø®Ø±ÛŒØ¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\"\n\n        keyboard = self.keyboards.get_main_menu(authenticated)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_start_shopping(self, query):\n        \"\"\"Handle start shopping\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        text = (\"Ø¹Ø§Ù„ÛŒÙ‡ \\n\\n\"\n                \"Ø¬Ù‡Øª Ø³ÙØ§Ø±Ø´ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯Ù†Ø·Ø± Ø®ÙˆØ¯Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ†:\")\n\n        keyboard = self.keyboards.get_categories_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_view_cart(self, query):\n        \"\"\"Handle view cart\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        if not cart_items:\n            text = \"ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\"\n            keyboard = self.keyboards.get_main_menu(authenticated=True)\n        else:\n            text = \"ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§:\\n\\n\"\n            total = 0\n\n            for i, item in enumerate(cart_items, 1):\n                item_total = item['price'] * item['quantity']\n                total += item_total\n                text += (\n                    f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                    f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                    f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                    f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n            text += f\"ğŸ’° Ù…Ø¬Ù…ÙˆØ¹: {format_price(total)} ØªÙˆÙ…Ø§Ù†\"\n            keyboard = self.keyboards.get_cart_management_keyboard()\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_view_invoice(self, query):\n        \"\"\"Handle view invoice\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        invoice_text = self.pricing_manager.generate_invoice(\n            cart_items, customer)\n        keyboard = self.keyboards.get_payment_keyboard()\n\n        await query.edit_message_text(invoice_text, reply_markup=keyboard)\n\n    async def _handle_category_selection(self, query, data):\n        \"\"\"Handle category selection\"\"\"\n        category = data.replace(\"category_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected category in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_category'] = category\n\n        category_info = get_category_info(category)\n        category_name = category_info.get('name', category)\n\n        if category == \"curtain_only\":\n            # For curtain_only, show products directly with icon-based keyboard\n            text = f\"{category_name}\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n            keyboard = self.keyboards.get_category_products_keyboard(category)\n        elif category == \"tablecloth\":\n            # For tablecloth, show subcategories first\n            keyboard = self.keyboards.get_tablecloth_subcategories()\n            await query.edit_message_text(\"Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ø´ÛŒÙ†Ù‡:\",\n                                          reply_markup=keyboard)\n            return\n        else:\n            # For other categories, show products directly with icon-based keyboard\n            text = f\"{category_name}\\n\\nØ¹Ø§Ù„ÛŒÙ‡! Ø­Ø§Ù„Ø§ Ø¨Ú¯Ùˆ Ú©Ø¯ÙˆÙ… Ø·Ø±Ø­ØŸ\"\n            keyboard = self.keyboards.get_category_products_keyboard(category)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_subcategory_selection(self, query, data):\n        \"\"\"Handle subcategory selection\"\"\"\n        subcategory = data.replace(\"subcategory_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected subcategory in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_subcategory'] = subcategory\n\n        text = f\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_alphabetical_keyboard(subcategory)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_alphabet_selection(self, query, data):\n        \"\"\"Handle alphabet selection\"\"\"\n        parts = data.split(\"_\")\n        if len(parts) < 3:\n            await query.edit_message_text(\"âŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±.\")\n            return\n        category = parts[1]\n        letter = parts[2]\n        user_id = query.from_user.id\n\n        # Get products starting with selected letter\n        subcategory = self.user_sessions[user_id].get('selected_subcategory')\n        actual_category = subcategory if subcategory else category\n\n        products = search_products_by_name(category, letter, subcategory)\n\n        if not products:\n            text = f\"âŒ Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø§ Ø­Ø±Ù Â«{letter}Â» ÛŒØ§ÙØª Ù†Ø´Ø¯.\\n\\nØ­Ø±Ù Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n            keyboard = self.keyboards.get_alphabetical_keyboard(\n                actual_category)\n        else:\n            text = f\"ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ Ø­Ø±Ù Â«{letter}Â»:\\n\\nÛŒÚ©ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n            keyboard = self.keyboards.get_products_keyboard(products, category)\n\n            # Store filtered products in session\n            self.user_sessions[user_id]['filtered_products'] = products\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_product_selection(self, query, data):\n        \"\"\"Handle product selection\"\"\"\n        product_id = data.replace(\"product_\", \"\")\n        user_id = query.from_user.id\n\n        # Find product by ID\n        product = get_product_by_id(product_id)\n\n        if not product:\n            await query.edit_message_text(\"âŒ Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯.\")\n            return\n\n        # Store selected product in session\n        self.user_sessions[user_id]['selected_product'] = product\n\n        # Get price based on product (check for special pricing first)\n        category = product.get('category_id', 'baby')\n\n        # For curtains, show fabric selection first\n        if category == 'curtain_only':\n            # Check if it's the special bedside curtain\n            if product_id == 'curtain_15':  # Ù¾Ø±Ø¯Ù‡ Ø­Ø±ÛŒØ± Ø³Ø±ØªØ®Øª (Ø¬ÙØª)\n                price = get_product_price(product['id'], category)\n                text = (f\"ğŸ“¦ {product['name']}\\n\"\n                        f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                        \"Ø¹Ø§Ù„ÛŒÙ‡! Ø§Ù†ØªØ®Ø§Ø¨Øª\\n\"\n                        \"Ø§Ø±ØªÙØ§Ø¹: 240 Ùˆ Ø¹Ø±Ø¶ 2Ã—290 Ù‡Ø³Øª Ú©Ù‡ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù†ÛŒØ³Øª\")\n                self.user_sessions[user_id]['selected_fabric'] = 'special'\n                self.user_sessions[user_id]['selected_category'] = category\n                self.user_sessions[user_id]['selected_size'] = 'Ø§Ø±ØªÙØ§Ø¹: 240 - Ø¹Ø±Ø¶: 2Ã—290'\n\n                keyboard = [[InlineKeyboardButton(\"Ø¨Ù„Ù‡ Ù‡Ù…ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø±Ùˆ Ù…ÛŒØ®ÙˆØ§Ù…\", callback_data=\"qty_1\")]]\n                keyboard.append([InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_categories\")])\n                keyboard = InlineKeyboardMarkup(keyboard)\n            else:\n                text = (f\"ğŸ“¦ {product['name']}\\n\\n\"\n                        \"Ø¹Ø§Ù„ÛŒÙ‡! Ù…Ø¯Ù„ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ. Ø­Ø§Ù„Ø§ Ø¬Ù†Ø³ Ù¾Ø§Ø±Ú†Ø´ Ú†ÛŒ Ø¨Ø§Ø´Ù‡ØŸ\")\n                keyboard = self.keyboards.get_fabric_selection_keyboard()\n        # For tablecloth, show base price initially\n        elif category == 'tablecloth':\n            price = PRODUCT_PRICES[category]  # Show base price\n            text = (f\"ğŸ“¦ {product['name']}\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: Ø§Ø² {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø³Ø§ÛŒØ² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            # Store category for size selection\n            self.user_sessions[user_id]['selected_category'] = category\n            keyboard = self.keyboards.get_size_selection_keyboard(category)\n        # For cushions, skip size selection and go directly to quantity\n        elif category == 'cushion':\n            price = get_product_price(product['id'], category)\n            # Store default size for cushions\n            self.user_sessions[user_id]['selected_size'] = 'Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯'\n            self.user_sessions[user_id]['selected_category'] = category\n\n            text = (f\"ğŸ“¦ {product['name']}\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"ØªØ¹Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            keyboard = self.keyboards.get_quantity_keyboard()\n        else:\n            price = get_product_price(product['id'], category)\n            text = (f\"ğŸ“¦ {product['name']}\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø³Ø§ÛŒØ² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n            keyboard = self.keyboards.get_size_selection_keyboard(category)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_size_selection_from_category(self, query, data):\n        \"\"\"Handle size selection directly from category\"\"\"\n        category = data.replace(\"size_selection_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected category in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_category'] = category\n\n        category_info = get_category_info(category)\n        category_name = category_info.get('name', category)\n        price = category_info.get('price', 4780000)\n\n        if category == 'tablecloth':\n            text = (f\"{category_name}\\n\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: Ø§Ø² {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ú†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¨ÛŒ! Ø­Ø§Ù„Ø§ Ø³Ø§ÛŒØ² ØªØ´Ú© Ú†Ù‚Ø¯Ø± Ø¨Ø§Ø´Ù‡ØŸ\")\n        else:\n            text = (f\"{category_name}\\n\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ú†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø®ÙˆØ¨ÛŒ! Ø­Ø§Ù„Ø§ Ø³Ø§ÛŒØ² ØªØ´Ú© Ú†Ù‚Ø¯Ø± Ø¨Ø§Ø´Ù‡ØŸ\")\n\n        # Use the keyboard's size selection method instead of hardcoded sizes\n        keyboard = self.keyboards.get_size_selection_keyboard(category)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_size_selection(self, query, data):\n        \"\"\"Handle size selection\"\"\"\n        parts = data.split(\"_\")\n        if len(parts) >= 3:\n            size = \"_\".join(parts[1:-1])  # All parts except first and last\n            category = parts[-1]  # Last part is category\n        else:\n            size = data.replace(\"size_\", \"\")\n            category = self.user_sessions.get(query.from_user.id,\n                                              {}).get('selected_category',\n                                                      'baby')\n\n        user_id = query.from_user.id\n\n        # Store selected size and category in session\n        self.user_sessions[user_id]['selected_size'] = size\n        self.user_sessions[user_id]['selected_category'] = category\n\n        # Get category info for price\n        category_info = get_category_info(category)\n\n        # For tablecloth, get size-based price\n        if category == 'tablecloth':\n            price = get_product_price('', category, size)\n        else:\n            price = category_info.get('price', 4780000)\n\n        text = (f\"ğŸ“ Ø³Ø§ÛŒØ² Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {size}\\n\"\n                f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                \"Ø·Ø±Ø­ Ù‚Ø´Ù†Ú¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ! Ø­Ø§Ù„Ø§ ØªØ¹Ø¯Ø§Ø¯ Ú†Ù‚Ø¯Ø± Ø¨Ø§Ø´Ù‡ØŸ\")\n        keyboard = self.keyboards.get_quantity_keyboard()\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_quantity_selection(self, query, data):\n        \"\"\"Handle quantity selection\"\"\"\n        quantity = int(data.replace(\"qty_\", \"\"))\n        user_id = query.from_user.id\n\n        # Get session data\n        session = self.user_sessions[user_id]\n        size = session.get('selected_size')\n        category = session.get('selected_category', 'baby')\n        fabric = session.get('selected_fabric')\n\n        # Check if we have a specific product or just category\n        if 'selected_product' in session:\n            # Product-based ordering\n            product = session['selected_product']\n            category = product.get('category_id', category)\n            product_name = product['name']\n            product_id = product['id']\n        else:\n            # Category-based ordering (for teen and adult)\n            category_info = get_category_info(category)\n            product_name = category_info.get('name', category)\n            product_id = f\"{category}_generic\"\n\n        # Get price based on product and fabric\n        if category == 'tablecloth':\n            price = get_product_price(product_id, category, size)\n        elif category == 'curtain_only' and fabric:\n            if fabric == 'special':  # For bedside curtain\n                price = get_product_price(product['id'], category)\n            else:\n                price = get_product_price(product_id, category, fabric=fabric)\n        else:\n            price = get_product_price(product['id'], category)\n\n        # Add fabric info to product name if applicable\n        if fabric and fabric != 'special':\n            fabric_name = \"Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\" if fabric == \"silk_cotton\" else \"Ù…Ø®Ù…Ù„\"\n            product_name = f\"{product_name} - {fabric_name}\"\n\n        # Add to cart\n        cart_item = {\n            'product_id': product_id,\n            'product_name': product_name,\n            'size': size,\n            'quantity': quantity,\n            'price': price\n        }\n\n        self.cart_manager.add_to_cart(user_id, cart_item)\n\n        total_price = price * quantity\n        text = (f\"âœ… Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!\\n\\n\"\n                f\"ğŸ“¦ {product_name}\\n\"\n                f\"ğŸ“ Ø³Ø§ÛŒØ²: {size}\\n\"\n                f\"ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(quantity))}\\n\"\n                f\"ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(total_price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                \"Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú†Ù‡ Ú©Ø§Ø± Ú©Ù†ÛŒØ¯ØŸ\")\n\n        keyboard = self.keyboards.get_cart_management_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_payment_selection(self, query, data):\n        \"\"\"Handle payment selection\"\"\"\n        user_id = query.from_user.id\n\n        # Check authentication\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\n                \"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=False))\n            return\n\n        cart_items = self.cart_manager.get_cart(user_id)\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n\n        if data == \"payment_cash_card\":\n            await self._handle_card_to_card_payment(query, \"cash\", \"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ\", 0.30)\n        elif data == \"payment_60day_card\":\n            await self._handle_card_to_card_payment(query, \"60day\", \"Ù¾Ø±Ø¯Ø§Ø®Øª Û¶Û° Ø±ÙˆØ²\", 0.25)\n        elif data == \"payment_90day_card\":\n            await self._handle_card_to_card_payment(query, \"90day\", \"Ù¾Ø±Ø¯Ø§Ø®Øª Û¹Û° Ø±ÙˆØ²\", 0.25)\n\n    async def _handle_zarinpal_payment(self, query, payment_type: str,\n                                       payment_method: str):\n        \"\"\"Handle ZarinPal payment\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Calculate payment amount based on type\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        discount_rate = self.pricing_manager.discount_rates.get(\n            payment_type, 0)\n        discount = self.pricing_manager.calculate_discount(\n            subtotal, discount_rate)\n\n        if payment_type == \"90day\":\n            # For 90-day payment, only 25% advance payment required\n            amount = int((subtotal - discount) * 0.25)  # 25% advance\n            description = f\"Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Û²ÛµÙª Ø³ÙØ§Ø±Ø´ - {customer['name']}\"\n        else:\n            # For cash payment, full amount\n            amount = int(subtotal - discount)\n            description = f\"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ Ø³ÙØ§Ø±Ø´ - {customer['name']}\"\n\n        # Create payment request with proper callback URL\n        callback_url = \"https://www.zarinpal.com/pg/services/WebGate/wsdl\"  # Temporary callback\n\n        payment_result = self.zarinpal.create_payment_request(\n            amount=amount,\n            description=description,\n            callback_url=callback_url,\n            customer_mobile=customer.get('phone', ''),\n            customer_email=customer.get('email', ''))\n\n        if payment_result['success']:\n            # Store payment info in session\n            self.user_sessions[user_id]['payment_info'] = {\n                'authority': payment_result['authority'],\n                'amount': amount,\n                'payment_type': payment_type,\n                'payment_method': payment_method\n            }\n\n            text = (f\"ğŸ’³ {payment_method}\\n\\n\"\n                    f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"ğŸ”— Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:\")\n\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†\",\n                                     url=payment_result['payment_url'])\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\",\n                                callback_data=\"payment_completed\")\n                        ],\n                        [\n                            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                                 callback_data=\"view_invoice\")\n                        ],\n                        [\n                            InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\",\n                                                 callback_data=\"main_menu\")\n                        ]]\n\n            await query.edit_message_text(\n                text, reply_markup=InlineKeyboardMarkup(keyboard))\n        else:\n            text = (f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n                    f\"{payment_result['error']}\\n\\n\"\n                    \"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\")\n\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯\",\n                    callback_data=f\"payment_{payment_type}_zarinpal\")\n            ], [\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            await query.edit_message_text(\n                text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_card_to_card_payment(self, query, payment_type: str, payment_method: str, discount_rate: float):\n        \"\"\"Handle card-to-card payment\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Calculate payment amount\n        subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n        discount = self.pricing_manager.calculate_discount(subtotal, discount_rate)\n        final_amount = subtotal - discount\n\n        # Store payment info in session\n        self.user_sessions[user_id]['payment_info'] = {\n            'payment_type': payment_type,\n            'payment_method': payment_method,\n            'amount': final_amount if payment_type not in [\"90day\", \"60day\"] else int(final_amount * 0.25),\n            'discount_rate': discount_rate,\n            'awaiting_receipt': payment_type != \"60day\",  # 60-day doesn't need receipt\n            'full_amount': final_amount,\n            'subtotal': subtotal,\n            'discount': discount\n        }\n\n        # Generate payment details based on payment type\n        if payment_type == \"cash\":\n            payment_details = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (30% ØªØ®ÙÛŒÙ)\\n\"\n                f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ ØªØ®ÙÛŒÙ (30%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø³ Ø§Ø² ØªØ®ÙÛŒÙ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:\\n\"\n                f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: 6219861915854102\\n\"\n                f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR110560611828005185959401\\n\"\n                f\"ğŸ‘¤ Ø¨Ù‡ Ù†Ø§Ù…:Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\\n\\n\"\n                f\"ğŸ“¸ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\"\n            )\n            # Create keyboard for cash payment\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\", callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        elif payment_type == \"60day\":\n            payment_details = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ (25% ØªØ®ÙÛŒÙ)\\n\"\n                f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ ØªØ®ÙÛŒÙ (25%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“… Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ø·ÙˆÙ„ 60 Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ù…Ø¨Ù„Øº Ø±Ø§ Ø®ÙˆØ±Ø¯ Ø®ÙˆØ±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯\\n\"\n                f\"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\\n\\n\"\n                f\"âœ… Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´ Ùˆ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:\"\n            )\n            # Create keyboard for 60-day payment\n            keyboard = [[\n                InlineKeyboardButton(\"âœ… Ø³ÙØ§Ø±Ø´Ù… Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ùˆ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø±Ø§ ØªØ§ÛŒÛŒØ¯\",\n                                   callback_data=\"confirm_60day_order\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        elif payment_type == \"90day\":\n            advance_payment = int(final_amount * 0.25)\n            payment_details = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª 90 Ø±ÙˆØ²Ù‡ (25% ØªØ®ÙÛŒÙ + 25% Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª)\\n\"\n                f\"Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ…\\n\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ (25%): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(final_amount)} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ’³ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (25%): {format_price(advance_payment)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨:\\n\"\n                f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: 6219861915854102\\n\"\n                f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR110560611828005185959401\\n\"\n                f\"ğŸ‘¤ Ø¨Ù‡ Ù†Ø§Ù…: Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ\\n\\n\"\n                f\"ğŸ“¸ Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ² Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®ØªØŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\"\n            )\n            # Create keyboard for 90-day payment\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\", callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        await query.edit_message_text(\n            payment_details,\n            reply_markup=InlineKeyboardMarkup(keyboard)\n        )\n\n    async def _handle_payment_terms_confirmation(self, query):\n        \"\"\"Handle payment terms confirmation for 60-day and 90-day payments\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        payment_info = self.user_sessions[user_id].get('payment_info')\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Send invoice to support group\n        invoice_text = self.pricing_manager.generate_final_invoice(\n            cart_items, customer, payment_info['payment_method'], payment_info['discount_rate'])\n\n        # Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n        if self.config.order_group_chat_id:\n            try:\n                group_message = (\n                    f\"ğŸ“‹ ØªØ§ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ\\n\"\n                    f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                    f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                    f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                    f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                    f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                    f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                    f\"ğŸ’° Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"ğŸ’° Ù…Ø¨Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {format_price(payment_info['full_amount'] - payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                    f\"â° Ø²Ù…Ø§Ù† ØªØ§ÛŒÛŒØ¯: {persian_numbers(datetime.now().strftime('%Y/%m/%d - %H:%M'))}\\n\\n\"\n                    f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                    f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                    f\"{invoice_text}\"\n                )\n\n                await query.bot.send_message(\n                    chat_id=self.config.order_group_chat_id,\n                    text=group_message\n                )\n                logger.info(f\"âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\")\n\n            except Exception as e:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: {e}\")\n\n        # Schedule payment reminder for both 60-day and 90-day payments\n        if payment_info['payment_type'] in ['60day', '90day']:\n            total_amount = payment_info['full_amount']\n            advance_paid = payment_info['amount']\n            remaining_amount = total_amount - advance_paid\n\n            # Create order ID for tracking\n            order_id = f\"ORDER_{user_id}_{int(datetime.now().timestamp())}\"\n\n            if payment_info['payment_type'] == '60day':\n                # For 60-day payment: single reminder after 60 days\n                self.payment_scheduler.add_60day_payment_schedule(\n                    user_id=user_id,\n                    customer_info=customer,\n                    total_amount=total_amount,\n                    advance_paid=advance_paid,\n                    remaining_amount=remaining_amount,\n                    order_id=order_id\n                )\n                logger.info(f\"âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n            else:\n                # For 90-day payment: monthly reminders\n                self.payment_scheduler.add_90day_payment_schedule(\n                    user_id=user_id,\n                    customer_info=customer,\n                    total_amount=total_amount,\n                    advance_paid=advance_paid,\n                    remaining_amount=remaining_amount,\n                    order_id=order_id\n                )\n                logger.info(f\"âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª 90 Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n\n        # Show upload receipt interface\n        await query.edit_message_text(\n            f\"âœ… Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯!\\n\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ“… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ø¨Ù‚ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\\n\\n\"\n            f\"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ² Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\",\n            reply_markup=InlineKeyboardMarkup([[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\", callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]))\n\n\n        if payment_type in [\"60day\", \"90day\"]:\n            keyboard = [[\n                InlineKeyboardButton(button_text, callback_data=\"confirm_payment_terms\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n        else:\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ“¸ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ\", callback_data=\"upload_receipt\")\n            ], [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]\n\n        await query.edit_message_text(\n            bank_info,\n            reply_markup=InlineKeyboardMarkup(keyboard)\n        )\n\n    async def _handle_upload_receipt_request(self, query):\n        \"\"\"Handle receipt upload request\"\"\"\n        await query.edit_message_text(\n            \"ğŸ“¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Ú†Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\\n\\n\"\n            \"âš ï¸ ÙÙ‚Ø· ØªØµØ§ÙˆÛŒØ± Ø¨Ø§ ÙØ±Ù…Øª JPG, PNG Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ù‡Ø³ØªÙ†Ø¯.\\n\\n\"\n            \"Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ØŒ Ø¯Ú©Ù…Ù‡ ØªØ§ÛŒÛŒØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.\",\n            reply_markup=InlineKeyboardMarkup([[\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"view_invoice\")\n            ]]))\n\n    async def _handle_payment_receipt_confirmation(self, query):\n        \"\"\"Handle payment receipt confirmation\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        # Check if user is authenticated\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\n                \"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=False))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n        payment_info = self.user_sessions[user_id].get('payment_info')\n\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        try:\n            # Get receipt photo if available\n            receipt_photo_id = None\n            if 'receipt_photo' in self.user_sessions[user_id]:\n                receipt_photo_id = self.user_sessions[user_id]['receipt_photo']['file_id']\n\n            # Create order using order management server\n            order_id = await self.order_server.create_order(\n                user_id=user_id,\n                customer=customer,\n                cart_items=cart_items,\n                payment_method=payment_info['payment_method'],\n                discount_rate=payment_info['discount_rate'],\n                receipt_photo_id=receipt_photo_id\n            )\n\n            # Clear cart and payment info\n            self.cart_manager.clear_cart(user_id)\n            if 'payment_info' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['payment_info']\n            if 'receipt_photo' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['receipt_photo']\n\n            # Confirm to customer\n            await query.edit_message_text(\n                f\"âœ… Ø¹Ø§Ù„ÛŒÙ‡! Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ”„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø§Ø¯.\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ….\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n            logger.info(f\"âœ… Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id}\")\n\n        except Exception as e:\n            logger.error(f\"Error in payment receipt confirmation: {e}\")\n            logger.error(f\"User ID: {user_id}, Customer: {customer if customer else 'None'}, Cart items: {len(cart_items) if cart_items else 0}\")\n\n            # More detailed error handling\n            try:\n                await query.edit_message_text(\n                    f\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯.\\n\"\n                    f\"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\\n\\n\"\n                    f\"Ú©Ø¯ Ø®Ø·Ø§: {type(e).__name__}\",\n                    reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            except Exception as edit_error:\n                logger.error(f\"Error editing message: {edit_error}\")\n                # Send new message if editing fails\n                try:\n                    await query.message.reply_text(\n                        f\"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯.\\n\"\n                        f\"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\",\n                        reply_markup=self.keyboards.get_main_menu(authenticated=True))\n                except Exception as reply_error:\n                    logger.error(f\"Error sending reply: {reply_error}\")\n\n    async def _handle_group_payment(self, query, payment_type: str,\n                                    payment_method: str):\n        \"\"\"Handle group payment (installment)\"\"\"\n        user_id = query.from_user.id\n        cart_items = self.cart_manager.get_cart(user_id)\n        customer = self.user_sessions[user_id]['customer']\n\n        # Check if cart is not empty\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Check if group chat ID is configured\n        if not self.config.order_group_chat_id:\n            await query.edit_message_text(\n                \"âŒ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        try:\n            # Generate final invoice\n            discount_rate = self.pricing_manager.discount_rates.get(\n                payment_type, 0.25)\n            invoice_text = self.pricing_manager.generate_final_invoice(\n                cart_items, customer, payment_method, discount_rate)\n\n            # Send to customer with confirmation\n            confirmation_text = (\n                f\"{invoice_text}\\n\\n\"\n                \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.\\n\"\n                \"ğŸ“ Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù…Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú¯Ø±ÙØª.\")\n\n            keyboard = [[\n                InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´\",\n                                     callback_data=\"confirm_order\")\n            ], [\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            # Store order info for confirmation```python\n            self.user_sessions[user_id]['pending_order'] = {\n                'payment_method': payment_method,\n                'discount_rate': discount_rate,\n                'invoice_text': invoice_text\n            }\n\n            await query.edit_message_text(\n                confirmation_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n            logger.info(\n                \"Group payment processed successfully for user {user_id}\")\n\n        except Exception as e:\n            logger.error(f\"Error in group payment handling: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    async def _handle_order_confirmation(self, query):\n        \"\"\"Handle order confirmation using order management server\"\"\"\n        user_id = query.from_user.id\n\n        # Check if user is authenticated\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\n                \"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=False))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n        pending_order = self.user_sessions[user_id].get('pending_order')\n\n        if not pending_order:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        if not cart_items:\n            await query.edit_message_text(\n                \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        try:\n            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª\n            order_id = await self.order_server.create_order(\n                user_id=user_id,\n                customer=customer,\n                cart_items=cart_items,\n                payment_method=pending_order['payment_method'],\n                discount_rate=pending_order['discount_rate']\n            )\n\n            # Clear cart and session\n            self.cart_manager.clear_cart(user_id)\n            if 'pending_order' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['pending_order']\n\n            # Store order ID in session\n            self.user_sessions[user_id]['last_order_id'] = order_id\n\n            # Confirm to customer\n            await query.edit_message_text(\n                f\"âœ… Ø¹Ø§Ù„ÛŒÙ‡! Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ”„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù† Ø³ÙØ§Ø±Ø´ Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¯Ø§Ø¯.\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ….\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n        except Exception as e:\n            logger.error(f\"Error in order confirmation: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    async def _handle_payment_completed(self, query):\n        \"\"\"Handle payment completed confirmation\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        payment_info = self.user_sessions[user_id].get('payment_info')\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\\n\"\n                \"Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Generate final invoice\n        discount_rate = self.pricing_manager.discount_rates.get(\n            payment_info['payment_type'], 0)\n        invoice_text = self.pricing_manager.generate_final_invoice(\n            cart_items, customer, payment_info['payment_method'],\n            discount_rate)\n\n        # Send to group if configured\n        if self.config.order_group_chat_id:\n            group_message = (\n                f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n                f\"ğŸ“± ÛŒÙˆØ²Ø±Ù†ÛŒÙ… ØªÙ„Ú¯Ø±Ø§Ù…: @{query.from_user.username or 'Ù†Ø¯Ø§Ø±Ø¯'}\\n\"\n                f\"ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"â° Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª: {persian_numbers(datetime.now().strftime('%Y/%m/%d - %H:%M'))}\\n\\n\"\n                f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"{invoice_text}\\n\\n\"\n                f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø±Ø³Ø§Ù„\")\n\n            # Create admin action buttons for paid orders\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"âœ… ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\",\n                    callback_data=f\"order_contacted_{user_id}\"),\n                InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n                                     callback_data=f\"order_ready_{user_id}\")\n            ],\n                        [\n                            InlineKeyboardButton(\n                                \"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                                callback_data=f\"order_shipped_{user_id}\"),\n                            InlineKeyboardButton(\n                                \"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                                callback_data=f\"order_completed_{user_id}\")\n                        ]]\n\n            try:\n                sent_message = await query.bot.send_message(\n                    chat_id=self.config.order_group_chat_id,\n                    text=group_message,\n                    reply_markup=InlineKeyboardMarkup(keyboard))\n                logger.info(\n                    f\"âœ… Payment info sent to group {self.config.order_group_chat_id}\"\n                )\n                logger.info(f\"Message ID: {sent_message.message_id}\")\n\n                # Store order info for tracking\n                order_info = {\n                    'user_id': user_id,\n                    'customer': customer,\n                    'message_id': sent_message.message_id,\n                    'status': 'paid',\n                    'created_at': datetime.now().isoformat()\n                }\n                self.user_sessions[user_id]['order_info'] = order_info\n\n            except Exception as e:\n                logger.error(\n                    f\"âŒ Error sending payment info to group {self.config.order_group_chat_id}: {e}\"\n                )\n                logger.error(f\"Error type: {type(e).__name__}\")\n                # Send error info to customer for debugging\n                await query.bot.send_message(\n                    chat_id=user_id,\n                    text=\n                    f\"âš ï¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø«Ø¨Øª Ø´Ø¯ Ø§Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯:\\n{str(e)[:200]}\"\n                )\n        else:\n            logger.warning(\n                \"âŒ Order group chat ID is not configured for payment notification\"\n            )\n\n        # Clear cart and payment info\n        self.cart_manager.clear_cart(user_id)\n        if 'payment_info' in self.user_sessions[user_id]:\n            del self.user_sessions[user_id]['payment_info']\n\n        text = (\n            f\"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!\\n\\n\"\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº: {format_price(payment_info['amount'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ“ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\\n\"\n            f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ….\")\n\n        await query.edit_message_text(\n            text,\n            reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n    async def _handle_payment_verification(self, query):\n        \"\"\"Handle payment verification\"\"\"\n        user_id = query.from_user.id\n        payment_info = self.user_sessions[user_id].get('payment_info')\n\n        if not payment_info:\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        # Verify payment with ZarinPal\n        verify_result = self.zarinpal.verify_payment(\n            authority=payment_info['authority'], amount=payment_info['amount'])\n\n        if verify_result['success']:\n            # Payment successful\n            customer = self.user_sessions[user_id]['customer']\n            cart_items = self.cart_manager.get_cart(user_id)\n\n            # Generate final invoice\n            discount_rate = self.pricing_manager.discount_rates[\n                payment_info['payment_type']]\n            invoice_text = self.pricing_manager.generate_final_invoice(\n                cart_items, customer, payment_info['payment_method'],\n                discount_rate)\n\n            # Send to group if configured\n            if self.config.order_group_chat_id:\n                group_message = (\n                    f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ - {payment_info['payment_method']}\\n\"\n                    f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                    f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                    f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                    f\"ğŸ†”Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ : {customer['customer_id']}\\n\"\n                    f\"ğŸ“± Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…: @{query.from_user.username or 'Ù†Ø¯Ø§Ø±Ø¯'}\\n\"\n                    f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: {verify_result['ref_id']}\\n\\n\"\n                    f\"{invoice_text}\")\n\n                try:\n                    await query.bot.send_message(\n                        chat_id=self.config.order_group_chat_id,\n                        text=group_message)\n                except Exception as e:\n                    logger.error(\n                        f\"Error sending payment confirmation to group: {e}\")\n\n            # Clear cart and payment info\n            self.cart_manager.clear_cart(user_id)\n            if 'payment_info' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['payment_info']\n\n            text = (f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!\\n\\n\"\n                    f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: {verify_result['ref_id']}\\n\\n\"\n                    f\"ğŸ“ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\\n\"\n                    f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ….\")\n\n            await query.edit_message_text(\n                text,\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n        else:\n            # Payment failed\n            text = (f\"âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯:\\n\"\n                    f\"{verify_result['error']}\\n\\n\"\n                    \"Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\")\n\n            keyboard = [[\n                InlineKeyboardButton(\n                    \"ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯\",\n                    callback_data=\n                    f\"payment_{payment_info['payment_type']}_zarinpal\")\n            ], [\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            await query.edit_message_text(\n                text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_cart_clear(self, query):\n        \"\"\"Handle cart clear\"\"\"\n        user_id = query.from_user.id\n        self.cart_manager.clear_cart(user_id)\n\n        text = \"ğŸ—‘ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ù¾Ø§Ú© Ø´Ø¯.\"\n        keyboard = self.keyboards.get_main_menu(authenticated=True)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_categories(self, query):\n        \"\"\"Handle back to categories\"\"\"\n        await self._handle_start_shopping(query)\n\n    async def _handle_back_to_alphabet(self, query):\n        \"\"\"Handle back to alphabet\"\"\"\n        user_id = query.from_user.id\n        category = self.user_sessions[user_id].get('selected_category', 'baby')\n\n        text = f\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_alphabetical_keyboard(category)\n\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_curtain_subcategories(self, query):\n        \"\"\"Handle back to curtain subcategories\"\"\"\n        text = \"ğŸ  Ù¾Ø±Ø¯Ù‡ Ùˆ Ú©ÙˆØ³Ù†\\n\\nÙ…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        keyboard = self.keyboards.get_curtain_subcategories()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_back_to_products(self, query):\n        \"\"\"Handle back to products\"\"\"\n        user_id = query.from_user.id\n        session = self.user_sessions[user_id]\n\n        if 'selected_product' in session:\n            product = session['selected_product']\n\n            # Get price based on category\n            category = product.get('category_id', 'baby')\n            category_info = get_category_info(category)\n            price = category_info.get('price', 4780000)\n\n            text = (f\"ğŸ“¦ {product['name']}\\n\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"ğŸ“ Ø³Ø§ÛŒØ² Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\")\n\n            keyboard = self.keyboards.get_size_selection_keyboard(category)\n            await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_alphabet_search(self, query, data):\n        \"\"\"Handle alphabet search button\"\"\"\n        category = data.replace(\"alphabet_search_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected category in session\n        if user_id not in self.user_sessions:\n            self.user_sessions[user_id] = {}\n        self.user_sessions[user_id]['selected_category'] = category\n\n        category_info = get_category_info(category)\n        category_name = category_info.get('name', category)\n\n        text = f\"{category_name}\\n\\nğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\\n\\nØ­Ø±Ù Ø§ÙˆÙ„ Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n\n        keyboard = self.keyboards.get_alphabetical_keyboard(category)\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_icon_selection(self, query, data):\n        \"\"\"Handle icon-based product selection\"\"\"\n        parts = data.split(\"_\", 2)\n        if len(parts) < 3:\n            await query.edit_message_text(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø¢ÛŒÚ©ÙˆÙ†.\")\n            return\n\n        category = parts[1]\n        icon = parts[2]\n\n        # Search products by icon\n        products = search_products_by_icon(category, icon)\n\n        if not products:\n            await query.edit_message_text(\"âŒ Ù…Ø­ØµÙˆÙ„ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ø¢ÛŒÚ©ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯.\")\n            return\n\n        if len(products) == 1:\n            # Only one product found, select it directly\n            product = products[0]\n            await self._handle_direct_product_selection(query, product, category)\n        else:\n            # Multiple products found, show selection keyboard\n            keyboard = self.keyboards.get_products_keyboard(products, category)\n            await query.edit_message_text(\n                f\"Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø±ØªØ¨Ø·:\",\n                reply_markup=keyboard\n            )\n\n    async def _handle_payment_confirmed(self, query, data):\n        \"\"\"Handle payment confirmation from the group\"\"\"\n        # Extract user_id from callback data\n        user_id = int(data.split(\"_\")[2])\n\n        # Get customer info\n        customer = self.user_sessions[user_id]['customer']\n\n        # Send confirmation to customer\n        text = (f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù…Ø§ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯!\\n\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ….\")\n\n        await query.bot.send_message(\n            chat_id=user_id,\n            text=text,\n            reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n        # Edit message in group to confirm\n        await query.edit_message_text(\n            f\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø´ØªØ±ÛŒ {customer['name']} ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.\")\n\n    async def _handle_contact_made(self, query, data):\n        \"\"\"Handle contact confirmation from the group\"\"\"\n        # Extract user_id from callback data\n        user_id = int(data.split(\"_\")[2])\n\n        # Get customer info\n        customer = self.user_sessions[user_id]['customer']\n\n        # Edit message in group to confirm\n        await query.edit_message_text(\n            f\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ {customer['name']} Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.\")\n\n    async def _handle_remind_tomorrow(self, query, data):\n        \"\"\"Handle remind tomorrow request from the group\"\"\"\n        # Extract user_id from callback data\n        user_id = int(data.split(\"_\")[2])\n\n        # Get customer info\n        customer = self.user_sessions[user_id]['customer']\n\n        # Schedule reminder\n        # self.payment_scheduler.schedule_reminder(user_id)\n\n        # Edit message in group to confirm\n        await query.edit_message_text(\n            f\"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ {customer['name']} Ø¨Ø±Ø§ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.\")\n\n    async def _handle_order_contacted(self, query, data):\n        \"\"\"Handle order contacted confirmation\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        # Update message\n        updated_text = f\"ğŸ“ {admin_name} Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª\\n\" + query.message.text\n\n        # Create updated keyboard with remaining options\n        keyboard = [[\n            InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n                                 callback_data=f\"order_ready_{user_id}\"),\n            InlineKeyboardButton(\"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                                 callback_data=f\"order_shipped_{user_id}\")\n        ],\n                    [\n                        InlineKeyboardButton(\n                            \"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                            callback_data=f\"order_completed_{user_id}\"),\n                        InlineKeyboardButton(\n                            \"âŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´\",\n                            callback_data=f\"order_cancelled_{user_id}\")\n                    ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\n                \"ğŸ“ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ù…Ø§ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª. Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª.\")\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_ready(self, query, data):\n        \"\"\"Handle order ready for shipping\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"ğŸ“¦ {admin_name}: Ø³ÙØ§Ø±Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\" + query.message.text\n\n        keyboard = [[\n            InlineKeyboardButton(\"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                                 callback_data=f\"order_shipped_{user_id}\"),\n            InlineKeyboardButton(\"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                                 callback_data=f\"order_completed_{user_id}\")\n        ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!\")\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_shipped(self, query, data):\n        \"\"\"Handle order shipped\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"ğŸšš {admin_name}: Ø³ÙØ§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\\n\" + query.message.text\n\n        keyboard = [[\n            InlineKeyboardButton(\"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                                 callback_data=f\"order_completed_{user_id}\")\n        ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\"ğŸšš Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ø±Ø¯.\")\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_completed(self, query, data):\n        \"\"\"Handle order completion\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"âœ… {admin_name}: Ø³ÙØ§Ø±Ø´ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\\n\" + query.message.text\n\n        await query.edit_message_text(updated_text)\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\n                \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!\\nğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…ØªØ´Ú©Ø±ÛŒÙ…. Ø§Ù…ÛŒØ¯ÙˆØ§Ø±ÛŒÙ… Ø§Ø² Ø®Ø±ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§Ø¶ÛŒ Ø¨Ø§Ø´ÛŒØ¯.\"\n            )\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_cancelled(self, query, data):\n        \"\"\"Handle order cancellation\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"âŒ {admin_name}: Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯\\n\" + query.message.text\n\n        await query.edit_message_text(updated_text)\n\n        # Notify customer - improved error handling\n        try:\n            await query.bot.send_message(\n                chat_id=user_id,\n                text=\n                \"âŒ Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ù„ØºÙˆ Ø´Ø¯.\\nğŸ“ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\"\n            )\n            logger.info(f\"Successfully notified customer {user_id}\")\n        except Exception as e:\n            logger.error(f\"Error notifying customer {user_id}: {e}\")\n            # Continue processing even if customer notification fails\n\n    async def _handle_order_reminder(self, query, data):\n        \"\"\"Handle order reminder for tomorrow\"\"\"\n        user_id = int(data.split(\"_\")[2])\n        admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n        updated_text = f\"â° {admin_name}: ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\\n\" + query.message.text\n\n        # Keep all original buttons\n        keyboard = [[\n            InlineKeyboardButton(\"âœ… ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\",\n                                 callback_data=f\"order_contacted_{user_id}\"),\n            InlineKeyboardButton(\"ğŸ“¦ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n                                 callback_data=f\"order_ready_{user_id}\")\n        ],\n                    [\n                        InlineKeyboardButton(\n                            \"ğŸšš Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n                            callback_data=f\"order_shipped_{user_id}\"),\n                        InlineKeyboardButton(\n                            \"âœ… ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n                            callback_data=f\"order_completed_{user_id}\")\n                    ],\n                    [\n                        InlineKeyboardButton(\n                            \"âŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´\",\n                            callback_data=f\"order_cancelled_{user_id}\")\n                    ]]\n\n        await query.edit_message_text(\n            updated_text, reply_markup=InlineKeyboardMarkup(keyboard))\n\n    async def _handle_order_status_update(self, query, data):\n        \"\"\"Handle order status update from admin\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª: {data}\")\n            \n            # Parse callback data: order_status_ORDER_ID_STATUS\n            parts = data.split(\"_\")\n            if len(parts) < 4:\n                logger.error(f\"âŒ ÙØ±Ù…Øª Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: {data}\")\n                await query.answer(\"âŒ Ø¯Ø§Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±\", show_alert=True)\n                return\n\n            order_id = parts[2]\n            new_status = parts[3]\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n            logger.info(f\"ğŸ“‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª {new_status} ØªÙˆØ³Ø· {admin_name}\")\n\n            # Ø§Ø¨ØªØ¯Ø§ Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¯Ù‡\n            await query.answer(\"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...\")\n\n            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø³ÙØ§Ø±Ø´\n            order_data = await self.order_server.get_order_details(order_id)\n            if not order_data:\n                logger.error(f\"âŒ Ø³ÙØ§Ø±Ø´ {order_id} ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n                await query.answer(\"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\", show_alert=True)\n                return\n\n            # Update order status Ø¨Ø§ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\n            success = await self.order_server.update_order_status(\n                order_id=order_id,\n                new_status=new_status,\n                admin_name=admin_name\n            )\n\n            if success:\n                logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\")\n                status_text = self.order_server._get_status_text(new_status)\n                \n                # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡\n                try:\n                    current_text = query.message.text or \"\"\n                    updated_text = f\"ğŸ“ {admin_name}: ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ '{status_text}' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n{current_text}\"\n\n                    # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯\n                    keyboard = self.order_server._create_admin_buttons(order_id, order_data['user_id'])\n\n                    await query.edit_message_text(\n                        updated_text,\n                        reply_markup=InlineKeyboardMarkup(keyboard)\n                    )\n                    logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                    \n                except Exception as edit_error:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ú¯Ø±ÙˆÙ‡: {edit_error}\")\n                    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´\n                    try:\n                        confirmation_message = f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ '{status_text}' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ ØªÙˆØ³Ø· {admin_name}\"\n                        await query.message.reply_text(confirmation_message)\n                        logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                    except Exception as reply_error:\n                        logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯: {reply_error}\")\n                        \n            else:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id}\")\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª\", show_alert=True)\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± _handle_order_status_update: {e}\")\n            logger.error(f\"   Data: {data}\")\n            logger.error(f\"   User: {query.from_user.first_name if query.from_user else 'Unknown'}\")\n            \n            try:\n                await query.answer(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´: {str(e)[:30]}\", show_alert=True)\n            except Exception as msg_error:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§: {msg_error}\")\n\n    \n\n    async def _handle_order_details_request(self, query, data):\n        \"\"\"Handle request for order details\"\"\"\n        try:\n            order_id = data.replace(\"order_details_\", \"\")\n            order_data = await self.order_server.get_order_details(order_id)\n\n            if not order_data:\n                await query.answer(\"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n                return\n\n            # Create detailed invoice message\n            customer = order_data.get('customer', {})\n            pricing = order_data.get('pricing', {})\n            cart_items = order_data.get('cart_items', [])\n            \n            invoice_text = (\n                f\"ğŸ“‹ ÙØ§Ú©ØªÙˆØ± - {order_id}\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ‘¤ {customer.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ™ï¸ {customer.get('city', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer.get('customer_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {order_data.get('user_id', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"â° {persian_numbers(order_data.get('created_at', '')[:16].replace('T', ' - '))}\\n\\n\"\n                f\"ğŸ“¦ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:\\n\"\n            )\n\n            # Add cart items\n            for i, item in enumerate(cart_items, 1):\n                item_total = item.get('price', 0) * item.get('quantity', 0)\n                invoice_text += (\n                    f\"{persian_numbers(str(i))}. {item.get('product_name', 'Ù…Ø­ØµÙˆÙ„')}\\n\"\n                    f\"   ğŸ“ {item.get('size', 'Ù†Ø§Ù…Ø´Ø®Øµ')} | \"\n                    f\"ğŸ“¦ {persian_numbers(str(item.get('quantity', 0)))} Ø¹Ø¯Ø¯ | \"\n                    f\"ğŸ’° {format_price(item_total)}\\n\"\n                )\n\n            # Add pricing\n            invoice_text += (\n                f\"\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ’³ {order_data.get('payment_method', 'Ù†Ù‚Ø¯ÛŒ')}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(pricing.get('total', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n                f\"ğŸ“Š {self.order_server._get_status_text(order_data.get('status', 'pending'))}\"\n            )\n\n            # Create management keyboard\n            keyboard = self.order_server._create_admin_buttons(order_id, order_data['user_id'])\n            keyboard.append([InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª\", callback_data=\"back_to_daily_orders\")])\n\n            await query.edit_message_text(\n                invoice_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Error showing order details: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª\")\n\n    async def _handle_daily_stats_request(self, query):\n        \"\"\"Handle daily statistics request\"\"\"\n        try:\n            stats = await self.order_server.get_orders_statistics()\n            today_orders = await self.order_server.get_todays_orders()\n\n            stats_text = (\n                f\"ğŸ“Š Ø¢Ù…Ø§Ø± Ø§Ù…Ø±ÙˆØ² ({persian_numbers(datetime.now().strftime('%Y/%m/%d'))})\\n\"\n                f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                f\"ğŸ“¦ Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {persian_numbers(str(len(today_orders)))}\\n\"\n                f\"ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²: {format_price(stats.get('today_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                f\"ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:\\n\"\n                f\"ğŸ“¦ Ú©Ù„ Ø³ÙØ§Ø±Ø´Ø§Øª: {persian_numbers(str(stats.get('total_orders', 0)))}\\n\"\n                f\"ğŸ’³ Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯: {format_price(stats.get('total_revenue', 0))} ØªÙˆÙ…Ø§Ù†\\n\"\n            )\n\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_daily_orders\")\n            ]]\n\n            await query.edit_message_text(\n                stats_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Error showing daily stats: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±\")\n\n    async def _handle_refresh_daily_orders(self, query):\n        \"\"\"Handle refresh daily orders request\"\"\"\n        await query.answer(\"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ...\")\n\n        # Create a fake update object to reuse the _show_daily_orders method\n        class FakeUpdate:\n            def __init__(self, message):\n                self.message = message\n\n        fake_update = FakeUpdate(query.message)\n        await self._show_daily_orders(fake_update)\n\n    async def _handle_back_to_daily_orders(self, query):\n        \"\"\"Handle back to daily orders list\"\"\"\n        # Create a fake update object to reuse the _show_daily_orders method\n        class FakeUpdate:\n            def __init__(self, message):\n                self.message = message\n\n        fake_update = FakeUpdate(query.message)\n        await self._show_daily_orders(fake_update)\n\n    async def _handle_contact_customer_request(self, query, data):\n        \"\"\"Handle request to contact customer\"\"\"\n        try:\n            user_id = int(data.replace(\"contact_customer_\", \"\"))\n\n            contact_message = (\n                f\"ğŸ“ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ\\n\"\n                f\"ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {user_id}\\n\\n\"\n                f\"Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªÙ„ÙÙ† ÛŒØ§ Ù¾ÛŒØ§Ù… Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.\"\n            )\n\n            await query.answer(\"âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯\")\n            await query.message.reply_text(contact_message)\n\n        except Exception as e:\n            logger.error(f\"Error handling contact request: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_check_order_status(self, query, data):\n        \"\"\"Handle customer's request to check order status\"\"\"\n        try:\n            order_id = data.replace(\"check_order_status_\", \"\")\n            order_data = await self.order_server.get_order_details(order_id)\n\n            if not order_data:\n                await query.edit_message_text(\n                    \"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯.\",\n                    reply_markup=InlineKeyboardMarkup([[\n                        InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n                    ]]))\n                return\n\n            status_text = self.order_server._get_status_text(order_data[\"status\"])\n            last_update = datetime.fromisoformat(order_data[\"updated_at\"]).strftime(\"%Y/%m/%d - %H:%M\")\n\n            status_message = (\n                f\"ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡: {order_id}\\n\\n\"\n                f\"ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: {status_text}\\n\"\n                f\"â° Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {persian_numbers(last_update)}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {order_data['payment_method']}\\n\"\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(order_data['pricing']['total'])} ØªÙˆÙ…Ø§Ù†\"\n            )\n\n            keyboard = self.order_server._create_customer_support_buttons(order_id)\n\n            await query.edit_message_text(\n                status_message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Error checking order status: {e}\")\n            await query.edit_message_text(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\")\n\n    async def _handle_payment_confirmation_from_group(self, query, data):\n        \"\"\"Handle payment confirmation from the payment reminder group\"\"\"\n        try:\n            # Extract schedule_id and payment_number from callback data\n            parts = data.split(\"_\")\n            schedule_id = parts[2]\n            payment_number = int(parts[3])\n\n            # Mark payment as made\n            success = self.payment_scheduler.mark_payment_made(schedule_id, payment_number)\n\n            if success:\n                await query.edit_message_text(\n                    query.message.text + \"\\n\\nâœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯\"\n                )\n                await query.answer(\"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\")\n            else:\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª\")\n\n        except Exception as e:\n            logger.error(f\"Error handling payment confirmation: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_contact_made_from_group(self, query, data):\n        \"\"\"Handle contact made confirmation from the payment reminder group\"\"\"\n        try:\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n            await query.edit_message_text(\n                query.message.text + f\"\\n\\nğŸ“ {admin_name} Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØª\"\n            )\n            await query.answer(\"âœ… ØªÙ…Ø§Ø³ Ø«Ø¨Øª Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"Error handling contact confirmation: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_remind_tomorrow_from_group(self, query, data):\n        \"\"\"Handle remind tomorrow request from the payment reminder group\"\"\"\n        try:\n            admin_name = query.from_user.first_name or \"Ø§Ø¯Ù…ÛŒÙ†\"\n\n            await query.edit_message_text(\n                query.message.text + f\"\\n\\nâ° {admin_name} ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯\"\n            )\n            await query.answer(\"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±Ø¯Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"Error handling remind tomorrow: {e}\")\n            await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª\")\n\n    async def _handle_contact_support_request(self, query):\n        \"\"\"Handle customer's request to contact support\"\"\"\n        user_id = query.from_user.id\n        await self.order_server.send_support_contact_info(user_id)\n        await query.answer(\"ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n    async def _handle_faq_request(self, query):\n        \"\"\"Handle customer's request for FAQ\"\"\"\n        user_id = query.from_user.id\n        await self.order_server.send_faq(user_id)\n        await query.answer(\"â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n    async def _handle_fabric_selection(self, query, data):\n        \"\"\"Handle fabric selection for curtains\"\"\"\n        fabric = data.replace(\"fabric_\", \"\")\n        user_id = query.from_user.id\n\n        # Store selected fabric in session\n        self.user_sessions[user_id]['selected_fabric'] = fabric\n        category = 'curtain_only'\n        self.user_sessions[user_id]['selected_category'] = category\n\n        # Get price based on fabric\n        price = get_product_price('', category, fabric=fabric)\n\n        fabric_name = \"Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\" if fabric == \"silk_cotton\" else \"Ù…Ø®Ù…Ù„\"\n\n        text = (f\"âœ… Ø¬Ù†Ø³ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {fabric_name}\\n\"\n                f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                \"Ø¹Ø§Ù„ÛŒÙ‡! Ø§Ù†ØªØ®Ø§Ø¨Øª. Ø¹Ø±Ø¶ Ù¾Ø±Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ù…ÛŒØ´Ù‡ Ø«Ø§Ø¨Øª Ù‡Ø³Øª Ø¨Ø±Ø§ÛŒ Ø§ÛŒÚ©ÙˆÙ† Ù¾Ø±Ø¯Ù‡ Ø³Ø±ØªØ®Øª 135 Ù‡Ø³Øª Ùˆ Ø§Ø±ØªÙØ§Ø¹ Ø§Ø² 2 Ù…ØªØ± Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ù…ØªØºÛŒØ±. Ù¾Ø³ Ø§Ø±ØªÙØ§Ø¹ Ù…Ø¯ Ù†Ø¸Ø±ØªÙˆ ØªØ§ÛŒÙ¾ Ú©Ù† Ø¨Ø±Ø§Ù…:\")\n\n        # Set flag for height input\n        self.user_sessions[user_id]['awaiting_curtain_height'] = True\n\n        keyboard = self.keyboards.get_height_input_keyboard()\n        await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_curtain_height_input(self, update, height_text):\n        \"\"\"Handle curtain height input\"\"\"\n        user_id = update.effective_user.id\n\n        try:\n            # Parse height (should be a number)\n            height = float(height_text)\n            if height < 2:\n                await update.message.reply_text(\n                    \"âŒ Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 2 Ù…ØªØ± Ø¨Ø§Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\")\n                return\n\n            # Store height and clear input flag\n            self.user_sessions[user_id]['selected_height'] = height\n            self.user_sessions[user_id]['awaiting_curtain_height'] = False\n\n            # Create custom size string for curtains\n            size = f\"Ø¹Ø±Ø¶: 135 - Ø§Ø±ØªÙØ§Ø¹: {height}Ù…\"\n            self.user_sessions[user_id]['selected_size'] = size\n\n            # Get price based on fabric\n            fabric = self.user_sessions[user_id]['selected_fabric']\n            category = self.user_sessions[user_id]['selected_category']\n\n            if fabric == 'special':  # For bedside curtain\n                product = self.user_sessions[user_id]['selected_product']\n                price = get_product_price(product['id'], category)\n            else:\n                price = get_product_price('', category, fabric=fabric)\n\n            text = (f\"âœ… Ø§Ø±ØªÙØ§Ø¹ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ: {height} Ù…ØªØ±\\n\"\n                    f\"ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(price)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n                    \"Ø­Ø§Ù„Ø§ Ù¾Ø±Ø¯Øª Ú†Ù†Ø¯ Ù‚ÙˆØ§Ø±Ù‡ Ø¨Ø§Ø´Ù‡ØŸ\")\n\n            keyboard = self.keyboards.get_quantity_keyboard()\n            await update.message.reply_text(text, reply_markup=keyboard)\n\n        except ValueError:\n            await update.message.reply_text(\n                \"âŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø±ØªÙØ§Ø¹ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 2.5):\")\n\n    async def _handle_back_to_fabric_selection(self, query):\n        \"\"\"Handle back to fabric selection\"\"\"\n        user_id = query.from_user.id\n\n        # Clear height input flag\n        if 'awaiting_curtain_height' in self.user_sessions[user_id]:\n            del self.user_sessions[user_id]['awaiting_curtain_height']\n\n        product = self.user_sessions[user_id].get('selected_product')\n        if product:\n            text = (f\"ğŸ“¦ {product['name']}\\n\\n\"\n                    \"Ø¹Ø§Ù„ÛŒÙ‡! Ù…Ø¯Ù„ Ù¾Ø±Ø¯Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ. Ø­Ø§Ù„Ø§ Ø¬Ù†Ø³ Ù¾Ø§Ø±Ú†Ø´ Ú†ÛŒ Ø¨Ø§Ø´Ù‡ØŸ\")\n            keyboard = self.keyboards.get_fabric_selection_keyboard()\n            await query.edit_message_text(text, reply_markup=keyboard)\n\n    async def _handle_order_actions(self, query, data):\n        \"\"\"Optimized handler for all order-related actions\"\"\"\n        try:\n            if data.startswith(\"order_contacted_\"):\n                await self._handle_order_contacted(query, data)\n            elif data.startswith(\"order_ready_\"):\n                await self._handle_order_ready(query, data)\n            elif data.startswith(\"order_shipped_\"):\n                await self._handle_order_shipped(query, data)\n            elif data.startswith(\"order_completed_\"):\n                await self._handle_order_completed(query, data)\n            elif data.startswith(\"order_cancelled_\"):\n                await self._handle_order_cancelled(query, data)\n            elif data.startswith(\"order_remind_\"):\n                await self._handle_order_reminder(query, data)\n            else:\n                logger.warning(f\"Unhandled order action: {data}\")\n                await query.answer(\"Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...\")\n        except Exception as e:\n            logger.error(f\"Order action error: {e}\")\n            try:\n                await query.answer(\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´.\")\n            except:\n                pass\n\n    def _is_authenticated(self, user_id: int) -> bool:\n        \"\"\"Check if user is authenticated\"\"\"\n        return (user_id in self.user_sessions\n                and self.user_sessions[user_id].get('authenticated', False))\n\n    async def test_group_connection(self, bot):\n        \"\"\"Test if bot can send messages to the configured group\"\"\"\n        logger.info(\"ğŸ” Testing group connection...\")\n\n        if not self.config.order_group_chat_id:\n            logger.warning(\"âŒ Order group chat ID is not configured\")\n            return False\n\n        try:\n            # Try to get chat info\n            chat = await bot.get_chat(self.config.order_group_chat_id)\n            logger.info(f\"âœ… Group connection successful!\")\n            logger.info(f\"   Title: {chat.title}\")\n            logger.info(f\"   Type: {chat.type}\")\n            logger.info(f\"   ID: {chat.id}\")\n\n            return True\n        except Exception as e:\n            logger.warning(f\"âš ï¸ Group connection test failed: {e}\")\n            logger.info(\"   Note: This is normal during startup - bot will work fine\")\n            return False\n\n    async def get_current_chat_info(self, bot, chat_id):\n        \"\"\"Get detailed info about current chat for debugging\"\"\"\n        try:\n            chat = await bot.get_chat(chat_id)\n            logger.info(f\"ğŸ’¬ Chat Info:\")\n            logger.info(f\"   ID: {chat.id}\")\n            logger.info(f\"   Title: {chat.title}\")\n            logger.info(f\"   Type: {chat.type}\")\n            logger.info(f\"   Description: {getattr(chat, 'description', 'N/A')}\")\n            return chat\n        except Exception as e:\n            logger.error(f\"Error getting chat info: {e}\")\n            return None\n\n\n    async def _send_invoice_to_group(self, invoice_text, user_id):\n        \"\"\"Send invoice to group after order completion\"\"\"\n        group_chat_id = self.config.order_group_chat_id\n        if not group_chat_id:\n            logger.error(\"Group chat ID not configured.\")\n            return\n\n        try:\n            # Note: self.bot is not available in handlers, we need to get it from context\n            logger.info(f\"Invoice sent to group {group_chat_id} for user {user_id}.\")\n        except Exception as e:\n            logger.error(f\"Failed to send invoice to group: {e}\")\n\n    async def _handle_60day_order_confirmation(self, query):\n        \"\"\"Handle confirmation for 60-day payment orders.\"\"\"\n        user_id = query.from_user.id\n\n        if not self._is_authenticated(user_id):\n            await query.edit_message_text(\"âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ù†ÛŒØ¯.\")\n            return\n\n        payment_info = self.user_sessions[user_id].get('payment_info')\n        if not payment_info or payment_info['payment_type'] != '60day':\n            await query.edit_message_text(\n                \"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ 60 Ø±ÙˆØ²Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n            return\n\n        customer = self.user_sessions[user_id]['customer']\n        cart_items = self.cart_manager.get_cart(user_id)\n\n        # Schedule the 60-day payment reminder\n        total_amount = payment_info['full_amount']\n        advance_paid = payment_info['amount']\n        remaining_amount = total_amount - advance_paid\n        order_id = f\"ORDER_{user_id}_{int(datetime.now().timestamp())}\"\n\n        self.payment_scheduler.add_60day_payment_schedule(\n            user_id=user_id,\n            customer_info=customer,\n            total_amount=total_amount,\n            advance_paid=advance_paid,\n            remaining_amount=remaining_amount,\n            order_id=order_id\n        )\n        logger.info(f\"âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯\")\n\n        try:\n            # Create order using order management server\n            order_id = await self.order_server.create_order(\n                user_id=user_id,\n                customer=customer,\n                cart_items=cart_items,\n                payment_method=payment_info['payment_method'],\n                discount_rate=payment_info['discount_rate']\n            )\n\n            # Clear cart and payment info\n            self.cart_manager.clear_cart(user_id)\n            if 'payment_info' in self.user_sessions[user_id]:\n                del self.user_sessions[user_id]['payment_info']\n\n            # Confirm to customer\n            await query.edit_message_text(\n                f\"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_id}\\n\"\n                f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_info['payment_method']}\\n\"\n                f\"ğŸ“… ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ù…Ø§Ø¨Ù‚ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª ÙØ¹Ø§Ù„ Ø´Ø¯.\\n\"\n                f\"ğŸ“ Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù…Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú¯Ø±ÙØª.\\n\"\n                f\"ğŸ™ Ø§Ø² Ø§Ø¹ØªÙ…Ø§Ø¯ Ø´Ù…Ø§ Ù…Ù…Ù†ÙˆÙ†ÛŒÙ….\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))\n\n            logger.info(f\"âœ… Ø³ÙØ§Ø±Ø´ 60 Ø±ÙˆØ²Ù‡ {order_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id}\")\n\n        except Exception as e:\n            logger.error(f\"Error in 60-day order confirmation: {e}\")\n            await query.edit_message_text(\n                \"âŒ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\",\n                reply_markup=self.keyboards.get_main_menu(authenticated=True))","size_bytes":125465},"payment_data/bot/hesabfa_integration.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nHesabfa API Integration\nØ§Ø¯ØºØ§Ù… Ø¨Ø§ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±Ù‡Ø§\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, List, Optional, Any\nfrom datetime import datetime\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\n\nlogger = setup_logger(__name__)\n\nclass HesabfaAPI:\n    \"\"\"Ú©Ù„Ø§Ø³ Ø§Ø¯ØºØ§Ù… Ø¨Ø§ API Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n    \n    def __init__(self, api_key: str = \"WjJ88NUd9rjK6dIUKYilbtCoPFCUFHs8\"):\n        self.api_key = api_key\n        self.base_url = \"https://api.hesabfa.com/v1\"\n        self.headers = {\n            \"Content-Type\": \"application/json\",\n            \"apikey\": self.api_key\n        }\n    \n    async def create_invoice(self, order_data: Dict) -> Dict[str, Any]:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_data.get('order_id')}\")\n            \n            # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±\n            invoice_data = self._prepare_invoice_data(order_data)\n            logger.info(f\"ğŸ“‹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯: {json.dumps(invoice_data, ensure_ascii=False, indent=2)}\")\n            \n            # Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API Ø­Ø³Ø§Ø¨ÙØ§\n            url = f\"{self.base_url}/invoice\"\n            logger.info(f\"ğŸŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡: {url}\")\n            \n            response = requests.post(\n                url, \n                headers=self.headers, \n                json=invoice_data,\n                timeout=30  # Ø§ÙØ²ÙˆØ¯Ù† timeout\n            )\n            \n            logger.info(f\"ğŸ“¡ Ù¾Ø§Ø³Ø® Ø­Ø³Ø§Ø¨ÙØ§: Status={response.status_code}\")\n            \n            if response.status_code == 200:\n                result = response.json()\n                logger.info(f\"ğŸ“„ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø§Ø³Ø®: {json.dumps(result, ensure_ascii=False, indent=2)}\")\n                \n                if result.get(\"Success\"):\n                    invoice_result = result.get(\"Result\", {})\n                    logger.info(f\"âœ… Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯ - ID: {invoice_result.get('Id')}\")\n                    return {\n                        \"success\": True,\n                        \"invoice_id\": invoice_result.get(\"Id\"),\n                        \"invoice_number\": invoice_result.get(\"Number\"),\n                        \"message\": \"Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯\"\n                    }\n                else:\n                    error_msg = result.get(\"ErrorMessage\", \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ\")\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±: {error_msg}\")\n                    return {\n                        \"success\": False,\n                        \"error\": error_msg\n                    }\n            else:\n                response_text = response.text[:500] if response.text else \"Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆØ§\"\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§: HTTP {response.status_code}\")\n                logger.error(f\"   Response: {response_text}\")\n                return {\n                    \"success\": False,\n                    \"error\": f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§: {response.status_code} - {response_text[:100]}\"\n                }\n                \n        except requests.exceptions.Timeout:\n            logger.error(\"âŒ Timeout Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯\"\n            }\n        except requests.exceptions.ConnectionError:\n            logger.error(\"âŒ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ÙØ§\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§\"\n            }\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§: {e}\")\n            logger.error(f\"   Ù†ÙˆØ¹ Ø®Ø·Ø§: {type(e).__name__}\")\n            return {\n                \"success\": False,\n                \"error\": f\"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ: {str(e)}\"\n            }\n    \n    def _prepare_invoice_data(self, order_data: Dict) -> Dict:\n        \"\"\"Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        customer = order_data.get(\"customer\", {})\n        cart_items = order_data.get(\"cart_items\", [])\n        pricing = order_data.get(\"pricing\", {})\n        \n        # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ\n        contact_data = {\n            \"Name\": customer.get(\"name\", \"Ù…Ø´ØªØ±ÛŒ\"),\n            \"Code\": customer.get(\"customer_id\", \"\"),\n            \"City\": customer.get(\"city\", \"\"),\n            \"ContactType\": 1  # 1 = Ù…Ø´ØªØ±ÛŒ\n        }\n        \n        # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±\n        invoice_items = []\n        for item in cart_items:\n            invoice_items.append({\n                \"ItemCode\": item.get(\"product_id\", \"\"),\n                \"ItemName\": item.get(\"product_name\", \"\"),\n                \"Description\": f\"Ø³Ø§ÛŒØ²: {item.get('size', '')}\",\n                \"Quantity\": item.get(\"quantity\", 1),\n                \"UnitPrice\": item.get(\"price\", 0),\n                \"Tax\": 0,  # Ù…Ø§Ù„ÛŒØ§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\n                \"Discount\": 0\n            })\n        \n        # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ÙØ§Ú©ØªÙˆØ±\n        invoice_data = {\n            \"Contact\": contact_data,\n            \"InvoiceItems\": invoice_items,\n            \"Number\": order_data.get(\"order_id\", \"\"),\n            \"Date\": datetime.now().strftime(\"%Y/%m/%d\"),\n            \"DueDate\": datetime.now().strftime(\"%Y/%m/%d\"),\n            \"Status\": 0,  # 0 = Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\n            \"Reference\": f\"Ø³ÙØ§Ø±Ø´ ØªÙ„Ú¯Ø±Ø§Ù… - {order_data.get('order_id')}\",\n            \"Notes\": f\"Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {order_data.get('payment_method', '')}\\nÚ©Ø§Ø±Ø¨Ø± ØªÙ„Ú¯Ø±Ø§Ù…: {order_data.get('user_id', '')}\",\n            \"Tag\": \"ØªÙ„Ú¯Ø±Ø§Ù…-Ø¨Ø§Øª\",\n            \"Project\": \"DecoTeen Bot Orders\",\n            \"SalesPerson\": \"Ø±Ø¨Ø§Øª ÙØ±ÙˆØ´\",\n            \"Currency\": \"IRR\"\n        }\n        \n        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ®ÙÛŒÙ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯\n        if pricing.get(\"discount\", 0) > 0:\n            invoice_data[\"Discount\"] = pricing.get(\"discount\", 0)\n            invoice_data[\"DiscountType\"] = 1  # 1 = Ù…Ù‚Ø¯Ø§Ø± Ø«Ø§Ø¨Øª\n        \n        return invoice_data\n    \n    async def create_contact_if_not_exists(self, customer: Dict) -> Dict[str, Any]:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨ Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯\"\"\"\n        try:\n            contact_data = {\n                \"Name\": customer.get(\"name\", \"Ù…Ø´ØªØ±ÛŒ\"),\n                \"Code\": customer.get(\"customer_id\", \"\"),\n                \"City\": customer.get(\"city\", \"\"),\n                \"ContactType\": 1,  # 1 = Ù…Ø´ØªØ±ÛŒ\n                \"Tag\": \"ØªÙ„Ú¯Ø±Ø§Ù…-Ø¨Ø§Øª\",\n                \"Notes\": f\"Ù…Ø´ØªØ±ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…\"\n            }\n            \n            url = f\"{self.base_url}/contact\"\n            response = requests.post(url, headers=self.headers, json=contact_data)\n            \n            if response.status_code == 200:\n                result = response.json()\n                if result.get(\"Success\"):\n                    logger.info(f\"âœ… Ù…Ø®Ø§Ø·Ø¨ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯: {customer.get('name')}\")\n                    return {\n                        \"success\": True,\n                        \"contact_id\": result.get(\"Result\", {}).get(\"Id\")\n                    }\n                else:\n                    # Ø§Ú¯Ø± Ù…Ø®Ø§Ø·Ø¨ Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªØŒ Ø®Ø·Ø§ Ù†ÛŒØ³Øª\n                    logger.info(f\"â„¹ï¸ Ù…Ø®Ø§Ø·Ø¨ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª: {customer.get('name')}\")\n                    return {\"success\": True}\n            else:\n                logger.warning(f\"âš ï¸ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨: HTTP {response.status_code}\")\n                return {\"success\": False}\n                \n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨: {e}\")\n            return {\"success\": False}\n    \n    async def get_invoice_status(self, invoice_id: str) -> Dict[str, Any]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        try:\n            url = f\"{self.base_url}/invoice/{invoice_id}\"\n            response = requests.get(url, headers=self.headers)\n            \n            if response.status_code == 200:\n                result = response.json()\n                if result.get(\"Success\"):\n                    return {\n                        \"success\": True,\n                        \"invoice\": result.get(\"Result\")\n                    }\n            \n            return {\"success\": False}\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ±: {e}\")\n            return {\"success\": False}\n    \n    async def update_invoice_status(self, invoice_id: str, status: int) -> Dict[str, Any]:\n        \"\"\"Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n        try:\n            # 0 = Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±ØŒ 1 = ÙØ§Ú©ØªÙˆØ±ØŒ 2 = Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡\n            url = f\"{self.base_url}/invoice/{invoice_id}\"\n            data = {\"Status\": status}\n            \n            response = requests.put(url, headers=self.headers, json=data)\n            \n            if response.status_code == 200:\n                result = response.json()\n                if result.get(\"Success\"):\n                    logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ± {invoice_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯\")\n                    return {\"success\": True}\n            \n            return {\"success\": False}\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ§Ú©ØªÙˆØ±: {e}\")\n            return {\"success\": False}\n","size_bytes":10137},"payment_data/bot/keyboards.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBot Keyboards\nManages all inline keyboards for the Telegram bot.\n\"\"\"\n\nfrom telegram import InlineKeyboardButton, InlineKeyboardMarkup\nfrom typing import List, Dict, Any\nfrom data.product_data import PERSIAN_ALPHABET, get_category_product_icons, search_products_by_icon\n\n\nclass BotKeyboards:\n    \"\"\"Class to manage all bot keyboards\"\"\"\n\n    def get_main_menu(self,\n                      authenticated: bool = False) -> InlineKeyboardMarkup:\n        \"\"\"Get main menu keyboard\"\"\"\n        buttons = []\n\n        if authenticated:\n            buttons.extend([[\n                InlineKeyboardButton(\"ğŸ›’ Ø´Ø±ÙˆØ¹ Ø®Ø±ÛŒØ¯\",\n                                     callback_data=\"start_shopping\")\n            ], [\n                InlineKeyboardButton(\"ğŸ›ï¸ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯\", callback_data=\"view_cart\")\n            ],\n                            [\n                                InlineKeyboardButton(\n                                    \"ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ±\",\n                                    callback_data=\"view_invoice\")\n                            ]])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_categories_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get main product categories keyboard\"\"\"\n        buttons = [\n            [\n                InlineKeyboardButton(\" Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ²Ø§Ø¯\",\n                                     callback_data=\"category_baby\")\n            ],\n            [\n                InlineKeyboardButton(\" Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ù†ÙˆØ¬ÙˆØ§Ù†\",\n                                     callback_data=\"category_teen\")\n            ],\n            [\n                InlineKeyboardButton(\"Ú©Ø§Ù„Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ø¨Ø²Ø±Ú¯Ø³Ø§Ù„\",\n                                     callback_data=\"category_adult\")\n            ],\n            [\n                InlineKeyboardButton(\" Ù¾Ø±Ø¯Ù‡\",\n                                     callback_data=\"category_curtain_only\")\n            ],\n            [\n                InlineKeyboardButton(\" Ú©ÙˆØ³Ù† Ùˆ Ø¹Ø±ÙˆØ³Ú©\",\n                                     callback_data=\"category_cushion\")\n            ],\n            [\n                InlineKeyboardButton(\"ğŸ§¸ ÙØ±Ø´ÛŒÙ†Ù‡\",\n                                     callback_data=\"category_tablecloth\")\n            ],\n            [InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")]\n        ]\n        return InlineKeyboardMarkup(buttons)\n\n\n\n    def get_curtain_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get curtain subcategories keyboard with icon navigation\"\"\"\n        buttons = []\n\n        # Get product icons for curtain_only category\n        product_icons = get_category_product_icons('curtain_only')\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_curtain_only\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_curtain_only_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get curtain only subcategories keyboard with icon navigation\"\"\"\n        buttons = []\n\n        # Get product icons for curtain_only category\n        product_icons = get_category_product_icons('curtain_only')\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_curtain_only\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_curtain_subcategories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_cushion_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get cushion subcategories keyboard with icon navigation\"\"\"\n        buttons = []\n\n        # Get product icons for cushion category\n        product_icons = get_category_product_icons('cushion')\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"icon_cushion_{icon}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_cushion\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_curtain_subcategories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_baby_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get baby subcategories keyboard with icon navigation\"\"\"\n        buttons = []\n\n        # Get product icons for baby category\n        product_icons = get_category_product_icons('baby')\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"icon_baby_{icon}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_baby\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_teen_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get teen subcategories keyboard with size selection\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ²\",\n                                 callback_data=\"size_selection_teen\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                            callback_data=\"back_to_categories\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_adult_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get adult subcategories keyboard with size selection\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø§ÛŒØ²\",\n                                 callback_data=\"size_selection_adult\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                            callback_data=\"back_to_categories\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_tablecloth_subcategories(self) -> InlineKeyboardMarkup:\n        \"\"\"Get tablecloth subcategories keyboard with icon navigation\"\"\"\n        buttons = []\n\n        # Get product icons for tablecloth category\n        product_icons = get_category_product_icons('tablecloth')\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description  # Remove icon from button text\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=\"alphabet_search_tablecloth\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_alphabetical_keyboard(self, category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get alphabetical search keyboard\"\"\"\n        buttons = []\n        row = []\n\n        for i, letter in enumerate(PERSIAN_ALPHABET):\n            # Create consistent callback data format\n            callback_data = f\"alpha_{category}_{letter}\"\n            row.append(\n                InlineKeyboardButton(letter, callback_data=callback_data))\n\n            # Create rows of 4 buttons each\n            if (i + 1) % 4 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining buttons if any\n        if row:\n            buttons.append(row)\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_products_keyboard(self, products: List[Dict],\n                              category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get products list keyboard\"\"\"\n        buttons = []\n\n        for product in products:\n            button_text = product['name']\n            callback_data = f\"product_{product['id']}\"\n            buttons.append([\n                InlineKeyboardButton(button_text, callback_data=callback_data)\n            ])\n\n        # Add navigation buttons\n        buttons.append(\n            [InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_category_products_keyboard(self,\n                                       category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get category products keyboard with icons\"\"\"\n        buttons = []\n\n        # Get product icons for this category\n        product_icons = get_category_product_icons(category)\n\n        # Create buttons for each unique icon - 2 buttons per row\n        row = []\n        for i, (icon, description, product_id) in enumerate(product_icons):\n            button_text = description\n            callback_data = f\"product_{product_id}\"\n            row.append(\n                InlineKeyboardButton(button_text, callback_data=callback_data))\n\n            # Create rows of 2 buttons each\n            if (i + 1) % 2 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining button if any\n        if row:\n            buttons.append(row)\n\n        # Add alphabet search button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”¤ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø­Ø±ÙˆÙ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ\",\n                                 callback_data=f\"alphabet_search_{category}\")\n        ])\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_size_selection_keyboard(self,\n                                    category: str) -> InlineKeyboardMarkup:\n        \"\"\"Get size selection keyboard based on category\"\"\"\n        if category == 'baby':\n            # Baby category: only 75Ã—160\n            sizes = [\"75Ã—160\"]\n        elif category in ['teen', 'adult']:\n            # Teen and adult: specific sizes as requested\n            if category == 'teen':\n                sizes = [\n                    \"90Ã—200\",\n                    \"100Ã—200\",\n                    \"120Ã—200\",\n                ]\n            else:  # category == 'adult'\n                sizes = [\n                    \"140Ã—200\",\n                    \"160Ã—200\",\n                    \"180Ã—200\",\n                ]\n        elif category == 'tablecloth':\n            # Tablecloth category: custom sizes with different prices\n            sizes = [\n                \"120Ã—80\",\n                \"100Ã—100\", \n                \"100Ã—150\",\n                \"120Ã—180\"\n            ]\n        else:\n            # Default sizes for other categories\n            sizes = [\n                \"140Ã—200\",\n                \"160Ã—200\",\n                \"180Ã—200\",\n            ]\n\n        buttons = []\n        row = []\n\n        for i, size in enumerate(sizes):\n            row.append(\n                InlineKeyboardButton(size,\n                                     callback_data=f\"size_{size}_{category}\"))\n\n            # Create rows of 3 buttons each for better layout with more sizes\n            if (i + 1) % 3 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add remaining buttons if any\n        if row:\n            buttons.append(row)\n\n        # Add back button\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\",\n                                 callback_data=\"back_to_categories\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_fabric_selection_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get fabric selection keyboard for curtains\"\"\"\n        buttons = [\n            [\n                InlineKeyboardButton(\"Ø­Ø±ÛŒØ± Ú©ØªØ§Ù†\", callback_data=\"fabric_silk_cotton\"),\n                InlineKeyboardButton(\"Ù…Ø®Ù…Ù„\", callback_data=\"fabric_velvet\")\n            ],\n            [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_categories\")\n            ]\n        ]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_height_input_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get height input keyboard for curtains\"\"\"\n        buttons = [\n            [\n                InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_fabric_selection\")\n            ]\n        ]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_quantity_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get quantity selection keyboard\"\"\"\n        buttons = []\n        row = []\n\n        # Quantities 1-10\n        for i in range(1, 11):\n            row.append(InlineKeyboardButton(str(i), callback_data=f\"qty_{i}\"))\n\n            # Create rows of 5 buttons each\n            if i % 5 == 0:\n                buttons.append(row)\n                row = []\n\n        # Add navigation buttons\n        buttons.append([\n            InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª\", callback_data=\"back_to_products\")\n        ])\n\n        return InlineKeyboardMarkup(buttons)\n\n    def get_payment_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get payment options keyboard\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (Û³Û°Ùª ØªØ®ÙÛŒÙ)\",\n                                 callback_data=\"payment_cash_card\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ“… Ù¾Ø±Ø¯Ø§Ø®Øª Û¶Û° Ø±ÙˆØ² (Û²ÛµÙª ØªØ®ÙÛŒÙ)\",\n                                            callback_data=\"payment_60day_card\")\n                   ],\n                   [\n                       InlineKeyboardButton(\n                           \"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Û¹Û° Ø±ÙˆØ² (Û²ÛµÙª ØªØ®ÙÛŒÙ + Û²ÛµÙª Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª)\",\n                           callback_data=\"payment_90day_card\")\n                   ],\n                   [\n                       InlineKeyboardButton(\"ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯\",\n                                            callback_data=\"view_cart\")\n                   ],\n                   [\n                       InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\",\n                                            callback_data=\"main_menu\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)\n\n    def get_cart_management_keyboard(self) -> InlineKeyboardMarkup:\n        \"\"\"Get cart management keyboard\"\"\"\n        buttons = [[\n            InlineKeyboardButton(\"ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ±\",\n                                 callback_data=\"view_invoice\")\n        ],\n                   [\n                       InlineKeyboardButton(\"ğŸ›’ Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯\",\n                                            callback_data=\"start_shopping\")\n                   ],\n                   [\n                       InlineKeyboardButton(\"ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯\",\n                                            callback_data=\"cart_clear\")\n                   ],\n                   [\n                       InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\",\n                                            callback_data=\"main_menu\")\n                   ]]\n        return InlineKeyboardMarkup(buttons)","size_bytes":18436},"payment_data/bot/order_server.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nOrder Management Server\nØ³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\n\"\"\"\n\nimport json\nimport os\nfrom datetime import datetime\nfrom typing import Dict, List, Optional, Any\nfrom telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup\nfrom bot.config import Config\nfrom bot.pricing import PricingManager\nfrom bot.hesabfa_integration import HesabfaAPI\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\n\nlogger = setup_logger(__name__)\n\nclass OrderStatus:\n    \"\"\"ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø³ÙØ§Ø±Ø´\"\"\"\n    PENDING = \"pending\"           # Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±\n    CONTACTED = \"contacted\"       # ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\n    CONFIRMED = \"confirmed\"       # ØªØ§ÛŒÛŒØ¯ Ø´Ø¯\n    PREPARING = \"preparing\"       # Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ\n    READY = \"ready\"              # Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\n    SHIPPED = \"shipped\"          # Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\n    DELIVERED = \"delivered\"      # ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯\n    COMPLETED = \"completed\"      # ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\n    CANCELLED = \"cancelled\"      # Ù„ØºÙˆ Ø´Ø¯\n\nclass OrderManagementServer:\n    \"\"\"Ø³Ø±ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´Ø§Øª\"\"\"\n\n    def __init__(self):\n        self.config = Config()\n        self.pricing_manager = PricingManager()\n        self.hesabfa_api = HesabfaAPI()\n        self.orders_dir = \"order_data\"\n        self.bot = None\n\n        # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\n        os.makedirs(self.orders_dir, exist_ok=True)\n\n        # Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ\n        self.status_messages = {\n            OrderStatus.PENDING: \"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³Øª.\",\n            OrderStatus.CONTACTED: \"ğŸ”„ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªÙˆØ³Ø· ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† Ø¯Ø±Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø³Ø§Ø²ÛŒ Ø§Ø³Øª.\",\n            OrderStatus.CONFIRMED: \"âœ… Ø¹Ø§Ù„ÛŒÙ‡! Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªÙˆØ³Ø· ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ú©ÙˆØªÛŒÙ† ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.\\nğŸ¦ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø´Ù…Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø«Ø¨Øª Ø´Ø¯.\\nğŸ“ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\",\n            OrderStatus.PREPARING: \"ğŸ”§ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³Øª.\",\n            OrderStatus.READY: \"ğŸ“¦ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!\",\n            OrderStatus.SHIPPED: \"ğŸšš Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ø² Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¯Ú©ÙˆØªÛŒÙ† Ù…Ù…Ù†ÙˆÙ†ÛŒÙ… Ùˆ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.\",\n            OrderStatus.DELIVERED: \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.\",\n            OrderStatus.COMPLETED: \"ğŸ‰ Ú©Ø§Ø±Ø¨Ø± Ú¯Ø±Ø§Ù…ÛŒ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± ØµÙ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒØ¨Ø§Ø´Ø¯.\",\n            OrderStatus.CANCELLED: \"\"  # Ù¾ÛŒØ§Ù… Ø®Ø§Øµ Ø¯Ø± Ù…ØªØ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡\n        }\n\n    def set_bot(self, bot: Bot):\n        \"\"\"ØªÙ†Ø¸ÛŒÙ… bot instance\"\"\"\n        self.bot = bot\n\n    def _get_order_file_path(self, order_id: str) -> str:\n        \"\"\"Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ø³ÙØ§Ø±Ø´\"\"\"\n        return os.path.join(self.orders_dir, f\"order_{order_id}.json\")\n\n    def _generate_order_id(self, user_id: int) -> str:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ÛŒ Ø³ÙØ§Ø±Ø´\"\"\"\n        # Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø³Ø§Ø¯Ù‡\n        counter_file = os.path.join(self.orders_dir, \"order_counter.txt\")\n\n        try:\n            # Ø®ÙˆØ§Ù†Ø¯Ù† Ø´Ù…Ø§Ø±Ù‡ ÙØ¹Ù„ÛŒ\n            if os.path.exists(counter_file):\n                with open(counter_file, 'r') as f:\n                    counter = int(f.read().strip())\n            else:\n                counter = 0\n\n            # Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡\n            counter += 1\n\n            # Ø°Ø®ÛŒØ±Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ø¬Ø¯ÛŒØ¯\n            with open(counter_file, 'w') as f:\n                f.write(str(counter))\n\n            return f\"{counter:05d}\"  # Ø´Ù…Ø§Ø±Ù‡ 5 Ø±Ù‚Ù…ÛŒ: 00001, 00002, ...\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {e}\")\n            # fallback to timestamp\n            timestamp = datetime.now().strftime(\"%H%M%S\")\n            return f\"ORD{timestamp}\"\n\n    async def create_order(self, user_id: int, customer: Dict, cart_items: List[Dict], \n                          payment_method: str, discount_rate: float = 0, receipt_photo_id: str = None) -> str:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯\"\"\"\n        try:\n            order_id = self._generate_order_id(user_id)\n\n            # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§\n            subtotal = self.pricing_manager.calculate_subtotal(cart_items)\n            discount = self.pricing_manager.calculate_discount(subtotal, discount_rate)\n            tax = self.pricing_manager.calculate_tax(subtotal - discount)\n            total = subtotal - discount + tax\n\n            # Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´\n            order_data = {\n                \"order_id\": order_id,\n                \"user_id\": user_id,\n                \"customer\": customer,\n                \"cart_items\": cart_items,\n                \"payment_method\": payment_method,\n                \"pricing\": {\n                    \"subtotal\": subtotal,\n                    \"discount_rate\": discount_rate,\n                    \"discount\": discount,\n                    \"tax\": tax,\n                    \"total\": total\n                },\n                \"status\": OrderStatus.PENDING,\n                \"created_at\": datetime.now().isoformat(),\n                \"updated_at\": datetime.now().isoformat(),\n                \"status_history\": [\n                    {\n                        \"status\": OrderStatus.PENDING,\n                        \"timestamp\": datetime.now().isoformat(),\n                        \"note\": \"Ø³ÙØ§Ø±Ø´ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯\"\n                    }\n                ]\n            }\n\n            # Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´\n            await self._save_order(order_data)\n\n            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n            await self._send_invoice_to_support_group(order_data, receipt_photo_id)\n\n            # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\n            await self._notify_customer(user_id, OrderStatus.PENDING, order_id)\n\n            logger.info(f\"Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: {order_id}\")\n            return order_id\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´: {e}\")\n            raise\n\n    async def _save_order(self, order_data: Dict):\n        \"\"\"Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´ Ø¯Ø± ÙØ§ÛŒÙ„\"\"\"\n        order_file = self._get_order_file_path(order_data[\"order_id\"])\n\n        try:\n            with open(order_file, 'w', encoding='utf-8') as f:\n                json.dump(order_data, f, ensure_ascii=False, indent=2)\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´: {e}\")\n            raise\n\n    async def _send_invoice_to_support_group(self, order_data: Dict, receipt_photo_id: str = None):\n        \"\"\"Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\"\"\"\n        if not self.bot:\n            logger.warning(\"âŒ Bot instance ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\")\n            return\n\n        if not self.config.order_group_chat_id:\n            logger.warning(\"âŒ Ú¯Ø±ÙˆÙ‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\")\n            return\n\n        try:\n            # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\n            try:\n                chat_info = await self.bot.get_chat(self.config.order_group_chat_id)\n                logger.info(f\"âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯: {chat_info.title}\")\n            except Exception as chat_error:\n                logger.error(f\"âŒ Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ {self.config.order_group_chat_id}: {chat_error}\")\n                return\n\n            # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\n            invoice_text = self._generate_invoice_text(order_data)\n\n            # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙØ§Ø±Ø´\n            keyboard = self._create_admin_buttons(order_data[\"order_id\"], order_data[\"user_id\"])\n\n            # Ø§Ú¯Ø± Ø¹Ú©Ø³ ÙÛŒØ´ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¢Ù† Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†\n            if receipt_photo_id:\n                try:\n                    photo_message = await self.bot.send_photo(\n                        chat_id=self.config.order_group_chat_id,\n                        photo=receipt_photo_id,\n                        caption=\"ğŸ“¸ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ù…Ø´ØªØ±ÛŒ\"\n                    )\n                    logger.info(f\"âœ… Ø¹Ú©Ø³ ÙÛŒØ´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ - Message ID: {photo_message.message_id}\")\n                except Exception as photo_error:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ÙÛŒØ´: {photo_error}\")\n                    # Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø¯Ù† Ø­ØªÛŒ Ø§Ú¯Ø± Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´ÙˆØ¯\n\n            # Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡\n            sent_message = await self.bot.send_message(\n                chat_id=self.config.order_group_chat_id,\n                text=invoice_text,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n            logger.info(f\"âœ… Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´ {order_data['order_id']} Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n            logger.info(f\"   Group ID: {self.config.order_group_chat_id}\")\n            logger.info(f\"   Message ID: {sent_message.message_id}\")\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡: {e}\")\n            logger.error(f\"   Order ID: {order_data.get('order_id', 'Unknown')}\")\n            logger.error(f\"   Group ID: {self.config.order_group_chat_id}\")\n            logger.error(f\"   Error type: {type(e).__name__}\")\n\n            # Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯\n            if hasattr(e, 'message'):\n                logger.error(f\"   Error message: {e.message}\")\n\n            # Ø­ØªÛŒ Ø§Ú¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´\n\n    def _generate_invoice_text(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"cart_items\"]\n        pricing = order_data[\"pricing\"]\n\n        invoice_text = (\n            f\"ğŸ†• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ø´Ù…Ø§Ø±Ù‡: {order_data['order_id']}\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n            f\"ğŸ†” Ú©Ø¯ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ: {customer['customer_id']}\\n\"\n            f\"ğŸ“± Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±: {order_data['user_id']}\\n\"\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {order_data['payment_method']}\\n\"\n            f\"â° Ø²Ù…Ø§Ù† Ø«Ø¨Øª: {persian_numbers('1404/05/14')} - {persian_numbers(datetime.fromisoformat(order_data['created_at']).strftime('%H:%M'))}\\n\\n\"\n            f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n        )\n\n        # Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            )\n\n        # Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ù‚ÛŒÙ…Øª\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ø¬Ù…Ø¹ Ú©Ù„: {format_price(pricing['subtotal'])} ØªÙˆÙ…Ø§Ù†\\n\"\n        )\n\n        if pricing['discount'] > 0:\n            invoice_text += f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(pricing['discount_rate'] * 100)))}Ùª): {format_price(pricing['discount'])} ØªÙˆÙ…Ø§Ù†\\n\"\n\n        invoice_text += (\n            f\"ğŸ“Š Ù…Ø§Ù„ÛŒØ§Øª (Û¹Ùª): {format_price(pricing['tax'])} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’³ Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(pricing['total'])} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª: {self._get_status_text(order_data['status'])}\"\n        )\n        \n        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ÙØ§ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯\n        if order_data.get(\"hesabfa_invoice_id\"):\n            invoice_text += (\n                f\"\\n\\nğŸ¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ÙØ§:\\n\"\n                f\"ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: {order_data.get('hesabfa_invoice_number', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\\n\"\n                f\"ğŸ†” Ø´Ù†Ø§Ø³Ù‡ ÙØ§Ú©ØªÙˆØ±: {order_data.get('hesabfa_invoice_id')}\"\n            )\n\n        return invoice_text\n\n    def _create_admin_buttons(self, order_id: str, user_id: int) -> List[List[InlineKeyboardButton]]:\n        \"\"\"Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† (Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡)\"\"\"\n        return [\n            [\n                InlineKeyboardButton(\"âœ… ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´\", callback_data=f\"order_status_{order_id}_confirmed\"),\n                InlineKeyboardButton(\"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\", callback_data=f\"order_status_{order_id}_contacted\")\n            ],\n            [\n                InlineKeyboardButton(\"ğŸšš Ø³ÙØ§Ø±Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\", callback_data=f\"order_status_{order_id}_shipped\"),\n                InlineKeyboardButton(\"ğŸ‰ Ø³ÙØ§Ø±Ø´ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\", callback_data=f\"order_status_{order_id}_completed\")\n            ],\n            [\n                InlineKeyboardButton(\"âŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´\", callback_data=f\"order_status_{order_id}_cancelled\")\n            ]\n        ]\n\n    async def update_order_status(self, order_id: str, new_status: str, admin_name: str = \"Ø§Ø¯Ù…ÛŒÙ†\", note: str = \"\") -> bool:\n        \"\"\"Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ {new_status}\")\n            \n            # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´\n            order_data = await self._load_order(order_id)\n            if not order_data:\n                logger.error(f\"âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯: {order_id}\")\n                return False\n\n            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª\n            old_status = order_data[\"status\"]\n            order_data[\"status\"] = new_status\n            order_data[\"updated_at\"] = datetime.now().isoformat()\n\n            # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡\n            status_entry = {\n                \"status\": new_status,\n                \"timestamp\": datetime.now().isoformat(),\n                \"admin\": admin_name,\n                \"note\": note or f\"ÙˆØ¶Ø¹ÛŒØª Ø§Ø² {self._get_status_text(old_status)} Ø¨Ù‡ {self._get_status_text(new_status)} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\"\n            }\n            order_data[\"status_history\"].append(status_entry)\n\n            # Ø§Ø¨ØªØ¯Ø§ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† ØªØ§ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ÛŒ Ø­Ø³Ø§Ø¨ÙØ§ØŒ Ú©Ø§Ø± Ø§Ø¯Ø§Ù…Ù‡ ÛŒØ§Ø¨Ø¯\n            await self._save_order(order_data)\n            logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯\")\n\n            # Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´ (Ø¨Ù‡ ØµÙˆØ±Øª ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù†)\n            if new_status == OrderStatus.CONFIRMED and not order_data.get(\"hesabfa_invoice_id\"):\n                logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n                \n                # Ø§Ø¬Ø±Ø§ÛŒ ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù† Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² blocking\n                import asyncio\n                asyncio.create_task(self._process_hesabfa_invoice(order_id, order_data))\n\n            # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\n            user_id = order_data[\"user_id\"]\n            if user_id and self.bot:\n                try:\n                    await self._notify_customer(user_id, new_status, order_id, admin_name)\n                    logger.info(f\"âœ… Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                except Exception as notify_error:\n                    logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ: {notify_error}\")\n                    # Ø§Ø¬Ø±Ø§ÛŒ ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§\n                    import asyncio\n                    asyncio.create_task(self._notify_customer_async(user_id, new_status, order_id, admin_name))\n\n            logger.info(f\"âœ… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡ {new_status} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\")\n            return True\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ {order_id}: {e}\")\n            logger.error(f\"   Ø®Ø·Ø§: {str(e)}\")\n            return False\n\n    async def _load_order(self, order_id: str) -> Optional[Dict]:\n        \"\"\"Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´ Ø§Ø² ÙØ§ÛŒÙ„\"\"\"\n        order_file = self._get_order_file_path(order_id)\n\n        try:\n            if os.path.exists(order_file):\n                with open(order_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            return None\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}: {e}\")\n            return None\n\n    async def _process_hesabfa_invoice(self, order_id: str, order_data: Dict):\n        \"\"\"Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ù‡ ØµÙˆØ±Øª ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù†\"\"\"\n        try:\n            logger.info(f\"ğŸ”„ Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n            \n            # Ø§Ø¨ØªØ¯Ø§ Ù…Ø®Ø§Ø·Ø¨ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù† (Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯)\n            contact_result = await self.hesabfa_api.create_contact_if_not_exists(order_data[\"customer\"])\n            logger.info(f\"ğŸ“ Ù†ØªÛŒØ¬Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨: {contact_result.get('success', False)}\")\n            \n            # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø§ timeout Ú©ÙˆØªØ§Ù‡â€ŒØªØ±\n            hesabfa_result = await self.hesabfa_api.create_invoice(order_data)\n            logger.info(f\"ğŸ¦ Ù†ØªÛŒØ¬Ù‡ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±: {hesabfa_result}\")\n            \n            # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³ÙØ§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ\n            current_order = await self._load_order(order_id)\n            if not current_order:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³ÙØ§Ø±Ø´ {order_id}\")\n                return\n                \n            if hesabfa_result.get(\"success\"):\n                # Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¯Ø± Ø³ÙØ§Ø±Ø´\n                current_order[\"hesabfa_invoice_id\"] = hesabfa_result.get(\"invoice_id\")\n                current_order[\"hesabfa_invoice_number\"] = hesabfa_result.get(\"invoice_number\")\n                \n                # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡\n                hesabfa_entry = {\n                    \"status\": \"hesabfa_created\",\n                    \"timestamp\": datetime.now().isoformat(),\n                    \"admin\": \"Ø³ÛŒØ³ØªÙ…\",\n                    \"note\": f\"Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯ - Ø´Ù…Ø§Ø±Ù‡: {hesabfa_result.get('invoice_number')}\"\n                }\n                current_order[\"status_history\"].append(hesabfa_entry)\n                \n                # Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª\n                await self._save_order(current_order)\n                \n                logger.info(f\"âœ… Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´ {order_id} Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯\")\n                logger.info(f\"   ğŸ“‹ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: {hesabfa_result.get('invoice_number')}\")\n                logger.info(f\"   ğŸ†” Ø´Ù†Ø§Ø³Ù‡ Ø­Ø³Ø§Ø¨ÙØ§: {hesabfa_result.get('invoice_id')}\")\n                logger.info(f\"   ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {order_data['customer']['name']}\")\n            else:\n                error_message = hesabfa_result.get('error', 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ')\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§: {error_message}\")\n                \n                # Ø«Ø¨Øª Ø®Ø·Ø§ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡\n                error_entry = {\n                    \"status\": \"hesabfa_error\",\n                    \"timestamp\": datetime.now().isoformat(),\n                    \"admin\": \"Ø³ÛŒØ³ØªÙ…\",\n                    \"note\": f\"Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§: {error_message}\"\n                }\n                current_order[\"status_history\"].append(error_entry)\n                await self._save_order(current_order)\n                \n        except Exception as hesabfa_exception:\n            logger.error(f\"âŒ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø«Ø¨Øª Ø­Ø³Ø§Ø¨ÙØ§: {hesabfa_exception}\")\n            \n            # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù…Ø¬Ø¯Ø¯ Ùˆ Ø«Ø¨Øª Ø®Ø·Ø§\n            try:\n                current_order = await self._load_order(order_id)\n                if current_order:\n                    error_entry = {\n                        \"status\": \"hesabfa_error\",\n                        \"timestamp\": datetime.now().isoformat(),\n                        \"admin\": \"Ø³ÛŒØ³ØªÙ…\",\n                        \"note\": f\"Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ Ø¯Ø± Ø«Ø¨Øª Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±: {str(hesabfa_exception)[:100]}\"\n                    }\n                    current_order[\"status_history\"].append(error_entry)\n                    await self._save_order(current_order)\n            except Exception as save_error:\n                logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø®Ø·Ø§ÛŒ Ø­Ø³Ø§Ø¨ÙØ§: {save_error}\")\n\n    async def _notify_customer_async(self, user_id: int, status: str, order_id: str, admin_name: str = \"\"):\n        \"\"\"Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù† Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\"\"\"\n        try:\n            await self._notify_customer(user_id, status, order_id, admin_name)\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØºÛŒØ±Ù‡Ù…Ø²Ù…Ø§Ù†: {e}\")\n\n    async def _notify_customer(self, user_id: int, status: str, order_id: str, admin_name: str = \"\"):\n        \"\"\"Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ\"\"\"\n        if not self.bot:\n            logger.warning(\"Bot instance ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\")\n            return\n\n        try:\n            logger.info(f\"ğŸ”” Ø´Ø±ÙˆØ¹ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n            \n            # Ø¨Ø±Ø±Ø³ÛŒ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ø®Ø§Øµ\n            if status == OrderStatus.CANCELLED:\n                # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ\n                order_data = await self._load_order(order_id)\n                customer_name = \"Ù…Ø´ØªØ±ÛŒ Ú¯Ø±Ø§Ù…ÛŒ\"\n\n                if order_data and order_data.get('customer'):\n                    customer_name = order_data['customer'].get('name', 'Ù…Ø´ØªØ±ÛŒ Ú¯Ø±Ø§Ù…ÛŒ')\n\n                full_message = (\n                    f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡: {order_id}\\n\\n\"\n                    f\"Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø§Ø² Ø´Ø±Ú©Øª Ø¯Ú©ÙˆØªÛŒÙ† Ù…Ù…Ù†ÙˆÙ†ÛŒÙ… {customer_name} Ø¹Ø²ÛŒØ²\\n\\n\"\n                    f\"Ø³Ù‚Ù Ø§Ø¹ØªØ¨Ø§Ø± Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù„Øª Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª\\n\\n\"\n                    f\"Ù„Ø·ÙØ§ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ù†Ù…Ø§ÛŒÛŒØ¯ Ùˆ Ø¨Ø§ Ø§Ø±Ø³Ø§Ù„ ÙÛŒØ´ Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯\\n\\n\"\n                    f\"Ø¨Ø§ ØªØ´Ú©Ø±\\n\"\n                    f\"Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø¯Ú©ÙˆØªÛŒÙ† ğŸŒŸ\"\n                )\n            else:\n                message = self.status_messages.get(status, f\"ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ù‡ {status} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.\")\n\n                # Ø§ÙØ²ÙˆØ¯Ù† Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´\n                full_message = (\n                    f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§Ø±Ù‡: {order_id}\\n\"\n                    f\"{message}\\n\"\n                )\n\n                if admin_name and status != OrderStatus.PENDING:\n                    full_message += f\"\\nğŸ‘¤ ØªÙˆØ³Ø·: {admin_name}\"\n\n            # Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n            keyboard = self._create_customer_support_buttons(order_id)\n\n            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ retry\n            max_retries = 3\n            for attempt in range(max_retries):\n                try:\n                    await self.bot.send_message(\n                        chat_id=user_id,\n                        text=full_message,\n                        reply_markup=InlineKeyboardMarkup(keyboard)\n                    )\n                    logger.info(f\"âœ… Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª {status} Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n                    return\n                except Exception as send_error:\n                    logger.warning(f\"âš ï¸ ØªÙ„Ø§Ø´ {attempt + 1} Ù†Ø§Ù…ÙˆÙÙ‚: {send_error}\")\n                    if attempt == max_retries - 1:\n                        # Ø¢Ø®Ø±ÛŒÙ† ØªÙ„Ø§Ø´ Ø¨Ø§ Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡\n                        simple_message = f\"ğŸ“‹ Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.\"\n                        await self.bot.send_message(\n                            chat_id=user_id,\n                            text=simple_message\n                        )\n                        logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n\n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id}: {e}\")\n            logger.error(f\"   Ø³ÙØ§Ø±Ø´: {order_id}, ÙˆØ¶Ø¹ÛŒØª: {status}\")\n            logger.error(f\"   Ø®Ø·Ø§ÛŒ Ú©Ø§Ù…Ù„: {str(e)}\")\n            \n            # ØªÙ„Ø§Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø³ÛŒØ§Ø± Ø³Ø§Ø¯Ù‡\n            try:\n                await self.bot.send_message(\n                    chat_id=user_id,\n                    text=f\"Ø³ÙØ§Ø±Ø´ {order_id} Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.\"\n                )\n                logger.info(f\"âœ… Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ {user_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\")\n            except:\n                logger.error(f\"âŒ Ø­ØªÛŒ Ù¾ÛŒØ§Ù… Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ Ù†ÛŒØ² Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯\")\n\n    def _create_customer_support_buttons(self, order_id: str) -> List[List[InlineKeyboardButton]]:\n        \"\"\"Create customer support buttons for order status\"\"\"\n        return [\n            [\n                InlineKeyboardButton(\"ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´\", callback_data=f\"check_order_status_{order_id}\"),\n                InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\", callback_data=\"contact_support\")\n            ],\n            [\n                InlineKeyboardButton(\"â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\", callback_data=\"faq\")\n            ]\n        ]\n\n    def _get_status_text(self, status: str) -> str:\n        \"\"\"Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª\"\"\"\n        status_texts = {\n            OrderStatus.PENDING: \"Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±\",\n            OrderStatus.CONTACTED: \"Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ\",\n            OrderStatus.CONFIRMED: \"ØªØ§ÛŒÛŒØ¯ Ø´Ø¯\",\n            OrderStatus.PREPARING: \"Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ\",\n            OrderStatus.READY: \"Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„\",\n            OrderStatus.SHIPPED: \"Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯\",\n            OrderStatus.DELIVERED: \"ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯\",\n            OrderStatus.COMPLETED: \"ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯\",\n            OrderStatus.CANCELLED: \"Ù„ØºÙˆ Ø´Ø¯\"\n        }\n        return status_texts.get(status, status)\n\n    async def get_order_details(self, order_id: str) -> Optional[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´\"\"\"\n        return await self._load_order(order_id)\n\n    async def get_customer_orders(self, user_id: int) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª ÛŒÚ© Ù…Ø´ØªØ±ÛŒ\"\"\"\n        orders = []\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(f\"order_{user_id}_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n                    if order_data:\n                        orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)\n            orders.sort(key=lambda x: x[\"created_at\"], reverse=True)\n            return orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ù…Ø´ØªØ±ÛŒ {user_id}: {e}\")\n            return []\n\n    async def get_all_orders(self, status_filter: str = None) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª (Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†)\"\"\"\n        orders = []\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(\"order_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n                    if order_data:\n                        if status_filter is None or order_data[\"status\"] == status_filter:\n                            orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)\n            orders.sort(key=lambda x: x[\"created_at\"], reverse=True)\n            return orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´Ø§Øª: {e}\")\n            return []\n\n    async def send_support_contact_info(self, user_id: int):\n        \"\"\"Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\"\"\"\n        if not self.bot:\n            return\n\n        try:\n            contact_message = (\n                \"ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\\n\\n\"\n                \"ğŸ• Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ: Ø´Ù†Ø¨Ù‡ ØªØ§ Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡ - Û¹ ØµØ¨Ø­ ØªØ§ Û¶ Ø¹ØµØ±\\n\"\n                \"ğŸ“ ØªÙ„ÙÙ†: Û°Û²Û±-Û±Û²Û³Û´ÛµÛ¶Û·Û¸\\n\"\n                \"ğŸ“± ÙˆØ§ØªØ³Ø§Ù¾: Û°Û¹Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹\\n\"\n                \"âœ‰ï¸ Ø§ÛŒÙ…ÛŒÙ„: support@example.com\\n\\n\"\n                \"âš¡ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø³Ø±ÛŒØ¹ Ø¯Ø± Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ\"\n            )\n\n            keyboard = [[\n                InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")\n            ]]\n\n            await self.bot.send_message(\n                chat_id=user_id,\n                text=contact_message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³: {e}\")\n\n    async def send_faq(self, user_id: int):\n        \"\"\"Ø§Ø±Ø³Ø§Ù„ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\"\"\"\n        if not self.bot:\n            return\n\n        try:\n            faq_message = (\n                \"â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\\n\\n\"\n                \"ğŸ”¸ Ú†Ù‚Ø¯Ø± Ø·ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ø´Ø¯ ØªØ§ Ø³ÙØ§Ø±Ø´ Ø¢Ù…Ø§Ø¯Ù‡ Ø´ÙˆØ¯ØŸ\\n\"\n                \"Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Û³ ØªØ§ Ûµ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ\\n\\n\"\n                \"ğŸ”¸ Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú†Ù‚Ø¯Ø± Ø§Ø³ØªØŸ\\n\"\n                \"Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø§Ù„Ø§ÛŒ Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù† Ø±Ø§ÛŒÚ¯Ø§Ù†\\n\\n\"\n                \"ğŸ”¸ Ø¢ÛŒØ§ Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ± ÛŒØ§ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŸ\\n\"\n                \"ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª\\n\\n\"\n                \"ğŸ”¸ Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú©Ù†Ù…ØŸ\\n\"\n                \"Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù‡Ù…ÛŒÙ† Ø±Ø¨Ø§Øª ÛŒØ§ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\"\n            )\n\n            keyboard = [\n                [InlineKeyboardButton(\"ğŸ“ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\", callback_data=\"contact_support\")],\n                [InlineKeyboardButton(\"ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ\", callback_data=\"main_menu\")]\n            ]\n\n            await self.bot.send_message(\n                chat_id=user_id,\n                text=faq_message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„: {e}\")\n\n    async def get_todays_orders(self) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²\"\"\"\n        today_orders = []\n        today_date = datetime.now().strftime(\"%Y-%m-%d\")\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(\"order_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n\n                    if order_data:\n                        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´\n                        order_date = order_data.get('created_at', '')[:10]\n                        if order_date == today_date:\n                            today_orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)\n            today_orders.sort(key=lambda x: x.get('created_at', ''), reverse=True)\n            return today_orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ø§Ù…Ø±ÙˆØ²: {e}\")\n            return []\n\n    async def get_orders_by_date(self, target_date: str) -> List[Dict]:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® (ÙØ±Ù…Øª: YYYY-MM-DD)\"\"\"\n        date_orders = []\n\n        try:\n            for filename in os.listdir(self.orders_dir):\n                if filename.startswith(\"order_\") and filename.endswith(\".json\"):\n                    order_id = filename.replace(\"order_\", \"\").replace(\".json\", \"\")\n                    order_data = await self._load_order(order_id)\n\n                    if order_data:\n                        order_date = order_data.get('created_at', '')[:10]\n                        if order_date == target_date:\n                            date_orders.append(order_data)\n\n            # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯\n            date_orders.sort(key=lambda x: x.get('created_at', ''))\n            return date_orders\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³ÙØ§Ø±Ø´Ø§Øª ØªØ§Ø±ÛŒØ® {target_date}: {e}\")\n            return []\n\n    async def get_orders_statistics(self) -> Dict:\n        \"\"\"Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÙØ§Ø±Ø´Ø§Øª\"\"\"\n        try:\n            all_orders = await self.get_all_orders()\n            today_orders = await self.get_todays_orders()\n\n            # Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ\n            total_orders = len(all_orders)\n            today_count = len(today_orders)\n\n            # Ø¢Ù…Ø§Ø± ÙˆØ¶Ø¹ÛŒØª\n            status_stats = {}\n            total_revenue = 0\n            today_revenue = 0\n\n            for order in all_orders:\n                status = order.get('status', 'pending')\n                status_text = self._get_status_text(status)\n                status_stats[status_text] = status_stats.get(status_text, 0) + 1\n                total_revenue += order.get('pricing', {}).get('total', 0)\n\n            for order in today_orders:\n                today_revenue += order.get('pricing', {}).get('total', 0)\n\n            return {\n                'total_orders': total_orders,\n                'today_orders': today_count,\n                'total_revenue': total_revenue,\n                'today_revenue': today_revenue,\n                'status_distribution': status_stats\n            }\n\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±: {e}\")\n            return {}","size_bytes":35248},"payment_data/bot/payment_reminder.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nPayment Reminder System\nAutomated system to send monthly payment reminders for 90-day payment plans.\n\"\"\"\n\nimport asyncio\nfrom datetime import datetime\nfrom telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup\nfrom bot.payment_scheduler import PaymentScheduler\nfrom bot.config import Config\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass PaymentReminderBot:\n    \"\"\"Automated payment reminder system\"\"\"\n    \n    def __init__(self, config: Config):\n        self.config = config\n        self.bot = Bot(token=config.bot_token)\n        self.payment_scheduler = PaymentScheduler()\n    \n    async def send_daily_reminders(self):\n        \"\"\"Check and send daily payment reminders\"\"\"\n        try:\n            pending_reminders = self.payment_scheduler.get_pending_reminders()\n            \n            if not pending_reminders:\n                logger.info(\"No payment reminders due today\")\n                return\n            \n            logger.info(f\"Found {len(pending_reminders)} payment reminders to send\")\n            \n            for reminder in pending_reminders:\n                await self._send_reminder_to_group(reminder)\n                \n        except Exception as e:\n            logger.error(f\"Error sending daily reminders: {e}\")\n    \n    async def _send_reminder_to_group(self, reminder_info):\n        \"\"\"Send payment reminder to order group\"\"\"\n        try:\n            message = self.payment_scheduler.generate_reminder_message(reminder_info)\n            \n            # Create keyboard for payment confirmation\n            keyboard = [\n                [\n                    InlineKeyboardButton(\n                        \"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯\",\n                        callback_data=f\"payment_confirmed_{reminder_info['schedule_id']}_{reminder_info['payment_number']}\"\n                    )\n                ],\n                [\n                    InlineKeyboardButton(\n                        \"ğŸ“ ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯\",\n                        callback_data=f\"contact_made_{reminder_info['schedule_id']}_{reminder_info['payment_number']}\"\n                    )\n                ],\n                [\n                    InlineKeyboardButton(\n                        \"â° ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ ÙØ±Ø¯Ø§\",\n                        callback_data=f\"remind_tomorrow_{reminder_info['schedule_id']}_{reminder_info['payment_number']}\"\n                    )\n                ]\n            ]\n            \n            await self.bot.send_message(\n                chat_id=self.config.order_group_chat_id,\n                text=message,\n                reply_markup=InlineKeyboardMarkup(keyboard)\n            )\n            \n            logger.info(f\"Sent payment reminder for user {reminder_info['user_id']}\")\n            \n        except Exception as e:\n            logger.error(f\"Error sending reminder to group: {e}\")\n    \n    async def handle_payment_confirmation(self, schedule_id: str, payment_number: int):\n        \"\"\"Handle payment confirmation from group admin\"\"\"\n        try:\n            success = self.payment_scheduler.mark_payment_made(schedule_id, payment_number)\n            \n            if success:\n                logger.info(f\"Payment {payment_number} confirmed for schedule {schedule_id}\")\n                return \"âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!\"\n            else:\n                logger.error(f\"Failed to confirm payment {payment_number} for schedule {schedule_id}\")\n                return \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n                \n        except Exception as e:\n            logger.error(f\"Error handling payment confirmation: {e}\")\n            return \"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n\nasync def run_daily_reminder_check():\n    \"\"\"Function to run daily reminder check\"\"\"\n    config = Config()\n    reminder_bot = PaymentReminderBot(config)\n    await reminder_bot.send_daily_reminders()\n\nif __name__ == \"__main__\":\n    # Run daily reminder check\n    asyncio.run(run_daily_reminder_check())\n","size_bytes":4009},"payment_data/bot/payment_scheduler.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nPayment Scheduler for 90-day Payment Plans\nManages monthly reminders for remaining payments.\n\"\"\"\n\nimport json\nimport os\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Any, Optional\nfrom utils.logger import setup_logger\nfrom utils.persian_utils import format_price, persian_numbers\n\nlogger = setup_logger(__name__)\n\nclass PaymentScheduler:\n    \"\"\"Manages payment schedules and monthly reminders\"\"\"\n\n    def __init__(self, data_dir: str = \"payment_data\"):\n        self.data_dir = data_dir\n        os.makedirs(self.data_dir, exist_ok=True)\n        self.payment_file = os.path.join(self.data_dir, \"payment_schedules.json\")\n\n    def _load_payment_schedules(self) -> Dict[str, Any]:\n        \"\"\"Load payment schedules from file\"\"\"\n        try:\n            if os.path.exists(self.payment_file):\n                with open(self.payment_file, 'r', encoding='utf-8') as f:\n                    return json.load(f)\n            return {}\n        except Exception as e:\n            logger.error(f\"Error loading payment schedules: {e}\")\n            return {}\n\n    def _save_payment_schedules(self, schedules: Dict[str, Any]) -> bool:\n        \"\"\"Save payment schedules to file\"\"\"\n        try:\n            with open(self.payment_file, 'w', encoding='utf-8') as f:\n                json.dump(schedules, f, ensure_ascii=False, indent=2, default=str)\n            return True\n        except Exception as e:\n            logger.error(f\"Error saving payment schedules: {e}\")\n            return False\n\n    def add_60day_payment_schedule(self, user_id: int, customer_info: Dict[str, Any], \n                                 total_amount: float, advance_paid: float, \n                                 remaining_amount: float, order_id: str) -> bool:\n        \"\"\"Add a new 60-day payment schedule\"\"\"\n        schedules = self._load_payment_schedules()\n\n        # Calculate payment date (60 days from now)\n        today = datetime.now()\n        payment_date = (today + timedelta(days=60)).strftime(\"%Y-%m-%d\")\n\n        schedule_id = f\"{user_id}_{order_id}_{int(today.timestamp())}\"\n\n        payment_schedule = {\n            'user_id': user_id,\n            'customer_info': customer_info,\n            'order_id': order_id,\n            'total_amount': total_amount,\n            'advance_paid': advance_paid,\n            'remaining_amount': remaining_amount,\n            'payment_date': payment_date,\n            'payment_type': '60day',\n            'payments_made': [],\n            'created_date': today.strftime(\"%Y-%m-%d\"),\n            'status': 'active'\n        }\n\n        schedules[schedule_id] = payment_schedule\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Added 60-day payment schedule for user {user_id}, order {order_id}\")\n            return True\n        return False\n\n    def add_90day_payment_schedule(self, user_id: int, customer_info: Dict[str, Any], \n                                 total_amount: float, advance_paid: float, \n                                 remaining_amount: float, order_id: str) -> bool:\n        \"\"\"Add a new 90-day payment schedule\"\"\"\n        schedules = self._load_payment_schedules()\n\n        # Calculate monthly payments (remaining amount / 3 months)\n        monthly_amount = remaining_amount / 3\n\n        # Calculate payment dates\n        today = datetime.now()\n        payment_dates = [\n            (today + timedelta(days=30)).strftime(\"%Y-%m-%d\"),\n            (today + timedelta(days=60)).strftime(\"%Y-%m-%d\"),\n            (today + timedelta(days=90)).strftime(\"%Y-%m-%d\")\n        ]\n\n        schedule_id = f\"{user_id}_{order_id}_{int(today.timestamp())}\"\n\n        payment_schedule = {\n            'user_id': user_id,\n            'customer_info': customer_info,\n            'order_id': order_id,\n            'total_amount': total_amount,\n            'advance_paid': advance_paid,\n            'remaining_amount': remaining_amount,\n            'monthly_amount': monthly_amount,\n            'payment_dates': payment_dates,\n            'payments_made': [],\n            'created_date': today.strftime(\"%Y-%m-%d\"),\n            'status': 'active'\n        }\n\n        schedules[schedule_id] = payment_schedule\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Added 90-day payment schedule for user {user_id}, order {order_id}\")\n            return True\n        return False\n\n    def get_pending_reminders(self) -> List[Dict[str, Any]]:\n        \"\"\"Get list of users who need payment reminders today\"\"\"\n        schedules = self._load_payment_schedules()\n        today = datetime.now().strftime(\"%Y-%m-%d\")\n        pending_reminders = []\n\n        for schedule_id, schedule in schedules.items():\n            if schedule['status'] != 'active':\n                continue\n\n            payment_type = schedule.get('payment_type', '90day')\n            \n            if payment_type == '60day':\n                # For 60-day payments: single payment date\n                payment_date = schedule['payment_date']\n                if payment_date == today and not schedule['payments_made']:\n                    reminder_info = {\n                        'schedule_id': schedule_id,\n                        'user_id': schedule['user_id'],\n                        'customer_info': schedule['customer_info'],\n                        'payment_number': 1,\n                        'payment_amount': schedule['remaining_amount'],\n                        'payment_type': '60day',\n                        'payment_date': payment_date\n                    }\n                    pending_reminders.append(reminder_info)\n            else:\n                # For 90-day payments: multiple payment dates\n                for i, payment_date in enumerate(schedule['payment_dates']):\n                    if payment_date == today:\n                        # Check if this payment hasn't been made yet\n                        if i not in schedule['payments_made']:\n                            reminder_info = {\n                                'schedule_id': schedule_id,\n                                'user_id': schedule['user_id'],\n                                'customer_info': schedule['customer_info'],\n                                'payment_number': i + 1,\n                                'monthly_amount': schedule['monthly_amount'],\n                                'remaining_payments': 3 - len(schedule['payments_made']),\n                                'payment_type': '90day',\n                                'payment_date': payment_date\n                            }\n                            pending_reminders.append(reminder_info)\n\n        return pending_reminders\n\n    def mark_payment_made(self, schedule_id: str, payment_number: int) -> bool:\n        \"\"\"Mark a payment as completed\"\"\"\n        schedules = self._load_payment_schedules()\n\n        if schedule_id not in schedules:\n            logger.error(f\"Schedule {schedule_id} not found\")\n            return False\n\n        schedule = schedules[schedule_id]\n        payment_type = schedule.get('payment_type', '90day')\n\n        if payment_type == '60day':\n            # For 60-day payments: mark as completed immediately\n            schedule['payments_made'] = [0]  # Single payment made\n            schedule['status'] = 'completed'\n        else:\n            # For 90-day payments: add payment to made payments list\n            if payment_number - 1 not in schedule['payments_made']:\n                schedule['payments_made'].append(payment_number - 1)\n                schedule['payments_made'].sort()\n\n            # Check if all payments are completed\n            if len(schedule['payments_made']) >= 3:\n                schedule['status'] = 'completed'\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Marked payment {payment_number} as completed for schedule {schedule_id}\")\n            return True\n        return False\n\n    def get_user_payment_schedules(self, user_id: int) -> List[Dict[str, Any]]:\n        \"\"\"Get all payment schedules for a specific user\"\"\"\n        schedules = self._load_payment_schedules()\n        user_schedules = []\n\n        for schedule_id, schedule in schedules.items():\n            if schedule['user_id'] == user_id:\n                user_schedules.append({\n                    'schedule_id': schedule_id,\n                    **schedule\n                })\n\n        return user_schedules\n\n    def generate_reminder_message(self, reminder_info: Dict[str, Any]) -> str:\n        \"\"\"Generate reminder message for payment\"\"\"\n        customer = reminder_info['customer_info']\n        payment_type = reminder_info.get('payment_type', '90day')\n        \n        if payment_type == '60day':\n            amount = reminder_info['payment_amount']\n            message = [\n                \"ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡\",\n                \"=\" * 30,\n                \"\",\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n                f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n                \"\",\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\",\n                f\"ğŸ“… Ø³Ø±Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª: Ø§Ù…Ø±ÙˆØ²\",\n                \"\",\n                \"ğŸ“ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯ ØªØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø§Ù…Ù„ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ø¯.\",\n                \"\",\n                \"Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\"\n            ]\n        else:\n            payment_num = reminder_info['payment_number']\n            amount = reminder_info['monthly_amount']\n            remaining = reminder_info['remaining_payments']\n            \n            message = [\n                \"ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡\",\n                \"=\" * 30,\n                \"\",\n                f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n                f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n                f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n                \"\",\n                f\"ğŸ“… Ù‚Ø³Ø· Ø´Ù…Ø§Ø±Ù‡: {persian_numbers(str(payment_num))} Ø§Ø² Û³\",\n                f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø³Ø·: {format_price(amount)} ØªÙˆÙ…Ø§Ù†\",\n                f\"ğŸ“Š Ø§Ù‚Ø³Ø§Ø· Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: {persian_numbers(str(remaining - 1))}\",\n                \"\",\n                \"ğŸ“ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø´ØªØ±ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯ ØªØ§ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ø¯.\",\n                \"\",\n                \"Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\"\n            ]\n\n        return \"\\n\".join(message)\n\n    def cancel_payment_schedule(self, schedule_id: str) -> bool:\n        \"\"\"Cancel a payment schedule\"\"\"\n        schedules = self._load_payment_schedules()\n\n        if schedule_id not in schedules:\n            logger.error(f\"Schedule {schedule_id} not found\")\n            return False\n\n        schedules[schedule_id]['status'] = 'cancelled'\n\n        if self._save_payment_schedules(schedules):\n            logger.info(f\"Cancelled payment schedule {schedule_id}\")\n            return True\n        return False\n\n    def schedule_payment_reminder(self, user_id: int, customer_name: str, amount: int, due_days: int, order_data: Dict):\n        \"\"\"Schedule a payment reminder\"\"\"\n        try:\n            # Load existing schedules\n            schedules = self._load_payment_schedules()\n\n            # Calculate due date\n            due_date = (datetime.now() + timedelta(days=due_days)).isoformat()\n\n            # Create schedule entry\n            schedule_id = f\"{user_id}_{int(datetime.now().timestamp())}\"\n            schedules[schedule_id] = {\n                'user_id': user_id,\n                'customer_name': customer_name,\n                'amount': amount,\n                'due_date': due_date,\n                'due_days': due_days,\n                'status': 'pending',\n                'created_at': datetime.now().isoformat(),\n                'order_data': order_data\n            }\n\n            # Save schedules\n            if self._save_payment_schedules(schedules):\n                logger.info(f\"Payment reminder scheduled for user {user_id}, due in {due_days} days\")\n                return schedule_id\n            else:\n                return None\n\n\n        except Exception as e:\n            logger.error(f\"Error scheduling payment reminder: {e}\")\n            return None","size_bytes":12386},"payment_data/bot/pricing.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nPricing and Invoice Management\nHandles price calculations and invoice generation.\n\"\"\"\n\nfrom typing import List, Dict, Any\nfrom utils.persian_utils import format_price, persian_numbers\nfrom datetime import datetime\n\n\nclass PricingManager:\n    \"\"\"Manages pricing and invoice generation\"\"\"\n\n    def __init__(self):\n        # Ù†Ø±Ø®â€ŒÙ‡Ø§ÛŒ ØªØ®ÙÛŒÙ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡\n        self.discount_rates = {\n            'cash': 0.30,  # ØªØ®ÙÛŒÙ Û³Û°Ùª Ù†Ù‚Ø¯ÛŒ\n            'installment': 0.25,  # ØªØ®ÙÛŒÙ Û²ÛµÙª Ø§Ù‚Ø³Ø§Ø·ÛŒ\n            '60day': 0.25,  # ØªØ®ÙÛŒÙ Û²ÛµÙª Ø¨Ø±Ø§ÛŒ Û¶Û° Ø±ÙˆØ²Ù‡\n            '90day': 0.25  # ØªØ®ÙÛŒÙ Û²ÛµÙª Ø¨Ø±Ø§ÛŒ Û¹Û° Ø±ÙˆØ²Ù‡\n        }\n\n        # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ\n        self.bank_info = {\n            'card_number': '6219861915854102',\n            'sheba_number': '110560611828005185959401',\n            'account_holder': 'Ù†ÛŒÙ…Ø§ Ú©Ø±ÛŒÙ…ÛŒ'\n        }\n\n    def calculate_subtotal(self, cart_items: List[Dict[str, Any]]) -> float:\n        \"\"\"Calculate subtotal from cart items\"\"\"\n        return sum(item['price'] * item['quantity'] for item in cart_items)\n\n    def calculate_discount(self, subtotal: int, discount_rate: float) -> int:\n        \"\"\"Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ®ÙÛŒÙ\"\"\"\n        return int(subtotal * discount_rate)\n\n    def calculate_tax(self, amount: int) -> int:\n        \"\"\"Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù„ÛŒØ§Øª (Û¹Ùª)\"\"\"\n        return int(amount * 0.09)\n\n    def calculate_total(self, subtotal: float, discount: float = 0) -> float:\n        \"\"\"Calculate final total\"\"\"\n        return subtotal - discount\n\n    def generate_invoice(self, cart_items: List[Dict[str, Any]],\n                         customer: Dict[str, Any]) -> str:\n        \"\"\"Generate invoice with all payment options displayed\"\"\"\n        if not cart_items:\n            return \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\"\n\n        # Calculate amounts\n        subtotal = self.calculate_subtotal(cart_items)\n\n        # Calculate discounts for each option\n        cash_discount = self.calculate_discount(subtotal, 0.30)\n        installment_discount = self.calculate_discount(subtotal, 0.25)\n\n        cash_total = subtotal - cash_discount\n        installment_total = subtotal - installment_discount\n        advance_payment_90 = installment_total * 0.25\n\n        # Generate invoice text\n        invoice_lines = [\n            \"ğŸ“‹ Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´\", \"=\" * 30, \"\", f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n            f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n            f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\", \"\", \"ğŸ“¦ Ø§Ù‚Ù„Ø§Ù… Ø³ÙØ§Ø±Ø´:\",\n            \"-\" * 20\n        ]\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_lines.extend([\n                f\"{persian_numbers(str(i))}. {item['product_name']}\",\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\",\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: {format_price(item['price'])} ØªÙˆÙ…Ø§Ù†\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\", \"\"\n            ])\n\n        # Add total amount\n        invoice_lines.extend([\n            \"-\" * 20, f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\",\n            \"\",\n            \"ğŸ’³ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®ØªØŒ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\"\n        ])\n\n        return \"\\n\".join(invoice_lines)\n\n    def generate_final_invoice(self, cart_items: List[Dict[str, Any]],\n                               customer: Dict[str, Any], payment_method: str,\n                               discount_rate: float) -> str:\n        \"\"\"Generate final invoice with payment method and discounts\"\"\"\n        if not cart_items:\n            return \"âŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.\"\n\n        # Calculate amounts\n        subtotal = self.calculate_subtotal(cart_items)\n        discount = self.calculate_discount(subtotal, discount_rate)\n        total = subtotal - discount\n\n        # Generate invoice text\n        invoice_lines = [\n            \"ğŸ“‹ ÙØ§Ú©ØªÙˆØ± Ù†Ù‡Ø§ÛŒÛŒ\", \"=\" * 30, \"\", f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {customer['name']}\",\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\",\n            f\"ğŸ†” Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: {customer['customer_id']}\",\n            f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\",\n            f\"ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: {payment_method}\", \"\", \"ğŸ“¦ Ø§Ù‚Ù„Ø§Ù… Ø³ÙØ§Ø±Ø´:\", \"-\" * 20\n        ]\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_lines.extend([\n                f\"{persian_numbers(str(i))}. {item['product_name']}\",\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\",\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: {format_price(item['price'])} ØªÙˆÙ…Ø§Ù†\",\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\", \"\"\n            ])\n\n        # Add calculations\n        invoice_lines.extend([\n            \"-\" * 20, f\"ğŸ’° Ù…Ø¬Ù…ÙˆØ¹: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\",\n            f\"ğŸ ØªØ®ÙÛŒÙ ({persian_numbers(str(int(discount_rate * 100)))}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\",\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(total)} ØªÙˆÙ…Ø§Ù†\"\n        ])\n\n        # Add special details for installment payment\n        if payment_method == \"Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ\":\n            invoice_lines.extend([\n                \"\", \"ğŸ’³ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ:\",\n                f\"ğŸ ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡: {persian_numbers(str(int(discount_rate * 100)))}Ùª\",\n                \"ğŸ“ Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ù‚Ø³Ø§Ø· Ø¨Ø§ ØªÙ…Ø§Ø³ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø§Ø¹Ù„Ø§Ù… Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯\"\n            ])\n\n        invoice_lines.extend(\n            [\"\", \"âœ… Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡ÛŒÙ… Ú¯Ø±ÙØª.\"])\n\n        return \"\\n\".join(invoice_lines)\n\n    def generate_invoice_text(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.25\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n        advance_payment = total * 0.25\n\n        invoice_text = (\n            f\"ğŸ†• Ø³ÙØ§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ - Ø´Ù…Ø§Ø±Ù‡: {order_data['order_id']}\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n            f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n            f\"ğŸ’° Ù‚ÛŒÙ…Øª Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ ØªØ®ÙÛŒÙ (25Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: {format_price(total)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’³ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª (25Ùª): {format_price(advance_payment)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ“… ØªØ§Ø±ÛŒØ®: Û±Û´Û°Û´/Û°Ûµ/Û±Û´\\n\"\n            f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n        return invoice_text\n\n    def generate_cash_payment_invoice(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ Ø¨Ø§ ØªØ®ÙÛŒÙ 30%\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.30  # 30% discount for cash payment\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n\n        invoice_text = (f\"ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ù‚Ø¯ÛŒ (30% ØªØ®ÙÛŒÙ)\\n\"\n                        f\"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_data['order_id']}\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\\n\\n\"\n                        f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n        # Add totals\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ ({persian_numbers('30')}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n            f\"ğŸª Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: {self.bank_info['account_holder']}\\n\"\n            f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: {self.bank_info['card_number']}\\n\"\n            f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR{self.bank_info['sheba_number']}\\n\\n\"\n            f\"âœ… Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ²ØŒ Ù„Ø·ÙØ§Ù‹ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\")\n\n        return invoice_text\n\n    def generate_installment_payment_invoice(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ Ø¨Ø§ ØªØ®ÙÛŒÙ 25%\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.25  # 25% discount for installment payment\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n\n        invoice_text = (f\"ğŸ“… Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù‚Ø³Ø§Ø·ÛŒ (25% ØªØ®ÙÛŒÙ)\\n\"\n                        f\"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_data['order_id']}\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\\n\\n\"\n                        f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n        # Add totals\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ ({persian_numbers('25')}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(total)} ØªÙˆÙ…Ø§Ù†\")\n\n        return invoice_text\n\n    def generate_60day_payment_invoice(self, order_data: Dict) -> str:\n        \"\"\"ØªÙˆÙ„ÛŒØ¯ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ Ø¨Ø§ ØªØ®ÙÛŒÙ 25% + Ù¾ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª 25%\"\"\"\n        customer = order_data[\"customer\"]\n        cart_items = order_data[\"items\"]\n\n        subtotal = sum(item['price'] * item['quantity'] for item in cart_items)\n        discount_rate = 0.25  # 25% discount\n        discount = subtotal * discount_rate\n        total = subtotal - discount\n        advance_payment = total * 0.25  # 25% advance payment from final amount\n\n        invoice_text = (f\"ğŸ• Ù¾Ø±Ø¯Ø§Ø®Øª 60 Ø±ÙˆØ²Ù‡ (25% ØªØ®ÙÛŒÙ)\\n\"\n                        f\"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´: {order_data['order_id']}\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n                        f\"ğŸ‘¤ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ: {customer['name']}\\n\"\n                        f\"ğŸ™ï¸ Ø´Ù‡Ø±: {customer['city']}\\n\"\n                        f\"ğŸ“… ØªØ§Ø±ÛŒØ®: {self._get_persian_date()}\\n\\n\"\n                        f\"ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ§Ø±Ø´:\\n\"\n                        f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\")\n\n        # Add cart items\n        for i, item in enumerate(cart_items, 1):\n            item_total = item['price'] * item['quantity']\n            invoice_text += (\n                f\"{persian_numbers(str(i))}. {item['product_name']}\\n\"\n                f\"   ğŸ“ Ø³Ø§ÛŒØ²: {item['size']}\\n\"\n                f\"   ğŸ“¦ ØªØ¹Ø¯Ø§Ø¯: {persian_numbers(str(item['quantity']))}\\n\"\n                f\"   ğŸ’° Ù‚ÛŒÙ…Øª: {format_price(item_total)} ØªÙˆÙ…Ø§Ù†\\n\\n\")\n\n        # Add totals and payment terms\n        invoice_text += (\n            f\"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {format_price(subtotal)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ ({persian_numbers('25')}Ùª): {format_price(discount)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’° Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: {format_price(total)} ØªÙˆÙ…Ø§Ù†\\n\"\n            f\"ğŸ’³ Ù…Ø¨Ù„Øº Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª ({persian_numbers('25')}Ùª): {format_price(advance_payment)} ØªÙˆÙ…Ø§Ù†\\n\\n\"\n            f\"ğŸ’³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n            f\"ğŸª Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø­Ø³Ø§Ø¨: {self.bank_info['account_holder']}\\n\"\n            f\"ğŸ’³ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: {self.bank_info['card_number']}\\n\"\n            f\"ğŸ¦ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§: IR{self.bank_info['sheba_number']}\\n\\n\"\n            f\"ğŸ“… Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:\\n\"\n            f\"â€¢ Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª 25Ùª Ø§Ø² Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ\\n\"\n            f\"â€¢ Ù…Ø§Ø¨Ù‚ÛŒ 60 Ø±ÙˆØ² Ù¾Ø³ Ø§Ø² ØªØ­ÙˆÛŒÙ„\\n\"\n            f\"â€¢ ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡ 25Ùª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡\\n\\n\"\n            f\"âœ… Ù¾Ø³ Ø§Ø² ÙˆØ§Ø±ÛŒØ² Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®ØªØŒ ÙÛŒØ´ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.\")\n\n        return invoice_text\n\n    def _get_persian_date(self) -> str:\n        \"\"\"Get current date in Persian format\"\"\"\n        # Return current Persian date: 1404/5/14\n        return persian_numbers(\"14 Ù…Ø±Ø¯Ø§Ø¯ 1404\")\n","size_bytes":15354},"payment_data/bot/zarinpal.py":{"content":"\n#!/usr/bin/env python3\n\"\"\"\nZarinPal Payment Integration\nHandles payment processing through ZarinPal gateway.\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, Any, Optional\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\nclass ZarinPalGateway:\n    \"\"\"ZarinPal payment gateway integration\"\"\"\n\n    def __init__(self, merchant_id: str, sandbox: bool = True):\n        self.merchant_id = merchant_id\n        self.sandbox = sandbox\n\n        if sandbox:\n            self.request_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentRequest.json\"\n            self.verify_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentVerification.json\"\n            self.gateway_url = \"https://sandbox.zarinpal.com/pg/StartPay/\"\n        else:\n            self.request_url = \"https://www.zarinpal.com/pg/rest/WebGate/PaymentRequest.json\"\n            self.verify_url = \"https://www.zarinpal.com/pg/rest/WebGate/PaymentVerification.json\"\n            self.gateway_url = \"https://www.zarinpal.com/pg/StartPay/\"\n\n    def create_payment_request(self, amount: int, description: str, \n                             callback_url: str, customer_email: str = \"\",\n                             customer_mobile: str = \"\") -> Dict[str, Any]:\n        \"\"\"Create payment request\"\"\"\n        try:\n            data = {\n                \"MerchantID\": self.merchant_id,\n                \"Amount\": amount,\n                \"Description\": description,\n                \"CallbackURL\": callback_url,\n                \"Email\": customer_email,\n                \"Mobile\": customer_mobile\n            }\n\n            response = requests.post(self.request_url, json=data, timeout=10)\n            result = response.json()\n\n            if result[\"Status\"] == 100:\n                authority = result[\"Authority\"]\n                payment_url = f\"{self.gateway_url}{authority}\"\n\n                logger.info(f\"Payment request created successfully. Authority: {authority}\")\n                return {\n                    \"success\": True,\n                    \"authority\": authority,\n                    \"payment_url\": payment_url\n                }\n            else:\n                error_msg = self._get_error_message(result[\"Status\"])\n                logger.error(f\"ZarinPal payment request failed: {error_msg}\")\n                return {\n                    \"success\": False,\n                    \"error\": error_msg\n                }\n\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Request error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n        except Exception as e:\n            logger.error(f\"Unexpected error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def verify_payment(self, authority: str, amount: int) -> Dict[str, Any]:\n        \"\"\"Verify payment\"\"\"\n        try:\n            data = {\n                \"MerchantID\": self.merchant_id,\n                \"Authority\": authority,\n                \"Amount\": amount\n            }\n\n            response = requests.post(self.verify_url, json=data, timeout=10)\n            result = response.json()\n\n            if result[\"Status\"] == 100:\n                ref_id = result[\"RefID\"]\n                logger.info(f\"Payment verified successfully. RefID: {ref_id}\")\n                return {\n                    \"success\": True,\n                    \"ref_id\": ref_id,\n                    \"status\": \"verified\"\n                }\n            else:\n                error_msg = self._get_error_message(result[\"Status\"])\n                logger.error(f\"Payment verification failed: {error_msg}\")\n                return {\n                    \"success\": False,\n                    \"error\": error_msg\n                }\n\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Request error during verification: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n        except Exception as e:\n            logger.error(f\"Unexpected error during verification: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def _get_error_message(self, status_code: int) -> str:\n        \"\"\"Get Persian error message for status code\"\"\"\n        error_messages = {\n            -1: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù†Ø§Ù‚Øµ Ø§Ø³Øª\",\n            -2: \"IP ÛŒØ§ Ù…Ø±Ú†Ù†Øª Ú©Ø¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª\",\n            -3: \"Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø´Ø§Ù¾Ø±Ú© Ø§Ù…Ú©Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -4: \"Ø³Ø·Ø­ ØªØ£ÛŒÛŒØ¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø³Ø·Ø­ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª\",\n            -11: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -12: \"Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒØ³Ø± Ù†Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -21: \"Ù‡ÛŒÚ† Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -22: \"ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -33: \"Ø±Ù‚Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ø±Ù‚Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯\",\n            -34: \"Ø³Ù‚Ù ØªÙ‚Ø³ÛŒÙ… ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² Ù„Ø­Ø§Ø¸ ØªØ¹Ø¯Ø§Ø¯ ÛŒØ§ Ø±Ù‚Ù… Ø¹Ø¨ÙˆØ± Ù†Ù…ÙˆØ¯Ù‡ Ø§Ø³Øª\",\n            -40: \"Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ØªØ¯ Ù…Ø±Ø¨ÙˆØ·Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -41: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ AdditionalData ØºÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -42: \"Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø¹ØªØ¨Ø± Ø·ÙˆÙ„ Ø¹Ù…Ø± Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Û´Ûµ Ø±ÙˆØ² Ø¨Ø§Ø´Ø¯\",\n            -54: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡ Ø§Ø³Øª\",\n            101: \"Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù‡ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ PaymentVerification ØªØ±Ø§Ú©Ù†Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª\"\n        }\n        \n        return error_messages.get(status_code, f\"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¨Ø§ Ú©Ø¯ {status_code}\")\n","size_bytes":6136},"payment_data/bot/zarinpal_test.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nZarinPal Payment Integration - Fixed Version\nHandles payment processing through ZarinPal gateway.\n\"\"\"\n\nimport requests\nimport json\nfrom typing import Dict, Any, Optional\nfrom utils.logger import setup_logger\n\nlogger = setup_logger(__name__)\n\n\nclass ZarinPalGateway:\n    \"\"\"ZarinPal payment gateway integration\"\"\"\n\n    def __init__(self, merchant_id: str, sandbox: bool = True):\n        self.merchant_id = merchant_id\n        self.sandbox = sandbox\n\n        if sandbox:\n            # Sandbox URLs\n            self.request_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentRequest.json\"\n            self.verify_url = \"https://sandbox.zarinpal.com/pg/rest/WebGate/PaymentVerification.json\"\n            self.gateway_url = \"https://sandbox.zarinpal.com/pg/StartPay/\"\n        else:\n            # Production URLs - API v4\n            self.request_url = \"https://api.zarinpal.com/pg/v4/payment/request/\"\n            self.verify_url = \"https://api.zarinpal.com/pg/v4/payment/verify/\"\n            self.gateway_url = \"https://www.zarinpal.com/pg/StartPay/\"\n\n    def create_payment_request(self,\n                               amount: int,\n                               description: str,\n                               callback_url: str,\n                               customer_email: str = \"\",\n                               customer_mobile: str = \"\") -> Dict[str, Any]:\n        \"\"\"Create payment request\"\"\"\n        try:\n            if self.sandbox:\n                # Sandbox API (v3 format)\n                data = {\n                    \"MerchantID\": self.merchant_id,\n                    \"Amount\": amount,\n                    \"Description\": description,\n                    \"CallbackURL\": callback_url,\n                    \"Email\": customer_email,\n                    \"Mobile\": customer_mobile\n                }\n                headers = {'Content-Type': 'application/json'}\n            else:\n                # Production API (v4 format)\n                data = {\n                    \"merchant_id\": self.merchant_id,\n                    \"amount\": amount,\n                    \"description\": description,\n                    \"callback_url\": callback_url,\n                    \"metadata\": {\n                        \"email\": customer_email,\n                        \"mobile\": customer_mobile\n                    }\n                }\n                headers = {\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                }\n\n            logger.info(f\"Sending payment request to: {self.request_url}\")\n            logger.info(\n                f\"Request data: {json.dumps(data, ensure_ascii=False)}\")\n\n            response = requests.post(self.request_url,\n                                     json=data,\n                                     headers=headers,\n                                     timeout=15)\n\n            logger.info(f\"Response status: {response.status_code}\")\n            logger.info(f\"Response headers: {dict(response.headers)}\")\n            logger.info(f\"Response text: {response.text}\")\n\n            if response.status_code != 200:\n                return {\n                    \"success\": False,\n                    \"error\":\n                    f\"HTTP Error {response.status_code}: {response.text}\"\n                }\n\n            result = response.json()\n\n            if self.sandbox:\n                # Sandbox response format\n                if result.get(\"Status\") == 100:\n                    authority = result.get(\"Authority\")\n                    payment_url = f\"{self.gateway_url}{authority}\"\n\n                    logger.info(\n                        f\"Payment request created successfully. Authority: {authority}\"\n                    )\n                    return {\n                        \"success\": True,\n                        \"authority\": authority,\n                        \"payment_url\": payment_url\n                    }\n                else:\n                    error_msg = self._get_error_message(\n                        result.get(\"Status\", -999))\n                    logger.error(\n                        f\"ZarinPal payment request failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n            else:\n                # Production response format\n                if result.get(\"data\") and result[\"data\"].get(\"code\") == 100:\n                    authority = result[\"data\"].get(\"authority\")\n                    payment_url = f\"{self.gateway_url}{authority}\"\n\n                    logger.info(\n                        f\"Payment request created successfully. Authority: {authority}\"\n                    )\n                    return {\n                        \"success\": True,\n                        \"authority\": authority,\n                        \"payment_url\": payment_url\n                    }\n                else:\n                    error_msg = result.get(\"errors\",\n                                           {}).get(\"message\", \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ\")\n                    logger.error(\n                        f\"ZarinPal payment request failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n\n        except requests.exceptions.Timeout:\n            logger.error(\"Request timeout\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø²Ù…Ø§Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.\"\n            }\n        except requests.exceptions.ConnectionError:\n            logger.error(\"Connection error\")\n            return {\n                \"success\":\n                False,\n                \"error\":\n                \"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª. Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.\"\n            }\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Request error: {e}\")\n            return {\"success\": False, \"error\": \"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except json.JSONDecodeError as e:\n            logger.error(f\"JSON decode error: {e}\")\n            return {\"success\": False, \"error\": \"Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except Exception as e:\n            logger.error(f\"Unexpected error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def verify_payment(self, authority: str, amount: int) -> Dict[str, Any]:\n        \"\"\"Verify payment\"\"\"\n        try:\n            if self.sandbox:\n                # Sandbox API (v3 format)\n                data = {\n                    \"MerchantID\": self.merchant_id,\n                    \"Authority\": authority,\n                    \"Amount\": amount\n                }\n                headers = {'Content-Type': 'application/json'}\n            else:\n                # Production API (v4 format)\n                data = {\n                    \"merchant_id\": self.merchant_id,\n                    \"authority\": authority,\n                    \"amount\": amount\n                }\n                headers = {\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json'\n                }\n\n            logger.info(f\"Verifying payment with authority: {authority}\")\n\n            response = requests.post(self.verify_url,\n                                     json=data,\n                                     headers=headers,\n                                     timeout=15)\n\n            logger.info(\n                f\"Verification response status: {response.status_code}\")\n            logger.info(f\"Verification response: {response.text}\")\n\n            if response.status_code != 200:\n                return {\n                    \"success\": False,\n                    \"error\":\n                    f\"HTTP Error {response.status_code}: {response.text}\"\n                }\n\n            result = response.json()\n\n            if self.sandbox:\n                # Sandbox response format\n                if result.get(\"Status\") == 100:\n                    ref_id = result.get(\"RefID\")\n                    logger.info(\n                        f\"Payment verified successfully. RefID: {ref_id}\")\n                    return {\n                        \"success\": True,\n                        \"ref_id\": ref_id,\n                        \"status\": \"verified\"\n                    }\n                else:\n                    error_msg = self._get_error_message(\n                        result.get(\"Status\", -999))\n                    logger.error(f\"Payment verification failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n            else:\n                # Production response format\n                if result.get(\"data\") and result[\"data\"].get(\"code\") == 100:\n                    ref_id = result[\"data\"].get(\"ref_id\")\n                    logger.info(\n                        f\"Payment verified successfully. RefID: {ref_id}\")\n                    return {\n                        \"success\": True,\n                        \"ref_id\": ref_id,\n                        \"status\": \"verified\"\n                    }\n                else:\n                    error_msg = result.get(\"errors\",\n                                           {}).get(\"message\", \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ\")\n                    logger.error(f\"Payment verification failed: {error_msg}\")\n                    return {\"success\": False, \"error\": error_msg}\n\n        except requests.exceptions.Timeout:\n            logger.error(\"Verification request timeout\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø²Ù…Ø§Ù† ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯\"\n            }\n        except requests.exceptions.ConnectionError:\n            logger.error(\"Verification connection error\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n        except requests.exceptions.RequestException as e:\n            logger.error(f\"Verification request error: {e}\")\n            return {\"success\": False, \"error\": \"Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except json.JSONDecodeError as e:\n            logger.error(f\"Verification JSON decode error: {e}\")\n            return {\"success\": False, \"error\": \"Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"}\n        except Exception as e:\n            logger.error(f\"Unexpected verification error: {e}\")\n            return {\n                \"success\": False,\n                \"error\": \"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª\"\n            }\n\n    def _get_error_message(self, status_code: int) -> str:\n        \"\"\"Get Persian error message for status code\"\"\"\n        error_messages = {\n            -1: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù†Ø§Ù‚Øµ Ø§Ø³Øª\",\n            -2: \"IP ÛŒØ§ Ù…Ø±Ú†Ù†Øª Ú©Ø¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª\",\n            -3: \"Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø´Ø§Ù¾Ø±Ú© Ø§Ù…Ú©Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -4: \"Ø³Ø·Ø­ ØªØ£ÛŒÛŒØ¯ Ù¾Ø°ÛŒØ±Ù†Ø¯Ù‡ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø² Ø³Ø·Ø­ Ù†Ù‚Ø±Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª\",\n            -11: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -12: \"Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒØ³Ø± Ù†Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -21: \"Ù‡ÛŒÚ† Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯\",\n            -22: \"ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -33: \"Ø±Ù‚Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ø±Ù‚Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯\",\n            -34: \"Ø³Ù‚Ù ØªÙ‚Ø³ÛŒÙ… ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² Ù„Ø­Ø§Ø¸ ØªØ¹Ø¯Ø§Ø¯ ÛŒØ§ Ø±Ù‚Ù… Ø¹Ø¨ÙˆØ± Ù†Ù…ÙˆØ¯Ù‡ Ø§Ø³Øª\",\n            -40: \"Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ØªØ¯ Ù…Ø±Ø¨ÙˆØ·Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯\",\n            -41: \"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ AdditionalData ØºÛŒØ± Ù…Ø¹ØªØ¨Ø± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯\",\n            -42:\n            \"Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù…Ø¹ØªØ¨Ø± Ø·ÙˆÙ„ Ø¹Ù…Ø± Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Û´Ûµ Ø±ÙˆØ² Ø¨Ø§Ø´Ø¯\",\n            -54: \"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¢Ø±Ø´ÛŒÙˆ Ø´Ø¯Ù‡ Ø§Ø³Øª\",\n            101:\n            \"Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù‡ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ PaymentVerification ØªØ±Ø§Ú©Ù†Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª\",\n            -999: \"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ - Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯\"\n        }\n\n        return error_messages.get(status_code,\n                                  f\"Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¨Ø§ Ú©Ø¯ {status_code}\")\n","size_bytes":12534},"README.md":{"content":"# decoteen\n\n","size_bytes":12},"retry_hesabfa_invoice.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§ Ø¨Ø±Ø§ÛŒ Ø³ÙØ§Ø±Ø´ Ù…ÙˆØ¬ÙˆØ¯\n\"\"\"\n\nimport asyncio\nimport json\nfrom bot.hesabfa_integration import HesabfaAPI\nfrom bot.order_server import OrderManagementServer\n\nasync def retry_hesabfa_for_order():\n    \"\"\"ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n    \n    # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ§Ø±Ø´ Ø¢Ø®Ø±ÛŒÙ†\n    order_server = OrderManagementServer()\n    order_id = \"00027\"  # Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´\n    \n    order_data = await order_server._load_order(order_id)\n    if not order_data:\n        print(f\"âŒ Ø³ÙØ§Ø±Ø´ {order_id} ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n        return\n    \n    print(f\"ğŸ“‹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ§Ø±Ø´ {order_id}\")\n    print(f\"ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: {order_data['customer']['name']}\")\n    print(f\"ğŸ’° Ù…Ø¨Ù„Øº Ú©Ù„: {order_data['pricing']['total']:,} ØªÙˆÙ…Ø§Ù†\")\n    \n    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§\n    hesabfa_api = HesabfaAPI()\n    \n    print(\"\\nğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§...\")\n    \n    # Ø§Ø¨ØªØ¯Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨\n    print(\"ğŸ‘¤ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨...\")\n    contact_result = await hesabfa_api.create_contact_if_not_exists(order_data[\"customer\"])\n    print(f\"   Ù†ØªÛŒØ¬Ù‡: {contact_result}\")\n    \n    # Ø³Ù¾Ø³ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±\n    print(\"ğŸ§¾ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±...\")\n    invoice_result = await hesabfa_api.create_invoice(order_data)\n    print(f\"   Ù†ØªÛŒØ¬Ù‡: {invoice_result}\")\n    \n    if invoice_result.get(\"success\"):\n        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ÙØ§\n        order_data[\"hesabfa_invoice_id\"] = invoice_result.get(\"invoice_id\")\n        order_data[\"hesabfa_invoice_number\"] = invoice_result.get(\"invoice_number\")\n        \n        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡\n        from datetime import datetime\n        hesabfa_entry = {\n            \"status\": \"hesabfa_created\",\n            \"timestamp\": datetime.now().isoformat(),\n            \"admin\": \"Ø¯Ø³ØªÛŒ\",\n            \"note\": f\"Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯ - Ø´Ù…Ø§Ø±Ù‡: {invoice_result.get('invoice_number')}\"\n        }\n        order_data[\"status_history\"].append(hesabfa_entry)\n        \n        # Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª\n        await order_server._save_order(order_id, order_data)\n        \n        print(f\"âœ… ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø­Ø³Ø§Ø¨ÙØ§ Ø«Ø¨Øª Ø´Ø¯!\")\n        print(f\"   Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: {invoice_result.get('invoice_number')}\")\n        print(f\"   Ø´Ù†Ø§Ø³Ù‡: {invoice_result.get('invoice_id')}\")\n    else:\n        print(f\"âŒ Ø®Ø·Ø§: {invoice_result.get('error')}\")\n\nif __name__ == \"__main__\":\n    asyncio.run(retry_hesabfa_for_order())","size_bytes":2669},"test_hesabfa.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ÙØ§\n\"\"\"\n\nimport os\nimport requests\nimport json\nfrom bot.hesabfa_integration import HesabfaAPI\n\ndef test_hesabfa_connection():\n    \"\"\"ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ÙØ§\"\"\"\n    \n    # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª\n    api_key = os.getenv(\"HESABFA_API_KEY\")\n    login_token = os.getenv(\"HESABFA_LOGIN_TOKEN\")\n    \n    print(f\"API Key: {api_key[:10]}...\" if api_key else \"API Key: âŒ Not Found\")\n    print(f\"Login Token: {login_token[:10]}...\" if login_token else \"Login Token: âŒ Not Found\")\n    \n    if not api_key or not login_token:\n        print(\"âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø­Ø³Ø§Ø¨ÙØ§ ÛŒØ§ÙØª Ù†Ø´Ø¯\")\n        return False\n    \n    # ØªØ³Øª endpoint Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù\n    endpoints_to_test = [\n        \"/Setting\",\n        \"/contact\", \n        \"/invoice\",\n        \"/item\"\n    ]\n    \n    base_url = \"https://api.hesabfa.com/v1\"\n    headers = {\n        \"Content-Type\": \"application/json\",\n        \"apikey\": api_key,\n        \"logintoken\": login_token\n    }\n    \n    print(\"\\nğŸ” ØªØ³Øª endpoint Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù:\")\n    \n    for endpoint in endpoints_to_test:\n        try:\n            url = f\"{base_url}{endpoint}\"\n            print(f\"\\nğŸ“¡ ØªØ³Øª {endpoint}...\")\n            \n            response = requests.get(\n                url,\n                headers=headers,\n                timeout=30\n            )\n            \n            print(f\"   Status: {response.status_code}\")\n            \n            if response.status_code == 200:\n                try:\n                    result = response.json()\n                    print(f\"   Response: {json.dumps(result, ensure_ascii=False, indent=2)[:200]}...\")\n                except:\n                    print(f\"   Response: {response.text[:200]}...\")\n            else:\n                print(f\"   Error: {response.text[:200]}\")\n                \n        except requests.exceptions.Timeout:\n            print(f\"   âŒ Timeout - {endpoint}\")\n        except requests.exceptions.ConnectionError:\n            print(f\"   âŒ Connection Error - {endpoint}\")\n        except Exception as e:\n            print(f\"   âŒ Error: {e}\")\n    \n    print(\"\\nğŸ§ª ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ù†Ù…ÙˆÙ†Ù‡:\")\n    \n    # ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡\n    try:\n        hesabfa_api = HesabfaAPI()\n        \n        sample_order = {\n            \"order_id\": \"TEST001\",\n            \"customer\": {\n                \"name\": \"Ù…Ø´ØªØ±ÛŒ ØªØ³Øª\",\n                \"customer_id\": \"TEST001\",\n                \"city\": \"ØªÙ‡Ø±Ø§Ù†\"\n            },\n            \"cart_items\": [{\n                \"product_id\": \"TEST_PRODUCT\",\n                \"product_name\": \"Ù…Ø­ØµÙˆÙ„ ØªØ³Øª\",\n                \"size\": \"Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯\",\n                \"quantity\": 1,\n                \"price\": 100000\n            }],\n            \"pricing\": {\n                \"subtotal\": 100000,\n                \"discount\": 10000,\n                \"tax\": 9000,\n                \"total\": 99000\n            },\n            \"payment_method\": \"Ù†Ù‚Ø¯ÛŒ\",\n            \"user_id\": \"TEST_USER\"\n        }\n        \n        print(\"ğŸ“‹ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯...\")\n        \n        # Ø§ÙˆÙ„ ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨\n        print(\"ğŸ‘¤ ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨...\")\n        contact_result = await hesabfa_api.create_contact_if_not_exists(sample_order[\"customer\"])\n        print(f\"   Ù†ØªÛŒØ¬Ù‡ Ù…Ø®Ø§Ø·Ø¨: {contact_result}\")\n        \n        # Ø¨Ø¹Ø¯ ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±  \n        print(\"ğŸ§¾ ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±...\")\n        invoice_result = await hesabfa_api.create_invoice(sample_order)\n        print(f\"   Ù†ØªÛŒØ¬Ù‡ ÙØ§Ú©ØªÙˆØ±: {invoice_result}\")\n        \n        return invoice_result.get(\"success\", False)\n        \n    except Exception as e:\n        print(f\"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª ÙØ§Ú©ØªÙˆØ±: {e}\")\n        return False\n\nif __name__ == \"__main__\":\n    import asyncio\n    result = asyncio.run(test_hesabfa_connection())\n    if result:\n        print(\"\\nâœ… ØªØ³Øª Ø­Ø³Ø§Ø¨ÙØ§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!\")\n    else:\n        print(\"\\nâŒ ØªØ³Øª Ø­Ø³Ø§Ø¨ÙØ§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!\")","size_bytes":4113}}}